<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Word2Stitch â€” Cross-Stitch Pattern Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Anybody:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* -- Reset -- */
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #f5f0ea;
    --bg-deep: #ece5db;
    --panel: #faf8f5;
    --border: #e0d6c8;
    --border-light: #eae3d9;
    --text: #3d3229;
    --text-mid: #7a6e60;
    --text-muted: #a99e8f;
    --accent: #b83a2a;
    --accent-hover: #9c3023;
    --accent-soft: rgba(184, 58, 42, 0.08);
    --accent-glow: rgba(184, 58, 42, 0.15);
    --stitch-grid: #d8d0c5;
    --stitch-bold: #a09585;
    --radius: 10px;
    --radius-sm: 6px;
    --font-display: 'DM Serif Display', Georgia, serif;
    --font-body: 'Anybody', system-ui, sans-serif;
  }

  html, body { height: 100%; overflow: hidden; }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
    line-height: 1.4;
    -webkit-font-smoothing: antialiased;
  }

  /* -- Linen noise texture -- */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    pointer-events: none;
    opacity: 0.3;
    background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 20h40M20 0v40' stroke='%23c8bfb0' stroke-width='0.3'/%3E%3C/svg%3E");
    background-size: 40px 40px;
    z-index: 0;
  }

  /* -- Top Bar -- */
  .topbar {
    position: relative;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 10px 20px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }

  .logo {
    display: flex;
    align-items: baseline;
    gap: 0;
    flex-shrink: 0;
    user-select: none;
  }
  .logo-x {
    font-size: 18px;
    color: var(--accent);
    font-weight: 700;
    line-height: 1;
    margin-right: 3px;
  }
  .logo-text {
    font-family: var(--font-display);
    font-size: 20px;
    color: var(--text);
    letter-spacing: -0.3px;
  }
  .logo-text em {
    color: var(--accent);
    font-style: italic;
  }

  .topbar-sep {
    width: 1px;
    height: 24px;
    background: var(--border);
    flex-shrink: 0;
  }

  /* -- Text Input (in topbar) -- */
  .text-input-area {
    flex: 1;
    min-width: 0;
    position: relative;
  }
  .text-input {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 8px 14px;
    font-family: var(--font-display);
    font-size: 22px;
    color: var(--text);
    background: #fff;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .text-input::placeholder {
    color: var(--text-muted);
    font-style: italic;
  }
  .text-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  /* Download button in topbar */
  .btn-download {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 9px 18px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    font-family: var(--font-body);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    white-space: nowrap;
  }
  .btn-download:hover {
    background: var(--accent-hover);
    box-shadow: 0 3px 12px rgba(184,58,42,0.25);
    transform: translateY(-1px);
  }
  .btn-download:active { transform: translateY(0); }
  .btn-download svg { width: 15px; height: 15px; }

  /* -- Main Layout -- */
  .main-layout {
    position: relative;
    z-index: 1;
    display: flex;
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  /* -- Left Sidebar -- */
  .sidebar {
    width: 280px;
    flex-shrink: 0;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-section {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border-light);
  }
  .sidebar-section:last-child { border-bottom: none; }

  .section-header {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .section-header svg {
    width: 12px;
    height: 12px;
    opacity: 0.5;
  }

  /* -- Font search input -- */
  .font-search {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 6px 10px;
    font-family: var(--font-body);
    font-size: 12px;
    color: var(--text);
    background: #fff;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .font-search::placeholder {
    color: var(--text-muted);
  }
  .font-search:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  /* -- Font Category Tabs -- */
  .font-tabs {
    display: flex;
    gap: 3px;
    overflow-x: auto;
    flex-wrap: nowrap;
    padding: 8px 0 4px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .font-tabs::-webkit-scrollbar { height: 3px; }
  .font-tabs::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  .font-tab {
    flex-shrink: 0;
    padding: 3px 7px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: transparent;
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 10px;
    font-weight: 600;
    color: var(--text-mid);
    transition: all 0.12s;
    white-space: nowrap;
    line-height: 1.3;
  }
  .font-tab:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .font-tab.active {
    border-color: var(--accent);
    background: var(--accent-soft);
    color: var(--accent);
  }

  /* -- Font List -- */
  .font-list {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    gap: 3px;
    padding: 0 14px 10px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .font-list::-webkit-scrollbar { width: 5px; }
  .font-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .font-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border: 1.5px solid transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.12s;
    background: transparent;
    flex-shrink: 0;
  }
  .font-item:hover {
    background: var(--accent-soft);
    border-color: var(--border);
  }
  .font-item.selected {
    background: var(--accent-soft);
    border-color: var(--accent);
  }
  .font-item-info {
    min-width: 0;
    flex: 1;
  }
  .font-item-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .font-item-meta {
    font-size: 10px;
    color: var(--text-muted);
  }

  /* -- Height Slider -- */
  .height-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .height-slider {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    border-radius: 4px;
    background: var(--border);
    outline: none;
    transition: background 0.2s;
  }
  .height-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    transition: transform 0.1s;
  }
  .height-slider::-webkit-slider-thumb:hover {
    transform: scale(1.15);
  }
  .height-slider::-moz-range-thumb {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .height-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    font-family: var(--font-body);
    min-width: 32px;
    text-align: right;
    line-height: 1;
  }
  .height-unit {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* -- Color Swatches -- */
  .color-row {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    align-items: center;
  }
  .color-dot {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.12s;
    position: relative;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.08);
  }
  .color-dot:hover {
    transform: scale(1.2);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  .color-dot.selected {
    border-color: var(--text);
    box-shadow: 0 0 0 2px #fff, 0 0 0 3.5px var(--text);
    transform: scale(1.1);
  }
  .color-dot .tip {
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--text);
    color: #fff;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 10px;
    font-weight: 500;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.12s;
    z-index: 20;
  }
  .color-dot .tip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 3px solid transparent;
    border-top-color: var(--text);
  }
  .color-dot:hover .tip { opacity: 1; }

  /* -- Aida selector -- */
  .aida-row {
    display: flex;
    gap: 5px;
  }
  .aida-chip {
    flex: 1;
    text-align: center;
    padding: 8px 0;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-family: var(--font-body);
    background: transparent;
    transition: all 0.12s;
  }
  .aida-chip:hover { border-color: var(--accent); }
  .aida-chip.selected {
    border-color: var(--accent);
    background: var(--accent-soft);
  }
  .aida-chip-num {
    display: block;
    font-size: 17px;
    font-weight: 700;
    color: var(--text);
    line-height: 1.1;
  }
  .aida-chip.selected .aida-chip-num { color: var(--accent); }
  .aida-chip-label {
    font-size: 9px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  /* -- Custom count input -- */
  .custom-count-row {
    display: none;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
  }
  .custom-count-row.visible { display: flex; }
  .custom-count-input {
    width: 58px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 5px 8px;
    font-family: var(--font-body);
    font-size: 14px;
    font-weight: 700;
    color: var(--accent);
    text-align: center;
    background: #fff;
    outline: none;
    transition: border-color 0.15s;
  }
  .custom-count-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  .custom-unit-toggle {
    display: flex;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }
  .custom-unit-btn {
    padding: 5px 8px;
    border: none;
    background: transparent;
    font-family: var(--font-body);
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.12s;
    text-transform: uppercase;
  }
  .custom-unit-btn.active {
    background: var(--accent);
    color: #fff;
  }
  .custom-unit-btn:not(.active):hover {
    background: var(--accent-soft);
    color: var(--accent);
  }
  .custom-count-label {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 500;
    white-space: nowrap;
  }

  /* -- Preview Area (right) -- */
  .preview-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 0;
    overflow: hidden;
    padding: 20px;
    position: relative;
  }

  .preview-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: var(--text-muted);
    font-size: 15px;
    text-align: center;
  }
  .preview-empty svg {
    width: 48px;
    height: 48px;
    opacity: 0.25;
    margin-bottom: 4px;
  }
  .preview-empty span {
    font-family: var(--font-display);
    font-size: 16px;
    font-style: italic;
  }

  /* -- Loading overlay -- */
  .preview-loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(245, 240, 234, 0.85);
    z-index: 5;
    gap: 12px;
  }
  .preview-loading.hidden { display: none; }
  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text {
    font-family: var(--font-display);
    font-size: 15px;
    font-style: italic;
    color: var(--text-mid);
  }

  .preview-canvas-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    max-width: 100%;
    max-height: 100%;
  }

  #mainCanvas {
    image-rendering: pixelated;
    max-width: 100%;
    max-height: calc(100vh - 200px);
    object-fit: contain;
    border-radius: 2px;
  }

  /* -- Stats Bar (below canvas) -- */
  .stats-bar {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .stat-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 11px;
    color: var(--text-mid);
    white-space: nowrap;
    transition: all 0.2s;
  }
  .stat-pill strong {
    color: var(--text);
    font-weight: 700;
  }
  .stat-pill .unit {
    color: var(--text-muted);
    font-size: 10px;
  }

  .stat-pill.size-pill {
    background: var(--accent-soft);
    border-color: var(--accent);
  }
  .stat-pill.size-pill strong {
    color: var(--accent);
    font-size: 13px;
  }

  .stat-sep {
    color: var(--border);
    font-size: 11px;
    padding: 0 2px;
  }

  /* -- Ruler visualization -- */
  .ruler-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    width: 100%;
    max-width: 600px;
  }

  .ruler-line {
    display: flex;
    align-items: center;
    gap: 0;
  }
  .ruler-edge {
    width: 1px;
    height: 10px;
    background: var(--accent);
    flex-shrink: 0;
  }
  .ruler-bar {
    flex: 1;
    height: 1.5px;
    background: var(--accent);
    position: relative;
  }
  .ruler-label {
    position: absolute;
    top: -16px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
    white-space: nowrap;
    font-family: var(--font-body);
  }

  .ruler-height-wrap {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .ruler-height-label {
    font-size: 11px;
    color: var(--text-muted);
  }
  .ruler-height-val {
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
  }

  /* -- Sidebar toggle & drawer backdrop (disabled - no longer used) -- */
  .sidebar-toggle {
    display: none;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    background: #fff;
    cursor: pointer;
    flex-shrink: 0;
    transition: border-color 0.15s, background 0.15s;
    position: relative;
  }
  .sidebar-toggle:hover { border-color: var(--accent); }
  .sidebar-toggle.active { border-color: var(--accent); background: var(--accent-soft); }
  .sidebar-toggle svg { width: 18px; height: 18px; color: var(--text-mid); }
  .sidebar-toggle.active svg { color: var(--accent); }

  .drawer-backdrop {
    display: none !important;
  }

  /* ============================================= */
  /* -- Responsive: Mobile (<=640px) -- */
  /* Vertical stack: topbar -> preview -> controls */
  /* ============================================= */
  @media (max-width: 640px) {
    html, body { overflow: auto; height: auto; min-height: 100vh; }
    body { height: auto; }

    .topbar { padding: 8px 12px; gap: 8px; }
    .topbar-sep, .logo { display: none; }
    .sidebar-toggle { display: none; }

    .text-input { font-size: 16px; min-height: 44px; }

    .main-layout {
      flex-direction: column;
      overflow: visible;
      min-height: 0;
    }

    .sidebar {
      width: 100%;
      order: 2;
      border-right: none;
      border-top: 1px solid var(--border);
      overflow: visible;
      max-height: none;
    }

    .preview-area {
      order: 1;
      min-height: 250px;
      max-height: 50vh;
      padding: 12px;
    }

    #mainCanvas { max-height: 45vh; }

    .font-list { max-height: 300px; }

    /* Larger touch targets */
    .font-item { min-height: 48px; padding: 12px 14px; }
    .font-item-name { font-size: 15px; }
    .color-dot { width: 40px; height: 40px; }
    .aida-chip { min-height: 52px; padding: 12px 4px; }
    .aida-chip-num { font-size: 22px; }
    .font-tab { min-height: 36px; padding: 6px 12px; font-size: 12px; }
    .font-search { min-height: 44px; font-size: 16px; }
    .height-slider { height: 10px; }
    .height-slider::-webkit-slider-thumb { width: 24px; height: 24px; }
    .height-slider::-moz-range-thumb { width: 24px; height: 24px; }
    .custom-count-input { min-height: 44px; font-size: 16px; }
    .sidebar-section { padding: 14px 16px; }
    .font-list { padding: 0 16px 12px; }

    .stats-bar { gap: 4px; }
    .stat-pill { font-size: 11px; }
  }

  /* ============================================= */
  /* -- Responsive: Small phones (<=380px) -- */
  /* ============================================= */
  @media (max-width: 380px) {
    .text-input { font-size: 16px; padding: 8px 10px; }
    .btn-download { padding: 8px 12px; }
    .preview-area { padding: 8px; min-height: 200px; }
    .color-dot { width: 36px; height: 36px; }
  }

  /* ============================================= */
  /* -- Responsive: Tablet (641-1024px) -- */
  /* ============================================= */
  @media (min-width: 641px) and (max-width: 1024px) {
    .sidebar { width: 250px; }
    .sidebar-toggle { display: none; }
    .text-input { font-size: 18px; }
  }

  /* ============================================= */
  /* -- Responsive: Desktop (>1024px) -- */
  /* ============================================= */
  @media (min-width: 1025px) {
    .sidebar { width: 300px; }
    .sidebar-toggle { display: none; }
  }

  /* -- Language selector -- */
  .lang-select {
    flex-shrink: 0;
    padding: 4px 6px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    background: #fff;
    font-family: var(--font-body);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-mid);
    cursor: pointer;
    outline: none;
    transition: border-color 0.15s;
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23a99e8f'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 6px center;
    padding-right: 20px;
  }
  .lang-select:hover, .lang-select:focus { border-color: var(--accent); }

  /* -- Scrollbar global -- */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
</style>
</head>
<body>

<!-- -- Top Bar -- -->
<div class="topbar">
  <div class="logo">
    <span class="logo-x">&#10006;</span>
    <span class="logo-text">Word<em>2</em>Stitch</span>
  </div>

  <div class="topbar-sep"></div>

  <div class="text-input-area">
    <input
      type="text"
      class="text-input"
      id="textInput"
      placeholder="Type your text here..."
      data-i18n-placeholder="placeholder_text"
      value="Welcome"
      maxlength="40"
      autocomplete="off"
      spellcheck="false"
    />
  </div>

  <select class="lang-select" id="langSelect">
    <option value="en">ğŸ‡¬ğŸ‡§ EN</option>
    <option value="es">ğŸ‡ªğŸ‡¸ ES</option>
    <option value="fr">ğŸ‡«ğŸ‡· FR</option>
    <option value="de">ğŸ‡©ğŸ‡ª DE</option>
    <option value="it">ğŸ‡®ğŸ‡¹ IT</option>
    <option value="pt">ğŸ‡§ğŸ‡· PT</option>
    <option value="nl">ğŸ‡³ğŸ‡± NL</option>
    <option value="ja">ğŸ‡¯ğŸ‡µ JA</option>
    <option value="ko">ğŸ‡°ğŸ‡· KO</option>
    <option value="zh">ğŸ‡¨ğŸ‡³ ZH</option>
    <option value="ru">ğŸ‡·ğŸ‡º RU</option>
    <option value="pl">ğŸ‡µğŸ‡± PL</option>
    <option value="sv">ğŸ‡¸ğŸ‡ª SV</option>
    <option value="da">ğŸ‡©ğŸ‡° DA</option>
    <option value="fi">ğŸ‡«ğŸ‡® FI</option>
    <option value="uk">ğŸ‡ºğŸ‡¦ UK</option>
    <option value="hu">ğŸ‡­ğŸ‡º HU</option>
  </select>

  <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle controls" data-i18n-aria="toggle_controls">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
      <line x1="3" y1="6" x2="21" y2="6"/>
      <line x1="3" y1="12" x2="21" y2="12"/>
      <line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
  </button>

  <button class="btn-download" id="btnDownload">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="7 10 12 15 17 10"/>
      <line x1="12" y1="15" x2="12" y2="3"/>
    </svg>
    <span class="dl-label">PDF</span>
  </button>
</div>

<!-- Drawer backdrop (mobile) -->
<div class="drawer-backdrop" id="drawerBackdrop"></div>

<!-- -- Main Split Layout -- -->
<div class="main-layout">

  <!-- -- Left Sidebar: Controls -- -->
  <div class="sidebar">

    <!-- Font Search + Header -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
        <span data-i18n="section_font">Font</span>
      </div>
      <input
        type="text"
        class="font-search"
        id="fontSearch"
        placeholder="Search fonts..."
        data-i18n-placeholder="search_fonts"
        autocomplete="off"
        spellcheck="false"
      />
      <div class="font-tabs" id="fontCategoryTabs">
        <button class="font-tab active" data-category="all">All</button>
      </div>
    </div>

    <!-- Font List (scrollable) -->
    <div class="font-list" id="fontList"></div>

    <!-- Height Control -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h4M18 12h4M7 7l2 2M15 15l2 2M7 17l2-2M15 7l2-2"/></svg>
        <span data-i18n="section_height">Stitch Height</span>
      </div>
      <div class="height-control">
        <input type="range" class="height-slider" id="heightSlider" min="4" max="30" value="18" step="1" />
        <div>
          <span class="height-value" id="heightValue">18</span>
          <span class="height-unit" data-i18n="unit_px">px</span>
        </div>
      </div>
    </div>

    <!-- Color Picker -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
        <span data-i18n="section_color">Thread Color</span>
      </div>
      <div class="color-row" id="colorRow"></div>
    </div>

    <!-- Aida Count -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
        <span data-i18n="section_fabric">Fabric</span>
      </div>
      <div class="aida-row" id="aidaRow">
        <button class="aida-chip" data-count="11">
          <span class="aida-chip-num">11</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip selected" data-count="14">
          <span class="aida-chip-num">14</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip" data-count="16">
          <span class="aida-chip-num">16</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip" data-count="18">
          <span class="aida-chip-num">18</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip" data-count="custom" id="aidaCustomChip">
          <span class="aida-chip-num">âœ</span>
          <span class="aida-chip-label">Custom</span>
        </button>
      </div>
      <div class="custom-count-row" id="customCountRow">
        <input type="number" class="custom-count-input" id="customCountInput" min="1" max="100" value="14" step="0.5" />
        <div class="custom-unit-toggle" id="customUnitToggle">
          <button class="custom-unit-btn active" data-unit="inch">/ inch</button>
          <button class="custom-unit-btn" data-unit="cm">/ cm</button>
        </div>
        <span class="custom-count-label" id="customCountLabel">= 14 ct</span>
      </div>
    </div>

  </div>

  <!-- -- Right: Preview -- -->
  <div class="preview-area" id="previewArea">

    <!-- Loading overlay -->
    <div class="preview-loading hidden" id="previewLoading">
      <div class="loading-spinner"></div>
      <div class="loading-text" data-i18n="loading_text">Rasterizing...</div>
    </div>

    <div class="preview-empty" id="previewEmpty">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <line x1="3" y1="9" x2="21" y2="9"/>
        <line x1="3" y1="15" x2="21" y2="15"/>
        <line x1="9" y1="3" x2="9" y2="21"/>
        <line x1="15" y1="3" x2="15" y2="21"/>
      </svg>
      <span data-i18n="empty_state">Type something to see your pattern</span>
    </div>

    <div class="preview-canvas-wrap" id="previewWrap" style="display:none;">
      <canvas id="mainCanvas"></canvas>

      <!-- Ruler showing width in cm -->
      <div class="ruler-info" id="rulerInfo">
        <div class="ruler-line">
          <div class="ruler-edge"></div>
          <div class="ruler-bar">
            <div class="ruler-label" id="rulerWidth">--</div>
          </div>
          <div class="ruler-edge"></div>
        </div>
      </div>

      <!-- Stats pills -->
      <div class="stats-bar" id="statsBar">
        <div class="stat-pill size-pill">
          <strong id="statSizeCm">--</strong>
          <span class="unit" data-i18n="unit_cm">cm</span>
        </div>
        <div class="stat-sep">.</div>
        <div class="stat-pill">
          <strong id="statStitchesW">--</strong>x<strong id="statStitchesH">--</strong>
          <span class="unit" data-i18n="unit_stitches">stitches</span>
        </div>
        <div class="stat-sep">.</div>
        <div class="stat-pill">
          <strong id="statTotal">--</strong>
          <span class="unit" data-i18n="unit_crosses">crosses</span>
        </div>
        <div class="stat-sep">.</div>
        <div class="stat-pill">
          DMC <strong id="statDmc">--</strong>
          <span class="unit" id="statThread">--</span>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ================================================ -->
<!-- ==  JavaScript                                 == -->
<!-- ================================================ -->
<script>
(function () {
  'use strict';

  // -- i18n translations --
  var I18N = {
    en: {
      placeholder_text: "Type your text here...",
      section_font: "Font",
      search_fonts: "Search fonts...",
      tab_all: "All",
      section_height: "Stitch Height",
      unit_px: "px",
      section_color: "Thread Color",
      section_fabric: "Fabric",
      label_aida: "Aida",
      empty_state: "Type something to see your pattern",
      loading_text: "Rasterizing...",
      unit_cm: "cm",
      unit_stitches: "stitches",
      unit_crosses: "crosses",
      toggle_controls: "Toggle controls",
      no_fonts: "No fonts available",
      no_matching: "No matching fonts",
      server_error: "Failed to load fonts. Is the server running?",
      alert_no_text: "Type some text and select a font first.",
      alert_no_pdf: "PDF engine not loaded. Please reload the page.",
      alert_no_jspdf: "jsPDF library not loaded. Check your internet connection and reload.",
      alert_pdf_fail: "PDF generation failed: "
    },
    es: {
      placeholder_text: "Escribe tu texto aquÃ­...",
      section_font: "Fuente",
      search_fonts: "Buscar fuentes...",
      tab_all: "Todas",
      section_height: "Altura de Puntada",
      unit_px: "px",
      section_color: "Color de Hilo",
      section_fabric: "Tela",
      label_aida: "Aida",
      empty_state: "Escribe algo para ver tu patrÃ³n",
      loading_text: "Rasterizando...",
      unit_cm: "cm",
      unit_stitches: "puntadas",
      unit_crosses: "cruces",
      toggle_controls: "Mostrar controles",
      no_fonts: "No hay fuentes disponibles",
      no_matching: "No se encontraron fuentes",
      server_error: "Error al cargar fuentes. Â¿EstÃ¡ el servidor activo?",
      alert_no_text: "Escribe un texto y selecciona una fuente primero.",
      alert_no_pdf: "Motor PDF no cargado. Recarga la pÃ¡gina.",
      alert_no_jspdf: "Biblioteca jsPDF no cargada. Verifica tu conexiÃ³n y recarga.",
      alert_pdf_fail: "Error al generar PDF: "
    },
    fr: {
      placeholder_text: "Tapez votre texte ici...",
      section_font: "Police",
      search_fonts: "Rechercher des polices...",
      tab_all: "Toutes",
      section_height: "Hauteur de Point",
      unit_px: "px",
      section_color: "Couleur du Fil",
      section_fabric: "Tissu",
      label_aida: "Aida",
      empty_state: "Tapez quelque chose pour voir votre motif",
      loading_text: "RastÃ©risation...",
      unit_cm: "cm",
      unit_stitches: "points",
      unit_crosses: "croix",
      toggle_controls: "Afficher les contrÃ´les",
      no_fonts: "Aucune police disponible",
      no_matching: "Aucune police trouvÃ©e",
      server_error: "Ã‰chec du chargement des polices. Le serveur est-il lancÃ© ?",
      alert_no_text: "Tapez du texte et sÃ©lectionnez une police d'abord.",
      alert_no_pdf: "Moteur PDF non chargÃ©. Rechargez la page.",
      alert_no_jspdf: "BibliothÃ¨que jsPDF non chargÃ©e. VÃ©rifiez votre connexion et rechargez.",
      alert_pdf_fail: "Ã‰chec de la gÃ©nÃ©ration du PDF : "
    },
    de: {
      placeholder_text: "Gib deinen Text ein...",
      section_font: "Schriftart",
      search_fonts: "Schriftarten suchen...",
      tab_all: "Alle",
      section_height: "StichhÃ¶he",
      unit_px: "px",
      section_color: "Garnfarbe",
      section_fabric: "Stoff",
      label_aida: "Aida",
      empty_state: "Tippe etwas, um dein Muster zu sehen",
      loading_text: "Wird gerastert...",
      unit_cm: "cm",
      unit_stitches: "Stiche",
      unit_crosses: "Kreuze",
      toggle_controls: "Steuerung anzeigen",
      no_fonts: "Keine Schriftarten verfÃ¼gbar",
      no_matching: "Keine passenden Schriftarten",
      server_error: "Schriftarten konnten nicht geladen werden. LÃ¤uft der Server?",
      alert_no_text: "Gib einen Text ein und wÃ¤hle eine Schriftart.",
      alert_no_pdf: "PDF-Engine nicht geladen. Seite neu laden.",
      alert_no_jspdf: "jsPDF nicht geladen. PrÃ¼fe deine Internetverbindung und lade neu.",
      alert_pdf_fail: "PDF-Erzeugung fehlgeschlagen: "
    },
    it: {
      placeholder_text: "Scrivi il tuo testo qui...",
      section_font: "Font",
      search_fonts: "Cerca font...",
      tab_all: "Tutti",
      section_height: "Altezza Punto",
      unit_px: "px",
      section_color: "Colore Filo",
      section_fabric: "Tessuto",
      label_aida: "Aida",
      empty_state: "Scrivi qualcosa per vedere il tuo schema",
      loading_text: "Rasterizzazione...",
      unit_cm: "cm",
      unit_stitches: "punti",
      unit_crosses: "croci",
      toggle_controls: "Mostra controlli",
      no_fonts: "Nessun font disponibile",
      no_matching: "Nessun font trovato",
      server_error: "Caricamento font fallito. Il server Ã¨ attivo?",
      alert_no_text: "Scrivi un testo e seleziona un font prima.",
      alert_no_pdf: "Motore PDF non caricato. Ricarica la pagina.",
      alert_no_jspdf: "Libreria jsPDF non caricata. Controlla la connessione e ricarica.",
      alert_pdf_fail: "Generazione PDF fallita: "
    },
    pt: {
      placeholder_text: "Digite seu texto aqui...",
      section_font: "Fonte",
      search_fonts: "Buscar fontes...",
      tab_all: "Todas",
      section_height: "Altura do Ponto",
      unit_px: "px",
      section_color: "Cor da Linha",
      section_fabric: "Tecido",
      label_aida: "Aida",
      empty_state: "Digite algo para ver seu padrÃ£o",
      loading_text: "Rasterizando...",
      unit_cm: "cm",
      unit_stitches: "pontos",
      unit_crosses: "cruzes",
      toggle_controls: "Mostrar controles",
      no_fonts: "Nenhuma fonte disponÃ­vel",
      no_matching: "Nenhuma fonte encontrada",
      server_error: "Falha ao carregar fontes. O servidor estÃ¡ ativo?",
      alert_no_text: "Digite um texto e selecione uma fonte primeiro.",
      alert_no_pdf: "Motor PDF nÃ£o carregado. Recarregue a pÃ¡gina.",
      alert_no_jspdf: "Biblioteca jsPDF nÃ£o carregada. Verifique sua conexÃ£o e recarregue.",
      alert_pdf_fail: "Falha na geraÃ§Ã£o do PDF: "
    },
    nl: {
      placeholder_text: "Typ je tekst hier...",
      section_font: "Lettertype",
      search_fonts: "Lettertypen zoeken...",
      tab_all: "Alle",
      section_height: "Steekhoogte",
      unit_px: "px",
      section_color: "Draadkleur",
      section_fabric: "Stof",
      label_aida: "Aida",
      empty_state: "Typ iets om je patroon te zien",
      loading_text: "Rasteren...",
      unit_cm: "cm",
      unit_stitches: "steken",
      unit_crosses: "kruisjes",
      toggle_controls: "Bediening tonen",
      no_fonts: "Geen lettertypen beschikbaar",
      no_matching: "Geen overeenkomende lettertypen",
      server_error: "Lettertypen laden mislukt. Draait de server?",
      alert_no_text: "Typ tekst en selecteer een lettertype.",
      alert_no_pdf: "PDF-engine niet geladen. Herlaad de pagina.",
      alert_no_jspdf: "jsPDF-bibliotheek niet geladen. Controleer je verbinding en herlaad.",
      alert_pdf_fail: "PDF genereren mislukt: "
    },
    ja: {
      placeholder_text: "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›...",
      section_font: "ãƒ•ã‚©ãƒ³ãƒˆ",
      search_fonts: "ãƒ•ã‚©ãƒ³ãƒˆã‚’æ¤œç´¢...",
      tab_all: "ã™ã¹ã¦",
      section_height: "ã‚¹ãƒ†ãƒƒãƒé«˜ã•",
      unit_px: "px",
      section_color: "ç³¸ã®è‰²",
      section_fabric: "å¸ƒåœ°",
      label_aida: "ã‚¢ã‚¤ãƒ¼ãƒ€",
      empty_state: "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™",
      loading_text: "ãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚ºä¸­...",
      unit_cm: "cm",
      unit_stitches: "ã‚¹ãƒ†ãƒƒãƒ",
      unit_crosses: "ã‚¯ãƒ­ã‚¹",
      toggle_controls: "ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º",
      no_fonts: "ãƒ•ã‚©ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“",
      no_matching: "ä¸€è‡´ã™ã‚‹ãƒ•ã‚©ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“",
      server_error: "ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã¯èµ·å‹•ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
      alert_no_text: "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚",
      alert_no_pdf: "PDFã‚¨ãƒ³ã‚¸ãƒ³ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚",
      alert_no_jspdf: "jsPDFãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚",
      alert_pdf_fail: "PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: "
    },
    ko: {
      placeholder_text: "í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...",
      section_font: "ê¸€ê¼´",
      search_fonts: "ê¸€ê¼´ ê²€ìƒ‰...",
      tab_all: "ì „ì²´",
      section_height: "ìŠ¤í‹°ì¹˜ ë†’ì´",
      unit_px: "px",
      section_color: "ì‹¤ ìƒ‰ìƒ",
      section_fabric: "ì›ë‹¨",
      label_aida: "ì•„ì´ë‹¤",
      empty_state: "í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ë©´ íŒ¨í„´ì´ í‘œì‹œë©ë‹ˆë‹¤",
      loading_text: "ë˜ìŠ¤í„°ë¼ì´ì¦ˆ ì¤‘...",
      unit_cm: "cm",
      unit_stitches: "ìŠ¤í‹°ì¹˜",
      unit_crosses: "í¬ë¡œìŠ¤",
      toggle_controls: "ì»¨íŠ¸ë¡¤ í‘œì‹œ",
      no_fonts: "ì‚¬ìš© ê°€ëŠ¥í•œ ê¸€ê¼´ì´ ì—†ìŠµë‹ˆë‹¤",
      no_matching: "ì¼ì¹˜í•˜ëŠ” ê¸€ê¼´ì´ ì—†ìŠµë‹ˆë‹¤",
      server_error: "ê¸€ê¼´ ë¡œë“œ ì‹¤íŒ¨. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.",
      alert_no_text: "í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê³  ê¸€ê¼´ì„ ì„ íƒí•˜ì„¸ìš”.",
      alert_no_pdf: "PDF ì—”ì§„ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.",
      alert_no_jspdf: "jsPDFê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì—°ê²°ì„ í™•ì¸í•˜ê³  ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.",
      alert_pdf_fail: "PDF ìƒì„± ì‹¤íŒ¨: "
    },
    zh: {
      placeholder_text: "åœ¨æ­¤è¾“å…¥æ–‡å­—...",
      section_font: "å­—ä½“",
      search_fonts: "æœç´¢å­—ä½“...",
      tab_all: "å…¨éƒ¨",
      section_height: "é’ˆé«˜",
      unit_px: "px",
      section_color: "çº¿è‰²",
      section_fabric: "å¸ƒæ–™",
      label_aida: "Aida",
      empty_state: "è¾“å…¥æ–‡å­—ä»¥æŸ¥çœ‹å›¾æ¡ˆ",
      loading_text: "æ­£åœ¨æ …æ ¼åŒ–...",
      unit_cm: "å˜ç±³",
      unit_stitches: "é’ˆ",
      unit_crosses: "åå­—",
      toggle_controls: "æ˜¾ç¤ºæ§ä»¶",
      no_fonts: "æ²¡æœ‰å¯ç”¨å­—ä½“",
      no_matching: "æ²¡æœ‰åŒ¹é…çš„å­—ä½“",
      server_error: "å­—ä½“åŠ è½½å¤±è´¥ã€‚æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Ÿ",
      alert_no_text: "è¯·è¾“å…¥æ–‡å­—å¹¶é€‰æ‹©å­—ä½“ã€‚",
      alert_no_pdf: "PDFå¼•æ“æœªåŠ è½½ã€‚è¯·åˆ·æ–°é¡µé¢ã€‚",
      alert_no_jspdf: "jsPDFåº“æœªåŠ è½½ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶åˆ·æ–°ã€‚",
      alert_pdf_fail: "PDFç”Ÿæˆå¤±è´¥: "
    },
    ru: {
      placeholder_text: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚...",
      section_font: "Ğ¨Ñ€Ğ¸Ñ„Ñ‚",
      search_fonts: "ĞŸĞ¾Ğ¸ÑĞº ÑˆÑ€Ğ¸Ñ„Ñ‚Ğ¾Ğ²...",
      tab_all: "Ğ’ÑĞµ",
      section_height: "Ğ’Ñ‹ÑĞ¾Ñ‚Ğ° ÑÑ‚ĞµĞ¶ĞºĞ°",
      unit_px: "px",
      section_color: "Ğ¦Ğ²ĞµÑ‚ Ğ½Ğ¸Ñ‚Ğ¸",
      section_fabric: "Ğ¢ĞºĞ°Ğ½ÑŒ",
      label_aida: "ĞĞ¸Ğ´Ğ°",
      empty_state: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ ÑƒĞ·Ğ¾Ñ€",
      loading_text: "Ğ Ğ°ÑÑ‚ĞµÑ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ...",
      unit_cm: "ÑĞ¼",
      unit_stitches: "ÑÑ‚ĞµĞ¶ĞºĞ¾Ğ²",
      unit_crosses: "ĞºÑ€ĞµÑÑ‚Ğ¾Ğ²",
      toggle_controls: "ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ",
      no_fonts: "ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… ÑˆÑ€Ğ¸Ñ„Ñ‚Ğ¾Ğ²",
      no_matching: "Ğ¨Ñ€Ğ¸Ñ„Ñ‚Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹",
      server_error: "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑˆÑ€Ğ¸Ñ„Ñ‚Ñ‹. Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½?",
      alert_no_text: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ğ¸ Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑˆÑ€Ğ¸Ñ„Ñ‚.",
      alert_no_pdf: "PDF-Ğ´Ğ²Ğ¸Ğ¶Ğ¾Ğº Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ.",
      alert_no_jspdf: "Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° jsPDF Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ°. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ.",
      alert_pdf_fail: "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ PDF: "
    },
    pl: {
      placeholder_text: "Wpisz swÃ³j tekst...",
      section_font: "Czcionka",
      search_fonts: "Szukaj czcionek...",
      tab_all: "Wszystkie",
      section_height: "WysokoÅ›Ä‡ Åšciegu",
      unit_px: "px",
      section_color: "Kolor Nici",
      section_fabric: "Tkanina",
      label_aida: "Aida",
      empty_state: "Wpisz coÅ›, aby zobaczyÄ‡ wzÃ³r",
      loading_text: "Rasteryzacja...",
      unit_cm: "cm",
      unit_stitches: "Å›ciegÃ³w",
      unit_crosses: "krzyÅ¼ykÃ³w",
      toggle_controls: "PokaÅ¼ panel",
      no_fonts: "Brak dostÄ™pnych czcionek",
      no_matching: "Nie znaleziono czcionek",
      server_error: "Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ czcionek. Czy serwer dziaÅ‚a?",
      alert_no_text: "Wpisz tekst i wybierz czcionkÄ™.",
      alert_no_pdf: "Silnik PDF nie zaÅ‚adowany. OdÅ›wieÅ¼ stronÄ™.",
      alert_no_jspdf: "Biblioteka jsPDF nie zaÅ‚adowana. SprawdÅº poÅ‚Ä…czenie i odÅ›wieÅ¼.",
      alert_pdf_fail: "BÅ‚Ä…d generowania PDF: "
    },
    sv: {
      placeholder_text: "Skriv din text hÃ¤r...",
      section_font: "Typsnitt",
      search_fonts: "SÃ¶k typsnitt...",
      tab_all: "Alla",
      section_height: "Stygnh\u00f6jd",
      unit_px: "px",
      section_color: "TrÃ¥dfÃ¤rg",
      section_fabric: "Tyg",
      label_aida: "Aida",
      empty_state: "Skriv nÃ¥got fÃ¶r att se ditt mÃ¶nster",
      loading_text: "Rastrerar...",
      unit_cm: "cm",
      unit_stitches: "stygn",
      unit_crosses: "kors",
      toggle_controls: "Visa kontroller",
      no_fonts: "Inga typsnitt tillgÃ¤ngliga",
      no_matching: "Inga matchande typsnitt",
      server_error: "Kunde inte ladda typsnitt. KÃ¶rs servern?",
      alert_no_text: "Skriv text och vÃ¤lj ett typsnitt fÃ¶rst.",
      alert_no_pdf: "PDF-motor inte laddad. Ladda om sidan.",
      alert_no_jspdf: "jsPDF inte laddat. Kontrollera din anslutning och ladda om.",
      alert_pdf_fail: "PDF-generering misslyckades: "
    },
    da: {
      placeholder_text: "Skriv din tekst her...",
      section_font: "Skrifttype",
      search_fonts: "SÃ¸g skrifttyper...",
      tab_all: "Alle",
      section_height: "StinghÃ¸jde",
      unit_px: "px",
      section_color: "TrÃ¥dfarve",
      section_fabric: "Stof",
      label_aida: "Aida",
      empty_state: "Skriv noget for at se dit mÃ¸nster",
      loading_text: "Rastrerer...",
      unit_cm: "cm",
      unit_stitches: "sting",
      unit_crosses: "kors",
      toggle_controls: "Vis kontroller",
      no_fonts: "Ingen skrifttyper tilgÃ¦ngelige",
      no_matching: "Ingen matchende skrifttyper",
      server_error: "Kunne ikke indlÃ¦se skrifttyper. KÃ¸rer serveren?",
      alert_no_text: "Skriv tekst og vÃ¦lg en skrifttype fÃ¸rst.",
      alert_no_pdf: "PDF-motor ikke indlÃ¦st. GenindlÃ¦s siden.",
      alert_no_jspdf: "jsPDF ikke indlÃ¦st. KontrollÃ©r din forbindelse og genindlÃ¦s.",
      alert_pdf_fail: "PDF-generering mislykkedes: "
    },
    fi: {
      placeholder_text: "Kirjoita tekstisi tÃ¤hÃ¤n...",
      section_font: "Fontti",
      search_fonts: "Etsi fontteja...",
      tab_all: "Kaikki",
      section_height: "Pistonkorkeus",
      unit_px: "px",
      section_color: "Langan VÃ¤ri",
      section_fabric: "Kangas",
      label_aida: "Aida",
      empty_state: "Kirjoita jotain nÃ¤hdÃ¤ksesi kuviosi",
      loading_text: "Rasteroidaan...",
      unit_cm: "cm",
      unit_stitches: "pistoa",
      unit_crosses: "ristiÃ¤",
      toggle_controls: "NÃ¤ytÃ¤ ohjaimet",
      no_fonts: "Ei fontteja saatavilla",
      no_matching: "Ei vastaavia fontteja",
      server_error: "Fonttien lataus epÃ¤onnistui. Onko palvelin kÃ¤ynnissÃ¤?",
      alert_no_text: "Kirjoita teksti ja valitse fontti ensin.",
      alert_no_pdf: "PDF-moottori ei latautunut. Lataa sivu uudelleen.",
      alert_no_jspdf: "jsPDF ei latautunut. Tarkista yhteys ja lataa uudelleen.",
      alert_pdf_fail: "PDF:n luonti epÃ¤onnistui: "
    },
    uk: {
      placeholder_text: "Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ñ‚ĞµĞºÑÑ‚...",
      section_font: "Ğ¨Ñ€Ğ¸Ñ„Ñ‚",
      search_fonts: "ĞŸĞ¾ÑˆÑƒĞº ÑˆÑ€Ğ¸Ñ„Ñ‚Ñ–Ğ²...",
      tab_all: "Ğ£ÑÑ–",
      section_height: "Ğ’Ğ¸ÑĞ¾Ñ‚Ğ° ÑÑ‚Ñ–Ğ±ĞºĞ°",
      unit_px: "px",
      section_color: "ĞšĞ¾Ğ»Ñ–Ñ€ Ğ½Ğ¸Ñ‚ĞºĞ¸",
      section_fabric: "Ğ¢ĞºĞ°Ğ½Ğ¸Ğ½Ğ°",
      label_aida: "ĞÑ—Ğ´Ğ°",
      empty_state: "Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ñ‚ĞµĞºÑÑ‚, Ñ‰Ğ¾Ğ± Ğ¿Ğ¾Ğ±Ğ°Ñ‡Ğ¸Ñ‚Ğ¸ Ğ²Ñ–Ğ·ĞµÑ€ÑƒĞ½Ğ¾Ğº",
      loading_text: "Ğ Ğ°ÑÑ‚ĞµÑ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ...",
      unit_cm: "ÑĞ¼",
      unit_stitches: "ÑÑ‚Ñ–Ğ±ĞºÑ–Ğ²",
      unit_crosses: "Ñ…Ñ€ĞµÑÑ‚Ğ¸ĞºÑ–Ğ²",
      toggle_controls: "ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚Ğ¸ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ",
      no_fonts: "ĞĞµĞ¼Ğ°Ñ” Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ñ… ÑˆÑ€Ğ¸Ñ„Ñ‚Ñ–Ğ²",
      no_matching: "Ğ¨Ñ€Ğ¸Ñ„Ñ‚Ğ¸ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾",
      server_error: "ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ ÑˆÑ€Ğ¸Ñ„Ñ‚Ğ¸. Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾?",
      alert_no_text: "Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ñ‚ĞµĞºÑÑ‚ Ñ– Ğ²Ğ¸Ğ±ĞµÑ€Ñ–Ñ‚ÑŒ ÑˆÑ€Ğ¸Ñ„Ñ‚.",
      alert_no_pdf: "PDF-Ñ€ÑƒÑˆÑ–Ğ¹ Ğ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ¾. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ñ‚Ğµ ÑÑ‚Ğ¾Ñ€Ñ–Ğ½ĞºÑƒ.",
      alert_no_jspdf: "Ğ‘Ñ–Ğ±Ğ»Ñ–Ğ¾Ñ‚ĞµĞºÑƒ jsPDF Ğ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ¾. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ Ğ·'Ñ”Ğ´Ğ½Ğ°Ğ½Ğ½Ñ Ñ– Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ñ‚Ğµ.",
      alert_pdf_fail: "ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ— PDF: "
    },
    hu: {
      placeholder_text: "Ãrd be a szÃ¶veged...",
      section_font: "BetÅ±tÃ­pus",
      search_fonts: "BetÅ±tÃ­pusok keresÃ©se...",
      tab_all: "Ã–sszes",
      section_height: "Ã–ltÃ©smagassÃ¡g",
      unit_px: "px",
      section_color: "FonalszÃ­n",
      section_fabric: "SzÃ¶vet",
      label_aida: "Aida",
      empty_state: "Ãrj valamit a minta megtekintÃ©sÃ©hez",
      loading_text: "RaszterizÃ¡lÃ¡s...",
      unit_cm: "cm",
      unit_stitches: "Ã¶ltÃ©s",
      unit_crosses: "kereszt",
      toggle_controls: "VezÃ©rlÅ‘k mutatÃ¡sa",
      no_fonts: "Nincs elÃ©rhetÅ‘ betÅ±tÃ­pus",
      no_matching: "Nincs egyezÅ‘ betÅ±tÃ­pus",
      server_error: "BetÅ±tÃ­pusok betÃ¶ltÃ©se sikertelen. Fut a szerver?",
      alert_no_text: "Ãrj szÃ¶veget Ã©s vÃ¡lassz betÅ±tÃ­pust.",
      alert_no_pdf: "PDF-motor nincs betÃ¶ltve. TÃ¶ltsd Ãºjra az oldalt.",
      alert_no_jspdf: "jsPDF nincs betÃ¶ltve. EllenÅ‘rizd a kapcsolatot Ã©s tÃ¶ltsd Ãºjra.",
      alert_pdf_fail: "PDF lÃ©trehozÃ¡s sikertelen: "
    }
  };

  var currentLang = 'en';

  function t(key) {
    var lang = I18N[currentLang] || I18N.en;
    return lang[key] || I18N.en[key] || key;
  }

  function applyLang() {
    document.querySelectorAll('[data-i18n]').forEach(function(el) {
      el.textContent = t(el.dataset.i18n);
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
      el.placeholder = t(el.dataset.i18nPlaceholder);
    });
    document.querySelectorAll('[data-i18n-aria]').forEach(function(el) {
      el.setAttribute('aria-label', t(el.dataset.i18nAria));
    });
    document.title = 'Word2Stitch â€” ' + t('empty_state').split(' ').slice(0, 4).join(' ');
  }

  function setLanguage(lang) {
    if (!I18N[lang]) lang = 'en';
    currentLang = lang;
    try { localStorage.setItem('w2s_lang', lang); } catch(e) {}
    var sel = document.getElementById('langSelect');
    if (sel) sel.value = lang;
    applyLang();
    if (typeof renderFontListUI === 'function') renderFontListUI();
  }

  // -- State --
  var currentText = 'Welcome';
  var currentFontFile = 'GeorgiaPro-Black.ttf';
  var currentFontName = 'GeorgiaPro-Black';
  var currentHeight = 18;
  var currentColorIndex = 0;
  var currentAida = 14;
  var currentCategoryFilter = 'all';

  var categoryLabels = {
    'serif': 'Serif', 'sans-serif': 'Sans', 'script': 'Script',
    'decorative': 'Decorative', 'monospace': 'Mono', 'other': 'Other'
  };

  // Font list from API: [{file, name, size, category}, ...]
  var fontListData = [];

  // Client-side cache: Map<string, fontJSON>
  // Key format: "filename.ttf_height"
  var fontCache = new Map();

  // Currently loaded font data (from cache or API)
  var currentFontData = null;

  // -- DOM refs --
  var textInput = document.getElementById('textInput');
  var fontList = document.getElementById('fontList');
  var fontSearch = document.getElementById('fontSearch');
  var heightSlider = document.getElementById('heightSlider');
  var heightValue = document.getElementById('heightValue');
  var colorRow = document.getElementById('colorRow');
  var aidaRow = document.getElementById('aidaRow');
  var btnDownload = document.getElementById('btnDownload');
  var previewEmpty = document.getElementById('previewEmpty');
  var previewWrap = document.getElementById('previewWrap');
  var previewLoading = document.getElementById('previewLoading');
  var mainCanvas = document.getElementById('mainCanvas');
  var previewArea = document.getElementById('previewArea');

  // -- Helpers --

  function getCacheKey(fontFile, height) {
    return fontFile + '_' + height;
  }

  function getCurrentColor() {
    if (typeof DMC_COLORS === 'undefined' || !DMC_COLORS.length) return { hex: '#b83a2a', code: '321', name: 'Red' };
    return DMC_COLORS[currentColorIndex] || DMC_COLORS[0];
  }

  function showLoading() {
    previewLoading.classList.remove('hidden');
  }

  function hideLoading() {
    previewLoading.classList.add('hidden');
  }

  // -- Bitmap --

  function getEffectiveBitmap(glyph) {
    if (!glyph || !glyph.bitmap || !glyph.bitmap.length) return [];
    var bitmap = glyph.bitmap;
    var lastFilledRow = -1;
    for (var r = bitmap.length - 1; r >= 0; r--) {
      if (bitmap[r].indexOf('1') !== -1) { lastFilledRow = r; break; }
    }
    if (lastFilledRow === -1) return bitmap.slice();
    return bitmap.slice(0, lastFilledRow + 1);
  }

  function getTextBitmap(text, fontData) {
    if (!text || !fontData || !fontData.glyphs) return { bitmap: [], width: 0, height: 0 };

    var height = fontData.height || 9;
    var letterSpacing = (fontData.letterSpacing != null) ? fontData.letterSpacing : 1;
    var spaceWidth = fontData.spaceWidth || 3;
    var columns = [];

    for (var ci = 0; ci < text.length; ci++) {
      var ch = text[ci];
      if (ci > 0 && letterSpacing > 0) {
        for (var s = 0; s < letterSpacing; s++) columns.push(new Array(height).fill(false));
      }
      if (ch === ' ') {
        for (var s2 = 0; s2 < spaceWidth; s2++) columns.push(new Array(height).fill(false));
        continue;
      }
      var glyph = fontData.glyphs[ch];
      if (!glyph || !glyph.bitmap || !glyph.bitmap.length) {
        for (var s3 = 0; s3 < spaceWidth; s3++) columns.push(new Array(height).fill(false));
        continue;
      }
      var bmp = glyph.bitmap;
      var glyphWidth = glyph.width || (bmp[0] ? bmp[0].length : 0);
      for (var x = 0; x < glyphWidth; x++) {
        var col = [];
        for (var y = 0; y < height; y++) {
          col.push(y < bmp.length && x < bmp[y].length && bmp[y][x] === '1');
        }
        columns.push(col);
      }
    }

    if (!columns.length) return { bitmap: [], width: 0, height: 0 };

    var width = columns.length;
    var bitmap = [];
    for (var y2 = 0; y2 < height; y2++) {
      var row = [];
      for (var x2 = 0; x2 < width; x2++) row.push(columns[x2][y2]);
      bitmap.push(row);
    }
    return { bitmap: bitmap, width: width, height: height };
  }

  // -- Render --

  function renderPreview(canvas, text, fontData, colorHex, options) {
    var ctx = canvas.getContext('2d');
    if (!text || !fontData) {
      canvas.width = 1; canvas.height = 1;
      ctx.clearRect(0, 0, 1, 1);
      return { width: 0, height: 0, stitches: 0 };
    }

    var result = getTextBitmap(text, fontData);
    var bitmap = result.bitmap;
    var width = result.width;
    var height = result.height;
    if (!bitmap.length || !width) {
      canvas.width = 1; canvas.height = 1;
      ctx.clearRect(0, 0, 1, 1);
      return { width: 0, height: 0, stitches: 0 };
    }

    var opts = options || {};
    var maxCanvasWidth = opts.maxWidth || 850;
    var cellSize = opts.cellSize || 12;
    if (width * cellSize > maxCanvasWidth) {
      cellSize = Math.max(2, Math.floor(maxCanvasWidth / width));
    }

    var canvasW = width * cellSize + 1;
    var canvasH = height * cellSize + 1;
    canvas.width = canvasW;
    canvas.height = canvasH;

    // Background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvasW, canvasH);

    var stitchCount = 0;

    // Filled cells
    ctx.fillStyle = colorHex;
    for (var y = 0; y < height; y++) {
      for (var x = 0; x < width; x++) {
        if (bitmap[y][x]) {
          ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
          stitchCount++;
        }
      }
    }

    // Grid lines
    ctx.strokeStyle = '#e0d8d0';
    ctx.lineWidth = 0.5;
    for (var gx = 0; gx <= width; gx++) {
      var px = gx * cellSize + 0.5;
      ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, canvasH); ctx.stroke();
    }
    for (var gy = 0; gy <= height; gy++) {
      var py = gy * cellSize + 0.5;
      ctx.beginPath(); ctx.moveTo(0, py); ctx.lineTo(canvasW, py); ctx.stroke();
    }

    // Bold every 10
    if (cellSize >= 4) {
      ctx.strokeStyle = '#a09888';
      ctx.lineWidth = 1.5;
      for (var bx = 0; bx <= width; bx += 10) {
        var bpx = bx * cellSize + 0.5;
        ctx.beginPath(); ctx.moveTo(bpx, 0); ctx.lineTo(bpx, canvasH); ctx.stroke();
      }
      for (var by = 0; by <= height; by += 10) {
        var bpy = by * cellSize + 0.5;
        ctx.beginPath(); ctx.moveTo(0, bpy); ctx.lineTo(canvasW, bpy); ctx.stroke();
      }
    }

    return { width: width, height: height, stitches: stitchCount };
  }

  // -- API calls --

  function fetchFontList() {
    return fetch('/api/fonts')
      .then(function (res) {
        if (!res.ok) throw new Error('Failed to load font list');
        return res.json();
      })
      .then(function (data) {
        fontListData = data;
        renderFontListUI();
        // Auto-rasterize default font on load
        if (currentFontFile && currentText) {
          loadAndRender();
        }
      })
      .catch(function (err) {
        fontList.innerHTML = '<div style="padding:20px;color:var(--text-muted);font-size:12px;text-align:center;">' + t('server_error') + '</div>';
        console.error('fetchFontList:', err);
      });
  }

  function rasterizeFont(fontFile, height) {
    var key = getCacheKey(fontFile, height);

    // Return cached data if available
    if (fontCache.has(key)) {
      return Promise.resolve(fontCache.get(key));
    }

    showLoading();

    return fetch('/api/rasterize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        font: fontFile,
        height: height,
        bold: 0,
        strategy: 'average'
      })
    })
    .then(function (res) {
      if (!res.ok) throw new Error('Rasterization failed');
      return res.json();
    })
    .then(function (data) {
      fontCache.set(key, data);
      hideLoading();
      return data;
    })
    .catch(function (err) {
      hideLoading();
      console.error('rasterizeFont:', err);
      return null;
    });
  }

  // -- Update Preview (main function) --

  function updatePreview() {
    var color = getCurrentColor();

    if (!currentText.trim() || !currentFontData) {
      previewEmpty.style.display = 'flex';
      previewWrap.style.display = 'none';
      return;
    }

    previewEmpty.style.display = 'none';
    previewWrap.style.display = 'flex';

    // Calculate available space
    var areaRect = previewArea.getBoundingClientRect();
    var maxW = areaRect.width - 40;

    var result = renderPreview(mainCanvas, currentText, currentFontData, color.hex, {
      cellSize: 16,
      maxWidth: maxW
    });

    if (result.width === 0) {
      previewEmpty.style.display = 'flex';
      previewWrap.style.display = 'none';
      return;
    }

    // Calculate physical size
    var widthCm = (result.width / currentAida * 2.54).toFixed(1);
    var heightCm = (result.height / currentAida * 2.54).toFixed(1);

    // Update stats
    document.getElementById('statSizeCm').textContent = widthCm + ' \u00d7 ' + heightCm;
    document.getElementById('statStitchesW').textContent = result.width;
    document.getElementById('statStitchesH').textContent = result.height;
    document.getElementById('statTotal').textContent = result.stitches;
    document.getElementById('statDmc').textContent = color.code;

    // Thread estimate
    var metersPerStitch = 0.013 * (14 / currentAida);
    var totalMeters = (result.stitches * metersPerStitch).toFixed(1);
    document.getElementById('statThread').textContent = totalMeters + 'm';

    // Ruler: match canvas rendered width
    document.getElementById('rulerWidth').textContent = widthCm + ' cm';
    requestAnimationFrame(function () {
      var canvasRendered = mainCanvas.getBoundingClientRect().width;
      var rulerLine = document.querySelector('.ruler-line');
      if (rulerLine && canvasRendered > 0) {
        rulerLine.style.width = canvasRendered + 'px';
      }
    });
  }

  // -- Trigger rasterization and update --

  function loadAndRender() {
    if (!currentFontFile) {
      currentFontData = null;
      updatePreview();
      return;
    }

    rasterizeFont(currentFontFile, currentHeight).then(function (data) {
      if (data) {
        currentFontData = data;
      }
      updatePreview();
    });
  }

  // -- Text Input --

  textInput.addEventListener('input', function () {
    currentText = this.value;
    updatePreview();
  });

  // -- Font List UI --

  function renderFontListUI() {
    var filter = (fontSearch.value || '').toLowerCase().trim();

    // Compute category counts from filtered fonts
    var categoryCounts = {};
    fontListData.forEach(function (font) {
      var name = font.name || font.file;
      if (filter && name.toLowerCase().indexOf(filter) === -1) return;
      var cat = font.category || 'other';
      categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
    });

    var categories = Object.keys(categoryCounts).sort();
    var totalFiltered = 0;
    categories.forEach(function (c) { totalFiltered += categoryCounts[c]; });

    // Populate category tabs
    var tabsEl = document.getElementById('fontCategoryTabs');
    tabsEl.innerHTML = '';
    var allBtn = document.createElement('button');
    allBtn.className = 'font-tab' + (currentCategoryFilter === 'all' ? ' active' : '');
    allBtn.dataset.category = 'all';
    allBtn.textContent = t('tab_all') + ' (' + totalFiltered + ')';
    tabsEl.appendChild(allBtn);

    categories.forEach(function (cat) {
      var btn = document.createElement('button');
      btn.className = 'font-tab' + (currentCategoryFilter === cat ? ' active' : '');
      btn.dataset.category = cat;
      btn.textContent = (categoryLabels[cat] || cat) + ' (' + categoryCounts[cat] + ')';
      tabsEl.appendChild(btn);
    });

    // Reset if current category has no fonts
    if (currentCategoryFilter !== 'all' && !categoryCounts[currentCategoryFilter]) {
      currentCategoryFilter = 'all';
      tabsEl.querySelector('[data-category="all"]').classList.add('active');
    }

    // Render font list
    fontList.innerHTML = '';

    if (!fontListData.length) {
      fontList.innerHTML = '<div style="padding:20px;color:var(--text-muted);font-size:12px;text-align:center;">' + t('no_fonts') + '</div>';
      return;
    }

    var displayed = 0;

    fontListData.forEach(function (font) {
      var name = font.name || font.file;
      if (filter && name.toLowerCase().indexOf(filter) === -1) return;
      if (currentCategoryFilter !== 'all' && (font.category || 'other') !== currentCategoryFilter) return;

      displayed++;

      var item = document.createElement('div');
      item.className = 'font-item' + (font.file === currentFontFile ? ' selected' : '');
      item.dataset.fontFile = font.file;

      var info = document.createElement('div');
      info.className = 'font-item-info';

      var nameEl = document.createElement('div');
      nameEl.className = 'font-item-name';
      nameEl.textContent = name;

      var meta = document.createElement('div');
      meta.className = 'font-item-meta';
      var sizeKb = font.size ? (font.size / 1024).toFixed(0) + ' KB' : '';
      meta.textContent = (categoryLabels[font.category] || font.category || '') + (sizeKb ? ' \u00b7 ' + sizeKb : '');

      info.appendChild(nameEl);
      info.appendChild(meta);
      item.appendChild(info);
      fontList.appendChild(item);

      item.addEventListener('click', function () {
        currentFontFile = font.file;
        currentFontName = name;
        fontList.querySelectorAll('.font-item').forEach(function (el) {
          el.classList.toggle('selected', el.dataset.fontFile === font.file);
        });
        loadAndRender();
      });
    });

    if (!displayed) {
      fontList.innerHTML = '<div style="padding:20px;color:var(--text-muted);font-size:12px;text-align:center;">' + t('no_matching') + '</div>';
    }
  }

  // Font search filtering
  fontSearch.addEventListener('input', function () {
    renderFontListUI();
  });

  // Category tab filtering (delegated)
  document.getElementById('fontCategoryTabs').addEventListener('click', function (e) {
    var tab = e.target.closest('.font-tab');
    if (!tab) return;
    currentCategoryFilter = tab.dataset.category;
    this.querySelectorAll('.font-tab').forEach(function (t) { t.classList.remove('active'); });
    tab.classList.add('active');
    renderFontListUI();
  });

  // -- Height Slider --

  var heightDebounceTimer = null;

  heightSlider.addEventListener('input', function () {
    var val = parseInt(this.value);
    heightValue.textContent = val;

    clearTimeout(heightDebounceTimer);
    heightDebounceTimer = setTimeout(function () {
      currentHeight = val;
      loadAndRender();
    }, 300);
  });

  // -- Color Swatches --

  function renderColors() {
    if (typeof DMC_COLORS === 'undefined' || !DMC_COLORS.length) return;
    colorRow.innerHTML = '';

    DMC_COLORS.forEach(function (color, index) {
      var dot = document.createElement('div');
      dot.className = 'color-dot' + (index === currentColorIndex ? ' selected' : '');
      dot.style.backgroundColor = color.hex;
      dot.dataset.index = index;

      var tip = document.createElement('div');
      tip.className = 'tip';
      tip.textContent = 'DMC ' + color.code + ' \u2014 ' + color.name;
      dot.appendChild(tip);

      dot.addEventListener('click', function () {
        currentColorIndex = index;
        colorRow.querySelectorAll('.color-dot').forEach(function (d) {
          d.classList.toggle('selected', parseInt(d.dataset.index) === index);
        });
        updatePreview();
      });

      colorRow.appendChild(dot);
    });
  }

  // -- Aida Count --

  document.getElementById('langSelect').addEventListener('change', function() {
    setLanguage(this.value);
  });

  var customCountRow = document.getElementById('customCountRow');
  var customCountInput = document.getElementById('customCountInput');
  var customUnitToggle = document.getElementById('customUnitToggle');
  var customCountLabel = document.getElementById('customCountLabel');
  var customUnit = 'inch'; // 'inch' or 'cm'
  var isCustomAida = false;

  function updateCustomLabel() {
    var val = parseFloat(customCountInput.value) || 14;
    var aidaEquiv;
    if (customUnit === 'cm') {
      aidaEquiv = val * 2.54; // convert stitches/cm to stitches/inch
    } else {
      aidaEquiv = val;
    }
    customCountLabel.textContent = '= ' + aidaEquiv.toFixed(1) + ' ct';
    currentAida = aidaEquiv;
    updatePreview();
  }

  aidaRow.addEventListener('click', function (e) {
    var chip = e.target.closest('.aida-chip');
    if (!chip) return;
    var countVal = chip.dataset.count;

    // Deselect all chips
    aidaRow.querySelectorAll('.aida-chip').forEach(function (c) {
      c.classList.remove('selected');
    });
    chip.classList.add('selected');

    if (countVal === 'custom') {
      isCustomAida = true;
      customCountRow.classList.add('visible');
      updateCustomLabel();
    } else {
      isCustomAida = false;
      customCountRow.classList.remove('visible');
      currentAida = parseInt(countVal);
      updatePreview();
    }
  });

  // Custom count input
  customCountInput.addEventListener('input', function () {
    if (isCustomAida) updateCustomLabel();
  });

  // Unit toggle (inch / cm)
  customUnitToggle.addEventListener('click', function (e) {
    var btn = e.target.closest('.custom-unit-btn');
    if (!btn) return;
    customUnit = btn.dataset.unit;
    customUnitToggle.querySelectorAll('.custom-unit-btn').forEach(function (b) {
      b.classList.toggle('active', b.dataset.unit === customUnit);
    });
    if (isCustomAida) updateCustomLabel();
  });

  // -- Download PDF --

  btnDownload.addEventListener('click', function () {
    var color = getCurrentColor();
    if (!currentFontData || !currentText.trim()) {
      alert(t('alert_no_text'));
      return;
    }
    if (typeof generatePDF !== 'function') {
      alert(t('alert_no_pdf'));
      return;
    }
    if (!window.jspdf) {
      alert(t('alert_no_jspdf'));
      return;
    }
    try {
      generatePDF(currentText, currentFontData, color, currentAida);
    } catch (err) {
      alert(t('alert_pdf_fail') + err.message);
      console.error('PDF error:', err);
    }
  });

  // -- Mobile sidebar drawer --

  var sidebarToggle = document.getElementById('sidebarToggle');
  var sidebar = document.querySelector('.sidebar');
  var drawerBackdrop = document.getElementById('drawerBackdrop');

  function openDrawer() {
    sidebar.classList.add('open');
    sidebarToggle.classList.add('active');
    drawerBackdrop.classList.add('visible');
  }

  function closeDrawer() {
    sidebar.classList.remove('open');
    sidebarToggle.classList.remove('active');
    drawerBackdrop.classList.remove('visible');
  }

  sidebarToggle.addEventListener('click', function () {
    if (sidebar.classList.contains('open')) {
      closeDrawer();
    } else {
      openDrawer();
    }
  });

  drawerBackdrop.addEventListener('click', closeDrawer);

  // Close drawer when a font is selected on mobile
  var origFontClick = fontList.addEventListener;
  fontList.addEventListener('click', function (e) {
    var item = e.target.closest('.font-item');
    if (item && window.innerWidth <= 640) {
      setTimeout(closeDrawer, 200);
    }
  });

  // -- Resize handling --

  var resizeTimer;
  window.addEventListener('resize', function () {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(updatePreview, 150);
  });

  // -- Initialize --

  function init() {
    // Detect language
    var savedLang = null;
    try { savedLang = localStorage.getItem('w2s_lang'); } catch(e) {}
    var browserLang = (navigator.language || '').split('-')[0];
    setLanguage(savedLang || (I18N[browserLang] ? browserLang : 'en'));

    renderColors();
    fetchFontList();
    updatePreview();
  }

  // Expose for pdf-engine
  window.getTextBitmap = getTextBitmap;
  window.getEffectiveBitmap = getEffectiveBitmap;
  window.renderPreview = renderPreview;

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Wait for DMC_COLORS if loaded late
  var _colorsInterval = setInterval(function () {
    if (typeof DMC_COLORS !== 'undefined') {
      clearInterval(_colorsInterval);
      renderColors();
    }
  }, 200);
  setTimeout(function () { clearInterval(_colorsInterval); }, 10000);

})();
</script>

</body>
</html>
