<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Word2Stitch â€” Cross-Stitch Pattern Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Anybody:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* -- Reset -- */
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #f5f0ea;
    --bg-deep: #ece5db;
    --panel: #faf8f5;
    --border: #e0d6c8;
    --border-light: #eae3d9;
    --text: #3d3229;
    --text-mid: #7a6e60;
    --text-muted: #a99e8f;
    --accent: #b83a2a;
    --accent-hover: #9c3023;
    --accent-soft: rgba(184, 58, 42, 0.08);
    --accent-glow: rgba(184, 58, 42, 0.15);
    --stitch-grid: #d8d0c5;
    --stitch-bold: #a09585;
    --radius: 10px;
    --radius-sm: 6px;
    --font-display: 'DM Serif Display', Georgia, serif;
    --font-body: 'Anybody', system-ui, sans-serif;
  }

  html, body { height: 100%; overflow: hidden; }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
    line-height: 1.4;
    -webkit-font-smoothing: antialiased;
  }

  /* -- Linen noise texture -- */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    pointer-events: none;
    opacity: 0.3;
    background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 20h40M20 0v40' stroke='%23c8bfb0' stroke-width='0.3'/%3E%3C/svg%3E");
    background-size: 40px 40px;
    z-index: 0;
  }

  /* -- Top Bar -- */
  .topbar {
    position: relative;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 10px 20px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }

  .logo {
    display: flex;
    align-items: baseline;
    gap: 0;
    flex-shrink: 0;
    user-select: none;
  }
  .logo-x {
    font-size: 18px;
    color: var(--accent);
    font-weight: 700;
    line-height: 1;
    margin-right: 3px;
  }
  .logo-text {
    font-family: var(--font-display);
    font-size: 20px;
    color: var(--text);
    letter-spacing: -0.3px;
  }
  .logo-text em {
    color: var(--accent);
    font-style: italic;
  }

  .topbar-sep {
    width: 1px;
    height: 24px;
    background: var(--border);
    flex-shrink: 0;
  }

  /* -- Text Input (in topbar) -- */
  .text-input-area {
    flex: 1;
    min-width: 0;
    position: relative;
  }
  .text-input {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 8px 14px;
    font-family: var(--font-display);
    font-size: 22px;
    color: var(--text);
    background: #fff;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .text-input::placeholder {
    color: var(--text-muted);
    font-style: italic;
  }
  .text-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  /* Download button in topbar */
  .btn-download {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 9px 18px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    font-family: var(--font-body);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    white-space: nowrap;
  }
  .btn-download:hover {
    background: var(--accent-hover);
    box-shadow: 0 3px 12px rgba(184,58,42,0.25);
    transform: translateY(-1px);
  }
  .btn-download:active { transform: translateY(0); }
  .btn-download:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .btn-download svg { width: 15px; height: 15px; }

  /* -- Main Layout -- */
  .main-layout {
    position: relative;
    z-index: 1;
    display: flex;
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  /* -- Left Sidebar -- */
  .sidebar {
    width: 280px;
    flex-shrink: 0;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-section {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border-light);
  }
  .sidebar-section:last-child { border-bottom: none; }

  .section-header {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .section-header svg {
    width: 12px;
    height: 12px;
    opacity: 0.5;
  }

  /* -- Font search input -- */
  .font-search {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 6px 10px;
    font-family: var(--font-body);
    font-size: 12px;
    color: var(--text);
    background: #fff;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .font-search::placeholder {
    color: var(--text-muted);
  }
  .font-search:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  /* -- Font Category Tabs -- */
  .font-tabs {
    display: flex;
    gap: 3px;
    overflow-x: auto;
    flex-wrap: nowrap;
    padding: 8px 0 4px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
    touch-action: pan-x;
  }
  .font-tabs::-webkit-scrollbar { height: 3px; }
  .font-tabs::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  .font-tab {
    flex-shrink: 0;
    padding: 3px 7px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: transparent;
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 10px;
    font-weight: 600;
    color: var(--text-mid);
    transition: background 0.12s, border-color 0.12s, color 0.12s;
    white-space: nowrap;
    line-height: 1.3;
    min-height: 44px;
  }
  .font-tab:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .font-tab.active {
    border-color: var(--accent);
    background: var(--accent-soft);
    color: var(--accent);
  }
  .font-tab:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* -- Font List -- */
  .font-list {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    gap: 3px;
    padding: 0 14px 10px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
    touch-action: pan-y;
  }
  .font-list::-webkit-scrollbar { width: 5px; }
  .font-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .font-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border: 1.5px solid transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background 0.12s, border-color 0.12s;
    background: transparent;
    flex-shrink: 0;
  }
  .font-item:hover {
    background: var(--accent-soft);
    border-color: var(--border);
  }
  .font-item.selected {
    background: var(--accent-soft);
    border-color: var(--accent);
  }
  .font-item-info {
    min-width: 0;
    flex: 1;
  }
  .font-item-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .font-item-meta {
    font-size: 10px;
    color: var(--text-muted);
  }
  .font-item-preview {
    width: 100%;
    height: 28px;
    image-rendering: pixelated;
    margin-top: 4px;
    border-radius: 3px;
    background: var(--bg);
  }
  .font-item-preview.loading {
    background: linear-gradient(90deg, var(--bg) 0%, var(--bg-deep) 50%, var(--bg) 100%);
    background-size: 200% 100%;
    animation: shimmer 1.5s ease-in-out infinite;
  }

  /* -- Height Slider -- */
  .height-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .height-slider {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    border-radius: 4px;
    background: var(--border);
    outline: none;
    transition: background 0.2s;
  }
  .height-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    transition: transform 0.1s;
  }
  .height-slider::-webkit-slider-thumb:hover {
    transform: scale(1.15);
  }
  .height-slider::-moz-range-thumb {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .height-slider:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .height-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    font-family: var(--font-body);
    min-width: 32px;
    text-align: right;
    line-height: 1;
  }
  .height-unit {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* -- Color Swatches -- */
  .color-row {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    align-items: center;
  }
  .color-dot {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    transition: transform 0.12s, box-shadow 0.12s, border-color 0.12s;
    position: relative;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.08);
  }
  .color-dot:hover {
    transform: scale(1.2);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  .color-dot.selected {
    border-color: var(--text);
    box-shadow: 0 0 0 2px #fff, 0 0 0 3.5px var(--text);
    transform: scale(1.1);
  }
  .color-dot .tip {
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--text);
    color: #fff;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 10px;
    font-weight: 500;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.12s;
    z-index: 20;
  }
  .color-dot .tip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 3px solid transparent;
    border-top-color: var(--text);
  }
  .color-dot:hover .tip { opacity: 1; }

  /* -- Aida selector -- */
  .aida-row {
    display: flex;
    gap: 5px;
  }
  .aida-chip {
    flex: 1;
    text-align: center;
    padding: 8px 0;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-family: var(--font-body);
    background: transparent;
    transition: border-color 0.12s, background 0.12s, color 0.12s;
  }
  .aida-chip:hover { border-color: var(--accent); }
  .aida-chip.selected {
    border-color: var(--accent);
    background: var(--accent-soft);
  }
  .aida-chip:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .aida-chip-num {
    display: block;
    font-size: 17px;
    font-weight: 700;
    color: var(--text);
    line-height: 1.1;
  }
  .aida-chip.selected .aida-chip-num { color: var(--accent); }
  .aida-chip-label {
    font-size: 9px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  /* -- Custom stitch length -- */
  .custom-stitch-row {
    display: none;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
    padding: 12px;
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border-light);
  }
  .custom-stitch-row.visible { display: flex; }
  .custom-stitch-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .custom-stitch-header .stitch-label {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-mid);
  }
  .custom-stitch-header .stitch-value-display {
    display: flex;
    align-items: baseline;
    gap: 3px;
  }
  .custom-stitch-header .stitch-value-num {
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    font-family: var(--font-body);
    line-height: 1;
  }
  .custom-stitch-header .stitch-value-unit {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-mid);
  }
  .custom-stitch-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: var(--border);
    outline: none;
  }
  .custom-stitch-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 3px solid #fff;
    box-shadow: 0 1px 6px rgba(0,0,0,0.2);
  }
  .custom-stitch-slider::-moz-range-thumb {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 3px solid #fff;
    box-shadow: 0 1px 6px rgba(0,0,0,0.2);
  }
  .custom-stitch-slider:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .custom-stitch-equiv {
    font-size: 11px;
    color: var(--text-muted);
    text-align: center;
  }
  /* -- Global Unit Toggle (topbar cm/in) -- */
  .unit-toggle {
    display: flex;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    flex-shrink: 0;
  }
  .unit-toggle-btn {
    padding: 10px 14px;
    border: none;
    background: transparent;
    font-family: var(--font-body);
    font-size: 13px;
    font-weight: 700;
    color: var(--text-muted);
    cursor: pointer;
    transition: background 0.12s, color 0.12s;
    text-transform: lowercase;
    min-height: 40px;
    min-width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .unit-toggle-btn.active {
    background: var(--accent);
    color: #fff;
  }
  .unit-toggle-btn:not(.active):hover {
    background: var(--accent-soft);
    color: var(--accent);
  }
  .unit-toggle-btn:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .custom-unit-toggle {
    display: flex;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }
  .custom-unit-btn {
    padding: 5px 8px;
    border: none;
    background: transparent;
    font-family: var(--font-body);
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    cursor: pointer;
    transition: background 0.12s, color 0.12s;
    text-transform: uppercase;
  }
  .custom-unit-btn.active {
    background: var(--accent);
    color: #fff;
  }
  .custom-unit-btn:not(.active):hover {
    background: var(--accent-soft);
    color: var(--accent);
  }
  .custom-count-label {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 500;
    white-space: nowrap;
  }

  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* -- Preview Area (right) -- */
  .preview-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 0;
    overflow: hidden;
    padding: 20px;
    position: relative;
  }

  .preview-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: var(--text-muted);
    font-size: 15px;
    text-align: center;
  }
  .preview-empty svg {
    width: 48px;
    height: 48px;
    opacity: 0.25;
    margin-bottom: 4px;
  }
  .preview-empty span {
    font-family: var(--font-display);
    font-size: 16px;
    font-style: italic;
  }

  /* -- Loading overlay -- */
  .preview-loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(245, 240, 234, 0.85);
    z-index: 5;
    gap: 12px;
  }
  .preview-loading.hidden { display: none; }
  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text {
    font-family: var(--font-display);
    font-size: 15px;
    font-style: italic;
    color: var(--text-mid);
  }

  .preview-canvas-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    max-width: 100%;
    max-height: 100%;
  }

  #mainCanvas {
    image-rendering: pixelated;
    max-width: 100%;
    max-height: calc(100vh - 200px);
    object-fit: contain;
    border-radius: 2px;
  }

  /* -- Stats Bar (below canvas) -- */
  .stats-bar {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .stat-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 11px;
    color: var(--text-mid);
    white-space: nowrap;
    transition: background 0.2s, color 0.2s;
  }
  .stat-pill strong {
    color: var(--text);
    font-weight: 700;
  }
  .stat-pill .unit {
    color: var(--text-muted);
    font-size: 10px;
  }

  .stat-pill.size-pill {
    background: var(--accent-soft);
    border-color: var(--accent);
  }
  .stat-pill.size-pill strong {
    color: var(--accent);
    font-size: 13px;
  }

  .stat-sep {
    color: var(--border);
    font-size: 11px;
    padding: 0 2px;
  }

  /* -- Ruler visualization -- */
  .ruler-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    width: 100%;
    max-width: 600px;
  }

  .ruler-line {
    display: flex;
    align-items: center;
    gap: 0;
  }
  .ruler-edge {
    width: 1px;
    height: 10px;
    background: var(--accent);
    flex-shrink: 0;
  }
  .ruler-bar {
    flex: 1;
    height: 1.5px;
    background: var(--accent);
    position: relative;
  }
  .ruler-label {
    position: absolute;
    top: -16px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
    white-space: nowrap;
    font-family: var(--font-body);
  }

  .ruler-height-wrap {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .ruler-height-label {
    font-size: 11px;
    color: var(--text-muted);
  }
  .ruler-height-val {
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
  }

  /* -- Vertical Ruler (left of canvas) -- */
  .ruler-vertical {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 0;
    flex-shrink: 0;
    position: relative;
    margin-right: 4px;
  }
  .ruler-v-edge {
    height: 1px;
    width: 7px;
    background: var(--accent);
    flex-shrink: 0;
  }
  .ruler-v-bar {
    flex: 1;
    width: 1.5px;
    background: var(--accent);
    position: relative;
    min-height: 10px;
  }
  .ruler-v-label {
    position: absolute;
    left: -4px;
    top: 50%;
    transform: translateX(-100%) translateY(-50%);
    font-size: 10px;
    font-weight: 700;
    color: var(--accent);
    white-space: nowrap;
    font-family: var(--font-body);
  }

  /* Desktop: canvas-rulers-wrap just passes through */
  .canvas-rulers-wrap {
    display: contents;
  }

  /* -- Sidebar toggle & drawer backdrop (disabled - no longer used) -- */
  .sidebar-toggle {
    display: none;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    background: #fff;
    cursor: pointer;
    flex-shrink: 0;
    transition: border-color 0.15s, background 0.15s;
    position: relative;
  }
  .sidebar-toggle:hover { border-color: var(--accent); }
  .sidebar-toggle.active { border-color: var(--accent); background: var(--accent-soft); }
  .sidebar-toggle svg { width: 18px; height: 18px; color: var(--text-mid); }
  .sidebar-toggle.active svg { color: var(--accent); }

  .drawer-backdrop {
    display: none !important;
  }

  /* ============================================= */
  /* -- Responsive: Mobile (<=640px) -- */
  /* Canvas First: topbar -> canvas -> toolbar     */
  /* ============================================= */
  @media (max-width: 640px) {
    html, body { height: 100vh; height: 100dvh; overflow: hidden; }
    body { height: 100vh; height: 100dvh; }

    .topbar {
      padding: calc(6px + env(safe-area-inset-top, 0px)) 12px 6px;
      gap: 8px;
      height: 48px;
      min-height: 48px;
    }
    .topbar-sep, .logo { display: none; }
    .lang-select {
      font-size: 12px;
      padding: 2px 16px 2px 4px;
      border: none;
      background-color: transparent;
      background-position: right 4px center;
      opacity: 0.7;
    }
    .sidebar-toggle { display: none; }
    .unit-toggle { border-radius: var(--radius-sm); }
    .unit-toggle-btn { padding: 6px 12px; min-height: 36px; min-width: 36px; font-size: 12px; }

    .text-input { font-size: 16px; min-height: 36px; padding: 6px 12px; }
    .btn-download { padding: 8px; min-height: 36px; min-width: 36px; }
    .btn-download .dl-label { display: none; }

    .main-layout {
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
      flex: 1;
      padding-bottom: calc(126px + env(safe-area-inset-bottom, 0px));
    }

    .sidebar { display: none !important; }

    .preview-area {
      flex: 1;
      padding: 14px 16px 14px 40px; /* extra left for vertical ruler label */
      min-height: 0;
      max-height: none;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    #mainCanvas {
      /* 48px header + 126px toolbar + safe-area + 100px stats(2rows)/rulers/gaps + 28px padding */
      max-height: calc(100vh - 48px - 126px - env(safe-area-inset-bottom, 0px) - 128px);
      max-height: calc(100dvh - 48px - 126px - env(safe-area-inset-bottom, 0px) - 128px);
    }

    /* Stats: responsive wrap on mobile */
    .stats-bar {
      gap: 4px 6px;
      padding: 0 4px;
      flex-wrap: wrap;
      justify-content: center;
      overflow: visible;
    }
    .stat-pill { padding: 2px 8px; font-size: 9px; }
    .stat-pill strong { font-size: 10px; }
    .stat-pill.size-pill strong { font-size: 11px; }
    .stat-sep { display: none; }

    /* Preview wrap: generous spacing between canvas, rulers, stats */
    .preview-canvas-wrap { gap: 14px; }

    /* Ruler: compact but readable */
    .ruler-info { gap: 2px; max-width: 100%; margin-top: 2px; }
    .ruler-label { font-size: 11px; top: -16px; }
    .ruler-edge { height: 8px; }

    /* Vertical ruler: visible on mobile */
    .ruler-vertical { display: flex; margin-right: 6px; }

    /* Canvas with rulers layout */
    .canvas-rulers-wrap {
      display: flex;
      align-items: flex-start;
      gap: 0;
      max-width: 100%;
      min-height: 0;
      justify-content: center;
    }

    .drawer-backdrop { display: none !important; }
  }

  /* ============================================= */
  /* -- Mobile Toolbar (Slider + 3 Buttons) -- */
  /* ============================================= */
  .mobile-toolbar {
    display: none;
  }
  @media (max-width: 640px) {
    .mobile-toolbar {
      display: flex;
      flex-direction: column;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding-bottom: env(safe-area-inset-bottom, 0px);
      background: var(--panel);
      border-top: 1px solid var(--border);
      z-index: 50;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.08);
    }
  }

  /* Row 1: Height slider â€” generous touch area */
  .mobile-slider-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 16px 8px;
    flex-shrink: 0;
  }
  .mobile-slider-row .height-slider {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    border-radius: 4px;
    background: var(--border);
    outline: none;
  }
  .mobile-slider-row .height-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  .mobile-slider-row .height-slider::-moz-range-thumb {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  .mobile-slider-label {
    font-family: var(--font-body);
    font-size: 13px;
    font-weight: 700;
    color: var(--text-mid);
    white-space: nowrap;
    letter-spacing: 0.3px;
    text-transform: uppercase;
  }
  .mobile-slider-value {
    font-family: var(--font-body);
    font-size: 20px;
    font-weight: 700;
    color: var(--accent);
    min-width: 28px;
    text-align: right;
    line-height: 1;
  }
  .mobile-slider-unit {
    font-size: 11px;
    color: var(--text-mid);
    font-weight: 600;
  }

  /* Row 2: 3 action buttons â€” big touch targets */
  .mobile-buttons-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px 14px;
    flex-shrink: 0;
  }

  /* Shared toolbar button style â€” 52px height for easy thumb taps */
  .mobile-tb-btn {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1.5px solid var(--border);
    background: var(--surface);
    border-radius: 14px;
    padding: 0 14px;
    height: 52px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    color: var(--text);
    font-family: var(--font-body);
    font-size: 14px;
    font-weight: 600;
    min-width: 0;
    transition: background 0.12s, border-color 0.12s;
  }
  .mobile-tb-btn:active {
    background: var(--accent-soft);
    border-color: var(--accent);
  }
  .mobile-tb-btn svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
    flex-shrink: 0;
  }
  .mobile-tb-btn .tb-label {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    min-width: 0;
  }
  .mobile-tb-btn .tb-chevron {
    width: 12px;
    height: 12px;
    margin-left: auto;
    flex-shrink: 0;
    opacity: 0.4;
  }

  /* Color button swatch */
  .mobile-color-swatch {
    width: 26px;
    height: 26px;
    min-width: 26px;
    border-radius: 50%;
    border: 2.5px solid var(--border);
    flex-shrink: 0;
  }

  /* ============================================= */
  /* -- Sheet Backdrop -- */
  /* ============================================= */
  .sheet-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    -webkit-backdrop-filter: blur(2px);
    backdrop-filter: blur(2px);
    z-index: 55;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .sheet-backdrop.visible {
    display: block;
    opacity: 1;
  }

  /* ============================================= */
  /* -- Bottom Sheets (generic) -- */
  /* ============================================= */
  .bottom-sheet {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--panel);
    border-radius: 16px 16px 0 0;
    z-index: 60;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    box-shadow: 0 -4px 20px rgba(0,0,0,0.12);
    overflow: hidden;
    max-height: 85vh;
    max-height: 85dvh;
    padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
  }
  @media (max-width: 640px) {
    .bottom-sheet { display: block; }
  }
  .bottom-sheet.open {
    transform: translateY(0);
  }
  .sheet-handle {
    display: flex;
    justify-content: center;
    padding: 10px 0 6px;
    cursor: grab;
    -webkit-tap-highlight-color: transparent;
  }
  .sheet-handle::after {
    content: '';
    width: 40px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
  }
  .sheet-title {
    font-family: var(--font-display);
    font-size: 18px;
    color: var(--text);
    padding: 0 16px 12px;
    border-bottom: 1px solid var(--border-light);
    text-wrap: balance;
  }
  .sheet-body {
    overflow-y: auto;
    overscroll-behavior: contain;
  }

  /* -- Font Sheet -- */
  .sheet-font { height: 70vh; height: 70dvh; }
  .sheet-font .sheet-body { flex: 1; overflow: hidden; display: flex; flex-direction: column; height: calc(70vh - 40px - 46px); height: calc(70dvh - 40px - 46px); }
  .sheet-font-search {
    position: sticky;
    top: 0;
    z-index: 2;
    padding: 8px 16px;
    background: var(--panel);
  }
  .sheet-font-search input {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
    font-family: var(--font-body);
    font-size: 16px;
    color: var(--text);
    background: #fff;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .sheet-font-search input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  .sheet-font-tabs {
    display: flex;
    gap: 4px;
    padding: 4px 16px 8px;
    overflow-x: auto;
    flex-shrink: 0;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .sheet-font-tabs::-webkit-scrollbar { display: none; }
  .sheet-font-tabs .font-tab {
    min-height: 36px;
    padding: 6px 12px;
    font-size: 12px;
  }
  .sheet-font-list-wrap {
    flex: 1;
    overflow-y: auto;
    overscroll-behavior: contain;
    position: relative;
    min-height: 0;
  }
  .sheet-font-list-viewport {
    position: relative;
  }
  .sheet-font-item {
    display: flex;
    align-items: center;
    height: 80px;
    padding: 0 16px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: background 0.12s;
    border-left: 3px solid transparent;
  }
  .sheet-font-item:active {
    background: var(--accent-soft);
  }
  .sheet-font-item.selected {
    background: var(--accent-soft);
    border-left-color: var(--accent);
  }
  .sheet-font-item-info {
    flex: 1;
    min-width: 0;
  }
  .sheet-font-item-name {
    font-size: 15px;
    font-weight: 700;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .sheet-font-item-meta {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .sheet-font-item-check {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    color: var(--accent);
    display: none;
  }
  .sheet-font-item.selected .sheet-font-item-check {
    display: block;
  }
  .sheet-font-item-preview {
    width: 100%;
    height: 36px;
    image-rendering: pixelated;
    margin-top: 4px;
    border-radius: 3px;
    background: var(--bg);
  }
  .sheet-font-item-preview.loading {
    background: linear-gradient(90deg, var(--bg) 0%, var(--bg-deep) 50%, var(--bg) 100%);
    background-size: 200% 100%;
    animation: shimmer 1.5s ease-in-out infinite;
  }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  /* -- Color Sheet -- */
  .sheet-color .sheet-body { padding: 16px; }
  .sheet-color-current {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg);
    border-radius: var(--radius);
    margin-bottom: 16px;
  }
  .sheet-color-swatch {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    flex-shrink: 0;
  }
  .sheet-color-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
  }
  .sheet-color-code {
    font-size: 12px;
    color: var(--text-muted);
  }
  .sheet-color-grid {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  .sheet-color-grid .color-dot {
    width: 44px;
    height: 44px;
  }

  /* -- Settings Sheet -- */
  .sheet-settings .sheet-body { padding: 16px; }
  .sheet-settings-group {
    margin-bottom: 20px;
  }
  .sheet-settings-group:last-child { margin-bottom: 0; }
  .sheet-settings-label {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .sheet-settings .height-control { margin-bottom: 0; }
  .sheet-settings .aida-row { flex-wrap: wrap; gap: 8px; }
  .sheet-settings .aida-chip { min-height: 52px; padding: 12px 8px; flex: 0 0 calc(33.33% - 6px); }
  .sheet-settings .aida-chip-num { font-size: 22px; }
  .sheet-settings .custom-stitch-row { margin-top: 12px; }
  .sheet-settings .custom-count-input { min-height: 44px; font-size: 16px; }

  /* -- Info Sheet -- */
  .sheet-info .sheet-body { padding: 16px; }
  .sheet-info-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 16px;
  }
  .sheet-info-card {
    background: var(--bg);
    border: 1px solid var(--border-light);
    border-radius: var(--radius);
    padding: 12px;
    text-align: center;
  }
  .sheet-info-card-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    line-height: 1.2;
  }
  .sheet-info-card-label {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 2px;
  }
  .sheet-info-card.full-width {
    grid-column: 1 / -1;
  }
  .sheet-info-ruler {
    margin: 16px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
  }
  .sheet-info-ruler .ruler-line {
    width: 100%;
    max-width: 300px;
  }
  .sheet-info-lang {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .sheet-info-lang label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-mid);
  }
  .sheet-info-lang select {
    flex: 1;
    padding: 8px 12px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    background: #fff;
    font-family: var(--font-body);
    font-size: 14px;
    color: var(--text);
    outline: none;
    -webkit-appearance: none;
    appearance: none;
  }

  /* -- Body scroll lock -- */
  body.sheet-open {
    overflow: hidden !important;
    touch-action: none;
  }

  /* ============================================= */
  /* -- Responsive: Small phones (<=380px) -- */
  /* ============================================= */
  @media (max-width: 380px) {
    .text-input { font-size: 16px; padding: 8px 10px; }
    .btn-download { padding: 8px 12px; }
    .preview-area { padding: 8px; min-height: 200px; }
    .color-dot { width: 36px; height: 36px; }
  }

  /* ============================================= */
  /* -- Responsive: Tablet (641-1024px) -- */
  /* ============================================= */
  @media (min-width: 641px) and (max-width: 1024px) {
    .sidebar { width: 250px; }
    .sidebar-toggle { display: none; }
    .text-input { font-size: 18px; }
  }

  /* ============================================= */
  /* -- Responsive: Desktop (>1024px) -- */
  /* ============================================= */
  @media (min-width: 1025px) {
    .sidebar { width: 300px; }
    .sidebar-toggle { display: none; }
  }

  /* -- Language selector -- */
  .lang-select {
    flex-shrink: 0;
    padding: 4px 6px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    background: #fff;
    font-family: var(--font-body);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-mid);
    cursor: pointer;
    outline: none;
    transition: border-color 0.15s;
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23a99e8f'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 6px center;
    padding-right: 20px;
  }
  .lang-select:hover, .lang-select:focus { border-color: var(--accent); }
  .lang-select:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* -- Scrollbar global -- */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
</style>
</head>
<body>

<!-- -- Top Bar -- -->
<header class="topbar">
  <div class="logo">
    <span class="logo-x">&#10006;</span>
    <span class="logo-text">Word<em>2</em>Stitch</span>
  </div>

  <div class="topbar-sep"></div>

  <div class="text-input-area">
    <input
      type="text"
      class="text-input"
      id="textInput"
      aria-label="Text to render"
      placeholder="Type your text hereâ€¦"
      data-i18n-placeholder="placeholder_text"
      value="Welcome"
      maxlength="40"
      autocomplete="off"
      spellcheck="false"
    />
  </div>

  <select class="lang-select" id="langSelect" aria-label="Language">
    <option value="en">ðŸ‡¬ðŸ‡§ EN</option>
    <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
    <option value="fr">ðŸ‡«ðŸ‡· FR</option>
    <option value="de">ðŸ‡©ðŸ‡ª DE</option>
    <option value="it">ðŸ‡®ðŸ‡¹ IT</option>
    <option value="pt">ðŸ‡§ðŸ‡· PT</option>
    <option value="nl">ðŸ‡³ðŸ‡± NL</option>
    <option value="ja">ðŸ‡¯ðŸ‡µ JA</option>
    <option value="ko">ðŸ‡°ðŸ‡· KO</option>
    <option value="zh">ðŸ‡¨ðŸ‡³ ZH</option>
    <option value="ru">ðŸ‡·ðŸ‡º RU</option>
    <option value="pl">ðŸ‡µðŸ‡± PL</option>
    <option value="sv">ðŸ‡¸ðŸ‡ª SV</option>
    <option value="da">ðŸ‡©ðŸ‡° DA</option>
    <option value="fi">ðŸ‡«ðŸ‡® FI</option>
    <option value="uk">ðŸ‡ºðŸ‡¦ UK</option>
    <option value="hu">ðŸ‡­ðŸ‡º HU</option>
  </select>

  <div class="unit-toggle" id="unitToggle">
    <button class="unit-toggle-btn active" data-unit="metric" aria-pressed="true" aria-label="Centimeters">cm</button>
    <button class="unit-toggle-btn" data-unit="imperial" aria-pressed="false" aria-label="Inches">in</button>
  </div>

  <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle controls" data-i18n-aria="toggle_controls">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
      <line x1="3" y1="6" x2="21" y2="6"/>
      <line x1="3" y1="12" x2="21" y2="12"/>
      <line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
  </button>

  <button class="btn-download" id="btnDownload" aria-label="Download PDF">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="7 10 12 15 17 10"/>
      <line x1="12" y1="15" x2="12" y2="3"/>
    </svg>
    <span class="dl-label">PDF</span>
  </button>
</header>

<!-- Drawer backdrop (mobile) -->
<div class="drawer-backdrop" id="drawerBackdrop"></div>

<!-- -- Main Split Layout -- -->
<main class="main-layout">

  <!-- -- Left Sidebar: Controls -- -->
  <aside class="sidebar">

    <!-- Font Search + Header -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
        <span data-i18n="section_font">Font</span>
      </div>
      <input
        type="text"
        class="font-search"
        id="fontSearch"
        aria-label="Search fonts"
        placeholder="Search fontsâ€¦"
        data-i18n-placeholder="search_fonts"
        autocomplete="off"
        spellcheck="false"
      />
      <div class="font-tabs" id="fontCategoryTabs">
        <button class="font-tab active" data-category="all">All</button>
      </div>
    </div>

    <!-- Font List (scrollable) -->
    <div class="font-list" id="fontList"></div>

    <!-- Height Control -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h4M18 12h4M7 7l2 2M15 15l2 2M7 17l2-2M15 7l2-2"/></svg>
        <span data-i18n="section_height">Stitch Height</span>
      </div>
      <div class="height-control">
        <input type="range" class="height-slider" id="heightSlider" min="8" max="30" value="18" step="1" aria-label="Stitch height" />
        <div>
          <span class="height-value" id="heightValue">18</span>
          <span class="height-unit" data-i18n="unit_px">px</span>
        </div>
      </div>
    </div>

    <!-- Color Picker -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
        <span data-i18n="section_color">Thread Color</span>
      </div>
      <div class="color-row" id="colorRow"></div>
    </div>

    <!-- Aida Count -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
        <span data-i18n="section_fabric">Fabric</span>
      </div>
      <div class="aida-row" id="aidaRow">
        <button class="aida-chip" data-count="11">
          <span class="aida-chip-num">11</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip selected" data-count="14">
          <span class="aida-chip-num">14</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip" data-count="16">
          <span class="aida-chip-num">16</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip" data-count="18">
          <span class="aida-chip-num">18</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip" data-count="custom" id="aidaCustomChip">
          <span class="aida-chip-num">âœŽ</span>
          <span class="aida-chip-label">Custom</span>
        </button>
      </div>
      <div class="custom-stitch-row" id="customStitchRow">
        <div class="custom-stitch-header">
          <span class="stitch-label">Stitch length</span>
          <div class="stitch-value-display">
            <span class="stitch-value-num" id="customStitchValue">3.0</span>
            <span class="stitch-value-unit" id="customStitchUnit">mm</span>
          </div>
        </div>
        <input type="range" class="custom-stitch-slider" id="customStitchSlider" min="1" max="10" value="3" step="0.1" aria-label="Custom stitch length" />
        <div class="custom-stitch-equiv" id="customStitchEquiv"></div>
      </div>
    </div>

  </aside>

  <!-- -- Right: Preview -- -->
  <div class="preview-area" id="previewArea">

    <!-- Loading overlay -->
    <div class="preview-loading hidden" id="previewLoading">
      <div class="loading-spinner"></div>
      <div class="loading-text" data-i18n="loading_text">Rasterizingâ€¦</div>
    </div>

    <div class="preview-empty" id="previewEmpty">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <line x1="3" y1="9" x2="21" y2="9"/>
        <line x1="3" y1="15" x2="21" y2="15"/>
        <line x1="9" y1="3" x2="9" y2="21"/>
        <line x1="15" y1="3" x2="15" y2="21"/>
      </svg>
      <span data-i18n="empty_state">Type something to see your pattern</span>
    </div>

    <div class="preview-canvas-wrap" id="previewWrap" style="display:none;">
      <!-- Canvas + vertical ruler wrapper -->
      <div class="canvas-rulers-wrap">
        <!-- Vertical ruler (left of canvas, mobile only) -->
        <div class="ruler-vertical" id="rulerVertical">
          <div class="ruler-v-edge"></div>
          <div class="ruler-v-bar">
            <div class="ruler-v-label" id="rulerHeight">--</div>
          </div>
          <div class="ruler-v-edge"></div>
        </div>
        <canvas id="mainCanvas"></canvas>
      </div>

      <!-- Ruler showing width in cm -->
      <div class="ruler-info" id="rulerInfo">
        <div class="ruler-line">
          <div class="ruler-edge"></div>
          <div class="ruler-bar">
            <div class="ruler-label" id="rulerWidth">--</div>
          </div>
          <div class="ruler-edge"></div>
        </div>
      </div>

      <!-- Stats pills -->
      <div class="stats-bar" id="statsBar">
        <div class="stat-pill size-pill">
          <strong id="statSizeCm">--</strong>
          <span class="unit" id="statSizeUnit">cm</span>
        </div>
        <div class="stat-sep">.</div>
        <div class="stat-pill">
          <strong id="statStitchesW">--</strong>x<strong id="statStitchesH">--</strong>
          <span class="unit" data-i18n="unit_stitches">stitches</span>
        </div>
        <div class="stat-sep">.</div>
        <div class="stat-pill">
          <strong id="statTotal">--</strong>
          <span class="unit" data-i18n="unit_crosses">crosses</span>
        </div>
        <div class="stat-sep">.</div>
        <div class="stat-pill">
          DMC <strong id="statDmc">--</strong>
          <span class="unit" id="statThread">--</span>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- -- Mobile Toolbar (Slider + 3 Buttons) -- -->
<div class="mobile-toolbar" id="mobileToolbar">
  <!-- Row 1: Height slider -->
  <div class="mobile-slider-row">
    <span class="mobile-slider-label">H</span>
    <input type="range" class="height-slider" id="mobileHeightSlider" min="8" max="30" value="18" step="1" />
    <span class="mobile-slider-value" id="mobileHeightValue">18</span>
    <span class="mobile-slider-unit">px</span>
  </div>
  <!-- Row 2: Aida + Font + Color buttons -->
  <div class="mobile-buttons-row">
    <button class="mobile-tb-btn" id="mobileAidaBtn" aria-label="Fabric settings">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
      <span class="tb-label" id="mobileAidaValue">14 ct</span>
      <svg class="tb-chevron" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
    </button>
    <button class="mobile-tb-btn" id="mobileFontBtn" aria-label="Select font">
      <svg viewBox="0 0 24 24"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg>
      <span class="tb-label" id="mobileFontName">Font</span>
      <svg class="tb-chevron" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
    </button>
    <button class="mobile-tb-btn" id="mobileColorBtn" aria-label="Thread color">
      <div class="mobile-color-swatch" id="mobileColorSwatch"></div>
      <span class="tb-label" id="mobileColorName">Black</span>
      <svg class="tb-chevron" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
    </button>
  </div>
</div>

<!-- -- Sheet Backdrop -- -->
<div class="sheet-backdrop" id="sheetBackdrop"></div>

<!-- -- Font Bottom Sheet -- -->
<div class="bottom-sheet sheet-font" id="sheetFont" role="dialog" aria-modal="true" aria-label="Font selector">
  <div class="sheet-handle" id="sheetFontHandle"></div>
  <div class="sheet-title" data-i18n="section_font">Font</div>
  <div class="sheet-body">
    <div class="sheet-font-search">
      <input type="text" id="sheetFontSearch" aria-label="Search fonts" placeholder="Search fontsâ€¦" data-i18n-placeholder="search_fonts" autocomplete="off" spellcheck="false" />
    </div>
    <div class="sheet-font-tabs" id="sheetFontTabs"></div>
    <div class="sheet-font-list-wrap" id="sheetFontListWrap" role="listbox" aria-label="Font list">
      <div class="sheet-font-list-viewport" id="sheetFontListViewport"></div>
    </div>
  </div>
</div>

<!-- -- Color Bottom Sheet -- -->
<div class="bottom-sheet sheet-color" id="sheetColor" role="dialog" aria-modal="true" aria-label="Color selector">
  <div class="sheet-handle" id="sheetColorHandle"></div>
  <div class="sheet-title" data-i18n="section_color">Thread Color</div>
  <div class="sheet-body">
    <div class="sheet-color-current" id="sheetColorCurrent">
      <div class="sheet-color-swatch" id="sheetColorSwatch"></div>
      <div>
        <div class="sheet-color-name" id="sheetColorName">--</div>
        <div class="sheet-color-code" id="sheetColorCode">DMC --</div>
      </div>
    </div>
    <div class="sheet-color-grid" id="sheetColorGrid"></div>
  </div>
</div>

<!-- -- Settings Bottom Sheet -- -->
<div class="bottom-sheet sheet-settings" id="sheetSettings" role="dialog" aria-modal="true" aria-label="Fabric & Stitch">
  <div class="sheet-handle" id="sheetSettingsHandle"></div>
  <div class="sheet-title">Fabric & Stitch</div>
  <div class="sheet-body">
    <div class="sheet-settings-group">
      <div class="sheet-settings-label">
        <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h4M18 12h4M7 7l2 2M15 15l2 2M7 17l2-2M15 7l2-2"/></svg>
        <span data-i18n="section_height">Stitch Height</span>
      </div>
      <div class="height-control">
        <input type="range" class="height-slider" id="sheetHeightSlider" min="8" max="30" value="18" step="1" aria-label="Stitch height" />
        <div>
          <span class="height-value" id="sheetHeightValue">18</span>
          <span class="height-unit" data-i18n="unit_px">px</span>
        </div>
      </div>
    </div>
    <div class="sheet-settings-group">
      <div class="sheet-settings-label">
        <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
        <span data-i18n="section_fabric">Fabric</span>
      </div>
      <div class="aida-row" id="sheetAidaRow">
        <button class="aida-chip" data-count="11"><span class="aida-chip-num">11</span><span class="aida-chip-label" data-i18n="label_aida">Aida</span></button>
        <button class="aida-chip selected" data-count="14"><span class="aida-chip-num">14</span><span class="aida-chip-label" data-i18n="label_aida">Aida</span></button>
        <button class="aida-chip" data-count="16"><span class="aida-chip-num">16</span><span class="aida-chip-label" data-i18n="label_aida">Aida</span></button>
        <button class="aida-chip" data-count="18"><span class="aida-chip-num">18</span><span class="aida-chip-label" data-i18n="label_aida">Aida</span></button>
        <button class="aida-chip" data-count="custom"><span class="aida-chip-num">&#9998;</span><span class="aida-chip-label">Custom</span></button>
      </div>
      <div class="custom-stitch-row" id="sheetCustomStitchRow">
        <div class="custom-stitch-header">
          <span class="stitch-label">Stitch length</span>
          <div class="stitch-value-display">
            <span class="stitch-value-num" id="sheetCustomStitchValue">3.0</span>
            <span class="stitch-value-unit" id="sheetCustomStitchUnit">mm</span>
          </div>
        </div>
        <input type="range" class="custom-stitch-slider" id="sheetCustomStitchSlider" min="1" max="10" value="3" step="0.1" aria-label="Custom stitch length" />
        <div class="custom-stitch-equiv" id="sheetCustomStitchEquiv"></div>
      </div>
    </div>
  </div>
</div>

<!-- -- Info Bottom Sheet -- -->
<div class="bottom-sheet sheet-info" id="sheetInfo" role="dialog" aria-modal="true" aria-label="Pattern info">
  <div class="sheet-handle" id="sheetInfoHandle"></div>
  <div class="sheet-title">Pattern Info</div>
  <div class="sheet-body">
    <div class="sheet-info-cards">
      <div class="sheet-info-card full-width">
        <div class="sheet-info-card-value" id="infoSize">-- x --</div>
        <div class="sheet-info-card-label" id="infoSizeUnit">cm</div>
      </div>
      <div class="sheet-info-card">
        <div class="sheet-info-card-value" id="infoStitches">--x--</div>
        <div class="sheet-info-card-label" data-i18n="unit_stitches">stitches</div>
      </div>
      <div class="sheet-info-card">
        <div class="sheet-info-card-value" id="infoCrosses">--</div>
        <div class="sheet-info-card-label" data-i18n="unit_crosses">crosses</div>
      </div>
      <div class="sheet-info-card">
        <div class="sheet-info-card-value" id="infoDmc">--</div>
        <div class="sheet-info-card-label">DMC</div>
      </div>
      <div class="sheet-info-card">
        <div class="sheet-info-card-value" id="infoThread">--</div>
        <div class="sheet-info-card-label">Thread</div>
      </div>
    </div>
    <div class="sheet-info-ruler" id="infoRuler">
      <div class="ruler-line">
        <div class="ruler-edge"></div>
        <div class="ruler-bar"><div class="ruler-label" id="infoRulerWidth">--</div></div>
        <div class="ruler-edge"></div>
      </div>
    </div>
    <div class="sheet-info-lang">
      <label>Language</label>
      <select id="sheetLangSelect">
        <option value="en">EN English</option>
        <option value="es">ES EspaÃ±ol</option>
        <option value="fr">FR FranÃ§ais</option>
        <option value="de">DE Deutsch</option>
        <option value="it">IT Italiano</option>
        <option value="pt">PT PortuguÃªs</option>
        <option value="nl">NL Nederlands</option>
        <option value="ja">JA Japanese</option>
        <option value="ko">KO Korean</option>
        <option value="zh">ZH Chinese</option>
        <option value="ru">RU Russian</option>
        <option value="pl">PL Polish</option>
        <option value="sv">SV Swedish</option>
        <option value="da">DA Danish</option>
        <option value="fi">FI Finnish</option>
        <option value="uk">UK Ukrainian</option>
        <option value="hu">HU Hungarian</option>
      </select>
    </div>
  </div>
</div>

<!-- ================================================ -->
<!-- ==  JavaScript                                 == -->
<!-- ================================================ -->
<script>
(function () {
  'use strict';

  // -- i18n translations --
  var I18N = {
    en: {
      placeholder_text: "Type your text hereâ€¦",
      section_font: "Font",
      search_fonts: "Search fontsâ€¦",
      tab_all: "All",
      section_height: "Stitch Height",
      unit_px: "px",
      section_color: "Thread Color",
      section_fabric: "Fabric",
      label_aida: "Aida",
      empty_state: "Type something to see your pattern",
      loading_text: "Rasterizingâ€¦",
      unit_cm: "cm",
      unit_stitches: "stitches",
      unit_crosses: "crosses",
      toggle_controls: "Toggle controls",
      no_fonts: "No fonts available",
      no_matching: "No matching fonts",
      server_error: "Failed to load fonts. Is the server running?",
      alert_no_text: "Type some text and select a font first.",
      alert_no_pdf: "PDF engine not loaded. Please reload the page.",
      alert_no_jspdf: "jsPDF library not loaded. Check your internet connection and reload.",
      alert_pdf_fail: "PDF generation failed: ",
      label_custom: 'Custom',
      label_stitch_length: 'Stitch length',
      sheet_fabric: 'Fabric & Stitch',
      sheet_info: 'Pattern Info',
      label_dmc: 'DMC',
      label_thread: 'Thread',
      label_language: 'Language'
    },
    es: {
      placeholder_text: "Escribe tu texto aquÃ­â€¦",
      section_font: "Fuente",
      search_fonts: "Buscar fuentesâ€¦",
      tab_all: "Todas",
      section_height: "Altura de Puntada",
      unit_px: "px",
      section_color: "Color de Hilo",
      section_fabric: "Tela",
      label_aida: "Aida",
      empty_state: "Escribe algo para ver tu patrÃ³n",
      loading_text: "Rasterizandoâ€¦",
      unit_cm: "cm",
      unit_stitches: "puntadas",
      unit_crosses: "cruces",
      toggle_controls: "Mostrar controles",
      no_fonts: "No hay fuentes disponibles",
      no_matching: "No se encontraron fuentes",
      server_error: "Error al cargar fuentes. Â¿EstÃ¡ el servidor activo?",
      alert_no_text: "Escribe un texto y selecciona una fuente primero.",
      alert_no_pdf: "Motor PDF no cargado. Recarga la pÃ¡gina.",
      alert_no_jspdf: "Biblioteca jsPDF no cargada. Verifica tu conexiÃ³n y recarga.",
      alert_pdf_fail: "Error al generar PDF: ",
      label_custom: 'Personalizado',
      label_stitch_length: 'Largo de puntada',
      sheet_fabric: 'Tela y Puntada',
      sheet_info: 'Info del PatrÃ³n',
      label_dmc: 'DMC',
      label_thread: 'Hilo',
      label_language: 'Idioma'
    },
    fr: {
      placeholder_text: "Tapez votre texte iciâ€¦",
      section_font: "Police",
      search_fonts: "Rechercher des policesâ€¦",
      tab_all: "Toutes",
      section_height: "Hauteur de Point",
      unit_px: "px",
      section_color: "Couleur du Fil",
      section_fabric: "Tissu",
      label_aida: "Aida",
      empty_state: "Tapez quelque chose pour voir votre motif",
      loading_text: "RastÃ©risationâ€¦",
      unit_cm: "cm",
      unit_stitches: "points",
      unit_crosses: "croix",
      toggle_controls: "Afficher les contrÃ´les",
      no_fonts: "Aucune police disponible",
      no_matching: "Aucune police trouvÃ©e",
      server_error: "Ã‰chec du chargement des polices. Le serveur est-il lancÃ© ?",
      alert_no_text: "Tapez du texte et sÃ©lectionnez une police d'abord.",
      alert_no_pdf: "Moteur PDF non chargÃ©. Rechargez la page.",
      alert_no_jspdf: "BibliothÃ¨que jsPDF non chargÃ©e. VÃ©rifiez votre connexion et rechargez.",
      alert_pdf_fail: "Ã‰chec de la gÃ©nÃ©ration du PDF : "
    },
    de: {
      placeholder_text: "Gib deinen Text einâ€¦",
      section_font: "Schriftart",
      search_fonts: "Schriftarten suchenâ€¦",
      tab_all: "Alle",
      section_height: "StichhÃ¶he",
      unit_px: "px",
      section_color: "Garnfarbe",
      section_fabric: "Stoff",
      label_aida: "Aida",
      empty_state: "Tippe etwas, um dein Muster zu sehen",
      loading_text: "Wird gerastertâ€¦",
      unit_cm: "cm",
      unit_stitches: "Stiche",
      unit_crosses: "Kreuze",
      toggle_controls: "Steuerung anzeigen",
      no_fonts: "Keine Schriftarten verfÃ¼gbar",
      no_matching: "Keine passenden Schriftarten",
      server_error: "Schriftarten konnten nicht geladen werden. LÃ¤uft der Server?",
      alert_no_text: "Gib einen Text ein und wÃ¤hle eine Schriftart.",
      alert_no_pdf: "PDF-Engine nicht geladen. Seite neu laden.",
      alert_no_jspdf: "jsPDF nicht geladen. PrÃ¼fe deine Internetverbindung und lade neu.",
      alert_pdf_fail: "PDF-Erzeugung fehlgeschlagen: "
    },
    it: {
      placeholder_text: "Scrivi il tuo testo quiâ€¦",
      section_font: "Font",
      search_fonts: "Cerca fontâ€¦",
      tab_all: "Tutti",
      section_height: "Altezza Punto",
      unit_px: "px",
      section_color: "Colore Filo",
      section_fabric: "Tessuto",
      label_aida: "Aida",
      empty_state: "Scrivi qualcosa per vedere il tuo schema",
      loading_text: "Rasterizzazioneâ€¦",
      unit_cm: "cm",
      unit_stitches: "punti",
      unit_crosses: "croci",
      toggle_controls: "Mostra controlli",
      no_fonts: "Nessun font disponibile",
      no_matching: "Nessun font trovato",
      server_error: "Caricamento font fallito. Il server Ã¨ attivo?",
      alert_no_text: "Scrivi un testo e seleziona un font prima.",
      alert_no_pdf: "Motore PDF non caricato. Ricarica la pagina.",
      alert_no_jspdf: "Libreria jsPDF non caricata. Controlla la connessione e ricarica.",
      alert_pdf_fail: "Generazione PDF fallita: "
    },
    pt: {
      placeholder_text: "Digite seu texto aquiâ€¦",
      section_font: "Fonte",
      search_fonts: "Buscar fontesâ€¦",
      tab_all: "Todas",
      section_height: "Altura do Ponto",
      unit_px: "px",
      section_color: "Cor da Linha",
      section_fabric: "Tecido",
      label_aida: "Aida",
      empty_state: "Digite algo para ver seu padrÃ£o",
      loading_text: "Rasterizandoâ€¦",
      unit_cm: "cm",
      unit_stitches: "pontos",
      unit_crosses: "cruzes",
      toggle_controls: "Mostrar controles",
      no_fonts: "Nenhuma fonte disponÃ­vel",
      no_matching: "Nenhuma fonte encontrada",
      server_error: "Falha ao carregar fontes. O servidor estÃ¡ ativo?",
      alert_no_text: "Digite um texto e selecione uma fonte primeiro.",
      alert_no_pdf: "Motor PDF nÃ£o carregado. Recarregue a pÃ¡gina.",
      alert_no_jspdf: "Biblioteca jsPDF nÃ£o carregada. Verifique sua conexÃ£o e recarregue.",
      alert_pdf_fail: "Falha na geraÃ§Ã£o do PDF: "
    },
    nl: {
      placeholder_text: "Typ je tekst hierâ€¦",
      section_font: "Lettertype",
      search_fonts: "Lettertypen zoekenâ€¦",
      tab_all: "Alle",
      section_height: "Steekhoogte",
      unit_px: "px",
      section_color: "Draadkleur",
      section_fabric: "Stof",
      label_aida: "Aida",
      empty_state: "Typ iets om je patroon te zien",
      loading_text: "Rasterenâ€¦",
      unit_cm: "cm",
      unit_stitches: "steken",
      unit_crosses: "kruisjes",
      toggle_controls: "Bediening tonen",
      no_fonts: "Geen lettertypen beschikbaar",
      no_matching: "Geen overeenkomende lettertypen",
      server_error: "Lettertypen laden mislukt. Draait de server?",
      alert_no_text: "Typ tekst en selecteer een lettertype.",
      alert_no_pdf: "PDF-engine niet geladen. Herlaad de pagina.",
      alert_no_jspdf: "jsPDF-bibliotheek niet geladen. Controleer je verbinding en herlaad.",
      alert_pdf_fail: "PDF genereren mislukt: "
    },
    ja: {
      placeholder_text: "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›â€¦",
      section_font: "ãƒ•ã‚©ãƒ³ãƒˆ",
      search_fonts: "ãƒ•ã‚©ãƒ³ãƒˆã‚’æ¤œç´¢â€¦",
      tab_all: "ã™ã¹ã¦",
      section_height: "ã‚¹ãƒ†ãƒƒãƒé«˜ã•",
      unit_px: "px",
      section_color: "ç³¸ã®è‰²",
      section_fabric: "å¸ƒåœ°",
      label_aida: "ã‚¢ã‚¤ãƒ¼ãƒ€",
      empty_state: "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™",
      loading_text: "ãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚ºä¸­â€¦",
      unit_cm: "cm",
      unit_stitches: "ã‚¹ãƒ†ãƒƒãƒ",
      unit_crosses: "ã‚¯ãƒ­ã‚¹",
      toggle_controls: "ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º",
      no_fonts: "ãƒ•ã‚©ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“",
      no_matching: "ä¸€è‡´ã™ã‚‹ãƒ•ã‚©ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“",
      server_error: "ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã¯èµ·å‹•ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
      alert_no_text: "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚’é¸æŠžã—ã¦ãã ã•ã„ã€‚",
      alert_no_pdf: "PDFã‚¨ãƒ³ã‚¸ãƒ³ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚",
      alert_no_jspdf: "jsPDFãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æŽ¥ç¶šã‚’ç¢ºèªã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚",
      alert_pdf_fail: "PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: "
    },
    ko: {
      placeholder_text: "í…ìŠ¤íŠ¸ë¥¼ ìž…ë ¥í•˜ì„¸ìš”â€¦",
      section_font: "ê¸€ê¼´",
      search_fonts: "ê¸€ê¼´ ê²€ìƒ‰â€¦",
      tab_all: "ì „ì²´",
      section_height: "ìŠ¤í‹°ì¹˜ ë†’ì´",
      unit_px: "px",
      section_color: "ì‹¤ ìƒ‰ìƒ",
      section_fabric: "ì›ë‹¨",
      label_aida: "ì•„ì´ë‹¤",
      empty_state: "í…ìŠ¤íŠ¸ë¥¼ ìž…ë ¥í•˜ë©´ íŒ¨í„´ì´ í‘œì‹œë©ë‹ˆë‹¤",
      loading_text: "ëž˜ìŠ¤í„°ë¼ì´ì¦ˆ ì¤‘â€¦",
      unit_cm: "cm",
      unit_stitches: "ìŠ¤í‹°ì¹˜",
      unit_crosses: "í¬ë¡œìŠ¤",
      toggle_controls: "ì»¨íŠ¸ë¡¤ í‘œì‹œ",
      no_fonts: "ì‚¬ìš© ê°€ëŠ¥í•œ ê¸€ê¼´ì´ ì—†ìŠµë‹ˆë‹¤",
      no_matching: "ì¼ì¹˜í•˜ëŠ” ê¸€ê¼´ì´ ì—†ìŠµë‹ˆë‹¤",
      server_error: "ê¸€ê¼´ ë¡œë“œ ì‹¤íŒ¨. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.",
      alert_no_text: "í…ìŠ¤íŠ¸ë¥¼ ìž…ë ¥í•˜ê³  ê¸€ê¼´ì„ ì„ íƒí•˜ì„¸ìš”.",
      alert_no_pdf: "PDF ì—”ì§„ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. íŽ˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.",
      alert_no_jspdf: "jsPDFê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì—°ê²°ì„ í™•ì¸í•˜ê³  ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.",
      alert_pdf_fail: "PDF ìƒì„± ì‹¤íŒ¨: "
    },
    zh: {
      placeholder_text: "åœ¨æ­¤è¾“å…¥æ–‡å­—â€¦",
      section_font: "å­—ä½“",
      search_fonts: "æœç´¢å­—ä½“â€¦",
      tab_all: "å…¨éƒ¨",
      section_height: "é’ˆé«˜",
      unit_px: "px",
      section_color: "çº¿è‰²",
      section_fabric: "å¸ƒæ–™",
      label_aida: "Aida",
      empty_state: "è¾“å…¥æ–‡å­—ä»¥æŸ¥çœ‹å›¾æ¡ˆ",
      loading_text: "æ­£åœ¨æ …æ ¼åŒ–â€¦",
      unit_cm: "åŽ˜ç±³",
      unit_stitches: "é’ˆ",
      unit_crosses: "åå­—",
      toggle_controls: "æ˜¾ç¤ºæŽ§ä»¶",
      no_fonts: "æ²¡æœ‰å¯ç”¨å­—ä½“",
      no_matching: "æ²¡æœ‰åŒ¹é…çš„å­—ä½“",
      server_error: "å­—ä½“åŠ è½½å¤±è´¥ã€‚æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Ÿ",
      alert_no_text: "è¯·è¾“å…¥æ–‡å­—å¹¶é€‰æ‹©å­—ä½“ã€‚",
      alert_no_pdf: "PDFå¼•æ“ŽæœªåŠ è½½ã€‚è¯·åˆ·æ–°é¡µé¢ã€‚",
      alert_no_jspdf: "jsPDFåº“æœªåŠ è½½ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥å¹¶åˆ·æ–°ã€‚",
      alert_pdf_fail: "PDFç”Ÿæˆå¤±è´¥: "
    },
    ru: {
      placeholder_text: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚â€¦",
      section_font: "Ð¨Ñ€Ð¸Ñ„Ñ‚",
      search_fonts: "ÐŸÐ¾Ð¸ÑÐº ÑˆÑ€Ð¸Ñ„Ñ‚Ð¾Ð²â€¦",
      tab_all: "Ð’ÑÐµ",
      section_height: "Ð’Ñ‹ÑÐ¾Ñ‚Ð° ÑÑ‚ÐµÐ¶ÐºÐ°",
      unit_px: "px",
      section_color: "Ð¦Ð²ÐµÑ‚ Ð½Ð¸Ñ‚Ð¸",
      section_fabric: "Ð¢ÐºÐ°Ð½ÑŒ",
      label_aida: "ÐÐ¸Ð´Ð°",
      empty_state: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ ÑƒÐ·Ð¾Ñ€",
      loading_text: "Ð Ð°ÑÑ‚ÐµÑ€Ð¸Ð·Ð°Ñ†Ð¸Ñâ€¦",
      unit_cm: "ÑÐ¼",
      unit_stitches: "ÑÑ‚ÐµÐ¶ÐºÐ¾Ð²",
      unit_crosses: "ÐºÑ€ÐµÑÑ‚Ð¾Ð²",
      toggle_controls: "ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ð°Ð½ÐµÐ»ÑŒ",
      no_fonts: "ÐÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… ÑˆÑ€Ð¸Ñ„Ñ‚Ð¾Ð²",
      no_matching: "Ð¨Ñ€Ð¸Ñ„Ñ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹",
      server_error: "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑˆÑ€Ð¸Ñ„Ñ‚Ñ‹. Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½?",
      alert_no_text: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð¸ Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑˆÑ€Ð¸Ñ„Ñ‚.",
      alert_no_pdf: "PDF-Ð´Ð²Ð¸Ð¶Ð¾Ðº Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½. ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ.",
      alert_no_jspdf: "Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° jsPDF Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ.",
      alert_pdf_fail: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ PDF: "
    },
    pl: {
      placeholder_text: "Wpisz swÃ³j tekstâ€¦",
      section_font: "Czcionka",
      search_fonts: "Szukaj czcionekâ€¦",
      tab_all: "Wszystkie",
      section_height: "WysokoÅ›Ä‡ Åšciegu",
      unit_px: "px",
      section_color: "Kolor Nici",
      section_fabric: "Tkanina",
      label_aida: "Aida",
      empty_state: "Wpisz coÅ›, aby zobaczyÄ‡ wzÃ³r",
      loading_text: "Rasteryzacjaâ€¦",
      unit_cm: "cm",
      unit_stitches: "Å›ciegÃ³w",
      unit_crosses: "krzyÅ¼ykÃ³w",
      toggle_controls: "PokaÅ¼ panel",
      no_fonts: "Brak dostÄ™pnych czcionek",
      no_matching: "Nie znaleziono czcionek",
      server_error: "Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ czcionek. Czy serwer dziaÅ‚a?",
      alert_no_text: "Wpisz tekst i wybierz czcionkÄ™.",
      alert_no_pdf: "Silnik PDF nie zaÅ‚adowany. OdÅ›wieÅ¼ stronÄ™.",
      alert_no_jspdf: "Biblioteka jsPDF nie zaÅ‚adowana. SprawdÅº poÅ‚Ä…czenie i odÅ›wieÅ¼.",
      alert_pdf_fail: "BÅ‚Ä…d generowania PDF: "
    },
    sv: {
      placeholder_text: "Skriv din text hÃ¤râ€¦",
      section_font: "Typsnitt",
      search_fonts: "SÃ¶k typsnittâ€¦",
      tab_all: "Alla",
      section_height: "Stygnh\u00f6jd",
      unit_px: "px",
      section_color: "TrÃ¥dfÃ¤rg",
      section_fabric: "Tyg",
      label_aida: "Aida",
      empty_state: "Skriv nÃ¥got fÃ¶r att se ditt mÃ¶nster",
      loading_text: "Rastrerarâ€¦",
      unit_cm: "cm",
      unit_stitches: "stygn",
      unit_crosses: "kors",
      toggle_controls: "Visa kontroller",
      no_fonts: "Inga typsnitt tillgÃ¤ngliga",
      no_matching: "Inga matchande typsnitt",
      server_error: "Kunde inte ladda typsnitt. KÃ¶rs servern?",
      alert_no_text: "Skriv text och vÃ¤lj ett typsnitt fÃ¶rst.",
      alert_no_pdf: "PDF-motor inte laddad. Ladda om sidan.",
      alert_no_jspdf: "jsPDF inte laddat. Kontrollera din anslutning och ladda om.",
      alert_pdf_fail: "PDF-generering misslyckades: "
    },
    da: {
      placeholder_text: "Skriv din tekst herâ€¦",
      section_font: "Skrifttype",
      search_fonts: "SÃ¸g skrifttyperâ€¦",
      tab_all: "Alle",
      section_height: "StinghÃ¸jde",
      unit_px: "px",
      section_color: "TrÃ¥dfarve",
      section_fabric: "Stof",
      label_aida: "Aida",
      empty_state: "Skriv noget for at se dit mÃ¸nster",
      loading_text: "Rastrererâ€¦",
      unit_cm: "cm",
      unit_stitches: "sting",
      unit_crosses: "kors",
      toggle_controls: "Vis kontroller",
      no_fonts: "Ingen skrifttyper tilgÃ¦ngelige",
      no_matching: "Ingen matchende skrifttyper",
      server_error: "Kunne ikke indlÃ¦se skrifttyper. KÃ¸rer serveren?",
      alert_no_text: "Skriv tekst og vÃ¦lg en skrifttype fÃ¸rst.",
      alert_no_pdf: "PDF-motor ikke indlÃ¦st. GenindlÃ¦s siden.",
      alert_no_jspdf: "jsPDF ikke indlÃ¦st. KontrollÃ©r din forbindelse og genindlÃ¦s.",
      alert_pdf_fail: "PDF-generering mislykkedes: "
    },
    fi: {
      placeholder_text: "Kirjoita tekstisi tÃ¤hÃ¤nâ€¦",
      section_font: "Fontti",
      search_fonts: "Etsi fonttejaâ€¦",
      tab_all: "Kaikki",
      section_height: "Pistonkorkeus",
      unit_px: "px",
      section_color: "Langan VÃ¤ri",
      section_fabric: "Kangas",
      label_aida: "Aida",
      empty_state: "Kirjoita jotain nÃ¤hdÃ¤ksesi kuviosi",
      loading_text: "Rasteroidaanâ€¦",
      unit_cm: "cm",
      unit_stitches: "pistoa",
      unit_crosses: "ristiÃ¤",
      toggle_controls: "NÃ¤ytÃ¤ ohjaimet",
      no_fonts: "Ei fontteja saatavilla",
      no_matching: "Ei vastaavia fontteja",
      server_error: "Fonttien lataus epÃ¤onnistui. Onko palvelin kÃ¤ynnissÃ¤?",
      alert_no_text: "Kirjoita teksti ja valitse fontti ensin.",
      alert_no_pdf: "PDF-moottori ei latautunut. Lataa sivu uudelleen.",
      alert_no_jspdf: "jsPDF ei latautunut. Tarkista yhteys ja lataa uudelleen.",
      alert_pdf_fail: "PDF:n luonti epÃ¤onnistui: "
    },
    uk: {
      placeholder_text: "Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚â€¦",
      section_font: "Ð¨Ñ€Ð¸Ñ„Ñ‚",
      search_fonts: "ÐŸÐ¾ÑˆÑƒÐº ÑˆÑ€Ð¸Ñ„Ñ‚Ñ–Ð²â€¦",
      tab_all: "Ð£ÑÑ–",
      section_height: "Ð’Ð¸ÑÐ¾Ñ‚Ð° ÑÑ‚Ñ–Ð±ÐºÐ°",
      unit_px: "px",
      section_color: "ÐšÐ¾Ð»Ñ–Ñ€ Ð½Ð¸Ñ‚ÐºÐ¸",
      section_fabric: "Ð¢ÐºÐ°Ð½Ð¸Ð½Ð°",
      label_aida: "ÐÑ—Ð´Ð°",
      empty_state: "Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚, Ñ‰Ð¾Ð± Ð¿Ð¾Ð±Ð°Ñ‡Ð¸Ñ‚Ð¸ Ð²Ñ–Ð·ÐµÑ€ÑƒÐ½Ð¾Ðº",
      loading_text: "Ð Ð°ÑÑ‚ÐµÑ€Ð¸Ð·Ð°Ñ†Ñ–Ñâ€¦",
      unit_cm: "ÑÐ¼",
      unit_stitches: "ÑÑ‚Ñ–Ð±ÐºÑ–Ð²",
      unit_crosses: "Ñ…Ñ€ÐµÑÑ‚Ð¸ÐºÑ–Ð²",
      toggle_controls: "ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚Ð¸ Ð¿Ð°Ð½ÐµÐ»ÑŒ",
      no_fonts: "ÐÐµÐ¼Ð°Ñ” Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ñ… ÑˆÑ€Ð¸Ñ„Ñ‚Ñ–Ð²",
      no_matching: "Ð¨Ñ€Ð¸Ñ„Ñ‚Ð¸ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾",
      server_error: "ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ ÑˆÑ€Ð¸Ñ„Ñ‚Ð¸. Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾?",
      alert_no_text: "Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚ Ñ– Ð²Ð¸Ð±ÐµÑ€Ñ–Ñ‚ÑŒ ÑˆÑ€Ð¸Ñ„Ñ‚.",
      alert_no_pdf: "PDF-Ñ€ÑƒÑˆÑ–Ð¹ Ð½Ðµ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð¾. ÐŸÐµÑ€ÐµÐ·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ñ‚Ðµ ÑÑ‚Ð¾Ñ€Ñ–Ð½ÐºÑƒ.",
      alert_no_jspdf: "Ð‘Ñ–Ð±Ð»Ñ–Ð¾Ñ‚ÐµÐºÑƒ jsPDF Ð½Ðµ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð¾. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ Ð·'Ñ”Ð´Ð½Ð°Ð½Ð½Ñ Ñ– Ð¿ÐµÑ€ÐµÐ·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ñ‚Ðµ.",
      alert_pdf_fail: "ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ— PDF: "
    },
    hu: {
      placeholder_text: "Ãrd be a szÃ¶vegedâ€¦",
      section_font: "BetÅ±tÃ­pus",
      search_fonts: "BetÅ±tÃ­pusok keresÃ©seâ€¦",
      tab_all: "Ã–sszes",
      section_height: "Ã–ltÃ©smagassÃ¡g",
      unit_px: "px",
      section_color: "FonalszÃ­n",
      section_fabric: "SzÃ¶vet",
      label_aida: "Aida",
      empty_state: "Ãrj valamit a minta megtekintÃ©sÃ©hez",
      loading_text: "RaszterizÃ¡lÃ¡sâ€¦",
      unit_cm: "cm",
      unit_stitches: "Ã¶ltÃ©s",
      unit_crosses: "kereszt",
      toggle_controls: "VezÃ©rlÅ‘k mutatÃ¡sa",
      no_fonts: "Nincs elÃ©rhetÅ‘ betÅ±tÃ­pus",
      no_matching: "Nincs egyezÅ‘ betÅ±tÃ­pus",
      server_error: "BetÅ±tÃ­pusok betÃ¶ltÃ©se sikertelen. Fut a szerver?",
      alert_no_text: "Ãrj szÃ¶veget Ã©s vÃ¡lassz betÅ±tÃ­pust.",
      alert_no_pdf: "PDF-motor nincs betÃ¶ltve. TÃ¶ltsd Ãºjra az oldalt.",
      alert_no_jspdf: "jsPDF nincs betÃ¶ltve. EllenÅ‘rizd a kapcsolatot Ã©s tÃ¶ltsd Ãºjra.",
      alert_pdf_fail: "PDF lÃ©trehozÃ¡s sikertelen: "
    }
  };

  var currentLang = 'en';

  function t(key) {
    var lang = I18N[currentLang] || I18N.en;
    return lang[key] || I18N.en[key] || key;
  }

  function applyLang() {
    document.querySelectorAll('[data-i18n]').forEach(function(el) {
      el.textContent = t(el.dataset.i18n);
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
      el.placeholder = t(el.dataset.i18nPlaceholder);
    });
    document.querySelectorAll('[data-i18n-aria]').forEach(function(el) {
      el.setAttribute('aria-label', t(el.dataset.i18nAria));
    });
    document.title = 'Word2Stitch â€” ' + t('empty_state').split(' ').slice(0, 4).join(' ');
  }

  function setLanguage(lang) {
    if (!I18N[lang]) lang = 'en';
    currentLang = lang;
    document.documentElement.lang = lang;
    try { localStorage.setItem('w2s_lang', lang); } catch(e) {}
    var sel = document.getElementById('langSelect');
    if (sel) sel.value = lang;
    applyLang();
    if (typeof renderFontListUI === 'function') renderFontListUI();
  }

  // -- State --
  var currentText = 'Welcome';
  var currentFontFile = 'GeorgiaPro-Black.ttf';
  var currentFontName = 'GeorgiaPro-Black';
  var currentHeight = 18;
  var currentColorIndex = 0;
  var currentAida = 14;
  var currentCategoryFilter = 'all';
  var displayUnit = 'metric'; // 'metric' | 'imperial'

  // -- Unit detection & formatting --

  function detectDefaultUnit() {
    var lang = navigator.language || '';
    var parts = lang.split('-');
    var country = (parts[1] || '').toUpperCase();
    // US, Liberia (LR), Myanmar (MM) use imperial
    if (country === 'US' || country === 'LR' || country === 'MM') return 'imperial';
    // Fallback: if just 'en' without country, assume metric (UK, AU, etc.)
    return 'metric';
  }

  function formatSize(wStitches, hStitches, aida) {
    var inW = (wStitches / aida).toFixed(1);
    var inH = (hStitches / aida).toFixed(1);
    var cmW = (wStitches / aida * 2.54).toFixed(1);
    var cmH = (hStitches / aida * 2.54).toFixed(1);
    if (displayUnit === 'imperial') {
      return { value: inW + ' \u00d7 ' + inH, unit: 'in', width: inW + ' in', height: inH + ' in' };
    }
    return { value: cmW + ' \u00d7 ' + cmH, unit: 'cm', width: cmW + ' cm', height: cmH + ' cm' };
  }

  function formatThread(stitches, aida) {
    var metersPerStitch = 0.013 * (14 / aida);
    var totalMeters = stitches * metersPerStitch;
    if (displayUnit === 'imperial') {
      var yards = (totalMeters * 1.09361).toFixed(1);
      return yards + '\u00a0yd';
    }
    return totalMeters.toFixed(1) + '\u00a0m';
  }

  function setDisplayUnit(unit) {
    displayUnit = (unit === 'imperial') ? 'imperial' : 'metric';
    try { localStorage.setItem('w2s_unit', displayUnit); } catch(e) {}
    // Sync toggle buttons
    var toggle = document.getElementById('unitToggle');
    if (toggle) {
      toggle.querySelectorAll('.unit-toggle-btn').forEach(function(b) {
        b.classList.toggle('active', b.dataset.unit === displayUnit);
      });
    }
    // Refresh custom stitch labels if visible
    if (isCustomAida) {
      updateCustomStitch(currentStitchMm, 'unit');
    }
    updatePreview();
  }

  var categoryLabels = {
    'serif': 'Serif', 'sans-serif': 'Sans', 'script': 'Script',
    'decorative': 'Decorative', 'monospace': 'Mono', 'other': 'Other'
  };

  // Font list from API: [{file, name, size, category}, ...]
  var fontListData = [];

  // Client-side cache: Map<string, fontJSON>
  // Key format: "filename.ttf_height"
  var fontCache = new Map();

  // Currently loaded font data (from cache or API)
  var currentFontData = null;

  // -- DOM refs --
  var textInput = document.getElementById('textInput');
  var fontList = document.getElementById('fontList');
  var fontSearch = document.getElementById('fontSearch');
  var heightSlider = document.getElementById('heightSlider');
  var heightValue = document.getElementById('heightValue');
  var colorRow = document.getElementById('colorRow');
  var aidaRow = document.getElementById('aidaRow');
  var btnDownload = document.getElementById('btnDownload');
  var previewEmpty = document.getElementById('previewEmpty');
  var previewWrap = document.getElementById('previewWrap');
  var previewLoading = document.getElementById('previewLoading');
  var mainCanvas = document.getElementById('mainCanvas');
  var previewArea = document.getElementById('previewArea');

  // -- Helpers --

  function getCacheKey(fontFile, height) {
    return fontFile + '_' + height;
  }

  function getCurrentColor() {
    if (typeof DMC_COLORS === 'undefined' || !DMC_COLORS.length) return { hex: '#b83a2a', code: '321', name: 'Red' };
    return DMC_COLORS[currentColorIndex] || DMC_COLORS[0];
  }

  function showLoading() {
    previewLoading.classList.remove('hidden');
  }

  function hideLoading() {
    previewLoading.classList.add('hidden');
  }

  // -- Bitmap --

  function getEffectiveBitmap(glyph) {
    if (!glyph || !glyph.bitmap || !glyph.bitmap.length) return [];
    var bitmap = glyph.bitmap;
    var lastFilledRow = -1;
    for (var r = bitmap.length - 1; r >= 0; r--) {
      if (bitmap[r].indexOf('1') !== -1) { lastFilledRow = r; break; }
    }
    if (lastFilledRow === -1) return bitmap.slice();
    return bitmap.slice(0, lastFilledRow + 1);
  }

  function getTextBitmap(text, fontData) {
    if (!text || !fontData || !fontData.glyphs) return { bitmap: [], width: 0, height: 0 };

    var height = fontData.height || 9;
    var letterSpacing = (fontData.letterSpacing != null) ? fontData.letterSpacing : 1;
    var spaceWidth = fontData.spaceWidth || 3;
    var columns = [];

    for (var ci = 0; ci < text.length; ci++) {
      var ch = text[ci];
      if (ci > 0 && letterSpacing > 0) {
        for (var s = 0; s < letterSpacing; s++) columns.push(new Array(height).fill(false));
      }
      if (ch === ' ') {
        for (var s2 = 0; s2 < spaceWidth; s2++) columns.push(new Array(height).fill(false));
        continue;
      }
      var glyph = fontData.glyphs[ch];
      if (!glyph || !glyph.bitmap || !glyph.bitmap.length) {
        for (var s3 = 0; s3 < spaceWidth; s3++) columns.push(new Array(height).fill(false));
        continue;
      }
      var bmp = glyph.bitmap;
      var glyphWidth = glyph.width || (bmp[0] ? bmp[0].length : 0);
      for (var x = 0; x < glyphWidth; x++) {
        var col = [];
        for (var y = 0; y < height; y++) {
          col.push(y < bmp.length && x < bmp[y].length && bmp[y][x] === '1');
        }
        columns.push(col);
      }
    }

    if (!columns.length) return { bitmap: [], width: 0, height: 0 };

    var width = columns.length;
    var bitmap = [];
    for (var y2 = 0; y2 < height; y2++) {
      var row = [];
      for (var x2 = 0; x2 < width; x2++) row.push(columns[x2][y2]);
      bitmap.push(row);
    }
    return { bitmap: bitmap, width: width, height: height };
  }

  // -- Render --

  function renderPreview(canvas, text, fontData, colorHex, options) {
    var ctx = canvas.getContext('2d');
    if (!text || !fontData) {
      canvas.width = 1; canvas.height = 1;
      ctx.clearRect(0, 0, 1, 1);
      return { width: 0, height: 0, stitches: 0 };
    }

    var result = getTextBitmap(text, fontData);
    var bitmap = result.bitmap;
    var width = result.width;
    var height = result.height;
    if (!bitmap.length || !width) {
      canvas.width = 1; canvas.height = 1;
      ctx.clearRect(0, 0, 1, 1);
      return { width: 0, height: 0, stitches: 0 };
    }

    var opts = options || {};
    var maxCanvasWidth = opts.maxWidth || 850;
    var cellSize = opts.cellSize || 12;
    if (width * cellSize > maxCanvasWidth) {
      cellSize = Math.max(2, Math.floor(maxCanvasWidth / width));
    }

    var canvasW = width * cellSize + 1;
    var canvasH = height * cellSize + 1;
    canvas.width = canvasW;
    canvas.height = canvasH;

    // Background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvasW, canvasH);

    var stitchCount = 0;

    // Filled cells
    ctx.fillStyle = colorHex;
    for (var y = 0; y < height; y++) {
      for (var x = 0; x < width; x++) {
        if (bitmap[y][x]) {
          ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
          stitchCount++;
        }
      }
    }

    // Grid lines
    ctx.strokeStyle = '#e0d8d0';
    ctx.lineWidth = 0.5;
    for (var gx = 0; gx <= width; gx++) {
      var px = gx * cellSize + 0.5;
      ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, canvasH); ctx.stroke();
    }
    for (var gy = 0; gy <= height; gy++) {
      var py = gy * cellSize + 0.5;
      ctx.beginPath(); ctx.moveTo(0, py); ctx.lineTo(canvasW, py); ctx.stroke();
    }

    // Bold every 10
    if (cellSize >= 4) {
      ctx.strokeStyle = '#a09888';
      ctx.lineWidth = 1.5;
      for (var bx = 0; bx <= width; bx += 10) {
        var bpx = bx * cellSize + 0.5;
        ctx.beginPath(); ctx.moveTo(bpx, 0); ctx.lineTo(bpx, canvasH); ctx.stroke();
      }
      for (var by = 0; by <= height; by += 10) {
        var bpy = by * cellSize + 0.5;
        ctx.beginPath(); ctx.moveTo(0, bpy); ctx.lineTo(canvasW, bpy); ctx.stroke();
      }
    }

    return { width: width, height: height, stitches: stitchCount };
  }

  // -- API calls --

  function fetchFontList() {
    return fetch('/api/fonts')
      .then(function (res) {
        if (!res.ok) throw new Error('Failed to load font list');
        return res.json();
      })
      .then(function (data) {
        fontListData = data;
        renderFontListUI();
        // Auto-rasterize default font on load
        if (currentFontFile && currentText) {
          loadAndRender();
        }
      })
      .catch(function (err) {
        fontList.innerHTML = '<div style="padding:20px;color:var(--text-muted);font-size:12px;text-align:center;">' + t('server_error') + '</div>';
        console.error('fetchFontList:', err);
      });
  }

  function rasterizeFont(fontFile, height) {
    var key = getCacheKey(fontFile, height);

    // Return cached data if available
    if (fontCache.has(key)) {
      return Promise.resolve(fontCache.get(key));
    }

    showLoading();

    return fetch('/api/rasterize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        font: fontFile,
        height: height,
        bold: 0,
        strategy: 'average'
      })
    })
    .then(function (res) {
      if (!res.ok) throw new Error('Rasterization failed');
      return res.json();
    })
    .then(function (data) {
      fontCache.set(key, data);
      hideLoading();
      return data;
    })
    .catch(function (err) {
      hideLoading();
      console.error('rasterizeFont:', err);
      return null;
    });
  }

  // -- Update Preview (main function) --

  function updatePreview() {
    var color = getCurrentColor();

    if (!currentText.trim() || !currentFontData) {
      previewEmpty.style.display = 'flex';
      previewWrap.style.display = 'none';
      return;
    }

    previewEmpty.style.display = 'none';
    previewWrap.style.display = 'flex';

    // Calculate available space
    var areaRect = previewArea.getBoundingClientRect();
    var maxW = areaRect.width - 40;

    var result = renderPreview(mainCanvas, currentText, currentFontData, color.hex, {
      cellSize: 16,
      maxWidth: maxW
    });

    if (result.width === 0) {
      previewEmpty.style.display = 'flex';
      previewWrap.style.display = 'none';
      return;
    }

    // Calculate physical size using unit-aware helpers
    var size = formatSize(result.width, result.height, currentAida);

    // Update stats
    var statsBar = document.getElementById('statsBar');
    if (statsBar && !statsBar.getAttribute('aria-live')) {
      statsBar.setAttribute('aria-live', 'polite');
      statsBar.setAttribute('aria-atomic', 'true');
    }
    document.getElementById('statSizeCm').textContent = size.value;
    var sizeUnitEl = document.getElementById('statSizeUnit');
    if (sizeUnitEl) sizeUnitEl.textContent = size.unit;
    document.getElementById('statStitchesW').textContent = result.width;
    document.getElementById('statStitchesH').textContent = result.height;
    document.getElementById('statTotal').textContent = result.stitches;
    document.getElementById('statDmc').textContent = color.code;

    // Thread estimate
    document.getElementById('statThread').textContent = formatThread(result.stitches, currentAida);

    // Ruler: match canvas rendered dimensions
    document.getElementById('rulerWidth').textContent = size.width;
    var rulerHeightLabel = document.getElementById('rulerHeight');
    if (rulerHeightLabel) rulerHeightLabel.textContent = size.height;
    requestAnimationFrame(function () {
      var canvasRect = mainCanvas.getBoundingClientRect();
      var rulerLine = document.querySelector('.ruler-line');
      if (rulerLine && canvasRect.width > 0) {
        rulerLine.style.width = canvasRect.width + 'px';
      }
      // Vertical ruler: match canvas rendered height
      var rulerV = document.getElementById('rulerVertical');
      if (rulerV && canvasRect.height > 0) {
        rulerV.style.height = canvasRect.height + 'px';
      }
    });
  }

  // -- Trigger rasterization and update --

  function loadAndRender() {
    if (!currentFontFile) {
      currentFontData = null;
      updatePreview();
      return;
    }

    rasterizeFont(currentFontFile, currentHeight).then(function (data) {
      if (data) {
        currentFontData = data;
      }
      updatePreview();
    });
  }

  // -- Text Input --

  textInput.addEventListener('input', function () {
    currentText = this.value;
    updatePreview();
    // Re-render font sheet previews with new text
    renderVirtualFontList();
  });

  // -- Font List UI --

  function renderFontListUI() {
    var filter = (fontSearch.value || '').toLowerCase().trim();

    // Compute category counts from filtered fonts
    var categoryCounts = {};
    fontListData.forEach(function (font) {
      var name = font.name || font.file;
      if (filter && name.toLowerCase().indexOf(filter) === -1) return;
      var cat = font.category || 'other';
      categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
    });

    var categories = Object.keys(categoryCounts).sort();
    var totalFiltered = 0;
    categories.forEach(function (c) { totalFiltered += categoryCounts[c]; });

    // Populate category tabs
    var tabsEl = document.getElementById('fontCategoryTabs');
    tabsEl.innerHTML = '';
    var allBtn = document.createElement('button');
    allBtn.className = 'font-tab' + (currentCategoryFilter === 'all' ? ' active' : '');
    allBtn.dataset.category = 'all';
    allBtn.textContent = t('tab_all') + ' (' + totalFiltered + ')';
    tabsEl.appendChild(allBtn);

    categories.forEach(function (cat) {
      var btn = document.createElement('button');
      btn.className = 'font-tab' + (currentCategoryFilter === cat ? ' active' : '');
      btn.dataset.category = cat;
      btn.textContent = (categoryLabels[cat] || cat) + ' (' + categoryCounts[cat] + ')';
      tabsEl.appendChild(btn);
    });

    // Reset if current category has no fonts
    if (currentCategoryFilter !== 'all' && !categoryCounts[currentCategoryFilter]) {
      currentCategoryFilter = 'all';
      tabsEl.querySelector('[data-category="all"]').classList.add('active');
    }

    // Render font list
    fontList.innerHTML = '';

    if (!fontListData.length) {
      fontList.innerHTML = '<div style="padding:20px;color:var(--text-muted);font-size:12px;text-align:center;">' + t('no_fonts') + '</div>';
      return;
    }

    var displayed = 0;
    var fragment = document.createDocumentFragment();

    fontListData.forEach(function (font) {
      var name = font.name || font.file;
      if (filter && name.toLowerCase().indexOf(filter) === -1) return;
      if (currentCategoryFilter !== 'all' && (font.category || 'other') !== currentCategoryFilter) return;

      displayed++;

      var item = document.createElement('div');
      item.className = 'font-item' + (font.file === currentFontFile ? ' selected' : '');
      item.dataset.fontFile = font.file;

      var info = document.createElement('div');
      info.className = 'font-item-info';

      var nameEl = document.createElement('div');
      nameEl.className = 'font-item-name';
      nameEl.textContent = name;

      var meta = document.createElement('div');
      meta.className = 'font-item-meta';
      var sizeKb = font.size ? (font.size / 1024).toFixed(0) + ' KB' : '';
      meta.textContent = (categoryLabels[font.category] || font.category || '') + (sizeKb ? ' \u00b7 ' + sizeKb : '');

      var previewCanvas = document.createElement('canvas');
      previewCanvas.className = 'font-item-preview';
      previewCanvas.dataset.fontFile = font.file;

      info.appendChild(nameEl);
      info.appendChild(meta);
      info.appendChild(previewCanvas);
      item.appendChild(info);
      fragment.appendChild(item);

      item.addEventListener('click', function () {
        currentFontFile = font.file;
        currentFontName = name;
        fontList.querySelectorAll('.font-item').forEach(function (el) {
          el.classList.toggle('selected', el.dataset.fontFile === font.file);
        });
        syncMobileFontName();
        loadAndRender();
      });
    });

    fontList.appendChild(fragment);

    if (!displayed) {
      fontList.innerHTML = '<div style="padding:20px;color:var(--text-muted);font-size:12px;text-align:center;">' + t('no_matching') + '</div>';
    }

    // Queue font previews for visible desktop items
    if (typeof queueFontPreview === 'function') {
      var desktopCanvases = fontList.querySelectorAll('.font-item-preview');
      for (var pi = 0; pi < desktopCanvases.length; pi++) {
        queueFontPreview(desktopCanvases[pi].dataset.fontFile, desktopCanvases[pi]);
      }
    }
  }

  // Font search filtering
  fontSearch.addEventListener('input', function () {
    renderFontListUI();
  });

  // Category tab filtering (delegated)
  document.getElementById('fontCategoryTabs').addEventListener('click', function (e) {
    var tab = e.target.closest('.font-tab');
    if (!tab) return;
    currentCategoryFilter = tab.dataset.category;
    this.querySelectorAll('.font-tab').forEach(function (t) { t.classList.remove('active'); });
    tab.classList.add('active');
    renderFontListUI();
  });

  // -- Height Slider --

  var heightDebounceTimer = null;

  heightSlider.addEventListener('input', function () {
    var val = parseInt(this.value);
    heightValue.textContent = val;
    syncMobileHeightValue(val);

    clearTimeout(heightDebounceTimer);
    heightDebounceTimer = setTimeout(function () {
      currentHeight = val;
      loadAndRender();
    }, 300);
  });

  // -- Color Swatches --

  function renderColors() {
    if (typeof DMC_COLORS === 'undefined' || !DMC_COLORS.length) return;
    colorRow.innerHTML = '';
    var fragment = document.createDocumentFragment();

    DMC_COLORS.forEach(function (color, index) {
      var dot = document.createElement('div');
      dot.className = 'color-dot' + (index === currentColorIndex ? ' selected' : '');
      dot.style.backgroundColor = color.hex;
      dot.dataset.index = index;

      var tip = document.createElement('div');
      tip.className = 'tip';
      tip.textContent = 'DMC ' + color.code + ' \u2014 ' + color.name;
      dot.appendChild(tip);

      dot.addEventListener('click', function () {
        currentColorIndex = index;
        colorRow.querySelectorAll('.color-dot').forEach(function (d) {
          d.classList.toggle('selected', parseInt(d.dataset.index) === index);
        });
        syncMobileColorStrip();
        updatePreview();
      });

      fragment.appendChild(dot);
    });

    colorRow.appendChild(fragment);
  }

  // -- Aida Count --

  document.getElementById('langSelect').addEventListener('change', function() {
    setLanguage(this.value);
  });

  var customStitchRow = document.getElementById('customStitchRow');
  var customStitchSlider = document.getElementById('customStitchSlider');
  var customStitchValue = document.getElementById('customStitchValue');
  var customStitchEquiv = document.getElementById('customStitchEquiv');
  var currentStitchMm = 3.0; // default 3mm stitch length
  var isCustomAida = false;

  function stitchMmToAida(mm) {
    return 25.4 / mm; // 25.4mm per inch
  }

  // Format stitch length + equivalence respecting displayUnit
  function formatStitchDisplay(mm) {
    var isImperial = (displayUnit === 'imperial');
    var displayVal, unit, equiv;
    if (isImperial) {
      displayVal = (mm / 25.4).toFixed(2);  // mm â†’ inches
      unit = 'in';
      equiv = '\u2248 ' + (25.4 / mm).toFixed(1) + ' stitches/in';
    } else {
      displayVal = mm.toFixed(1);
      unit = 'mm';
      equiv = '\u2248 ' + (10 / mm).toFixed(1) + ' stitches/cm';
    }
    return { value: displayVal, unit: unit, equiv: equiv };
  }

  function updateCustomStitch(mm, source) {
    currentStitchMm = mm;
    var aida = stitchMmToAida(mm);
    currentAida = aida;

    var fmt = formatStitchDisplay(mm);

    // Update desktop UI
    if (customStitchValue) customStitchValue.textContent = fmt.value;
    if (customStitchSlider && source !== 'desktop') customStitchSlider.value = mm;
    if (customStitchEquiv) customStitchEquiv.textContent = fmt.equiv;
    var dUnit = document.getElementById('customStitchUnit');
    if (dUnit) dUnit.textContent = fmt.unit;

    // Update sheet UI
    var sheetVal = document.getElementById('sheetCustomStitchValue');
    var sheetSlider = document.getElementById('sheetCustomStitchSlider');
    var sheetEquiv = document.getElementById('sheetCustomStitchEquiv');
    var sheetUnit = document.getElementById('sheetCustomStitchUnit');
    if (sheetVal) sheetVal.textContent = fmt.value;
    if (sheetSlider && source !== 'sheet') sheetSlider.value = mm;
    if (sheetEquiv) sheetEquiv.textContent = fmt.equiv;
    if (sheetUnit) sheetUnit.textContent = fmt.unit;

    syncMobileAidaChips();
    updatePreview();
  }

  aidaRow.addEventListener('click', function (e) {
    var chip = e.target.closest('.aida-chip');
    if (!chip) return;
    var countVal = chip.dataset.count;

    // Deselect all chips
    aidaRow.querySelectorAll('.aida-chip').forEach(function (c) {
      c.classList.remove('selected');
    });
    chip.classList.add('selected');

    if (countVal === 'custom') {
      isCustomAida = true;
      if (customStitchRow) customStitchRow.classList.add('visible');
      updateCustomStitch(currentStitchMm, 'init');
    } else {
      isCustomAida = false;
      if (customStitchRow) customStitchRow.classList.remove('visible');
      currentAida = parseInt(countVal);
      syncMobileAidaChips();
      updatePreview();
    }
  });

  // Desktop stitch slider
  if (customStitchSlider) {
    customStitchSlider.addEventListener('input', function () {
      if (isCustomAida) updateCustomStitch(parseFloat(this.value), 'desktop');
    });
  }

  // -- Global unit toggle (cm / in) --
  document.getElementById('unitToggle').addEventListener('click', function (e) {
    var btn = e.target.closest('.unit-toggle-btn');
    if (!btn || btn.classList.contains('active')) return;
    setDisplayUnit(btn.dataset.unit);
  });

  // -- Download PDF --

  btnDownload.addEventListener('click', function () {
    var color = getCurrentColor();
    if (!currentFontData || !currentText.trim()) {
      alert(t('alert_no_text'));
      return;
    }
    if (typeof generatePDF !== 'function') {
      alert(t('alert_no_pdf'));
      return;
    }
    if (!window.jspdf) {
      alert(t('alert_no_jspdf'));
      return;
    }
    try {
      generatePDF(currentText, currentFontData, color, currentAida);
    } catch (err) {
      alert(t('alert_pdf_fail') + err.message);
      console.error('PDF error:', err);
    }
  });

  // -- Resize handling --

  var resizeTimer;
  window.addEventListener('resize', function () {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(updatePreview, 150);
  });

  // -- Initialize --

  function init() {
    // Detect language
    var savedLang = null;
    try { savedLang = localStorage.getItem('w2s_lang'); } catch(e) {}
    var browserLang = (navigator.language || '').split('-')[0];
    setLanguage(savedLang || (I18N[browserLang] ? browserLang : 'en'));

    // Detect unit preference
    var savedUnit = null;
    try { savedUnit = localStorage.getItem('w2s_unit'); } catch(e) {}
    setDisplayUnit(savedUnit || detectDefaultUnit());

    renderColors();
    initMobileToolbar();
    fetchFontList();
    updatePreview();
  }

  // Expose for pdf-engine
  window.getTextBitmap = getTextBitmap;
  window.getEffectiveBitmap = getEffectiveBitmap;
  window.renderPreview = renderPreview;
  window.getDisplayUnit = function() { return displayUnit; };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Wait for DMC_COLORS if loaded late
  var _colorsInterval = setInterval(function () {
    if (typeof DMC_COLORS !== 'undefined') {
      clearInterval(_colorsInterval);
      renderColors();
      populateMobileColorStrip();
    }
  }, 200);
  setTimeout(function () { clearInterval(_colorsInterval); }, 10000);

  // ============================================================
  // == Mobile Canvas First: Bottom Sheets & Virtual Scroll     ==
  // ============================================================

  var isMobile = function () { return window.innerWidth <= 640; };

  // -- Sheet State --
  var activeSheet = null;
  var sheetBackdrop = document.getElementById('sheetBackdrop');
  var mobileToolbar = document.getElementById('mobileToolbar');
  var sheets = {
    font: document.getElementById('sheetFont'),
    color: document.getElementById('sheetColor'),
    settings: document.getElementById('sheetSettings'),
    info: document.getElementById('sheetInfo')
  };

  // -- Sheet Open / Close --
  function openSheet(name) {
    if (!isMobile()) return;
    if (activeSheet === name) {
      closeSheet();
      return;
    }
    // Close any open sheet first (no animation, instant)
    if (activeSheet) {
      sheets[activeSheet].classList.remove('open');
    }
    activeSheet = name;
    var sheet = sheets[name];
    if (!sheet) return;

    // Populate sheet content before opening
    if (name === 'font') populateFontSheet();
    if (name === 'color') populateColorSheet();
    if (name === 'settings') syncSettingsSheet();
    if (name === 'info') syncInfoSheet();

    sheetBackdrop.classList.add('visible');
    sheet.classList.add('open');
    document.body.classList.add('sheet-open');
    sheet.setAttribute('aria-hidden', 'false');
  }

  function closeSheet() {
    if (!activeSheet) return;
    var sheet = sheets[activeSheet];
    if (sheet) {
      sheet.classList.remove('open');
      sheet.setAttribute('aria-hidden', 'true');
    }
    sheetBackdrop.classList.remove('visible');
    document.body.classList.remove('sheet-open');
    activeSheet = null;
  }

  // Backdrop click closes sheet
  sheetBackdrop.addEventListener('click', closeSheet);

  // Escape key closes sheet
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape' && activeSheet) closeSheet();
  });

  // ============================================================
  // == Swipe-to-Dismiss on Sheet Handles                       ==
  // ============================================================

  function initSheetDrag(handleId, sheetId) {
    var handle = document.getElementById(handleId);
    var sheet = document.getElementById(sheetId);
    if (!handle || !sheet) return;

    var startY = 0, currentY = 0, startTime = 0, isDragging = false;

    handle.addEventListener('touchstart', function (e) {
      if (!sheet.classList.contains('open')) return;
      isDragging = true;
      startY = e.touches[0].clientY;
      currentY = startY;
      startTime = Date.now();
      sheet.style.transition = 'none';
    }, { passive: true });

    handle.addEventListener('touchmove', function (e) {
      if (!isDragging) return;
      currentY = e.touches[0].clientY;
      var dy = Math.max(0, currentY - startY);
      sheet.style.transform = 'translateY(' + dy + 'px)';
    }, { passive: true });

    handle.addEventListener('touchend', function () {
      if (!isDragging) return;
      isDragging = false;
      sheet.style.transition = '';
      var dy = currentY - startY;
      var dt = Date.now() - startTime;
      var velocity = dy / Math.max(dt, 1);

      if (dy > 120 || velocity > 0.5) {
        closeSheet();
      } else {
        sheet.style.transform = '';
      }
    });
  }

  initSheetDrag('sheetFontHandle', 'sheetFont');
  initSheetDrag('sheetColorHandle', 'sheetColor');
  initSheetDrag('sheetSettingsHandle', 'sheetSettings');
  initSheetDrag('sheetInfoHandle', 'sheetInfo');

  // ============================================================
  // == Font Sheet: Virtual Scroll                              ==
  // ============================================================

  var FONT_ITEM_HEIGHT = 80;
  var OVERSCAN = 5;
  var fontSheetFilter = '';
  var fontSheetCategory = 'all';
  var filteredFontsCache = [];

  function getFilteredFonts() {
    var filter = fontSheetFilter.toLowerCase().trim();
    return fontListData.filter(function (font) {
      var name = (font.name || font.file).toLowerCase();
      if (filter && name.indexOf(filter) === -1) return false;
      if (fontSheetCategory !== 'all' && (font.category || 'other') !== fontSheetCategory) return false;
      return true;
    });
  }

  function populateFontSheet() {
    // Build tabs
    var tabsEl = document.getElementById('sheetFontTabs');
    var filter = fontSheetFilter.toLowerCase().trim();
    var categoryCounts = {};
    fontListData.forEach(function (font) {
      var name = (font.name || font.file).toLowerCase();
      if (filter && name.indexOf(filter) === -1) return;
      var cat = font.category || 'other';
      categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
    });
    var categories = Object.keys(categoryCounts).sort();
    var total = 0;
    categories.forEach(function (c) { total += categoryCounts[c]; });

    tabsEl.innerHTML = '';
    var allTab = document.createElement('button');
    allTab.className = 'font-tab' + (fontSheetCategory === 'all' ? ' active' : '');
    allTab.dataset.category = 'all';
    allTab.textContent = t('tab_all') + ' (' + total + ')';
    tabsEl.appendChild(allTab);

    categories.forEach(function (cat) {
      var btn = document.createElement('button');
      btn.className = 'font-tab' + (fontSheetCategory === cat ? ' active' : '');
      btn.dataset.category = cat;
      btn.textContent = (categoryLabels[cat] || cat) + ' (' + categoryCounts[cat] + ')';
      tabsEl.appendChild(btn);
    });

    // Reset category if invalid
    if (fontSheetCategory !== 'all' && !categoryCounts[fontSheetCategory]) {
      fontSheetCategory = 'all';
    }

    // Update filtered cache
    filteredFontsCache = getFilteredFonts();

    // Set viewport total height
    var viewport = document.getElementById('sheetFontListViewport');
    viewport.style.height = (filteredFontsCache.length * FONT_ITEM_HEIGHT) + 'px';

    // Trigger initial render
    renderVirtualFontList();
  }

  var rafPending = false;

  function renderVirtualFontList() {
    var wrap = document.getElementById('sheetFontListWrap');
    var viewport = document.getElementById('sheetFontListViewport');
    if (!wrap || !viewport) return;

    var scrollTop = wrap.scrollTop;
    var viewportHeight = wrap.clientHeight;
    var totalItems = filteredFontsCache.length;

    if (!totalItems) {
      viewport.innerHTML = '<div style="padding:40px 20px;color:var(--text-muted);font-size:14px;text-align:center;">' + t('no_matching') + '</div>';
      viewport.style.height = 'auto';
      return;
    }

    var startIndex = Math.max(0, Math.floor(scrollTop / FONT_ITEM_HEIGHT) - OVERSCAN);
    var endIndex = Math.min(totalItems, Math.ceil((scrollTop + viewportHeight) / FONT_ITEM_HEIGHT) + OVERSCAN);

    var fragment = document.createDocumentFragment();

    // Top spacer
    if (startIndex > 0) {
      var topSpacer = document.createElement('div');
      topSpacer.style.height = (startIndex * FONT_ITEM_HEIGHT) + 'px';
      fragment.appendChild(topSpacer);
    }

    for (var i = startIndex; i < endIndex; i++) {
      var font = filteredFontsCache[i];
      var name = font.name || font.file;

      var item = document.createElement('div');
      item.className = 'sheet-font-item' + (font.file === currentFontFile ? ' selected' : '');
      item.dataset.fontFile = font.file;
      item.dataset.fontIndex = i;
      item.setAttribute('role', 'option');
      item.setAttribute('aria-selected', font.file === currentFontFile ? 'true' : 'false');

      var info = document.createElement('div');
      info.className = 'sheet-font-item-info';

      var nameEl = document.createElement('div');
      nameEl.className = 'sheet-font-item-name';
      nameEl.textContent = name;

      var meta = document.createElement('div');
      meta.className = 'sheet-font-item-meta';
      meta.textContent = categoryLabels[font.category] || font.category || '';

      var previewCanvas = document.createElement('canvas');
      previewCanvas.className = 'sheet-font-item-preview';
      previewCanvas.dataset.fontFile = font.file;

      info.appendChild(nameEl);
      info.appendChild(meta);
      info.appendChild(previewCanvas);
      item.appendChild(info);

      // Checkmark
      var check = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      check.setAttribute('class', 'sheet-font-item-check');
      check.setAttribute('viewBox', '0 0 24 24');
      check.setAttribute('fill', 'none');
      check.setAttribute('stroke', 'currentColor');
      check.setAttribute('stroke-width', '3');
      check.setAttribute('stroke-linecap', 'round');
      check.setAttribute('stroke-linejoin', 'round');
      var path = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
      path.setAttribute('points', '20 6 9 17 4 12');
      check.appendChild(path);
      item.appendChild(check);

      fragment.appendChild(item);
    }

    // Bottom spacer
    var bottomHeight = (totalItems - endIndex) * FONT_ITEM_HEIGHT;
    if (bottomHeight > 0) {
      var bottomSpacer = document.createElement('div');
      bottomSpacer.style.height = bottomHeight + 'px';
      fragment.appendChild(bottomSpacer);
    }

    previewQueue = [];
    viewport.innerHTML = '';
    viewport.appendChild(fragment);
    viewport.style.height = ''; // let spacers define height

    // Queue font previews for visible items
    var canvases = viewport.querySelectorAll('.sheet-font-item-preview');
    for (var ci = 0; ci < canvases.length; ci++) {
      queueFontPreview(canvases[ci].dataset.fontFile, canvases[ci]);
    }
  }

  // -- Font Preview Queue --
  var previewQueue = [];
  var activePreviewRequests = 0;
  var MAX_PREVIEW_CONCURRENT = 3;

  function queueFontPreview(fontFile, canvasEl) {
    var cacheKey = getCacheKey(fontFile, currentHeight);
    if (fontCache.has(cacheKey)) {
      renderFontPreviewCanvas(canvasEl, fontCache.get(cacheKey));
      return;
    }
    canvasEl.classList.add('loading');
    previewQueue.push({ fontFile: fontFile, canvas: canvasEl, height: currentHeight });
    processPreviewQueue();
  }

  function processPreviewQueue() {
    while (activePreviewRequests < MAX_PREVIEW_CONCURRENT && previewQueue.length > 0) {
      var job = previewQueue.shift();
      if (!document.contains(job.canvas)) continue;
      var cacheKey = getCacheKey(job.fontFile, job.height);
      if (fontCache.has(cacheKey)) {
        renderFontPreviewCanvas(job.canvas, fontCache.get(cacheKey));
        job.canvas.classList.remove('loading');
        continue;
      }
      activePreviewRequests++;
      rasterizeFontForPreview(job);
    }
  }

  function rasterizeFontForPreview(job) {
    var cacheKey = getCacheKey(job.fontFile, job.height);
    fetch('/api/rasterize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ font: job.fontFile, height: job.height, bold: 0, strategy: 'average' })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      fontCache.set(cacheKey, data);
      if (document.contains(job.canvas)) {
        renderFontPreviewCanvas(job.canvas, data);
        job.canvas.classList.remove('loading');
      }
    })
    .catch(function() {
      if (document.contains(job.canvas)) job.canvas.classList.remove('loading');
    })
    .finally(function() {
      activePreviewRequests--;
      processPreviewQueue();
    });
  }

  function renderFontPreviewCanvas(canvas, fontData) {
    var text = currentText || 'Abc';
    var color = getCurrentColor().hex;
    renderPreview(canvas, text, fontData, color, { cellSize: 2, maxWidth: 260 });
  }

  // Scroll handler (RAF-throttled)
  var sheetFontListWrap = document.getElementById('sheetFontListWrap');
  if (sheetFontListWrap) {
    sheetFontListWrap.addEventListener('scroll', function () {
      if (rafPending) return;
      rafPending = true;
      requestAnimationFrame(function () {
        rafPending = false;
        renderVirtualFontList();
      });
    }, { passive: true });
  }

  // Font sheet: item click (delegated)
  var sheetFontListViewport = document.getElementById('sheetFontListViewport');
  if (sheetFontListViewport) {
    sheetFontListViewport.addEventListener('click', function (e) {
      var item = e.target.closest('.sheet-font-item');
      if (!item) return;
      var fontFile = item.dataset.fontFile;
      var font = fontListData.find(function (f) { return f.file === fontFile; });
      if (!font) return;

      currentFontFile = font.file;
      currentFontName = font.name || font.file;

      // Update desktop sidebar selection too
      fontList.querySelectorAll('.font-item').forEach(function (el) {
        el.classList.toggle('selected', el.dataset.fontFile === font.file);
      });

      syncMobileFontName();
      loadAndRender();

      // Re-render virtual list to update selection
      renderVirtualFontList();

      // Close sheet after brief delay
      setTimeout(closeSheet, 200);
    });
  }

  // Font sheet: search
  var sheetFontSearchInput = document.getElementById('sheetFontSearch');
  var fontSearchDebounce = null;
  if (sheetFontSearchInput) {
    sheetFontSearchInput.addEventListener('input', function () {
      clearTimeout(fontSearchDebounce);
      fontSearchDebounce = setTimeout(function () {
        fontSheetFilter = sheetFontSearchInput.value;
        filteredFontsCache = getFilteredFonts();
        var viewport = document.getElementById('sheetFontListViewport');
        if (viewport) viewport.style.height = (filteredFontsCache.length * FONT_ITEM_HEIGHT) + 'px';
        var wrap = document.getElementById('sheetFontListWrap');
        if (wrap) wrap.scrollTop = 0;
        populateFontSheet();
      }, 150);
    });
  }

  // Font sheet: category tabs (delegated)
  var sheetFontTabs = document.getElementById('sheetFontTabs');
  if (sheetFontTabs) {
    sheetFontTabs.addEventListener('click', function (e) {
      var tab = e.target.closest('.font-tab');
      if (!tab) return;
      fontSheetCategory = tab.dataset.category;
      // Also sync desktop sidebar
      currentCategoryFilter = fontSheetCategory;
      populateFontSheet();
      renderFontListUI();
    });
  }

  // ============================================================
  // == Color Sheet                                             ==
  // ============================================================

  function populateColorSheet() {
    if (typeof DMC_COLORS === 'undefined' || !DMC_COLORS.length) return;

    var color = getCurrentColor();
    var swatch = document.getElementById('sheetColorSwatch');
    var nameEl = document.getElementById('sheetColorName');
    var codeEl = document.getElementById('sheetColorCode');
    if (swatch) swatch.style.backgroundColor = color.hex;
    if (nameEl) nameEl.textContent = color.name;
    if (codeEl) codeEl.textContent = 'DMC ' + color.code;

    var grid = document.getElementById('sheetColorGrid');
    if (!grid) return;
    grid.innerHTML = '';

    DMC_COLORS.forEach(function (c, index) {
      var dot = document.createElement('div');
      dot.className = 'color-dot' + (index === currentColorIndex ? ' selected' : '');
      dot.style.backgroundColor = c.hex;
      dot.dataset.index = index;

      dot.addEventListener('click', function () {
        currentColorIndex = index;

        // Update desktop sidebar
        colorRow.querySelectorAll('.color-dot').forEach(function (d) {
          d.classList.toggle('selected', parseInt(d.dataset.index) === index);
        });

        // Sync mobile color strip
        syncMobileColorStrip();

        // Update this sheet
        populateColorSheet();
        updatePreview();
      });

      grid.appendChild(dot);
    });
  }

  // ============================================================
  // == Settings Sheet                                          ==
  // ============================================================

  function syncSettingsSheet() {
    var sheetSlider = document.getElementById('sheetHeightSlider');
    var sheetValue = document.getElementById('sheetHeightValue');
    if (sheetSlider) sheetSlider.value = currentHeight;
    if (sheetValue) sheetValue.textContent = currentHeight;

    // Sync aida selection
    var sheetAidaRow = document.getElementById('sheetAidaRow');
    if (sheetAidaRow) {
      sheetAidaRow.querySelectorAll('.aida-chip').forEach(function (chip) {
        var count = chip.dataset.count;
        if (count === 'custom') {
          chip.classList.toggle('selected', isCustomAida);
        } else {
          chip.classList.toggle('selected', !isCustomAida && parseInt(count) === currentAida);
        }
      });
    }

    var sheetCustomRow = document.getElementById('sheetCustomStitchRow');
    if (sheetCustomRow) {
      sheetCustomRow.classList.toggle('visible', isCustomAida);
      if (isCustomAida) {
        var fmt = formatStitchDisplay(currentStitchMm);
        var sv = document.getElementById('sheetCustomStitchValue');
        var ss = document.getElementById('sheetCustomStitchSlider');
        var se = document.getElementById('sheetCustomStitchEquiv');
        var su = document.getElementById('sheetCustomStitchUnit');
        if (sv) sv.textContent = fmt.value;
        if (ss) ss.value = currentStitchMm;
        if (se) se.textContent = fmt.equiv;
        if (su) su.textContent = fmt.unit;
      }
    }
  }

  // Settings sheet: height slider
  var sheetHeightSlider = document.getElementById('sheetHeightSlider');
  var sheetHeightDebounce = null;
  if (sheetHeightSlider) {
    sheetHeightSlider.addEventListener('input', function () {
      var val = parseInt(this.value);
      var sheetValue = document.getElementById('sheetHeightValue');
      if (sheetValue) sheetValue.textContent = val;

      // Sync desktop slider + mobile slider
      heightSlider.value = val;
      heightValue.textContent = val;
      syncMobileHeightValue(val);

      clearTimeout(sheetHeightDebounce);
      sheetHeightDebounce = setTimeout(function () {
        currentHeight = val;
        loadAndRender();
      }, 300);
    });
  }

  // Settings sheet: aida chips
  var sheetAidaRow = document.getElementById('sheetAidaRow');
  if (sheetAidaRow) {
    sheetAidaRow.addEventListener('click', function (e) {
      var chip = e.target.closest('.aida-chip');
      if (!chip) return;
      var countVal = chip.dataset.count;

      // Deselect all in sheet
      sheetAidaRow.querySelectorAll('.aida-chip').forEach(function (c) { c.classList.remove('selected'); });
      chip.classList.add('selected');

      // Sync desktop
      aidaRow.querySelectorAll('.aida-chip').forEach(function (c) { c.classList.remove('selected'); });
      var desktopChip = aidaRow.querySelector('[data-count="' + countVal + '"]');
      if (desktopChip) desktopChip.classList.add('selected');

      var sheetCustomRow = document.getElementById('sheetCustomStitchRow');

      if (countVal === 'custom') {
        isCustomAida = true;
        if (customStitchRow) customStitchRow.classList.add('visible');
        if (sheetCustomRow) sheetCustomRow.classList.add('visible');
        updateCustomStitch(currentStitchMm, 'init');
      } else {
        isCustomAida = false;
        if (customStitchRow) customStitchRow.classList.remove('visible');
        if (sheetCustomRow) sheetCustomRow.classList.remove('visible');
        currentAida = parseInt(countVal);
        syncMobileAidaChips();
        updatePreview();
      }
    });
  }

  // Settings sheet: stitch length slider
  var sheetStitchSlider = document.getElementById('sheetCustomStitchSlider');
  if (sheetStitchSlider) {
    sheetStitchSlider.addEventListener('input', function () {
      if (isCustomAida) updateCustomStitch(parseFloat(this.value), 'sheet');
    });
  }

  // ============================================================
  // == Mobile Toolbar (Slider + 3 Buttons â†’ Sheets)           ==
  // ============================================================

  // -- Sync helpers --

  function syncMobileColorStrip() {
    // Update color button swatch and name
    var color = getCurrentColor();
    var swatch = document.getElementById('mobileColorSwatch');
    var nameEl = document.getElementById('mobileColorName');
    if (swatch) swatch.style.backgroundColor = color.hex;
    if (nameEl) nameEl.textContent = color.name;
  }

  function syncMobileHeightValue(val) {
    var el = document.getElementById('mobileHeightValue');
    var slider = document.getElementById('mobileHeightSlider');
    if (el) el.textContent = val;
    if (slider) slider.value = val;
  }

  function syncMobileAidaChips() {
    var el = document.getElementById('mobileAidaValue');
    if (el) el.textContent = (isCustomAida ? Math.round(currentAida) : currentAida) + ' ct';
  }

  function syncMobileFontName() {
    var el = document.getElementById('mobileFontName');
    if (el) el.textContent = currentFontName || 'Font';
  }

  // Kept for compatibility â€” no longer renders dots
  function populateMobileColorStrip() {
    syncMobileColorStrip();
  }

  // -- Mobile height slider --

  var mobileSlider = document.getElementById('mobileHeightSlider');
  var mobileSliderDebounce = null;
  if (mobileSlider) {
    mobileSlider.addEventListener('input', function () {
      var val = parseInt(this.value);
      var display = document.getElementById('mobileHeightValue');
      if (display) display.textContent = val;

      // Sync desktop + sheet sliders
      heightSlider.value = val;
      heightValue.textContent = val;
      var sheetSlider = document.getElementById('sheetHeightSlider');
      var sheetValue = document.getElementById('sheetHeightValue');
      if (sheetSlider) sheetSlider.value = val;
      if (sheetValue) sheetValue.textContent = val;

      clearTimeout(mobileSliderDebounce);
      mobileSliderDebounce = setTimeout(function () {
        currentHeight = val;
        loadAndRender();
      }, 300);
    });
  }

  // -- Aida button â†’ opens settings sheet --

  var mobileAidaBtn = document.getElementById('mobileAidaBtn');
  if (mobileAidaBtn) {
    mobileAidaBtn.addEventListener('click', function () {
      openSheet('settings');
    });
  }

  // -- Font button â†’ opens font sheet --

  var mobileFontBtn = document.getElementById('mobileFontBtn');
  if (mobileFontBtn) {
    mobileFontBtn.addEventListener('click', function () {
      openSheet('font');
    });
  }

  // -- Color button â†’ opens color sheet --

  var mobileColorBtn = document.getElementById('mobileColorBtn');
  if (mobileColorBtn) {
    mobileColorBtn.addEventListener('click', function () {
      openSheet('color');
    });
  }

  // -- Initialize mobile toolbar on load --

  function initMobileToolbar() {
    syncMobileColorStrip();
    syncMobileHeightValue(currentHeight);
    syncMobileAidaChips();
    syncMobileFontName();
  }

  // ============================================================
  // == Info Sheet                                              ==
  // ============================================================

  function syncInfoSheet() {
    var color = getCurrentColor();
    var sizeCm = document.getElementById('statSizeCm');
    var stitchW = document.getElementById('statStitchesW');
    var stitchH = document.getElementById('statStitchesH');
    var total = document.getElementById('statTotal');
    var dmc = document.getElementById('statDmc');
    var thread = document.getElementById('statThread');

    var infoSize = document.getElementById('infoSize');
    var infoStitches = document.getElementById('infoStitches');
    var infoCrosses = document.getElementById('infoCrosses');
    var infoDmc = document.getElementById('infoDmc');
    var infoThread = document.getElementById('infoThread');
    var infoRulerW = document.getElementById('infoRulerWidth');

    if (infoSize && sizeCm) infoSize.textContent = sizeCm.textContent || '-- x --';
    if (infoStitches && stitchW && stitchH) infoStitches.textContent = (stitchW.textContent || '--') + 'x' + (stitchH.textContent || '--');
    if (infoCrosses && total) infoCrosses.textContent = total.textContent || '--';
    if (infoDmc && dmc) infoDmc.textContent = dmc.textContent || '--';
    if (infoThread && thread) infoThread.textContent = thread.textContent || '--';
    // Sync unit label
    var infoSizeUnit = document.getElementById('infoSizeUnit');
    var statSizeUnit = document.getElementById('statSizeUnit');
    if (infoSizeUnit && statSizeUnit) infoSizeUnit.textContent = statSizeUnit.textContent;
    if (infoRulerW) {
      var rulerW = document.getElementById('rulerWidth');
      infoRulerW.textContent = rulerW ? rulerW.textContent : '--';
    }

    // Sync language selector
    var sheetLang = document.getElementById('sheetLangSelect');
    if (sheetLang) sheetLang.value = currentLang;
  }

  // Info sheet: language selector
  var sheetLangSelect = document.getElementById('sheetLangSelect');
  if (sheetLangSelect) {
    sheetLangSelect.addEventListener('change', function () {
      setLanguage(this.value);
      // Sync desktop selector
      var desktopSelect = document.getElementById('langSelect');
      if (desktopSelect) desktopSelect.value = this.value;
    });
  }

  // ============================================================
  // == Resize: close sheet if transitioning to desktop         ==
  // ============================================================

  var mobileResizeTimer;
  window.addEventListener('resize', function () {
    clearTimeout(mobileResizeTimer);
    mobileResizeTimer = setTimeout(function () {
      if (!isMobile() && activeSheet) {
        closeSheet();
      }
    }, 150);
  });

})();
</script>

</body>
</html>
