<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Word2Stitch â€” Cross-Stitch Pattern Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Anybody:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* -- Reset -- */
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #f5f0ea;
    --bg-deep: #ece5db;
    --panel: #faf8f5;
    --border: #e0d6c8;
    --border-light: #eae3d9;
    --text: #3d3229;
    --text-mid: #7a6e60;
    --text-muted: #a99e8f;
    --accent: #b83a2a;
    --accent-hover: #9c3023;
    --accent-soft: rgba(184, 58, 42, 0.08);
    --accent-glow: rgba(184, 58, 42, 0.15);
    --stitch-grid: #d8d0c5;
    --stitch-bold: #a09585;
    --radius: 10px;
    --radius-sm: 6px;
    --font-display: 'DM Serif Display', Georgia, serif;
    --font-body: 'Anybody', system-ui, sans-serif;
  }

  html, body { height: 100%; overflow: hidden; }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
    line-height: 1.4;
    -webkit-font-smoothing: antialiased;
  }

  /* -- Linen noise texture -- */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    pointer-events: none;
    opacity: 0.3;
    background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 20h40M20 0v40' stroke='%23c8bfb0' stroke-width='0.3'/%3E%3C/svg%3E");
    background-size: 40px 40px;
    z-index: 0;
  }

  /* -- Top Bar -- */
  .topbar {
    position: relative;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 10px 20px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }

  .logo {
    display: flex;
    align-items: baseline;
    gap: 0;
    flex-shrink: 0;
    user-select: none;
  }
  .logo-x {
    font-size: 18px;
    color: var(--accent);
    font-weight: 700;
    line-height: 1;
    margin-right: 3px;
  }
  .logo-text {
    font-family: var(--font-display);
    font-size: 20px;
    color: var(--text);
    letter-spacing: -0.3px;
  }
  .logo-text em {
    color: var(--accent);
    font-style: italic;
  }

  .topbar-sep {
    width: 1px;
    height: 24px;
    background: var(--border);
    flex-shrink: 0;
  }

  /* -- Text Input (in topbar) -- */
  .text-input-area {
    flex: 1;
    min-width: 0;
    position: relative;
  }
  .text-input {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 8px 14px;
    font-family: var(--font-display);
    font-size: 22px;
    color: var(--text);
    background: #fff;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .text-input::placeholder {
    color: var(--text-muted);
    font-style: italic;
  }
  .text-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  /* Download button in topbar */
  .btn-download {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 9px 18px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    font-family: var(--font-body);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    white-space: nowrap;
  }
  .btn-download:hover {
    background: var(--accent-hover);
    box-shadow: 0 3px 12px rgba(184,58,42,0.25);
    transform: translateY(-1px);
  }
  .btn-download:active { transform: translateY(0); }
  .btn-download svg { width: 15px; height: 15px; }

  /* -- Main Layout -- */
  .main-layout {
    position: relative;
    z-index: 1;
    display: flex;
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  /* -- Left Sidebar -- */
  .sidebar {
    width: 280px;
    flex-shrink: 0;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-section {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border-light);
  }
  .sidebar-section:last-child { border-bottom: none; }

  .section-header {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .section-header svg {
    width: 12px;
    height: 12px;
    opacity: 0.5;
  }

  /* -- Font search input -- */
  .font-search {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 6px 10px;
    font-family: var(--font-body);
    font-size: 12px;
    color: var(--text);
    background: #fff;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .font-search::placeholder {
    color: var(--text-muted);
  }
  .font-search:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  /* -- Font Category Tabs -- */
  .font-tabs {
    display: flex;
    gap: 3px;
    overflow-x: auto;
    flex-wrap: nowrap;
    padding: 8px 0 4px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .font-tabs::-webkit-scrollbar { height: 3px; }
  .font-tabs::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  .font-tab {
    flex-shrink: 0;
    padding: 3px 7px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: transparent;
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 10px;
    font-weight: 600;
    color: var(--text-mid);
    transition: all 0.12s;
    white-space: nowrap;
    line-height: 1.3;
  }
  .font-tab:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .font-tab.active {
    border-color: var(--accent);
    background: var(--accent-soft);
    color: var(--accent);
  }

  /* -- Font List -- */
  .font-list {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    gap: 3px;
    padding: 0 14px 10px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .font-list::-webkit-scrollbar { width: 5px; }
  .font-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .font-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border: 1.5px solid transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.12s;
    background: transparent;
    flex-shrink: 0;
  }
  .font-item:hover {
    background: var(--accent-soft);
    border-color: var(--border);
  }
  .font-item.selected {
    background: var(--accent-soft);
    border-color: var(--accent);
  }
  .font-item-info {
    min-width: 0;
    flex: 1;
  }
  .font-item-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .font-item-meta {
    font-size: 10px;
    color: var(--text-muted);
  }

  /* -- Height Slider -- */
  .height-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .height-slider {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    border-radius: 4px;
    background: var(--border);
    outline: none;
    transition: background 0.2s;
  }
  .height-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    transition: transform 0.1s;
  }
  .height-slider::-webkit-slider-thumb:hover {
    transform: scale(1.15);
  }
  .height-slider::-moz-range-thumb {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .height-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    font-family: var(--font-body);
    min-width: 32px;
    text-align: right;
    line-height: 1;
  }
  .height-unit {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* -- Color Swatches -- */
  .color-row {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    align-items: center;
  }
  .color-dot {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.12s;
    position: relative;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.08);
  }
  .color-dot:hover {
    transform: scale(1.2);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  .color-dot.selected {
    border-color: var(--text);
    box-shadow: 0 0 0 2px #fff, 0 0 0 3.5px var(--text);
    transform: scale(1.1);
  }
  .color-dot .tip {
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--text);
    color: #fff;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 10px;
    font-weight: 500;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.12s;
    z-index: 20;
  }
  .color-dot .tip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 3px solid transparent;
    border-top-color: var(--text);
  }
  .color-dot:hover .tip { opacity: 1; }

  /* -- Aida selector -- */
  .aida-row {
    display: flex;
    gap: 5px;
  }
  .aida-chip {
    flex: 1;
    text-align: center;
    padding: 8px 0;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-family: var(--font-body);
    background: transparent;
    transition: all 0.12s;
  }
  .aida-chip:hover { border-color: var(--accent); }
  .aida-chip.selected {
    border-color: var(--accent);
    background: var(--accent-soft);
  }
  .aida-chip-num {
    display: block;
    font-size: 17px;
    font-weight: 700;
    color: var(--text);
    line-height: 1.1;
  }
  .aida-chip.selected .aida-chip-num { color: var(--accent); }
  .aida-chip-label {
    font-size: 9px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  /* -- Custom count input -- */
  .custom-count-row {
    display: none;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
  }
  .custom-count-row.visible { display: flex; }
  .custom-count-input {
    width: 58px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 5px 8px;
    font-family: var(--font-body);
    font-size: 14px;
    font-weight: 700;
    color: var(--accent);
    text-align: center;
    background: #fff;
    outline: none;
    transition: border-color 0.15s;
  }
  .custom-count-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  .custom-unit-toggle {
    display: flex;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }
  .custom-unit-btn {
    padding: 5px 8px;
    border: none;
    background: transparent;
    font-family: var(--font-body);
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.12s;
    text-transform: uppercase;
  }
  .custom-unit-btn.active {
    background: var(--accent);
    color: #fff;
  }
  .custom-unit-btn:not(.active):hover {
    background: var(--accent-soft);
    color: var(--accent);
  }
  .custom-count-label {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 500;
    white-space: nowrap;
  }

  /* -- Preview Area (right) -- */
  .preview-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 0;
    overflow: hidden;
    padding: 20px;
    position: relative;
  }

  .preview-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: var(--text-muted);
    font-size: 15px;
    text-align: center;
  }
  .preview-empty svg {
    width: 48px;
    height: 48px;
    opacity: 0.25;
    margin-bottom: 4px;
  }
  .preview-empty span {
    font-family: var(--font-display);
    font-size: 16px;
    font-style: italic;
  }

  /* -- Loading overlay -- */
  .preview-loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(245, 240, 234, 0.85);
    z-index: 5;
    gap: 12px;
  }
  .preview-loading.hidden { display: none; }
  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text {
    font-family: var(--font-display);
    font-size: 15px;
    font-style: italic;
    color: var(--text-mid);
  }

  .preview-canvas-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    max-width: 100%;
    max-height: 100%;
  }

  #mainCanvas {
    image-rendering: pixelated;
    max-width: 100%;
    max-height: calc(100vh - 200px);
    object-fit: contain;
    border-radius: 2px;
  }

  /* -- Stats Bar (below canvas) -- */
  .stats-bar {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .stat-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 11px;
    color: var(--text-mid);
    white-space: nowrap;
    transition: all 0.2s;
  }
  .stat-pill strong {
    color: var(--text);
    font-weight: 700;
  }
  .stat-pill .unit {
    color: var(--text-muted);
    font-size: 10px;
  }

  .stat-pill.size-pill {
    background: var(--accent-soft);
    border-color: var(--accent);
  }
  .stat-pill.size-pill strong {
    color: var(--accent);
    font-size: 13px;
  }

  .stat-sep {
    color: var(--border);
    font-size: 11px;
    padding: 0 2px;
  }

  /* -- Ruler visualization -- */
  .ruler-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    width: 100%;
    max-width: 600px;
  }

  .ruler-line {
    display: flex;
    align-items: center;
    gap: 0;
  }
  .ruler-edge {
    width: 1px;
    height: 10px;
    background: var(--accent);
    flex-shrink: 0;
  }
  .ruler-bar {
    flex: 1;
    height: 1.5px;
    background: var(--accent);
    position: relative;
  }
  .ruler-label {
    position: absolute;
    top: -16px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
    white-space: nowrap;
    font-family: var(--font-body);
  }

  .ruler-height-wrap {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .ruler-height-label {
    font-size: 11px;
    color: var(--text-muted);
  }
  .ruler-height-val {
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
  }

  /* -- Sidebar toggle & drawer backdrop (disabled - no longer used) -- */
  .sidebar-toggle {
    display: none;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    background: #fff;
    cursor: pointer;
    flex-shrink: 0;
    transition: border-color 0.15s, background 0.15s;
    position: relative;
  }
  .sidebar-toggle:hover { border-color: var(--accent); }
  .sidebar-toggle.active { border-color: var(--accent); background: var(--accent-soft); }
  .sidebar-toggle svg { width: 18px; height: 18px; color: var(--text-mid); }
  .sidebar-toggle.active svg { color: var(--accent); }

  .drawer-backdrop {
    display: none !important;
  }

  /* ============================================= */
  /* -- Responsive: Mobile (<=640px) -- */
  /* Vertical stack: topbar -> preview -> controls */
  /* ============================================= */
  @media (max-width: 640px) {
    html, body { overflow: auto; height: auto; min-height: 100vh; }
    body { height: auto; }

    .topbar { padding: 8px 12px; gap: 8px; }
    .topbar-sep, .logo { display: none; }
    .sidebar-toggle { display: none; }

    .text-input { font-size: 16px; min-height: 44px; }

    .main-layout {
      flex-direction: column;
      overflow: visible;
      min-height: 0;
    }

    .sidebar {
      width: 100%;
      order: 2;
      border-right: none;
      border-top: 1px solid var(--border);
      overflow: visible;
      max-height: none;
    }

    .preview-area {
      order: 1;
      min-height: 250px;
      max-height: 50vh;
      padding: 12px;
    }

    #mainCanvas { max-height: 45vh; }

    .font-list { max-height: 300px; }

    /* Larger touch targets */
    .font-item { min-height: 48px; padding: 12px 14px; }
    .font-item-name { font-size: 15px; }
    .color-dot { width: 40px; height: 40px; }
    .aida-chip { min-height: 52px; padding: 12px 4px; }
    .aida-chip-num { font-size: 22px; }
    .font-tab { min-height: 36px; padding: 6px 12px; font-size: 12px; }
    .font-search { min-height: 44px; font-size: 16px; }
    .height-slider { height: 10px; }
    .height-slider::-webkit-slider-thumb { width: 24px; height: 24px; }
    .height-slider::-moz-range-thumb { width: 24px; height: 24px; }
    .custom-count-input { min-height: 44px; font-size: 16px; }
    .sidebar-section { padding: 14px 16px; }
    .font-list { padding: 0 16px 12px; }

    .stats-bar { gap: 4px; }
    .stat-pill { font-size: 11px; }
  }

  /* ============================================= */
  /* -- Responsive: Small phones (<=380px) -- */
  /* ============================================= */
  @media (max-width: 380px) {
    .text-input { font-size: 16px; padding: 8px 10px; }
    .btn-download { padding: 8px 12px; }
    .preview-area { padding: 8px; min-height: 200px; }
    .color-dot { width: 36px; height: 36px; }
  }

  /* ============================================= */
  /* -- Responsive: Tablet (641-1024px) -- */
  /* ============================================= */
  @media (min-width: 641px) and (max-width: 1024px) {
    .sidebar { width: 250px; }
    .sidebar-toggle { display: none; }
    .text-input { font-size: 18px; }
  }

  /* ============================================= */
  /* -- Responsive: Desktop (>1024px) -- */
  /* ============================================= */
  @media (min-width: 1025px) {
    .sidebar { width: 300px; }
    .sidebar-toggle { display: none; }
  }

  /* -- Language selector -- */
  .lang-select {
    flex-shrink: 0;
    padding: 4px 6px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    background: #fff;
    font-family: var(--font-body);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-mid);
    cursor: pointer;
    outline: none;
    transition: border-color 0.15s;
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23a99e8f'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 6px center;
    padding-right: 20px;
  }
  .lang-select:hover, .lang-select:focus { border-color: var(--accent); }

  /* -- Scrollbar global -- */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
</style>
</head>
<body>

<!-- -- Top Bar -- -->
<div class="topbar">
  <div class="logo">
    <span class="logo-x">&#10006;</span>
    <span class="logo-text">Word<em>2</em>Stitch</span>
  </div>

  <div class="topbar-sep"></div>

  <div class="text-input-area">
    <input
      type="text"
      class="text-input"
      id="textInput"
      placeholder="Type your text here..."
      data-i18n-placeholder="placeholder_text"
      value="Welcome"
      maxlength="40"
      autocomplete="off"
      spellcheck="false"
    />
  </div>

  <select class="lang-select" id="langSelect">
    <option value="en">ðŸ‡¬ðŸ‡§ EN</option>
    <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
    <option value="fr">ðŸ‡«ðŸ‡· FR</option>
    <option value="de">ðŸ‡©ðŸ‡ª DE</option>
    <option value="it">ðŸ‡®ðŸ‡¹ IT</option>
    <option value="pt">ðŸ‡§ðŸ‡· PT</option>
    <option value="nl">ðŸ‡³ðŸ‡± NL</option>
    <option value="ja">ðŸ‡¯ðŸ‡µ JA</option>
    <option value="ko">ðŸ‡°ðŸ‡· KO</option>
    <option value="zh">ðŸ‡¨ðŸ‡³ ZH</option>
    <option value="ru">ðŸ‡·ðŸ‡º RU</option>
    <option value="pl">ðŸ‡µðŸ‡± PL</option>
    <option value="sv">ðŸ‡¸ðŸ‡ª SV</option>
    <option value="da">ðŸ‡©ðŸ‡° DA</option>
    <option value="fi">ðŸ‡«ðŸ‡® FI</option>
    <option value="uk">ðŸ‡ºðŸ‡¦ UK</option>
    <option value="hu">ðŸ‡­ðŸ‡º HU</option>
  </select>

  <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle controls" data-i18n-aria="toggle_controls">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
      <line x1="3" y1="6" x2="21" y2="6"/>
      <line x1="3" y1="12" x2="21" y2="12"/>
      <line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
  </button>

  <button class="btn-download" id="btnDownload">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="7 10 12 15 17 10"/>
      <line x1="12" y1="15" x2="12" y2="3"/>
    </svg>
    <span class="dl-label">PDF</span>
  </button>
</div>

<!-- Drawer backdrop (mobile) -->
<div class="drawer-backdrop" id="drawerBackdrop"></div>

<!-- -- Main Split Layout -- -->
<div class="main-layout">

  <!-- -- Left Sidebar: Controls -- -->
  <div class="sidebar">

    <!-- Font Search + Header -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
        <span data-i18n="section_font">Font</span>
      </div>
      <input
        type="text"
        class="font-search"
        id="fontSearch"
        placeholder="Search fonts..."
        data-i18n-placeholder="search_fonts"
        autocomplete="off"
        spellcheck="false"
      />
      <div class="font-tabs" id="fontCategoryTabs">
        <button class="font-tab active" data-category="all">All</button>
      </div>
    </div>

    <!-- Font List (scrollable) -->
    <div class="font-list" id="fontList"></div>

    <!-- Height Control -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h4M18 12h4M7 7l2 2M15 15l2 2M7 17l2-2M15 7l2-2"/></svg>
        <span data-i18n="section_height">Stitch Height</span>
      </div>
      <div class="height-control">
        <input type="range" class="height-slider" id="heightSlider" min="4" max="30" value="18" step="1" />
        <div>
          <span class="height-value" id="heightValue">18</span>
          <span class="height-unit" data-i18n="unit_px">px</span>
        </div>
      </div>
    </div>

    <!-- Color Picker -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
        <span data-i18n="section_color">Thread Color</span>
      </div>
      <div class="color-row" id="colorRow"></div>
    </div>

    <!-- Aida Count -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
        <span data-i18n="section_fabric">Fabric</span>
      </div>
      <div class="aida-row" id="aidaRow">
        <button class="aida-chip" data-count="11">
          <span class="aida-chip-num">11</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip selected" data-count="14">
          <span class="aida-chip-num">14</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip" data-count="16">
          <span class="aida-chip-num">16</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip" data-count="18">
          <span class="aida-chip-num">18</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip" data-count="custom" id="aidaCustomChip">
          <span class="aida-chip-num">âœŽ</span>
          <span class="aida-chip-label">Custom</span>
        </button>
      </div>
      <div class="custom-count-row" id="customCountRow">
        <input type="number" class="custom-count-input" id="customCountInput" min="1" max="100" value="14" step="0.5" />
        <div class="custom-unit-toggle" id="customUnitToggle">
          <button class="custom-unit-btn active" data-unit="inch">/ inch</button>
          <button class="custom-unit-btn" data-unit="cm">/ cm</button>
        </div>
        <span class="custom-count-label" id="customCountLabel">= 14 ct</span>
      </div>
    </div>

  </div>

  <!-- -- Right: Preview -- -->
  <div class="preview-area" id="previewArea">

    <!-- Loading overlay -->
    <div class="preview-loading hidden" id="previewLoading">
      <div class="loading-spinner"></div>
      <div class="loading-text" data-i18n="loading_text">Rasterizing...</div>
    </div>

    <div class="preview-empty" id="previewEmpty">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <line x1="3" y1="9" x2="21" y2="9"/>
        <line x1="3" y1="15" x2="21" y2="15"/>
        <line x1="9" y1="3" x2="9" y2="21"/>
        <line x1="15" y1="3" x2="15" y2="21"/>
      </svg>
      <span data-i18n="empty_state">Type something to see your pattern</span>
    </div>

    <div class="preview-canvas-wrap" id="previewWrap" style="display:none;">
      <canvas id="mainCanvas"></canvas>

      <!-- Ruler showing width in cm -->
      <div class="ruler-info" id="rulerInfo">
        <div class="ruler-line">
          <div class="ruler-edge"></div>
          <div class="ruler-bar">
            <div class="ruler-label" id="rulerWidth">--</div>
          </div>
          <div class="ruler-edge"></div>
        </div>
      </div>

      <!-- Stats pills -->
      <div class="stats-bar" id="statsBar">
        <div class="stat-pill size-pill">
          <strong id="statSizeCm">--</strong>
          <span class="unit" data-i18n="unit_cm">cm</span>
        </div>
        <div class="stat-sep">.</div>
        <div class="stat-pill">
          <strong id="statStitchesW">--</strong>x<strong id="statStitchesH">--</strong>
          <span class="unit" data-i18n="unit_stitches">stitches</span>
        </div>
        <div class="stat-sep">.</div>
        <div class="stat-pill">
          <strong id="statTotal">--</strong>
          <span class="unit" data-i18n="unit_crosses">crosses</span>
        </div>
        <div class="stat-sep">.</div>
        <div class="stat-pill">
          DMC <strong id="statDmc">--</strong>
          <span class="unit" id="statThread">--</span>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ================================================ -->
<!-- ==  JavaScript                                 == -->
<!-- ================================================ -->

<!-- â•â•â• jsPDF CDN â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- â•â•â• Embedded Font & Color Data â•â•â• -->
<script>
// DMC thread color data for word2stitch
const DMC_COLORS = [
  {"code":"310","name":"Black","hex":"#000000"},
  {"code":"321","name":"Christmas Red","hex":"#C72C2C"},
  {"code":"blanc","name":"White","hex":"#FFFFFF"},
  {"code":"498","name":"Christmas Red Dark","hex":"#A7132B"},
  {"code":"666","name":"Bright Red","hex":"#E31D42"},
  {"code":"336","name":"Navy Blue","hex":"#253B73"},
  {"code":"796","name":"Royal Blue Dark","hex":"#13395F"},
  {"code":"699","name":"Christmas Green","hex":"#056533"},
  {"code":"702","name":"Kelly Green","hex":"#5CA462"},
  {"code":"553","name":"Violet","hex":"#9B6E94"},
  {"code":"550","name":"Violet Very Dark","hex":"#501A55"},
  {"code":"720","name":"Orange Spice Dark","hex":"#E55B00"},
  {"code":"741","name":"Tangerine Medium","hex":"#FFA300"},
  {"code":"307","name":"Lemon","hex":"#FDED54"},
  {"code":"444","name":"Lemon Dark","hex":"#FFD600"},
  {"code":"3846","name":"Bright Turquoise Light","hex":"#06E3E6"},
  {"code":"3801","name":"Christmas Red Very Dark","hex":"#E50033"},
  {"code":"3607","name":"Plum Light","hex":"#E74F86"},
  {"code":"738","name":"Tan Very Light","hex":"#ECCC9E"},
  {"code":"414","name":"Steel Gray Dark","hex":"#8C8C8C"}
];


// Add RGB values to DMC colors (PDF engine needs r,g,b)
DMC_COLORS.forEach(function(c) {
  if (c.hex && !c.r) {
    c.r = parseInt(c.hex.slice(1, 3), 16);
    c.g = parseInt(c.hex.slice(3, 5), 16);
    c.b = parseInt(c.hex.slice(5, 7), 16);
  }
});
</script>

<!-- â•â•â• PDF Generation Engine â•â•â• -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Word2Stitch â€” PDF Generation Engine
//  Generates cross-stitch pattern PDFs from bitmap font data
//  Depends on jsPDF loaded via CDN (window.jspdf.jsPDF)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Convert text string to a 2D boolean bitmap using bitmap font glyph data.
 * Handles letter spacing, space width, and missing glyphs gracefully.
 *
 * @param {string} text - The text to render
 * @param {object} fontData - Font object with glyphs, height, letterSpacing, spaceWidth
 * @returns {boolean[][]} 2D array where true = filled stitch, false = empty
 */
function getTextBitmapForPDF(text, fontData) {
  if (!text || !fontData || !fontData.glyphs) return [];

  const glyphs = fontData.glyphs;
  const letterSpacing = fontData.letterSpacing ?? 1;
  const spaceWidth = fontData.spaceWidth ?? 3;

  // Determine the max glyph height from the font data
  const fontHeight = fontData.height || Math.max(
    1,
    ...Object.values(glyphs).map(g =>
      g.bitmap ? g.bitmap.length : 0
    )
  );

  // Build columns for each character, then concatenate
  const charColumns = [];

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];

    // Add spacing between characters (not before the first one)
    if (i > 0 && letterSpacing > 0) {
      for (let s = 0; s < letterSpacing; s++) {
        const emptyCol = new Array(fontHeight).fill(false);
        charColumns.push(emptyCol);
      }
    }

    if (ch === ' ' || !glyphs[ch]) {
      // Space or missing glyph: insert empty columns
      const w = ch === ' ' ? spaceWidth : spaceWidth;
      for (let s = 0; s < w; s++) {
        charColumns.push(new Array(fontHeight).fill(false));
      }
      continue;
    }

    const glyph = glyphs[ch];
    const bitmap = glyph.bitmap || [];
    const glyphWidth = glyph.width || (bitmap[0] ? bitmap[0].length : 0);
    const glyphHeight = bitmap.length;

    // Vertically align glyph to bottom of font height
    const yOffset = fontHeight - glyphHeight;

    for (let col = 0; col < glyphWidth; col++) {
      const column = new Array(fontHeight).fill(false);
      for (let row = 0; row < glyphHeight; row++) {
        if (bitmap[row] && col < bitmap[row].length && bitmap[row][col] === '1') {
          column[yOffset + row] = true;
        }
      }
      charColumns.push(column);
    }
  }

  if (charColumns.length === 0) return [];

  // Convert column-based data to row-based 2D array
  const width = charColumns.length;
  const result = [];
  for (let row = 0; row < fontHeight; row++) {
    const rowData = [];
    for (let col = 0; col < width; col++) {
      rowData.push(charColumns[col][row]);
    }
    result.push(rowData);
  }

  return result;
}

/**
 * Calculate multi-page layout for the pattern grid.
 *
 * @param {number} width - Total bitmap width in cells
 * @param {number} height - Total bitmap height in cells
 * @param {number} cellSize - Cell size in mm
 * @param {number} pageW - Usable page width in mm
 * @param {number} pageH - Usable page height in mm
 * @returns {object} Layout info: colsPerPage, rowsPerPage, pagesX, pagesY, totalPages
 */
function calculatePDFLayout(width, height, cellSize, pageW, pageH) {
  // Reserve space for coordinate labels on left (~8mm) and top (~6mm)
  const labelMarginLeft = 8;
  const labelMarginTop = 6;

  const availableW = pageW - labelMarginLeft;
  const availableH = pageH - labelMarginTop;

  const colsPerPage = Math.max(1, Math.floor(availableW / cellSize));
  const rowsPerPage = Math.max(1, Math.floor(availableH / cellSize));

  const pagesX = Math.max(1, Math.ceil(width / colsPerPage));
  const pagesY = Math.max(1, Math.ceil(height / rowsPerPage));

  return {
    colsPerPage,
    rowsPerPage,
    pagesX,
    pagesY,
    totalPages: pagesX * pagesY,
    labelMarginLeft,
    labelMarginTop,
  };
}

/**
 * Draw one page section of the pattern grid.
 *
 * @param {jsPDF} pdf - jsPDF instance
 * @param {boolean[][]} bitmap - Full 2D bitmap
 * @param {object} color - { r, g, b } thread color
 * @param {number} startCol - First column index for this page
 * @param {number} startRow - First row index for this page
 * @param {number} colsPerPage - Max columns that fit on one page
 * @param {number} rowsPerPage - Max rows that fit on one page
 * @param {number} cellSize - Cell size in mm
 * @param {object} margins - { left, top } in mm
 * @param {object} layout - Layout info from calculatePDFLayout
 */
function drawGridPage(pdf, bitmap, color, startCol, startRow, colsPerPage, rowsPerPage, cellSize, margins, layout) {
  const totalWidth = bitmap[0] ? bitmap[0].length : 0;
  const totalHeight = bitmap.length;

  // How many cells to actually draw on this page
  const endCol = Math.min(startCol + colsPerPage, totalWidth);
  const endRow = Math.min(startRow + rowsPerPage, totalHeight);
  const drawCols = endCol - startCol;
  const drawRows = endRow - startRow;

  const offsetX = margins.left + layout.labelMarginLeft;
  const offsetY = margins.top + layout.labelMarginTop;

  // Determine symbol color based on luminance
  const luminance = (0.299 * color.r + 0.587 * color.g + 0.114 * color.b) / 255;
  const symbolIsWhite = luminance < 0.5;

  // 1. Draw filled cells
  for (let row = startRow; row < endRow; row++) {
    for (let col = startCol; col < endCol; col++) {
      if (bitmap[row] && bitmap[row][col]) {
        const x = offsetX + (col - startCol) * cellSize;
        const y = offsetY + (row - startRow) * cellSize;

        // Fill cell with thread color
        pdf.setFillColor(color.r, color.g, color.b);
        pdf.rect(x, y, cellSize, cellSize, 'F');

        // Draw cross symbol centered in cell (only if cell is large enough to be readable)
        if (cellSize >= 1.5) {
          if (symbolIsWhite) {
            pdf.setTextColor(255, 255, 255);
          } else {
            pdf.setTextColor(0, 0, 0);
          }
          pdf.setFontSize(Math.max(4, cellSize * 2.2));
          pdf.text(
            '\u00D7',
            x + cellSize / 2,
            y + cellSize / 2 + cellSize * 0.12,
            { align: 'center' }
          );
        }
      }
    }
  }

  // 2. Draw grid lines

  // Thin grid lines (every cell)
  pdf.setDrawColor(204, 204, 204); // #ccc
  pdf.setLineWidth(0.1);

  for (let col = 0; col <= drawCols; col++) {
    const x = offsetX + col * cellSize;
    pdf.line(x, offsetY, x, offsetY + drawRows * cellSize);
  }
  for (let row = 0; row <= drawRows; row++) {
    const y = offsetY + row * cellSize;
    pdf.line(offsetX, y, offsetX + drawCols * cellSize, y);
  }

  // Bold grid lines (every 10 cells)
  pdf.setDrawColor(51, 51, 51); // #333
  pdf.setLineWidth(0.3);

  for (let col = 0; col <= drawCols; col++) {
    const absCol = startCol + col;
    if (absCol % 10 === 0) {
      const x = offsetX + col * cellSize;
      pdf.line(x, offsetY, x, offsetY + drawRows * cellSize);
    }
  }
  for (let row = 0; row <= drawRows; row++) {
    const absRow = startRow + row;
    if (absRow % 10 === 0) {
      const y = offsetY + row * cellSize;
      pdf.line(offsetX, y, offsetX + drawCols * cellSize, y);
    }
  }

  // Bold border around the grid area
  pdf.setDrawColor(51, 51, 51);
  pdf.setLineWidth(0.3);
  pdf.rect(offsetX, offsetY, drawCols * cellSize, drawRows * cellSize, 'S');

  // 3. Coordinate labels every 10 cells

  pdf.setFontSize(5);
  pdf.setTextColor(120, 120, 120);

  // Top edge labels
  for (let col = 0; col <= drawCols; col++) {
    const absCol = startCol + col;
    if (absCol % 10 === 0 && absCol > 0) {
      const x = offsetX + col * cellSize;
      pdf.text(String(absCol), x, offsetY - 1, { align: 'center' });
    }
  }

  // Left edge labels
  for (let row = 0; row <= drawRows; row++) {
    const absRow = startRow + row;
    if (absRow % 10 === 0 && absRow > 0) {
      const y = offsetY + row * cellSize + 0.3;
      pdf.text(String(absRow), offsetX - 1.5, y, { align: 'right' });
    }
  }

  // 4. Verification scale bar (1:1 print check)
  // Draw a 10mm bar at bottom-right so users can verify print scale with a ruler
  const gridBottom = offsetY + drawRows * cellSize;
  const gridRight = offsetX + drawCols * cellSize;
  const barLen = 10; // exactly 10mm
  const barY = gridBottom + 5;
  const barX = gridRight - barLen;

  // Bar line
  pdf.setDrawColor(184, 58, 42);
  pdf.setLineWidth(0.4);
  pdf.line(barX, barY, barX + barLen, barY);
  // End ticks
  pdf.line(barX, barY - 1.5, barX, barY + 1.5);
  pdf.line(barX + barLen, barY - 1.5, barX + barLen, barY + 1.5);
  // Label
  pdf.setFontSize(5.5);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(184, 58, 42);
  pdf.text('\u2190 10 mm \u2192', barX + barLen / 2, barY - 2.5, { align: 'center' });
  pdf.setFontSize(4.5);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(140, 130, 120);
  pdf.text('Verify: measure this bar with a ruler. Must be exactly 10 mm.', barX + barLen / 2, barY + 3.5, { align: 'center' });
}

/**
 * Draw the legend/materials page.
 *
 * @param {jsPDF} pdf - jsPDF instance
 * @param {object} color - { code, name, hex, r, g, b }
 * @param {number} stitchCount - Total filled stitches
 * @param {number} aidaCount - Fabric count (11, 14, 16, 18)
 * @param {number} width - Pattern width in stitches
 * @param {number} height - Pattern height in stitches
 * @param {string} fontName - Name of the font used
 */
function drawLegend(pdf, color, stitchCount, aidaCount, width, height, fontName, text, pageNum, totalPages, pageW, pageH) {
  const margin = 15;
  pageW = pageW || 210;
  pageH = pageH || 297;

  // Branded header + footer
  drawBrandedHeader(pdf, text || '', fontName, width, height, pageNum, totalPages, margin, pageW);
  drawBrandedFooter(pdf, margin, pageW, pageH);

  let y = margin + 18; // after branded header bar

  // Title
  pdf.setFontSize(16);
  pdf.setTextColor(184, 58, 42); // accent color
  pdf.setFont('helvetica', 'bold');
  pdf.text('Thread Legend', margin, y);
  pdf.setFontSize(10);
  pdf.setTextColor(120, 120, 120);
  pdf.setFont('helvetica', 'normal');
  pdf.text(' / Leyenda de Hilos', margin + 42, y);
  y += 10;

  // Thread calculation: ~0.013m per full cross stitch at Aida 14
  // (4 diagonal passes Ã— stitch_size Ã— âˆš2 + 20% waste), scaled by fabric count
  const metersPerStitch = 0.013 * (14 / aidaCount);
  const meters = stitchCount * metersPerStitch;
  const skeins = Math.ceil(meters / 8);

  // Table width adapts to page
  const contentW = pageW - margin * 2;
  const tW = Math.min(contentW, 220);
  const colPcts = [0, 0.10, 0.19, 0.31, 0.52, 0.68, 0.84];
  const colX = colPcts.map(function(p) { return margin + p * tW; });
  const colLabels = ['Symbol', 'Swatch', 'DMC Code', 'Color Name', 'Stitches', 'Thread', 'Skeins'];

  // Table header
  pdf.setFillColor(245, 240, 235);
  pdf.rect(margin, y - 3, tW, 8, 'F');
  pdf.setFontSize(8);
  pdf.setTextColor(80, 80, 80);
  pdf.setFont('helvetica', 'bold');
  for (let i = 0; i < colLabels.length; i++) {
    pdf.text(colLabels[i], colX[i] + 1, y + 2);
  }
  y += 10;

  // Header line
  pdf.setDrawColor(200, 190, 175);
  pdf.setLineWidth(0.3);
  pdf.line(margin, y - 2, margin + tW, y - 2);

  // Data row
  const luminance = (0.299 * color.r + 0.587 * color.g + 0.114 * color.b) / 255;

  // Symbol cell
  pdf.setFillColor(color.r, color.g, color.b);
  pdf.rect(colX[0] + 1, y - 2, 10, 7, 'F');
  pdf.setTextColor(luminance < 0.5 ? 255 : 0, luminance < 0.5 ? 255 : 0, luminance < 0.5 ? 255 : 0);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.text('\u00D7', colX[0] + 6, y + 3, { align: 'center' });

  // Color swatch
  pdf.setFillColor(color.r, color.g, color.b);
  pdf.rect(colX[1] + 1, y - 2, 14, 7, 'F');
  pdf.setDrawColor(180, 170, 160);
  pdf.setLineWidth(0.15);
  pdf.rect(colX[1] + 1, y - 2, 14, 7, 'S');

  // Text values
  pdf.setTextColor(60, 60, 60);
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(9);
  pdf.text('DMC ' + color.code, colX[2] + 1, y + 2.5);
  pdf.text(color.name || '', colX[3] + 1, y + 2.5);
  pdf.text(String(stitchCount), colX[4] + 1, y + 2.5);
  pdf.text(meters.toFixed(2) + ' m', colX[5] + 1, y + 2.5);
  pdf.text(String(skeins), colX[6] + 1, y + 2.5);
  y += 12;

  // Bottom line
  pdf.setDrawColor(200, 190, 175);
  pdf.setLineWidth(0.2);
  pdf.line(margin, y - 3, margin + tW, y - 3);
  y += 8;

  // â”€â”€ Pattern Information â”€â”€
  pdf.setFontSize(13);
  pdf.setTextColor(184, 58, 42);
  pdf.setFont('helvetica', 'bold');
  pdf.text('Pattern Information', margin, y);
  y += 9;

  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(9);
  pdf.setTextColor(70, 70, 70);

  const stitchMm = (25.4 / aidaCount).toFixed(2);
  const inchesW = (width / aidaCount).toFixed(2);
  const inchesH = (height / aidaCount).toFixed(2);
  const cmW = (width / aidaCount * 2.54).toFixed(1);
  const cmH = (height / aidaCount * 2.54).toFixed(1);

  const notes = [
    'Use 2 strands of DMC thread for cross stitches',
    'Start from the center of the fabric for best results',
    'Fabric: Aida ' + aidaCount.toFixed(1) + ' ct \u2014 Each stitch = ' + stitchMm + ' mm',
    'Pattern size: ' + width + ' \u00D7 ' + height + ' stitches',
    'Finished size: ' + cmW + ' \u00D7 ' + cmH + ' cm (' + inchesW + ' \u00D7 ' + inchesH + '")',
    'Total crosses: ' + stitchCount,
    'Thread required: ' + meters.toFixed(2) + ' m (' + skeins + ' skein' + (skeins !== 1 ? 's' : '') + ')',
    '\u26a0 Print at 100% scale (no fit-to-page) for 1:1 stitch size',
  ];

  for (const note of notes) {
    pdf.text('\u2022  ' + note, margin + 2, y);
    y += 5.8;
  }
  y += 6;

  // â”€â”€ Finished Size / Cut Fabric boxes â”€â”€
  pdf.setDrawColor(184, 58, 42);
  pdf.setLineWidth(0.4);
  pdf.setFillColor(253, 248, 244);
  const boxW = Math.min(tW / 2 - 4, 90);

  // Finished Size box
  pdf.rect(margin, y, boxW, 22, 'FD');
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(184, 58, 42);
  pdf.text('Finished Size', margin + 4, y + 6);
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(11);
  pdf.setTextColor(60, 60, 60);
  pdf.text(cmW + ' \u00D7 ' + cmH + ' cm', margin + 4, y + 13);
  pdf.setFontSize(8);
  pdf.setTextColor(140, 130, 120);
  pdf.text('(' + inchesW + ' \u00D7 ' + inchesH + '")', margin + 4, y + 18);

  // Cut Fabric box (add 3" margin each side)
  const cutX = margin + boxW + 8;
  pdf.setDrawColor(184, 58, 42);
  pdf.setFillColor(253, 248, 244);
  pdf.rect(cutX, y, boxW, 22, 'FD');
  const cutInW = (parseFloat(inchesW) + 6).toFixed(1);
  const cutInH = (parseFloat(inchesH) + 6).toFixed(1);
  const cutCmW = (cutInW * 2.54).toFixed(1);
  const cutCmH = (cutInH * 2.54).toFixed(1);
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(184, 58, 42);
  pdf.text('Cut Fabric', cutX + 4, y + 6);
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(11);
  pdf.setTextColor(60, 60, 60);
  pdf.text(cutCmW + ' \u00D7 ' + cutCmH + ' cm', cutX + 4, y + 13);
  pdf.setFontSize(8);
  pdf.setTextColor(140, 130, 120);
  pdf.text('(+3" margin each side)', cutX + 4, y + 18);

}

/**
 * Draw branded header bar on a PDF page.
 * Crimson accent bar + logo text + pattern info + page number.
 */
function drawBrandedHeader(pdf, text, fontName, patternWidth, patternHeight, pageNum, totalPages, margin, pageW) {
  const barY = margin - 2;
  const barH = 12;

  // Accent bar background
  pdf.setFillColor(184, 58, 42); // var(--accent) #b83a2a
  pdf.rect(margin, barY, pageW - margin * 2, barH, 'F');

  // Logo: âœ• Word2Stitch
  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(9);
  pdf.setTextColor(255, 255, 255);
  pdf.text('\u2715 Word2Stitch', margin + 3, barY + 5);

  // Pattern description
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(7);
  pdf.setTextColor(255, 230, 225);
  const desc = '"' + truncate(text, 25) + '" \u00B7 ' + fontName + ' \u00B7 ' +
    patternWidth + '\u00D7' + patternHeight;
  pdf.text(desc, margin + 3, barY + 9.5);

  // Page number (right-aligned)
  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(8);
  pdf.setTextColor(255, 255, 255);
  pdf.text(pageNum + ' / ' + totalPages, pageW - margin - 3, barY + 7, { align: 'right' });
}

/**
 * Draw branded footer on a PDF page.
 * Thin accent line + branding text + date.
 */
function drawBrandedFooter(pdf, margin, pageW, pageH) {
  const footerY = pageH - margin + 2;

  // Accent line
  pdf.setDrawColor(184, 58, 42);
  pdf.setLineWidth(0.5);
  pdf.line(margin, footerY, pageW - margin, footerY);

  // Left: branding
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(7);
  pdf.setTextColor(184, 58, 42);
  pdf.text('\u2715 Word2Stitch \u2014 Cross-Stitch Pattern Generator', margin, footerY + 4);

  // Right: date
  pdf.setTextColor(160, 150, 140);
  var now = new Date();
  var dateStr = now.getFullYear() + '-' +
    String(now.getMonth() + 1).padStart(2, '0') + '-' +
    String(now.getDate()).padStart(2, '0');
  pdf.text(dateStr, pageW - margin, footerY + 4, { align: 'right' });
}

/**
 * Build the PDF document with given orientation.
 * Returns { pdf, filename } without saving.
 */
function buildPDF(text, fontData, dmcColor, aidaCount, orientation) {
  const bitmap = getTextBitmapForPDF(text, fontData);
  if (bitmap.length === 0 || !bitmap[0] || bitmap[0].length === 0) {
    return null;
  }

  const patternWidth = bitmap[0].length;
  const patternHeight = bitmap.length;

  let stitchCount = 0;
  for (let row = 0; row < patternHeight; row++) {
    for (let col = 0; col < patternWidth; col++) {
      if (bitmap[row][col]) stitchCount++;
    }
  }

  const isLandscape = orientation === 'landscape';
  const pageW = isLandscape ? 297 : 210;
  const pageH = isLandscape ? 210 : 297;
  const margin = 15;
  const headerHeight = 14;
  // 1:1 scale: cellSize = real stitch size in mm = 25.4 / aidaCount
  const cellSize = 25.4 / aidaCount;

  const usableW = pageW - margin * 2;
  const usableH = pageH - margin * 2 - headerHeight;

  const layout = calculatePDFLayout(patternWidth, patternHeight, cellSize, usableW, usableH);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation: isLandscape ? 'landscape' : 'portrait',
    unit: 'mm',
    format: 'a4',
  });

  const totalGridPages = layout.totalPages;
  const totalPagesWithLegend = totalGridPages + 1;
  const fontName = fontData.name || fontData.id || 'Unknown';

  let pageNum = 0;
  for (let pageY = 0; pageY < layout.pagesY; pageY++) {
    for (let pageX = 0; pageX < layout.pagesX; pageX++) {
      if (pageNum > 0) {
        pdf.addPage();
      }
      pageNum++;

      const startCol = pageX * layout.colsPerPage;
      const startRow = pageY * layout.rowsPerPage;

      drawBrandedHeader(pdf, text, fontName, patternWidth, patternHeight, pageNum, totalPagesWithLegend, margin, pageW);
      drawBrandedFooter(pdf, margin, pageW, pageH);

      drawGridPage(
        pdf,
        bitmap,
        { r: dmcColor.r, g: dmcColor.g, b: dmcColor.b },
        startCol,
        startRow,
        layout.colsPerPage,
        layout.rowsPerPage,
        cellSize,
        { left: margin, top: margin + headerHeight },
        layout
      );
    }
  }

  pdf.addPage();
  drawLegend(pdf, dmcColor, stitchCount, aidaCount, patternWidth, patternHeight, fontName, text, totalPagesWithLegend, totalPagesWithLegend, pageW, pageH);

  const safeText = text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '').substring(0, 40);
  const safeId = (fontData.id || 'font').replace(/[^a-z0-9-]/g, '');
  const filename = 'word2stitch-' + (safeText || 'pattern') + '-' + safeId + '.pdf';

  return { pdf, filename, pages: totalPagesWithLegend, stitches: stitchCount, patternWidth, patternHeight };
}

/**
 * Create and show the print preview modal.
 */
function _createPrintModal() {
  if (document.getElementById('printModal')) return;

  var modal = document.createElement('div');
  modal.id = 'printModal';
  modal.innerHTML = [
    '<div class="pm-backdrop"></div>',
    '<div class="pm-dialog">',
    '  <div class="pm-header">',
    '    <span class="pm-title">\u2715 Print Preview</span>',
    '    <button class="pm-close" id="pmClose">\u2715</button>',
    '  </div>',
    '  <div class="pm-orient-row">',
    '    <button class="pm-orient-btn pm-active" data-orient="portrait">',
    '      <svg viewBox="0 0 24 32" width="20" height="26"><rect x="1" y="1" width="22" height="30" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><line x1="5" y1="8" x2="19" y2="8" stroke="currentColor" stroke-width="1.5"/></svg>',
    '      Portrait',
    '    </button>',
    '    <button class="pm-orient-btn" data-orient="landscape">',
    '      <svg viewBox="0 0 32 24" width="26" height="20"><rect x="1" y="1" width="30" height="22" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><line x1="5" y1="6" x2="27" y2="6" stroke="currentColor" stroke-width="1.5"/></svg>',
    '      Landscape',
    '    </button>',
    '  </div>',
    '  <div class="pm-preview">',
    '    <iframe id="pmIframe" class="pm-iframe"></iframe>',
    '  </div>',
    '  <div class="pm-info" id="pmInfo"></div>',
    '  <div class="pm-actions">',
    '    <button class="pm-btn pm-btn-secondary" id="pmDownload">',
    '      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
    '      Download PDF',
    '    </button>',
    '    <button class="pm-btn pm-btn-primary" id="pmPrint">',
    '      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>',
    '      Print',
    '    </button>',
    '  </div>',
    '</div>',
  ].join('\n');

  var style = document.createElement('style');
  style.textContent = [
    '#printModal { position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; }',
    '#printModal.pm-hidden { display:none; }',
    '.pm-backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.5); }',
    '.pm-dialog { position:relative; background:#faf8f5; border-radius:14px; width:90vw; max-width:680px; max-height:90vh; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden; }',
    '.pm-header { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid #e0d6c8; }',
    '.pm-title { font-family:"DM Serif Display",Georgia,serif; font-size:18px; color:#3d3229; }',
    '.pm-close { background:none; border:none; font-size:18px; color:#a99e8f; cursor:pointer; padding:4px 8px; border-radius:6px; transition:all 0.15s; }',
    '.pm-close:hover { background:rgba(184,58,42,0.08); color:#b83a2a; }',
    '.pm-orient-row { display:flex; gap:8px; padding:12px 18px; justify-content:center; }',
    '.pm-orient-btn { display:flex; align-items:center; gap:8px; padding:10px 20px; border:2px solid #e0d6c8; border-radius:10px; background:#fff; cursor:pointer; font-family:"Anybody",system-ui,sans-serif; font-size:13px; font-weight:600; color:#7a6e60; transition:all 0.15s; min-height:48px; }',
    '.pm-orient-btn:hover { border-color:#b83a2a; color:#b83a2a; }',
    '.pm-orient-btn.pm-active { border-color:#b83a2a; background:rgba(184,58,42,0.08); color:#b83a2a; }',
    '.pm-preview { flex:1; min-height:0; padding:0 18px; overflow:hidden; }',
    '.pm-iframe { width:100%; height:350px; border:1px solid #e0d6c8; border-radius:8px; background:#fff; }',
    '.pm-info { padding:8px 18px; font-size:12px; color:#7a6e60; text-align:center; }',
    '.pm-actions { display:flex; gap:10px; padding:14px 18px; border-top:1px solid #e0d6c8; justify-content:flex-end; }',
    '.pm-btn { display:flex; align-items:center; gap:6px; padding:10px 20px; border-radius:10px; font-family:"Anybody",system-ui,sans-serif; font-size:14px; font-weight:600; cursor:pointer; border:none; transition:all 0.15s; min-height:48px; }',
    '.pm-btn-secondary { background:#fff; color:#3d3229; border:2px solid #e0d6c8; }',
    '.pm-btn-secondary:hover { border-color:#b83a2a; color:#b83a2a; }',
    '.pm-btn-primary { background:#b83a2a; color:#fff; }',
    '.pm-btn-primary:hover { background:#9c3023; box-shadow:0 3px 12px rgba(184,58,42,0.25); }',
    '@media(max-width:640px) { .pm-dialog { width:96vw; max-height:95vh; border-radius:10px; } .pm-iframe { height:280px; } .pm-orient-btn { padding:8px 14px; font-size:12px; } .pm-actions { flex-direction:column; } .pm-btn { justify-content:center; } }',
  ].join('\n');

  document.head.appendChild(style);
  document.body.appendChild(modal);
}

/**
 * Show the print preview modal.
 * Generates PDF in chosen orientation and displays in iframe.
 */
function generatePDF(text, fontData, dmcColor, aidaCount) {
  if (!text || !text.trim()) { alert('Please enter some text.'); return; }
  if (!fontData || !fontData.glyphs) { alert('No font selected.'); return; }
  if (!dmcColor) { alert('No color selected.'); return; }

  _createPrintModal();

  var modal = document.getElementById('printModal');
  var iframe = document.getElementById('pmIframe');
  var info = document.getElementById('pmInfo');
  var currentOrientation = 'portrait';
  var currentBlobUrl = null;

  function buildAndShow(orient) {
    var result = buildPDF(text, fontData, dmcColor, aidaCount, orient);
    if (!result) { alert('Could not render pattern.'); return; }

    if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
    var blob = result.pdf.output('blob');
    currentBlobUrl = URL.createObjectURL(blob);

    iframe.src = currentBlobUrl;

    var cmW = (result.patternWidth / aidaCount * 2.54).toFixed(1);
    var cmH = (result.patternHeight / aidaCount * 2.54).toFixed(1);
    info.textContent = result.patternWidth + '\u00d7' + result.patternHeight +
      ' stitches \u00b7 ' + cmW + ' \u00d7 ' + cmH + ' cm \u00b7 ' +
      result.pages + ' pages \u00b7 ' + result.stitches + ' crosses';

    // Store for download/print
    modal._pdfResult = result;
    modal._blobUrl = currentBlobUrl;
  }

  // Show modal
  modal.classList.remove('pm-hidden');
  buildAndShow(currentOrientation);

  // Orientation buttons
  var orientBtns = modal.querySelectorAll('.pm-orient-btn');
  function handleOrient(e) {
    var btn = e.target.closest('.pm-orient-btn');
    if (!btn) return;
    var orient = btn.dataset.orient;
    if (orient === currentOrientation) return;
    currentOrientation = orient;
    orientBtns.forEach(function(b) { b.classList.toggle('pm-active', b.dataset.orient === orient); });
    buildAndShow(orient);
  }
  orientBtns.forEach(function(b) {
    b.removeEventListener('click', handleOrient);
    b.addEventListener('click', handleOrient);
  });

  // Close
  function closeModal() {
    modal.classList.add('pm-hidden');
    iframe.src = 'about:blank';
    if (currentBlobUrl) { URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; }
  }
  modal.querySelector('.pm-backdrop').onclick = closeModal;
  document.getElementById('pmClose').onclick = closeModal;

  // Download
  document.getElementById('pmDownload').onclick = function() {
    if (modal._pdfResult) {
      modal._pdfResult.pdf.save(modal._pdfResult.filename);
    }
  };

  // Print
  document.getElementById('pmPrint').onclick = function() {
    if (modal._blobUrl) {
      var printWin = window.open(modal._blobUrl, '_blank');
      if (printWin) {
        printWin.addEventListener('load', function() {
          setTimeout(function() { printWin.print(); }, 500);
        });
      }
    }
  };
}

/**
 * Truncate a string to maxLen characters, adding ellipsis if needed.
 */
function truncate(str, maxLen) {
  if (!str) return '';
  if (str.length <= maxLen) return str;
  return str.substring(0, maxLen - 1) + '\u2026';
}

</script>

<!-- â•â•â• UI Application Logic â•â•â• -->
<script>
(function () {
  'use strict';

  // -- i18n translations --
  var I18N = {
    en: {
      placeholder_text: "Type your text here...",
      section_font: "Font",
      search_fonts: "Search fonts...",
      tab_all: "All",
      section_height: "Stitch Height",
      unit_px: "px",
      section_color: "Thread Color",
      section_fabric: "Fabric",
      label_aida: "Aida",
      empty_state: "Type something to see your pattern",
      loading_text: "Rasterizing...",
      unit_cm: "cm",
      unit_stitches: "stitches",
      unit_crosses: "crosses",
      toggle_controls: "Toggle controls",
      no_fonts: "No fonts available",
      no_matching: "No matching fonts",
      server_error: "Failed to load fonts. Is the server running?",
      alert_no_text: "Type some text and select a font first.",
      alert_no_pdf: "PDF engine not loaded. Please reload the page.",
      alert_no_jspdf: "jsPDF library not loaded. Check your internet connection and reload.",
      alert_pdf_fail: "PDF generation failed: "
    },
    es: {
      placeholder_text: "Escribe tu texto aquÃ­...",
      section_font: "Fuente",
      search_fonts: "Buscar fuentes...",
      tab_all: "Todas",
      section_height: "Altura de Puntada",
      unit_px: "px",
      section_color: "Color de Hilo",
      section_fabric: "Tela",
      label_aida: "Aida",
      empty_state: "Escribe algo para ver tu patrÃ³n",
      loading_text: "Rasterizando...",
      unit_cm: "cm",
      unit_stitches: "puntadas",
      unit_crosses: "cruces",
      toggle_controls: "Mostrar controles",
      no_fonts: "No hay fuentes disponibles",
      no_matching: "No se encontraron fuentes",
      server_error: "Error al cargar fuentes. Â¿EstÃ¡ el servidor activo?",
      alert_no_text: "Escribe un texto y selecciona una fuente primero.",
      alert_no_pdf: "Motor PDF no cargado. Recarga la pÃ¡gina.",
      alert_no_jspdf: "Biblioteca jsPDF no cargada. Verifica tu conexiÃ³n y recarga.",
      alert_pdf_fail: "Error al generar PDF: "
    },
    fr: {
      placeholder_text: "Tapez votre texte ici...",
      section_font: "Police",
      search_fonts: "Rechercher des polices...",
      tab_all: "Toutes",
      section_height: "Hauteur de Point",
      unit_px: "px",
      section_color: "Couleur du Fil",
      section_fabric: "Tissu",
      label_aida: "Aida",
      empty_state: "Tapez quelque chose pour voir votre motif",
      loading_text: "RastÃ©risation...",
      unit_cm: "cm",
      unit_stitches: "points",
      unit_crosses: "croix",
      toggle_controls: "Afficher les contrÃ´les",
      no_fonts: "Aucune police disponible",
      no_matching: "Aucune police trouvÃ©e",
      server_error: "Ã‰chec du chargement des polices. Le serveur est-il lancÃ© ?",
      alert_no_text: "Tapez du texte et sÃ©lectionnez une police d'abord.",
      alert_no_pdf: "Moteur PDF non chargÃ©. Rechargez la page.",
      alert_no_jspdf: "BibliothÃ¨que jsPDF non chargÃ©e. VÃ©rifiez votre connexion et rechargez.",
      alert_pdf_fail: "Ã‰chec de la gÃ©nÃ©ration du PDF : "
    },
    de: {
      placeholder_text: "Gib deinen Text ein...",
      section_font: "Schriftart",
      search_fonts: "Schriftarten suchen...",
      tab_all: "Alle",
      section_height: "StichhÃ¶he",
      unit_px: "px",
      section_color: "Garnfarbe",
      section_fabric: "Stoff",
      label_aida: "Aida",
      empty_state: "Tippe etwas, um dein Muster zu sehen",
      loading_text: "Wird gerastert...",
      unit_cm: "cm",
      unit_stitches: "Stiche",
      unit_crosses: "Kreuze",
      toggle_controls: "Steuerung anzeigen",
      no_fonts: "Keine Schriftarten verfÃ¼gbar",
      no_matching: "Keine passenden Schriftarten",
      server_error: "Schriftarten konnten nicht geladen werden. LÃ¤uft der Server?",
      alert_no_text: "Gib einen Text ein und wÃ¤hle eine Schriftart.",
      alert_no_pdf: "PDF-Engine nicht geladen. Seite neu laden.",
      alert_no_jspdf: "jsPDF nicht geladen. PrÃ¼fe deine Internetverbindung und lade neu.",
      alert_pdf_fail: "PDF-Erzeugung fehlgeschlagen: "
    },
    it: {
      placeholder_text: "Scrivi il tuo testo qui...",
      section_font: "Font",
      search_fonts: "Cerca font...",
      tab_all: "Tutti",
      section_height: "Altezza Punto",
      unit_px: "px",
      section_color: "Colore Filo",
      section_fabric: "Tessuto",
      label_aida: "Aida",
      empty_state: "Scrivi qualcosa per vedere il tuo schema",
      loading_text: "Rasterizzazione...",
      unit_cm: "cm",
      unit_stitches: "punti",
      unit_crosses: "croci",
      toggle_controls: "Mostra controlli",
      no_fonts: "Nessun font disponibile",
      no_matching: "Nessun font trovato",
      server_error: "Caricamento font fallito. Il server Ã¨ attivo?",
      alert_no_text: "Scrivi un testo e seleziona un font prima.",
      alert_no_pdf: "Motore PDF non caricato. Ricarica la pagina.",
      alert_no_jspdf: "Libreria jsPDF non caricata. Controlla la connessione e ricarica.",
      alert_pdf_fail: "Generazione PDF fallita: "
    },
    pt: {
      placeholder_text: "Digite seu texto aqui...",
      section_font: "Fonte",
      search_fonts: "Buscar fontes...",
      tab_all: "Todas",
      section_height: "Altura do Ponto",
      unit_px: "px",
      section_color: "Cor da Linha",
      section_fabric: "Tecido",
      label_aida: "Aida",
      empty_state: "Digite algo para ver seu padrÃ£o",
      loading_text: "Rasterizando...",
      unit_cm: "cm",
      unit_stitches: "pontos",
      unit_crosses: "cruzes",
      toggle_controls: "Mostrar controles",
      no_fonts: "Nenhuma fonte disponÃ­vel",
      no_matching: "Nenhuma fonte encontrada",
      server_error: "Falha ao carregar fontes. O servidor estÃ¡ ativo?",
      alert_no_text: "Digite um texto e selecione uma fonte primeiro.",
      alert_no_pdf: "Motor PDF nÃ£o carregado. Recarregue a pÃ¡gina.",
      alert_no_jspdf: "Biblioteca jsPDF nÃ£o carregada. Verifique sua conexÃ£o e recarregue.",
      alert_pdf_fail: "Falha na geraÃ§Ã£o do PDF: "
    },
    nl: {
      placeholder_text: "Typ je tekst hier...",
      section_font: "Lettertype",
      search_fonts: "Lettertypen zoeken...",
      tab_all: "Alle",
      section_height: "Steekhoogte",
      unit_px: "px",
      section_color: "Draadkleur",
      section_fabric: "Stof",
      label_aida: "Aida",
      empty_state: "Typ iets om je patroon te zien",
      loading_text: "Rasteren...",
      unit_cm: "cm",
      unit_stitches: "steken",
      unit_crosses: "kruisjes",
      toggle_controls: "Bediening tonen",
      no_fonts: "Geen lettertypen beschikbaar",
      no_matching: "Geen overeenkomende lettertypen",
      server_error: "Lettertypen laden mislukt. Draait de server?",
      alert_no_text: "Typ tekst en selecteer een lettertype.",
      alert_no_pdf: "PDF-engine niet geladen. Herlaad de pagina.",
      alert_no_jspdf: "jsPDF-bibliotheek niet geladen. Controleer je verbinding en herlaad.",
      alert_pdf_fail: "PDF genereren mislukt: "
    },
    ja: {
      placeholder_text: "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›...",
      section_font: "ãƒ•ã‚©ãƒ³ãƒˆ",
      search_fonts: "ãƒ•ã‚©ãƒ³ãƒˆã‚’æ¤œç´¢...",
      tab_all: "ã™ã¹ã¦",
      section_height: "ã‚¹ãƒ†ãƒƒãƒé«˜ã•",
      unit_px: "px",
      section_color: "ç³¸ã®è‰²",
      section_fabric: "å¸ƒåœ°",
      label_aida: "ã‚¢ã‚¤ãƒ¼ãƒ€",
      empty_state: "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™",
      loading_text: "ãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚ºä¸­...",
      unit_cm: "cm",
      unit_stitches: "ã‚¹ãƒ†ãƒƒãƒ",
      unit_crosses: "ã‚¯ãƒ­ã‚¹",
      toggle_controls: "ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º",
      no_fonts: "ãƒ•ã‚©ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“",
      no_matching: "ä¸€è‡´ã™ã‚‹ãƒ•ã‚©ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“",
      server_error: "ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã¯èµ·å‹•ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
      alert_no_text: "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚’é¸æŠžã—ã¦ãã ã•ã„ã€‚",
      alert_no_pdf: "PDFã‚¨ãƒ³ã‚¸ãƒ³ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚",
      alert_no_jspdf: "jsPDFãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æŽ¥ç¶šã‚’ç¢ºèªã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚",
      alert_pdf_fail: "PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: "
    },
    ko: {
      placeholder_text: "í…ìŠ¤íŠ¸ë¥¼ ìž…ë ¥í•˜ì„¸ìš”...",
      section_font: "ê¸€ê¼´",
      search_fonts: "ê¸€ê¼´ ê²€ìƒ‰...",
      tab_all: "ì „ì²´",
      section_height: "ìŠ¤í‹°ì¹˜ ë†’ì´",
      unit_px: "px",
      section_color: "ì‹¤ ìƒ‰ìƒ",
      section_fabric: "ì›ë‹¨",
      label_aida: "ì•„ì´ë‹¤",
      empty_state: "í…ìŠ¤íŠ¸ë¥¼ ìž…ë ¥í•˜ë©´ íŒ¨í„´ì´ í‘œì‹œë©ë‹ˆë‹¤",
      loading_text: "ëž˜ìŠ¤í„°ë¼ì´ì¦ˆ ì¤‘...",
      unit_cm: "cm",
      unit_stitches: "ìŠ¤í‹°ì¹˜",
      unit_crosses: "í¬ë¡œìŠ¤",
      toggle_controls: "ì»¨íŠ¸ë¡¤ í‘œì‹œ",
      no_fonts: "ì‚¬ìš© ê°€ëŠ¥í•œ ê¸€ê¼´ì´ ì—†ìŠµë‹ˆë‹¤",
      no_matching: "ì¼ì¹˜í•˜ëŠ” ê¸€ê¼´ì´ ì—†ìŠµë‹ˆë‹¤",
      server_error: "ê¸€ê¼´ ë¡œë“œ ì‹¤íŒ¨. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.",
      alert_no_text: "í…ìŠ¤íŠ¸ë¥¼ ìž…ë ¥í•˜ê³  ê¸€ê¼´ì„ ì„ íƒí•˜ì„¸ìš”.",
      alert_no_pdf: "PDF ì—”ì§„ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. íŽ˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.",
      alert_no_jspdf: "jsPDFê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì—°ê²°ì„ í™•ì¸í•˜ê³  ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.",
      alert_pdf_fail: "PDF ìƒì„± ì‹¤íŒ¨: "
    },
    zh: {
      placeholder_text: "åœ¨æ­¤è¾“å…¥æ–‡å­—...",
      section_font: "å­—ä½“",
      search_fonts: "æœç´¢å­—ä½“...",
      tab_all: "å…¨éƒ¨",
      section_height: "é’ˆé«˜",
      unit_px: "px",
      section_color: "çº¿è‰²",
      section_fabric: "å¸ƒæ–™",
      label_aida: "Aida",
      empty_state: "è¾“å…¥æ–‡å­—ä»¥æŸ¥çœ‹å›¾æ¡ˆ",
      loading_text: "æ­£åœ¨æ …æ ¼åŒ–...",
      unit_cm: "åŽ˜ç±³",
      unit_stitches: "é’ˆ",
      unit_crosses: "åå­—",
      toggle_controls: "æ˜¾ç¤ºæŽ§ä»¶",
      no_fonts: "æ²¡æœ‰å¯ç”¨å­—ä½“",
      no_matching: "æ²¡æœ‰åŒ¹é…çš„å­—ä½“",
      server_error: "å­—ä½“åŠ è½½å¤±è´¥ã€‚æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Ÿ",
      alert_no_text: "è¯·è¾“å…¥æ–‡å­—å¹¶é€‰æ‹©å­—ä½“ã€‚",
      alert_no_pdf: "PDFå¼•æ“ŽæœªåŠ è½½ã€‚è¯·åˆ·æ–°é¡µé¢ã€‚",
      alert_no_jspdf: "jsPDFåº“æœªåŠ è½½ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥å¹¶åˆ·æ–°ã€‚",
      alert_pdf_fail: "PDFç”Ÿæˆå¤±è´¥: "
    },
    ru: {
      placeholder_text: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚...",
      section_font: "Ð¨Ñ€Ð¸Ñ„Ñ‚",
      search_fonts: "ÐŸÐ¾Ð¸ÑÐº ÑˆÑ€Ð¸Ñ„Ñ‚Ð¾Ð²...",
      tab_all: "Ð’ÑÐµ",
      section_height: "Ð’Ñ‹ÑÐ¾Ñ‚Ð° ÑÑ‚ÐµÐ¶ÐºÐ°",
      unit_px: "px",
      section_color: "Ð¦Ð²ÐµÑ‚ Ð½Ð¸Ñ‚Ð¸",
      section_fabric: "Ð¢ÐºÐ°Ð½ÑŒ",
      label_aida: "ÐÐ¸Ð´Ð°",
      empty_state: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ ÑƒÐ·Ð¾Ñ€",
      loading_text: "Ð Ð°ÑÑ‚ÐµÑ€Ð¸Ð·Ð°Ñ†Ð¸Ñ...",
      unit_cm: "ÑÐ¼",
      unit_stitches: "ÑÑ‚ÐµÐ¶ÐºÐ¾Ð²",
      unit_crosses: "ÐºÑ€ÐµÑÑ‚Ð¾Ð²",
      toggle_controls: "ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ð°Ð½ÐµÐ»ÑŒ",
      no_fonts: "ÐÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… ÑˆÑ€Ð¸Ñ„Ñ‚Ð¾Ð²",
      no_matching: "Ð¨Ñ€Ð¸Ñ„Ñ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹",
      server_error: "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑˆÑ€Ð¸Ñ„Ñ‚Ñ‹. Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½?",
      alert_no_text: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð¸ Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑˆÑ€Ð¸Ñ„Ñ‚.",
      alert_no_pdf: "PDF-Ð´Ð²Ð¸Ð¶Ð¾Ðº Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½. ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ.",
      alert_no_jspdf: "Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° jsPDF Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ.",
      alert_pdf_fail: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ PDF: "
    },
    pl: {
      placeholder_text: "Wpisz swÃ³j tekst...",
      section_font: "Czcionka",
      search_fonts: "Szukaj czcionek...",
      tab_all: "Wszystkie",
      section_height: "WysokoÅ›Ä‡ Åšciegu",
      unit_px: "px",
      section_color: "Kolor Nici",
      section_fabric: "Tkanina",
      label_aida: "Aida",
      empty_state: "Wpisz coÅ›, aby zobaczyÄ‡ wzÃ³r",
      loading_text: "Rasteryzacja...",
      unit_cm: "cm",
      unit_stitches: "Å›ciegÃ³w",
      unit_crosses: "krzyÅ¼ykÃ³w",
      toggle_controls: "PokaÅ¼ panel",
      no_fonts: "Brak dostÄ™pnych czcionek",
      no_matching: "Nie znaleziono czcionek",
      server_error: "Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ czcionek. Czy serwer dziaÅ‚a?",
      alert_no_text: "Wpisz tekst i wybierz czcionkÄ™.",
      alert_no_pdf: "Silnik PDF nie zaÅ‚adowany. OdÅ›wieÅ¼ stronÄ™.",
      alert_no_jspdf: "Biblioteka jsPDF nie zaÅ‚adowana. SprawdÅº poÅ‚Ä…czenie i odÅ›wieÅ¼.",
      alert_pdf_fail: "BÅ‚Ä…d generowania PDF: "
    },
    sv: {
      placeholder_text: "Skriv din text hÃ¤r...",
      section_font: "Typsnitt",
      search_fonts: "SÃ¶k typsnitt...",
      tab_all: "Alla",
      section_height: "Stygnh\u00f6jd",
      unit_px: "px",
      section_color: "TrÃ¥dfÃ¤rg",
      section_fabric: "Tyg",
      label_aida: "Aida",
      empty_state: "Skriv nÃ¥got fÃ¶r att se ditt mÃ¶nster",
      loading_text: "Rastrerar...",
      unit_cm: "cm",
      unit_stitches: "stygn",
      unit_crosses: "kors",
      toggle_controls: "Visa kontroller",
      no_fonts: "Inga typsnitt tillgÃ¤ngliga",
      no_matching: "Inga matchande typsnitt",
      server_error: "Kunde inte ladda typsnitt. KÃ¶rs servern?",
      alert_no_text: "Skriv text och vÃ¤lj ett typsnitt fÃ¶rst.",
      alert_no_pdf: "PDF-motor inte laddad. Ladda om sidan.",
      alert_no_jspdf: "jsPDF inte laddat. Kontrollera din anslutning och ladda om.",
      alert_pdf_fail: "PDF-generering misslyckades: "
    },
    da: {
      placeholder_text: "Skriv din tekst her...",
      section_font: "Skrifttype",
      search_fonts: "SÃ¸g skrifttyper...",
      tab_all: "Alle",
      section_height: "StinghÃ¸jde",
      unit_px: "px",
      section_color: "TrÃ¥dfarve",
      section_fabric: "Stof",
      label_aida: "Aida",
      empty_state: "Skriv noget for at se dit mÃ¸nster",
      loading_text: "Rastrerer...",
      unit_cm: "cm",
      unit_stitches: "sting",
      unit_crosses: "kors",
      toggle_controls: "Vis kontroller",
      no_fonts: "Ingen skrifttyper tilgÃ¦ngelige",
      no_matching: "Ingen matchende skrifttyper",
      server_error: "Kunne ikke indlÃ¦se skrifttyper. KÃ¸rer serveren?",
      alert_no_text: "Skriv tekst og vÃ¦lg en skrifttype fÃ¸rst.",
      alert_no_pdf: "PDF-motor ikke indlÃ¦st. GenindlÃ¦s siden.",
      alert_no_jspdf: "jsPDF ikke indlÃ¦st. KontrollÃ©r din forbindelse og genindlÃ¦s.",
      alert_pdf_fail: "PDF-generering mislykkedes: "
    },
    fi: {
      placeholder_text: "Kirjoita tekstisi tÃ¤hÃ¤n...",
      section_font: "Fontti",
      search_fonts: "Etsi fontteja...",
      tab_all: "Kaikki",
      section_height: "Pistonkorkeus",
      unit_px: "px",
      section_color: "Langan VÃ¤ri",
      section_fabric: "Kangas",
      label_aida: "Aida",
      empty_state: "Kirjoita jotain nÃ¤hdÃ¤ksesi kuviosi",
      loading_text: "Rasteroidaan...",
      unit_cm: "cm",
      unit_stitches: "pistoa",
      unit_crosses: "ristiÃ¤",
      toggle_controls: "NÃ¤ytÃ¤ ohjaimet",
      no_fonts: "Ei fontteja saatavilla",
      no_matching: "Ei vastaavia fontteja",
      server_error: "Fonttien lataus epÃ¤onnistui. Onko palvelin kÃ¤ynnissÃ¤?",
      alert_no_text: "Kirjoita teksti ja valitse fontti ensin.",
      alert_no_pdf: "PDF-moottori ei latautunut. Lataa sivu uudelleen.",
      alert_no_jspdf: "jsPDF ei latautunut. Tarkista yhteys ja lataa uudelleen.",
      alert_pdf_fail: "PDF:n luonti epÃ¤onnistui: "
    },
    uk: {
      placeholder_text: "Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚...",
      section_font: "Ð¨Ñ€Ð¸Ñ„Ñ‚",
      search_fonts: "ÐŸÐ¾ÑˆÑƒÐº ÑˆÑ€Ð¸Ñ„Ñ‚Ñ–Ð²...",
      tab_all: "Ð£ÑÑ–",
      section_height: "Ð’Ð¸ÑÐ¾Ñ‚Ð° ÑÑ‚Ñ–Ð±ÐºÐ°",
      unit_px: "px",
      section_color: "ÐšÐ¾Ð»Ñ–Ñ€ Ð½Ð¸Ñ‚ÐºÐ¸",
      section_fabric: "Ð¢ÐºÐ°Ð½Ð¸Ð½Ð°",
      label_aida: "ÐÑ—Ð´Ð°",
      empty_state: "Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚, Ñ‰Ð¾Ð± Ð¿Ð¾Ð±Ð°Ñ‡Ð¸Ñ‚Ð¸ Ð²Ñ–Ð·ÐµÑ€ÑƒÐ½Ð¾Ðº",
      loading_text: "Ð Ð°ÑÑ‚ÐµÑ€Ð¸Ð·Ð°Ñ†Ñ–Ñ...",
      unit_cm: "ÑÐ¼",
      unit_stitches: "ÑÑ‚Ñ–Ð±ÐºÑ–Ð²",
      unit_crosses: "Ñ…Ñ€ÐµÑÑ‚Ð¸ÐºÑ–Ð²",
      toggle_controls: "ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚Ð¸ Ð¿Ð°Ð½ÐµÐ»ÑŒ",
      no_fonts: "ÐÐµÐ¼Ð°Ñ” Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ñ… ÑˆÑ€Ð¸Ñ„Ñ‚Ñ–Ð²",
      no_matching: "Ð¨Ñ€Ð¸Ñ„Ñ‚Ð¸ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾",
      server_error: "ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ ÑˆÑ€Ð¸Ñ„Ñ‚Ð¸. Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾?",
      alert_no_text: "Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚ Ñ– Ð²Ð¸Ð±ÐµÑ€Ñ–Ñ‚ÑŒ ÑˆÑ€Ð¸Ñ„Ñ‚.",
      alert_no_pdf: "PDF-Ñ€ÑƒÑˆÑ–Ð¹ Ð½Ðµ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð¾. ÐŸÐµÑ€ÐµÐ·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ñ‚Ðµ ÑÑ‚Ð¾Ñ€Ñ–Ð½ÐºÑƒ.",
      alert_no_jspdf: "Ð‘Ñ–Ð±Ð»Ñ–Ð¾Ñ‚ÐµÐºÑƒ jsPDF Ð½Ðµ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð¾. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ Ð·'Ñ”Ð´Ð½Ð°Ð½Ð½Ñ Ñ– Ð¿ÐµÑ€ÐµÐ·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ñ‚Ðµ.",
      alert_pdf_fail: "ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ— PDF: "
    },
    hu: {
      placeholder_text: "Ãrd be a szÃ¶veged...",
      section_font: "BetÅ±tÃ­pus",
      search_fonts: "BetÅ±tÃ­pusok keresÃ©se...",
      tab_all: "Ã–sszes",
      section_height: "Ã–ltÃ©smagassÃ¡g",
      unit_px: "px",
      section_color: "FonalszÃ­n",
      section_fabric: "SzÃ¶vet",
      label_aida: "Aida",
      empty_state: "Ãrj valamit a minta megtekintÃ©sÃ©hez",
      loading_text: "RaszterizÃ¡lÃ¡s...",
      unit_cm: "cm",
      unit_stitches: "Ã¶ltÃ©s",
      unit_crosses: "kereszt",
      toggle_controls: "VezÃ©rlÅ‘k mutatÃ¡sa",
      no_fonts: "Nincs elÃ©rhetÅ‘ betÅ±tÃ­pus",
      no_matching: "Nincs egyezÅ‘ betÅ±tÃ­pus",
      server_error: "BetÅ±tÃ­pusok betÃ¶ltÃ©se sikertelen. Fut a szerver?",
      alert_no_text: "Ãrj szÃ¶veget Ã©s vÃ¡lassz betÅ±tÃ­pust.",
      alert_no_pdf: "PDF-motor nincs betÃ¶ltve. TÃ¶ltsd Ãºjra az oldalt.",
      alert_no_jspdf: "jsPDF nincs betÃ¶ltve. EllenÅ‘rizd a kapcsolatot Ã©s tÃ¶ltsd Ãºjra.",
      alert_pdf_fail: "PDF lÃ©trehozÃ¡s sikertelen: "
    }
  };

  var currentLang = 'en';

  function t(key) {
    var lang = I18N[currentLang] || I18N.en;
    return lang[key] || I18N.en[key] || key;
  }

  function applyLang() {
    document.querySelectorAll('[data-i18n]').forEach(function(el) {
      el.textContent = t(el.dataset.i18n);
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
      el.placeholder = t(el.dataset.i18nPlaceholder);
    });
    document.querySelectorAll('[data-i18n-aria]').forEach(function(el) {
      el.setAttribute('aria-label', t(el.dataset.i18nAria));
    });
    document.title = 'Word2Stitch â€” ' + t('empty_state').split(' ').slice(0, 4).join(' ');
  }

  function setLanguage(lang) {
    if (!I18N[lang]) lang = 'en';
    currentLang = lang;
    try { localStorage.setItem('w2s_lang', lang); } catch(e) {}
    var sel = document.getElementById('langSelect');
    if (sel) sel.value = lang;
    applyLang();
    if (typeof renderFontListUI === 'function') renderFontListUI();
  }

  // -- State --
  var currentText = 'Welcome';
  var currentFontFile = 'GeorgiaPro-Black.ttf';
  var currentFontName = 'GeorgiaPro-Black';
  var currentHeight = 18;
  var currentColorIndex = 0;
  var currentAida = 14;
  var currentCategoryFilter = 'all';

  var categoryLabels = {
    'serif': 'Serif', 'sans-serif': 'Sans', 'script': 'Script',
    'decorative': 'Decorative', 'monospace': 'Mono', 'other': 'Other'
  };

  // Font list from API: [{file, name, size, category}, ...]
  var fontListData = [];

  // Client-side cache: Map<string, fontJSON>
  // Key format: "filename.ttf_height"
  var fontCache = new Map();

  // Currently loaded font data (from cache or API)
  var currentFontData = null;

  // -- DOM refs --
  var textInput = document.getElementById('textInput');
  var fontList = document.getElementById('fontList');
  var fontSearch = document.getElementById('fontSearch');
  var heightSlider = document.getElementById('heightSlider');
  var heightValue = document.getElementById('heightValue');
  var colorRow = document.getElementById('colorRow');
  var aidaRow = document.getElementById('aidaRow');
  var btnDownload = document.getElementById('btnDownload');
  var previewEmpty = document.getElementById('previewEmpty');
  var previewWrap = document.getElementById('previewWrap');
  var previewLoading = document.getElementById('previewLoading');
  var mainCanvas = document.getElementById('mainCanvas');
  var previewArea = document.getElementById('previewArea');

  // -- Helpers --

  function getCacheKey(fontFile, height) {
    return fontFile + '_' + height;
  }

  function getCurrentColor() {
    if (typeof DMC_COLORS === 'undefined' || !DMC_COLORS.length) return { hex: '#b83a2a', code: '321', name: 'Red' };
    return DMC_COLORS[currentColorIndex] || DMC_COLORS[0];
  }

  function showLoading() {
    previewLoading.classList.remove('hidden');
  }

  function hideLoading() {
    previewLoading.classList.add('hidden');
  }

  // -- Bitmap --

  function getEffectiveBitmap(glyph) {
    if (!glyph || !glyph.bitmap || !glyph.bitmap.length) return [];
    var bitmap = glyph.bitmap;
    var lastFilledRow = -1;
    for (var r = bitmap.length - 1; r >= 0; r--) {
      if (bitmap[r].indexOf('1') !== -1) { lastFilledRow = r; break; }
    }
    if (lastFilledRow === -1) return bitmap.slice();
    return bitmap.slice(0, lastFilledRow + 1);
  }

  function getTextBitmap(text, fontData) {
    if (!text || !fontData || !fontData.glyphs) return { bitmap: [], width: 0, height: 0 };

    var height = fontData.height || 9;
    var letterSpacing = (fontData.letterSpacing != null) ? fontData.letterSpacing : 1;
    var spaceWidth = fontData.spaceWidth || 3;
    var columns = [];

    for (var ci = 0; ci < text.length; ci++) {
      var ch = text[ci];
      if (ci > 0 && letterSpacing > 0) {
        for (var s = 0; s < letterSpacing; s++) columns.push(new Array(height).fill(false));
      }
      if (ch === ' ') {
        for (var s2 = 0; s2 < spaceWidth; s2++) columns.push(new Array(height).fill(false));
        continue;
      }
      var glyph = fontData.glyphs[ch];
      if (!glyph || !glyph.bitmap || !glyph.bitmap.length) {
        for (var s3 = 0; s3 < spaceWidth; s3++) columns.push(new Array(height).fill(false));
        continue;
      }
      var bmp = glyph.bitmap;
      var glyphWidth = glyph.width || (bmp[0] ? bmp[0].length : 0);
      for (var x = 0; x < glyphWidth; x++) {
        var col = [];
        for (var y = 0; y < height; y++) {
          col.push(y < bmp.length && x < bmp[y].length && bmp[y][x] === '1');
        }
        columns.push(col);
      }
    }

    if (!columns.length) return { bitmap: [], width: 0, height: 0 };

    var width = columns.length;
    var bitmap = [];
    for (var y2 = 0; y2 < height; y2++) {
      var row = [];
      for (var x2 = 0; x2 < width; x2++) row.push(columns[x2][y2]);
      bitmap.push(row);
    }
    return { bitmap: bitmap, width: width, height: height };
  }

  // -- Render --

  function renderPreview(canvas, text, fontData, colorHex, options) {
    var ctx = canvas.getContext('2d');
    if (!text || !fontData) {
      canvas.width = 1; canvas.height = 1;
      ctx.clearRect(0, 0, 1, 1);
      return { width: 0, height: 0, stitches: 0 };
    }

    var result = getTextBitmap(text, fontData);
    var bitmap = result.bitmap;
    var width = result.width;
    var height = result.height;
    if (!bitmap.length || !width) {
      canvas.width = 1; canvas.height = 1;
      ctx.clearRect(0, 0, 1, 1);
      return { width: 0, height: 0, stitches: 0 };
    }

    var opts = options || {};
    var maxCanvasWidth = opts.maxWidth || 850;
    var cellSize = opts.cellSize || 12;
    if (width * cellSize > maxCanvasWidth) {
      cellSize = Math.max(2, Math.floor(maxCanvasWidth / width));
    }

    var canvasW = width * cellSize + 1;
    var canvasH = height * cellSize + 1;
    canvas.width = canvasW;
    canvas.height = canvasH;

    // Background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvasW, canvasH);

    var stitchCount = 0;

    // Filled cells
    ctx.fillStyle = colorHex;
    for (var y = 0; y < height; y++) {
      for (var x = 0; x < width; x++) {
        if (bitmap[y][x]) {
          ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
          stitchCount++;
        }
      }
    }

    // Grid lines
    ctx.strokeStyle = '#e0d8d0';
    ctx.lineWidth = 0.5;
    for (var gx = 0; gx <= width; gx++) {
      var px = gx * cellSize + 0.5;
      ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, canvasH); ctx.stroke();
    }
    for (var gy = 0; gy <= height; gy++) {
      var py = gy * cellSize + 0.5;
      ctx.beginPath(); ctx.moveTo(0, py); ctx.lineTo(canvasW, py); ctx.stroke();
    }

    // Bold every 10
    if (cellSize >= 4) {
      ctx.strokeStyle = '#a09888';
      ctx.lineWidth = 1.5;
      for (var bx = 0; bx <= width; bx += 10) {
        var bpx = bx * cellSize + 0.5;
        ctx.beginPath(); ctx.moveTo(bpx, 0); ctx.lineTo(bpx, canvasH); ctx.stroke();
      }
      for (var by = 0; by <= height; by += 10) {
        var bpy = by * cellSize + 0.5;
        ctx.beginPath(); ctx.moveTo(0, bpy); ctx.lineTo(canvasW, bpy); ctx.stroke();
      }
    }

    return { width: width, height: height, stitches: stitchCount };
  }

  // -- API calls --

  function fetchFontList() {
    return fetch('/api/fonts')
      .then(function (res) {
        if (!res.ok) throw new Error('Failed to load font list');
        return res.json();
      })
      .then(function (data) {
        fontListData = data;
        renderFontListUI();
        // Auto-rasterize default font on load
        if (currentFontFile && currentText) {
          loadAndRender();
        }
      })
      .catch(function (err) {
        fontList.innerHTML = '<div style="padding:20px;color:var(--text-muted);font-size:12px;text-align:center;">' + t('server_error') + '</div>';
        console.error('fetchFontList:', err);
      });
  }

  function rasterizeFont(fontFile, height) {
    var key = getCacheKey(fontFile, height);

    // Return cached data if available
    if (fontCache.has(key)) {
      return Promise.resolve(fontCache.get(key));
    }

    showLoading();

    return fetch('/api/rasterize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        font: fontFile,
        height: height,
        bold: 0,
        strategy: 'average'
      })
    })
    .then(function (res) {
      if (!res.ok) throw new Error('Rasterization failed');
      return res.json();
    })
    .then(function (data) {
      fontCache.set(key, data);
      hideLoading();
      return data;
    })
    .catch(function (err) {
      hideLoading();
      console.error('rasterizeFont:', err);
      return null;
    });
  }

  // -- Update Preview (main function) --

  function updatePreview() {
    var color = getCurrentColor();

    if (!currentText.trim() || !currentFontData) {
      previewEmpty.style.display = 'flex';
      previewWrap.style.display = 'none';
      return;
    }

    previewEmpty.style.display = 'none';
    previewWrap.style.display = 'flex';

    // Calculate available space
    var areaRect = previewArea.getBoundingClientRect();
    var maxW = areaRect.width - 40;

    var result = renderPreview(mainCanvas, currentText, currentFontData, color.hex, {
      cellSize: 16,
      maxWidth: maxW
    });

    if (result.width === 0) {
      previewEmpty.style.display = 'flex';
      previewWrap.style.display = 'none';
      return;
    }

    // Calculate physical size
    var widthCm = (result.width / currentAida * 2.54).toFixed(1);
    var heightCm = (result.height / currentAida * 2.54).toFixed(1);

    // Update stats
    document.getElementById('statSizeCm').textContent = widthCm + ' \u00d7 ' + heightCm;
    document.getElementById('statStitchesW').textContent = result.width;
    document.getElementById('statStitchesH').textContent = result.height;
    document.getElementById('statTotal').textContent = result.stitches;
    document.getElementById('statDmc').textContent = color.code;

    // Thread estimate
    var metersPerStitch = 0.013 * (14 / currentAida);
    var totalMeters = (result.stitches * metersPerStitch).toFixed(1);
    document.getElementById('statThread').textContent = totalMeters + 'm';

    // Ruler: match canvas rendered width
    document.getElementById('rulerWidth').textContent = widthCm + ' cm';
    requestAnimationFrame(function () {
      var canvasRendered = mainCanvas.getBoundingClientRect().width;
      var rulerLine = document.querySelector('.ruler-line');
      if (rulerLine && canvasRendered > 0) {
        rulerLine.style.width = canvasRendered + 'px';
      }
    });
  }

  // -- Trigger rasterization and update --

  function loadAndRender() {
    if (!currentFontFile) {
      currentFontData = null;
      updatePreview();
      return;
    }

    rasterizeFont(currentFontFile, currentHeight).then(function (data) {
      if (data) {
        currentFontData = data;
      }
      updatePreview();
    });
  }

  // -- Text Input --

  textInput.addEventListener('input', function () {
    currentText = this.value;
    updatePreview();
  });

  // -- Font List UI --

  function renderFontListUI() {
    var filter = (fontSearch.value || '').toLowerCase().trim();

    // Compute category counts from filtered fonts
    var categoryCounts = {};
    fontListData.forEach(function (font) {
      var name = font.name || font.file;
      if (filter && name.toLowerCase().indexOf(filter) === -1) return;
      var cat = font.category || 'other';
      categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
    });

    var categories = Object.keys(categoryCounts).sort();
    var totalFiltered = 0;
    categories.forEach(function (c) { totalFiltered += categoryCounts[c]; });

    // Populate category tabs
    var tabsEl = document.getElementById('fontCategoryTabs');
    tabsEl.innerHTML = '';
    var allBtn = document.createElement('button');
    allBtn.className = 'font-tab' + (currentCategoryFilter === 'all' ? ' active' : '');
    allBtn.dataset.category = 'all';
    allBtn.textContent = t('tab_all') + ' (' + totalFiltered + ')';
    tabsEl.appendChild(allBtn);

    categories.forEach(function (cat) {
      var btn = document.createElement('button');
      btn.className = 'font-tab' + (currentCategoryFilter === cat ? ' active' : '');
      btn.dataset.category = cat;
      btn.textContent = (categoryLabels[cat] || cat) + ' (' + categoryCounts[cat] + ')';
      tabsEl.appendChild(btn);
    });

    // Reset if current category has no fonts
    if (currentCategoryFilter !== 'all' && !categoryCounts[currentCategoryFilter]) {
      currentCategoryFilter = 'all';
      tabsEl.querySelector('[data-category="all"]').classList.add('active');
    }

    // Render font list
    fontList.innerHTML = '';

    if (!fontListData.length) {
      fontList.innerHTML = '<div style="padding:20px;color:var(--text-muted);font-size:12px;text-align:center;">' + t('no_fonts') + '</div>';
      return;
    }

    var displayed = 0;

    fontListData.forEach(function (font) {
      var name = font.name || font.file;
      if (filter && name.toLowerCase().indexOf(filter) === -1) return;
      if (currentCategoryFilter !== 'all' && (font.category || 'other') !== currentCategoryFilter) return;

      displayed++;

      var item = document.createElement('div');
      item.className = 'font-item' + (font.file === currentFontFile ? ' selected' : '');
      item.dataset.fontFile = font.file;

      var info = document.createElement('div');
      info.className = 'font-item-info';

      var nameEl = document.createElement('div');
      nameEl.className = 'font-item-name';
      nameEl.textContent = name;

      var meta = document.createElement('div');
      meta.className = 'font-item-meta';
      var sizeKb = font.size ? (font.size / 1024).toFixed(0) + ' KB' : '';
      meta.textContent = (categoryLabels[font.category] || font.category || '') + (sizeKb ? ' \u00b7 ' + sizeKb : '');

      info.appendChild(nameEl);
      info.appendChild(meta);
      item.appendChild(info);
      fontList.appendChild(item);

      item.addEventListener('click', function () {
        currentFontFile = font.file;
        currentFontName = name;
        fontList.querySelectorAll('.font-item').forEach(function (el) {
          el.classList.toggle('selected', el.dataset.fontFile === font.file);
        });
        loadAndRender();
      });
    });

    if (!displayed) {
      fontList.innerHTML = '<div style="padding:20px;color:var(--text-muted);font-size:12px;text-align:center;">' + t('no_matching') + '</div>';
    }
  }

  // Font search filtering
  fontSearch.addEventListener('input', function () {
    renderFontListUI();
  });

  // Category tab filtering (delegated)
  document.getElementById('fontCategoryTabs').addEventListener('click', function (e) {
    var tab = e.target.closest('.font-tab');
    if (!tab) return;
    currentCategoryFilter = tab.dataset.category;
    this.querySelectorAll('.font-tab').forEach(function (t) { t.classList.remove('active'); });
    tab.classList.add('active');
    renderFontListUI();
  });

  // -- Height Slider --

  var heightDebounceTimer = null;

  heightSlider.addEventListener('input', function () {
    var val = parseInt(this.value);
    heightValue.textContent = val;

    clearTimeout(heightDebounceTimer);
    heightDebounceTimer = setTimeout(function () {
      currentHeight = val;
      loadAndRender();
    }, 300);
  });

  // -- Color Swatches --

  function renderColors() {
    if (typeof DMC_COLORS === 'undefined' || !DMC_COLORS.length) return;
    colorRow.innerHTML = '';

    DMC_COLORS.forEach(function (color, index) {
      var dot = document.createElement('div');
      dot.className = 'color-dot' + (index === currentColorIndex ? ' selected' : '');
      dot.style.backgroundColor = color.hex;
      dot.dataset.index = index;

      var tip = document.createElement('div');
      tip.className = 'tip';
      tip.textContent = 'DMC ' + color.code + ' \u2014 ' + color.name;
      dot.appendChild(tip);

      dot.addEventListener('click', function () {
        currentColorIndex = index;
        colorRow.querySelectorAll('.color-dot').forEach(function (d) {
          d.classList.toggle('selected', parseInt(d.dataset.index) === index);
        });
        updatePreview();
      });

      colorRow.appendChild(dot);
    });
  }

  // -- Aida Count --

  document.getElementById('langSelect').addEventListener('change', function() {
    setLanguage(this.value);
  });

  var customCountRow = document.getElementById('customCountRow');
  var customCountInput = document.getElementById('customCountInput');
  var customUnitToggle = document.getElementById('customUnitToggle');
  var customCountLabel = document.getElementById('customCountLabel');
  var customUnit = 'inch'; // 'inch' or 'cm'
  var isCustomAida = false;

  function updateCustomLabel() {
    var val = parseFloat(customCountInput.value) || 14;
    var aidaEquiv;
    if (customUnit === 'cm') {
      aidaEquiv = val * 2.54; // convert stitches/cm to stitches/inch
    } else {
      aidaEquiv = val;
    }
    customCountLabel.textContent = '= ' + aidaEquiv.toFixed(1) + ' ct';
    currentAida = aidaEquiv;
    updatePreview();
  }

  aidaRow.addEventListener('click', function (e) {
    var chip = e.target.closest('.aida-chip');
    if (!chip) return;
    var countVal = chip.dataset.count;

    // Deselect all chips
    aidaRow.querySelectorAll('.aida-chip').forEach(function (c) {
      c.classList.remove('selected');
    });
    chip.classList.add('selected');

    if (countVal === 'custom') {
      isCustomAida = true;
      customCountRow.classList.add('visible');
      updateCustomLabel();
    } else {
      isCustomAida = false;
      customCountRow.classList.remove('visible');
      currentAida = parseInt(countVal);
      updatePreview();
    }
  });

  // Custom count input
  customCountInput.addEventListener('input', function () {
    if (isCustomAida) updateCustomLabel();
  });

  // Unit toggle (inch / cm)
  customUnitToggle.addEventListener('click', function (e) {
    var btn = e.target.closest('.custom-unit-btn');
    if (!btn) return;
    customUnit = btn.dataset.unit;
    customUnitToggle.querySelectorAll('.custom-unit-btn').forEach(function (b) {
      b.classList.toggle('active', b.dataset.unit === customUnit);
    });
    if (isCustomAida) updateCustomLabel();
  });

  // -- Download PDF --

  btnDownload.addEventListener('click', function () {
    var color = getCurrentColor();
    if (!currentFontData || !currentText.trim()) {
      alert(t('alert_no_text'));
      return;
    }
    if (typeof generatePDF !== 'function') {
      alert(t('alert_no_pdf'));
      return;
    }
    if (!window.jspdf) {
      alert(t('alert_no_jspdf'));
      return;
    }
    try {
      generatePDF(currentText, currentFontData, color, currentAida);
    } catch (err) {
      alert(t('alert_pdf_fail') + err.message);
      console.error('PDF error:', err);
    }
  });

  // -- Mobile sidebar drawer --

  var sidebarToggle = document.getElementById('sidebarToggle');
  var sidebar = document.querySelector('.sidebar');
  var drawerBackdrop = document.getElementById('drawerBackdrop');

  function openDrawer() {
    sidebar.classList.add('open');
    sidebarToggle.classList.add('active');
    drawerBackdrop.classList.add('visible');
  }

  function closeDrawer() {
    sidebar.classList.remove('open');
    sidebarToggle.classList.remove('active');
    drawerBackdrop.classList.remove('visible');
  }

  sidebarToggle.addEventListener('click', function () {
    if (sidebar.classList.contains('open')) {
      closeDrawer();
    } else {
      openDrawer();
    }
  });

  drawerBackdrop.addEventListener('click', closeDrawer);

  // Close drawer when a font is selected on mobile
  var origFontClick = fontList.addEventListener;
  fontList.addEventListener('click', function (e) {
    var item = e.target.closest('.font-item');
    if (item && window.innerWidth <= 640) {
      setTimeout(closeDrawer, 200);
    }
  });

  // -- Resize handling --

  var resizeTimer;
  window.addEventListener('resize', function () {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(updatePreview, 150);
  });

  // -- Initialize --

  function init() {
    // Detect language
    var savedLang = null;
    try { savedLang = localStorage.getItem('w2s_lang'); } catch(e) {}
    var browserLang = (navigator.language || '').split('-')[0];
    setLanguage(savedLang || (I18N[browserLang] ? browserLang : 'en'));

    renderColors();
    fetchFontList();
    updatePreview();
  }

  // Expose for pdf-engine
  window.getTextBitmap = getTextBitmap;
  window.getEffectiveBitmap = getEffectiveBitmap;
  window.renderPreview = renderPreview;

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Wait for DMC_COLORS if loaded late
  var _colorsInterval = setInterval(function () {
    if (typeof DMC_COLORS !== 'undefined') {
      clearInterval(_colorsInterval);
      renderColors();
    }
  }, 200);
  setTimeout(function () { clearInterval(_colorsInterval); }, 10000);

})();
</script>



</body>
</html>
