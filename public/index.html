<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Word2Stitch — Cross-Stitch Pattern Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Anybody:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Cascade layer order — loaded first, controls specificity */
@layer tokens, layout, components, sheets, responsive;


@layer tokens {
  /* -- Reset -- */
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #f5f0ea;
    --bg-deep: #ece5db;
    --panel: #faf8f5;
    --border: #e0d6c8;
    --border-light: #eae3d9;
    --text: #3d3229;
    --text-mid: #7a6e60;
    --text-muted: #a99e8f;
    --accent: #b83a2a;
    --accent-hover: #9c3023;
    --accent-soft: rgba(184, 58, 42, 0.08);
    --accent-glow: rgba(184, 58, 42, 0.15);
    --stitch-grid: #d8d0c5;
    --stitch-bold: #a09585;
    --radius: 10px;
    --radius-sm: 6px;
    --font-display: 'DM Serif Display', Georgia, serif;
    --font-body: 'Anybody', system-ui, sans-serif;
  }

  html, body { height: 100%; overflow: hidden; }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
    line-height: 1.4;
    -webkit-font-smoothing: antialiased;
  }

  /* -- Linen noise texture -- */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    pointer-events: none;
    opacity: 0.3;
    background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 20h40M20 0v40' stroke='%23c8bfb0' stroke-width='0.3'/%3E%3C/svg%3E");
    background-size: 40px 40px;
    z-index: 0;
  }
}


@layer layout {
  /* -- Top Bar -- */
  .topbar {
    position: relative;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 10px 20px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }

  .logo {
    display: flex;
    align-items: baseline;
    gap: 0;
    flex-shrink: 0;
    user-select: none;
  }
  .logo-x {
    font-size: 18px;
    color: var(--accent);
    font-weight: 700;
    line-height: 1;
    margin-right: 3px;
  }
  .logo-text {
    font-family: var(--font-display);
    font-size: 20px;
    color: var(--text);
    letter-spacing: -0.3px;
  }
  .logo-text em {
    color: var(--accent);
    font-style: italic;
  }

  .topbar-sep {
    width: 1px;
    height: 24px;
    background: var(--border);
    flex-shrink: 0;
  }

  /* -- Text Input (in topbar) -- */
  .text-input-area {
    flex: 1;
    min-width: 0;
    position: relative;
  }
  .text-input {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 8px 14px;
    font-family: var(--font-display);
    font-size: 22px;
    color: var(--text);
    background: #fff;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    resize: none;
    overflow: hidden;
    line-height: 1.3;
    field-sizing: content;
    min-height: 42px;
    max-height: 120px;
  }
  .text-input::placeholder {
    color: var(--text-muted);
    font-style: italic;
  }
  .text-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  /* Download button in topbar */
  .btn-download {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 9px 18px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    font-family: var(--font-body);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    white-space: nowrap;
  }
  .btn-download:hover {
    background: var(--accent-hover);
    box-shadow: 0 3px 12px rgba(184,58,42,0.25);
    transform: translateY(-1px);
  }
  .btn-download:active { transform: translateY(0); }
  .btn-download:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .btn-download svg { width: 15px; height: 15px; }

  /* -- Main Layout -- */
  .main-layout {
    position: relative;
    z-index: 1;
    display: flex;
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  /* -- Left Sidebar -- */
  .sidebar {
    width: 280px;
    flex-shrink: 0;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-section {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border-light);
  }
  .sidebar-section:last-child { border-bottom: none; }

  .section-header {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .section-header svg {
    width: 12px;
    height: 12px;
    opacity: 0.5;
  }
}


@layer components {
  /* -- Font search input -- */
  .font-search {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 6px 10px;
    font-family: var(--font-body);
    font-size: 12px;
    color: var(--text);
    background: #fff;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .font-search::placeholder {
    color: var(--text-muted);
  }
  .font-search:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  /* -- Font Category Tabs -- */
  .font-tabs {
    display: flex;
    gap: 3px;
    overflow-x: auto;
    flex-wrap: nowrap;
    padding: 8px 0 4px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
    touch-action: pan-x;
  }
  .font-tabs::-webkit-scrollbar { height: 3px; }
  .font-tabs::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  .font-tab {
    flex-shrink: 0;
    padding: 4px 8px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: transparent;
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 10px;
    font-weight: 600;
    color: var(--text-mid);
    transition: background 0.12s, border-color 0.12s, color 0.12s;
    white-space: nowrap;
    line-height: 1.3;
  }
  .font-tab:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .font-tab.active {
    border-color: var(--accent);
    background: var(--accent-soft);
    color: var(--accent);
  }
  .font-tab:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* -- Font List -- */
  .font-list {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    gap: 3px;
    padding: 0 14px 10px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
    touch-action: pan-y;
  }
  .font-list::-webkit-scrollbar { width: 5px; }
  .font-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .font-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border: 1.5px solid transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background 0.12s, border-color 0.12s;
    background: transparent;
    flex-shrink: 0;
  }
  .font-item:hover {
    background: var(--accent-soft);
    border-color: var(--border);
  }
  .font-item.selected {
    background: var(--accent-soft);
    border-color: var(--accent);
  }
  .font-item-info {
    min-width: 0;
    flex: 1;
  }
  .font-item-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .font-item-meta {
    font-size: 10px;
    color: var(--text-muted);
  }
  .font-item-preview {
    width: 100%;
    height: 28px;
    image-rendering: pixelated;
    margin-top: 4px;
    border-radius: 3px;
    background: var(--bg);
  }
  .font-item-preview.loading {
    background: linear-gradient(90deg, var(--bg) 0%, var(--bg-deep) 50%, var(--bg) 100%);
    background-size: 200% 100%;
    animation: shimmer 1.5s ease-in-out infinite;
  }

  /* -- Height Slider -- */
  .height-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .height-slider {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    border-radius: 3px;
    background: var(--border);
    outline: none;
    transition: background 0.2s;
  }
  .height-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    transition: transform 0.1s;
  }
  .height-slider::-webkit-slider-thumb:hover {
    transform: scale(1.15);
  }
  .height-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .height-slider:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .height-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    font-family: var(--font-body);
    min-width: 32px;
    text-align: right;
    line-height: 1;
  }
  .height-unit {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* -- Color Swatches -- */
  .color-row {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    align-items: center;
  }
  .color-dot {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    transition: transform 0.12s, box-shadow 0.12s, border-color 0.12s;
    position: relative;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.08);
  }
  .color-dot:hover {
    transform: scale(1.2);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  .color-dot.selected {
    border-color: var(--text);
    box-shadow: 0 0 0 2px #fff, 0 0 0 3.5px var(--text);
    transform: scale(1.1);
  }
  .color-dot .tip {
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--text);
    color: #fff;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 10px;
    font-weight: 500;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.12s;
    z-index: 20;
  }
  .color-dot .tip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 3px solid transparent;
    border-top-color: var(--text);
  }
  .color-dot:hover .tip { opacity: 1; }

  /* "All colors" button in sidebar */
  .color-all-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1.5px dashed var(--text-muted);
    background: transparent;
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 9px;
    font-weight: 700;
    color: var(--text-muted);
    transition: border-color 0.12s, color 0.12s, background 0.12s;
  }
  .color-all-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-soft);
  }

  /* -- Desktop Color Popover -- */
  .sidebar-color-section { position: relative; }
  .color-popover {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: var(--panel);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    z-index: 30;
    padding: 10px;
    flex-direction: column;
    gap: 8px;
    max-height: 320px;
  }
  .color-popover.open { display: flex; }
  .color-popover-header {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .color-popover-search {
    flex: 1;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 6px 10px;
    font-family: var(--font-body);
    font-size: 12px;
    color: var(--text);
    background: #fff;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .color-popover-search:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  .color-popover-close {
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.12s, color 0.12s;
    flex-shrink: 0;
  }
  .color-popover-close:hover {
    background: var(--accent-soft);
    color: var(--accent);
  }
  .color-popover-grid {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    overflow-y: auto;
    overscroll-behavior: contain;
    max-height: 240px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .color-popover-grid .color-dot {
    width: 24px;
    height: 24px;
  }
  .color-popover-grid .color-dot .tip { display: none; }
  .color-popover-grid .color-dot:hover .tip { display: block; }
}


@layer components {
  /* -- Aida selector -- */
  .aida-row {
    display: flex;
    gap: 5px;
  }
  .aida-chip {
    flex: 1;
    text-align: center;
    padding: 8px 0;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-family: var(--font-body);
    background: transparent;
    transition: border-color 0.12s, background 0.12s, color 0.12s;
  }
  .aida-chip:hover { border-color: var(--accent); }
  .aida-chip.selected {
    border-color: var(--accent);
    background: var(--accent-soft);
  }
  .aida-chip:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .aida-chip-num {
    display: block;
    font-size: 17px;
    font-weight: 700;
    color: var(--text);
    line-height: 1.1;
  }
  .aida-chip.selected .aida-chip-num { color: var(--accent); }
  .aida-chip-label {
    font-size: 9px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  /* -- Custom stitch length -- */
  .custom-stitch-row {
    display: none;
    flex-direction: column;
    gap: 4px;
    margin-top: 8px;
    padding: 0;
  }
  .custom-stitch-row.visible { display: flex; }
  .custom-stitch-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .custom-stitch-header .stitch-label {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-mid);
  }
  .custom-stitch-header .stitch-value-display {
    display: flex;
    align-items: baseline;
    gap: 3px;
  }
  .custom-stitch-header .stitch-value-num {
    font-size: 15px;
    font-weight: 700;
    color: var(--accent);
    font-family: var(--font-body);
    line-height: 1;
  }
  .custom-stitch-header .stitch-value-unit {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-mid);
  }
  .custom-stitch-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: var(--border);
    outline: none;
  }
  .custom-stitch-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .custom-stitch-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .custom-stitch-slider:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .custom-stitch-equiv {
    font-size: 11px;
    color: var(--text-muted);
    text-align: center;
  }
  /* -- Alignment Buttons -- */
  .align-row, .mobile-align-row {
    display: flex;
    gap: 5px;
  }
  .align-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px 0;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-mid);
    background: transparent;
    transition: border-color 0.12s, background 0.12s, color 0.12s;
  }
  .align-btn svg {
    width: 18px;
    height: 18px;
  }
  .align-btn:hover { border-color: var(--accent); color: var(--accent); }
  .align-btn.active {
    border-color: var(--accent);
    background: var(--accent-soft);
    color: var(--accent);
  }
  .align-btn:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* Desktop sidebar: icon-only alignment buttons */
  .sidebar .align-btn span { display: none; }

  /* -- Global Unit Toggle (topbar cm/in) -- */
  .unit-toggle {
    display: flex;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    flex-shrink: 0;
  }
  .unit-toggle-btn {
    padding: 10px 14px;
    border: none;
    background: transparent;
    font-family: var(--font-body);
    font-size: 13px;
    font-weight: 700;
    color: var(--text-muted);
    cursor: pointer;
    transition: background 0.12s, color 0.12s;
    text-transform: lowercase;
    min-height: 40px;
    min-width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .unit-toggle-btn.active {
    background: var(--accent);
    color: #fff;
  }
  .unit-toggle-btn:not(.active):hover {
    background: var(--accent-soft);
    color: var(--accent);
  }
  .unit-toggle-btn:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
}


@layer components {
  /* -- Preview Area (right) -- */
  .preview-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 0;
    overflow: hidden;
    padding: 20px;
    position: relative;
  }

  .preview-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: var(--text-muted);
    font-size: 15px;
    text-align: center;
  }
  .preview-empty svg {
    width: 48px;
    height: 48px;
    opacity: 0.25;
    margin-bottom: 4px;
  }
  .preview-empty span {
    font-family: var(--font-display);
    font-size: 16px;
    font-style: italic;
  }

  /* -- Loading overlay -- */
  .preview-loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(245, 240, 234, 0.85);
    z-index: 5;
    gap: 12px;
  }
  .preview-loading.hidden { display: none; }
  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text {
    font-family: var(--font-display);
    font-size: 15px;
    font-style: italic;
    color: var(--text-mid);
  }

  .preview-canvas-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    max-width: 100%;
    max-height: 100%;
  }

  #mainCanvas {
    image-rendering: pixelated;
    max-width: 100%;
    max-height: calc(100vh - 200px);
    object-fit: contain;
    border-radius: 2px;
  }

  /* -- Stats Bar (below canvas) -- */
  .stats-bar {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .stat-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 11px;
    color: var(--text-mid);
    white-space: nowrap;
    transition: background 0.2s, color 0.2s;
  }
  .stat-pill strong {
    color: var(--text);
    font-weight: 700;
  }
  .stat-pill .unit {
    color: var(--text-muted);
    font-size: 10px;
  }

  .stat-pill.size-pill {
    background: var(--accent-soft);
    border-color: var(--accent);
  }
  .stat-pill.size-pill strong {
    color: var(--accent);
    font-size: 13px;
  }

  .stat-sep {
    color: var(--border);
    font-size: 11px;
    padding: 0 2px;
  }

  /* -- Ruler visualization -- */
  .ruler-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    width: 100%;
    max-width: 600px;
  }

  .ruler-line {
    display: flex;
    align-items: center;
    gap: 0;
  }
  .ruler-edge {
    width: 1px;
    height: 10px;
    background: var(--accent);
    flex-shrink: 0;
  }
  .ruler-bar {
    flex: 1;
    height: 1.5px;
    background: var(--accent);
    position: relative;
  }
  .ruler-label {
    position: absolute;
    top: -16px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
    white-space: nowrap;
    font-family: var(--font-body);
  }

  /* -- Vertical Ruler (left of canvas) -- */
  .ruler-vertical {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
    flex-shrink: 0;
    position: relative;
    min-width: 20px;
    margin-right: 2px;
  }
  .ruler-v-edge {
    height: 1px;
    width: 7px;
    background: var(--accent);
    flex-shrink: 0;
  }
  .ruler-v-bar {
    flex: 1;
    width: 1.5px;
    background: var(--accent);
    position: relative;
    min-height: 10px;
  }
  .ruler-v-label {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) rotate(-90deg);
    font-size: 11px;
    font-weight: 700;
    color: var(--accent);
    white-space: nowrap;
    font-family: var(--font-body);
    background: var(--bg-main, #faf8f5);
    padding: 2px 4px;
    line-height: 1;
  }

  /* Desktop: flex row so vertical ruler + canvas sit side by side */
  .canvas-rulers-wrap {
    display: flex;
    align-items: flex-start;
    gap: 0;
    justify-content: center;
  }
}


@layer sheets {
  /* ============================================= */
  /* -- Sheet Backdrop -- */
  /* ============================================= */
  .sheet-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    -webkit-backdrop-filter: blur(2px);
    backdrop-filter: blur(2px);
    z-index: 55;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .sheet-backdrop.visible {
    display: block;
    opacity: 1;
  }

  /* ============================================= */
  /* -- Bottom Sheets (generic) -- */
  /* ============================================= */
  .bottom-sheet {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--panel);
    border-radius: 16px 16px 0 0;
    z-index: 60;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    box-shadow: 0 -4px 20px rgba(0,0,0,0.12);
    overflow: hidden;
    max-height: 85vh;
    max-height: 85dvh;
    padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
  }
  @media (max-width: 640px) {
    .bottom-sheet { display: block; }
  }
  .bottom-sheet.open {
    transform: translateY(0);
  }
  .sheet-handle {
    display: flex;
    justify-content: center;
    padding: 12px 0 10px;
    min-height: 44px;
    touch-action: none;
    cursor: grab;
    -webkit-tap-highlight-color: transparent;
  }
  .sheet-handle::after {
    content: '';
    width: 40px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
  }
  .sheet-title {
    font-family: var(--font-display);
    font-size: 18px;
    color: var(--text);
    padding: 0 16px 12px;
    border-bottom: 1px solid var(--border-light);
    text-wrap: balance;
  }
  .sheet-body {
    overflow-y: auto;
    overscroll-behavior: contain;
  }

  /* -- Font Sheet -- */
  .sheet-font { max-height: 70dvh; }
  .sheet-font .sheet-body { flex: 1; overflow: hidden; display: flex; flex-direction: column; height: calc(70vh - 40px - 46px); height: calc(70dvh - 40px - 46px); }
  .sheet-font-search {
    position: sticky;
    top: 0;
    z-index: 2;
    padding: 8px 16px;
    background: var(--panel);
  }
  .sheet-font-search input {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
    font-family: var(--font-body);
    font-size: 16px;
    color: var(--text);
    background: #fff;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .sheet-font-search input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  .sheet-font-tabs {
    display: flex;
    gap: 4px;
    padding: 4px 16px 8px;
    overflow-x: auto;
    flex-shrink: 0;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .sheet-font-tabs::-webkit-scrollbar { display: none; }
  .sheet-font-tabs .font-tab {
    min-height: 36px;
    padding: 6px 12px;
    font-size: 12px;
  }
  .sheet-font-list-wrap {
    flex: 1;
    overflow-y: auto;
    overscroll-behavior: contain;
    position: relative;
    min-height: 0;
  }
  .sheet-font-list-viewport {
    position: relative;
  }
  .sheet-font-item {
    display: flex;
    align-items: center;
    height: 80px;
    padding: 0 16px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: background 0.12s;
    border-left: 3px solid transparent;
  }
  .sheet-font-item:active {
    background: var(--accent-soft);
  }
  .sheet-font-item.selected {
    background: var(--accent-soft);
    border-left-color: var(--accent);
  }
  .sheet-font-item-info {
    flex: 1;
    min-width: 0;
  }
  .sheet-font-item-name {
    font-size: 15px;
    font-weight: 700;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .sheet-font-item-meta {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .sheet-font-item-check {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    color: var(--accent);
    display: none;
  }
  .sheet-font-item.selected .sheet-font-item-check {
    display: block;
  }
  .sheet-font-item-preview {
    width: 100%;
    height: 36px;
    image-rendering: pixelated;
    margin-top: 4px;
    border-radius: 3px;
    background: var(--bg);
  }
  .sheet-font-item-preview.loading {
    background: linear-gradient(90deg, var(--bg) 0%, var(--bg-deep) 50%, var(--bg) 100%);
    background-size: 200% 100%;
    animation: shimmer 1.5s ease-in-out infinite;
  }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  /* -- Color Sheet -- */
  .sheet-color .sheet-body { padding: 16px; }
  .sheet-color-current {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg);
    border-radius: var(--radius);
    margin-bottom: 16px;
  }
  .sheet-color-swatch {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    flex-shrink: 0;
  }
  .sheet-color-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
  }
  .sheet-color-code {
    font-size: 12px;
    color: var(--text-muted);
  }
  .sheet-color-search {
    position: sticky;
    top: 0;
    z-index: 2;
    padding: 0 0 12px;
    background: var(--panel);
  }
  .sheet-color-search input {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
    font-family: var(--font-body);
    font-size: 16px;
    color: var(--text);
    background: #fff;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .sheet-color-search input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  .sheet-color-grid {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-start;
    max-height: 50vh;
    overflow-y: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .sheet-color-grid .color-dot {
    width: 44px;
    height: 44px;
  }

  /* -- Settings Sheet -- */
  .sheet-settings .sheet-body { padding: 16px; }
  .sheet-settings-group {
    margin-bottom: 20px;
  }
  .sheet-settings-group:last-child { margin-bottom: 0; }
  .sheet-settings-label {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .sheet-settings .height-control { margin-bottom: 0; }
  .sheet-settings .aida-row { flex-wrap: wrap; gap: 8px; }
  .sheet-settings .aida-chip { min-height: 52px; padding: 12px 8px; flex: 0 0 calc(33.33% - 6px); }
  .sheet-settings .aida-chip-num { font-size: 22px; }
  .sheet-settings .custom-stitch-row { margin-top: 12px; }
  .sheet-settings .custom-count-input { min-height: 44px; font-size: 16px; }

  /* -- Info Sheet -- */
  .sheet-info .sheet-body { padding: 16px; }
  .sheet-info-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 16px;
  }
  .sheet-info-card {
    background: var(--bg);
    border: 1px solid var(--border-light);
    border-radius: var(--radius);
    padding: 12px;
    text-align: center;
  }
  .sheet-info-card-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    line-height: 1.2;
  }
  .sheet-info-card-label {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 2px;
  }
  .sheet-info-card.full-width {
    grid-column: 1 / -1;
  }
  .sheet-info-ruler {
    margin: 16px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
  }
  .sheet-info-ruler .ruler-line {
    width: 100%;
    max-width: 300px;
  }
  .sheet-info-lang {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .sheet-info-lang label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-mid);
  }
  .sheet-info-lang select {
    flex: 1;
    padding: 8px 12px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    background: #fff;
    font-family: var(--font-body);
    font-size: 14px;
    color: var(--text);
    outline: none;
    -webkit-appearance: none;
    appearance: none;
  }

  /* -- Reduced motion -- */
  @media (prefers-reduced-motion: reduce) {
    .bottom-sheet { transition-duration: 0.01ms !important; }
    .sheet-backdrop { transition-duration: 0.01ms !important; }
  }

  /* -- Body scroll lock -- */
  body.sheet-open {
    overflow: hidden !important;
    touch-action: none;
  }
}


@layer responsive {
  /* ============================================= */
  /* -- Responsive: Mobile (<=640px) -- */
  /* Canvas First: topbar -> canvas -> toolbar     */
  /* ============================================= */
  @media (max-width: 640px) {
    html, body { height: 100vh; height: 100dvh; overflow: hidden; }
    body { height: 100vh; height: 100dvh; }

    .topbar {
      padding: calc(6px + env(safe-area-inset-top, 0px)) 12px 6px;
      gap: 8px;
      height: 48px;
      min-height: 48px;
    }
    .topbar-sep, .logo { display: none; }
    .lang-select {
      font-size: 12px;
      padding: 2px 16px 2px 4px;
      border: none;
      background-color: transparent;
      background-position: right 4px center;
      opacity: 0.7;
    }
    .unit-toggle { border-radius: var(--radius-sm); }
    .unit-toggle-btn { padding: 6px 12px; min-height: 36px; min-width: 36px; font-size: 12px; }

    .text-input-area { display: none; }
    .text-input { font-size: 16px; min-height: 36px; padding: 6px 12px; }
    .btn-download { padding: 8px; min-height: 36px; min-width: 36px; }
    .btn-download .dl-label { display: none; }

    .main-layout {
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
      flex: 1;
      padding-bottom: calc(228px + env(safe-area-inset-bottom, 0px));
    }

    .sidebar { display: none !important; }

    .preview-area {
      flex: 1;
      padding: 14px 16px 14px 40px; /* extra left for vertical ruler label */
      min-height: 0;
      max-height: none;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    #mainCanvas {
      /* 48px header + 126px toolbar + safe-area + 100px stats(2rows)/rulers/gaps + 28px padding */
      max-height: calc(100vh - 48px - 228px - env(safe-area-inset-bottom, 0px) - 128px);
      max-height: calc(100dvh - 48px - 228px - env(safe-area-inset-bottom, 0px) - 128px);
    }

    /* Stats: responsive wrap on mobile */
    .stats-bar {
      gap: 4px 6px;
      padding: 0 4px;
      flex-wrap: wrap;
      justify-content: center;
      overflow: visible;
    }
    .stat-pill { padding: 2px 8px; font-size: 9px; }
    .stat-pill strong { font-size: 10px; }
    .stat-pill.size-pill strong { font-size: 11px; }
    .stat-sep { display: none; }

    /* Preview wrap: generous spacing between canvas, rulers, stats */
    .preview-canvas-wrap { gap: 14px; }

    /* Ruler: compact but readable */
    .ruler-info { gap: 2px; max-width: 100%; margin-top: 2px; }
    .ruler-label { font-size: 11px; top: -16px; }
    .ruler-edge { height: 8px; }

    /* Vertical ruler: visible on mobile */
    .ruler-vertical { display: flex; margin-right: 6px; }

    /* Canvas with rulers layout */
    .canvas-rulers-wrap {
      display: flex;
      align-items: flex-start;
      gap: 0;
      max-width: 100%;
      min-height: 0;
      justify-content: center;
    }
  }

  /* ============================================= */
  /* -- Mobile Toolbar (Slider + 3 Buttons) -- */
  /* ============================================= */
  .mobile-toolbar {
    display: none;
  }
  @media (max-width: 640px) {
    .mobile-toolbar {
      display: flex;
      flex-direction: column;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding-bottom: env(safe-area-inset-bottom, 0px);
      background: var(--panel);
      border-top: 1px solid var(--border);
      z-index: 50;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.08);
    }
  }

  /* Row 1: Height slider — generous touch area */
  .mobile-slider-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 16px 8px;
    flex-shrink: 0;
  }
  .mobile-slider-row .height-slider {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    border-radius: 4px;
    background: var(--border);
    outline: none;
  }
  .mobile-slider-row .height-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  .mobile-slider-row .height-slider::-moz-range-thumb {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  .mobile-slider-label {
    font-family: var(--font-body);
    font-size: 13px;
    font-weight: 700;
    color: var(--text-mid);
    white-space: nowrap;
    letter-spacing: 0.3px;
    text-transform: uppercase;
  }
  .mobile-slider-value {
    font-family: var(--font-body);
    font-size: 20px;
    font-weight: 700;
    color: var(--accent);
    min-width: 28px;
    text-align: right;
    line-height: 1;
  }
  .mobile-slider-unit {
    font-size: 11px;
    color: var(--text-mid);
    font-weight: 600;
  }

  /* Row 2: 3 action buttons — big touch targets */
  .mobile-buttons-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px 14px;
    flex-shrink: 0;
  }

  /* Shared toolbar button style — 52px height for easy thumb taps */
  .mobile-tb-btn {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1.5px solid var(--border);
    background: var(--surface);
    border-radius: 14px;
    padding: 0 14px;
    height: 52px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    color: var(--text);
    font-family: var(--font-body);
    font-size: 14px;
    font-weight: 600;
    min-width: 0;
    transition: background 0.12s, border-color 0.12s;
  }
  .mobile-tb-btn:active {
    background: var(--accent-soft);
    border-color: var(--accent);
  }
  .mobile-tb-btn svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
    flex-shrink: 0;
  }
  .mobile-tb-btn .tb-label {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    min-width: 0;
  }
  .mobile-tb-btn .tb-chevron {
    width: 12px;
    height: 12px;
    margin-left: auto;
    flex-shrink: 0;
    opacity: 0.4;
  }

  /* Mobile alignment row */
  .mobile-align-row {
    padding: 4px 12px 6px;
    gap: 8px;
  }
  .mobile-align-row .align-btn {
    min-height: 40px;
    border-radius: 10px;
  }

  /* Color button swatch */
  .mobile-color-swatch {
    width: 26px;
    height: 26px;
    min-width: 26px;
    border-radius: 50%;
    border: 2.5px solid var(--border);
    flex-shrink: 0;
  }

  /* -- Mobile Input Bar (above toolbar) -- */
  .mobile-input-bar {
    display: none;
  }
  @media (max-width: 640px) {
    .mobile-input-bar {
      display: flex;
      position: fixed;
      bottom: calc(176px + env(safe-area-inset-bottom, 0px));
      left: 0;
      right: 0;
      padding: 8px 12px;
      background: var(--panel);
      border-top: 1px solid var(--border);
      z-index: 49;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.04);
    }
    .mobile-text-input {
      width: 100%;
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 14px;
      font-family: var(--font-display);
      font-size: 18px;
      color: var(--text);
      background: #fff;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      touch-action: manipulation;
      min-height: 44px;
      max-height: 100px;
      resize: none;
      overflow-y: auto;
      line-height: 1.3;
      field-sizing: content;
    }
    .mobile-text-input::placeholder {
      color: var(--text-muted);
      font-style: italic;
    }
    .mobile-text-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    /* Hint: tapping canvas focuses the input */
    .preview-area { cursor: text; }
  }

  /* -- Keyboard Open Mode: hide toolbar, maximize canvas space -- */
  @media (max-width: 640px) {
    body.keyboard-open .mobile-toolbar {
      transform: translateY(100%);
      pointer-events: none;
      opacity: 0;
      transition: transform 0.2s ease, opacity 0.15s ease;
    }
    body.keyboard-open .mobile-input-bar {
      bottom: env(safe-area-inset-bottom, 0px);
    }
    body.keyboard-open .main-layout {
      padding-bottom: calc(52px + env(safe-area-inset-bottom, 0px));
    }
    body.keyboard-open #mainCanvas {
      max-height: calc(100vh - 48px - 52px - env(safe-area-inset-bottom, 0px) - 80px);
      max-height: calc(100dvh - 48px - 52px - env(safe-area-inset-bottom, 0px) - 80px);
    }
    body.keyboard-open .stats-bar { display: none; }
    body.keyboard-open .ruler-info { display: none; }
  }

  /* -- Desktop: cursor hint for canvas tap-to-focus -- */
  @media (min-width: 641px) {
    .preview-area { cursor: text; }
  }

  /* ============================================= */
  /* -- Responsive: Small phones (<=380px) -- */
  /* ============================================= */
  @media (max-width: 380px) {
    .text-input { font-size: 16px; padding: 8px 10px; }
    .btn-download { padding: 8px 12px; }
    .preview-area { padding: 8px; min-height: 200px; }
    .color-dot { width: 36px; height: 36px; }
  }

  /* ============================================= */
  /* -- Responsive: Tablet (641-1024px) -- */
  /* ============================================= */
  @media (min-width: 641px) and (max-width: 1024px) {
    .sidebar { width: 250px; }
    .text-input { font-size: 18px; }
  }

  /* ============================================= */
  /* -- Responsive: Desktop (>1024px) -- */
  /* ============================================= */
  @media (min-width: 1025px) {
    .sidebar { width: 300px; }
  }

  /* -- Language selector -- */
  .lang-select {
    flex-shrink: 0;
    padding: 4px 6px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    background: #fff;
    font-family: var(--font-body);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-mid);
    cursor: pointer;
    outline: none;
    transition: border-color 0.15s;
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23a99e8f'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 6px center;
    padding-right: 20px;
  }
  .lang-select:hover, .lang-select:focus { border-color: var(--accent); }
  .lang-select:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* -- Scrollbar global -- */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
}


/* Payment modal styles (Lemon Squeezy overlay) */
@layer components {

  #pay-modal,
  #free-modal,
  #upsell-modal {
    position: fixed;
    inset: 0;
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #pay-modal.pay-hidden,
  #free-modal.pay-hidden,
  #upsell-modal.pay-hidden {
    display: none;
  }

  .pay-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(61, 50, 41, 0.35);
    backdrop-filter: blur(2px);
  }

  .pay-dialog {
    position: relative;
    background: #faf8f5;
    border-radius: 16px;
    padding: 2rem;
    max-width: 560px;
    width: 90vw;
    box-shadow: 0 20px 60px rgba(61, 50, 41, 0.35);
    text-align: center;
  }

  .pay-close {
    position: absolute;
    top: 12px;
    right: 14px;
    background: none;
    border: none;
    font-size: 1.4rem;
    color: #a99e8f;
    cursor: pointer;
    padding: 8px 12px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: background 0.15s, color 0.15s;
  }

  .pay-close:hover {
    background: rgba(184, 58, 42, 0.08);
    color: #b83a2a;
  }

  .pay-title {
    font-family: 'DM Serif Display', Georgia, serif;
    font-size: 1.4rem;
    color: #3d3229;
    margin-bottom: 0.3rem;
  }

  .pay-subtitle {
    font-size: 0.9rem;
    color: #7a6e60;
    margin-bottom: 1.5rem;
  }

  .pay-options {
    display: flex;
    gap: 0.75rem;
  }

  .pay-option {
    flex: 1;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
    padding: 1.2rem 0.75rem;
    border: 2px solid #e0d6c8;
    border-radius: 12px;
    background: #fff;
    cursor: pointer;
    transition: border-color 0.2s, transform 0.15s;
    font-family: 'Anybody', system-ui, sans-serif;
  }

  .pay-option:hover {
    border-color: #b83a2a;
    transform: translateY(-2px);
  }

  .pay-option:focus-visible {
    outline: 2px solid #b83a2a;
    outline-offset: 2px;
  }

  .pay-option-featured {
    border-color: #b83a2a;
    background: linear-gradient(180deg, rgba(184, 58, 42, 0.08), #fff);
    box-shadow: 0 4px 16px rgba(184, 58, 42, 0.12);
    transform: scale(1.03);
  }

  .pay-option-featured:hover {
    transform: scale(1.03) translateY(-2px);
  }

  .pay-option-badge {
    position: absolute;
    top: -11px;
    background: linear-gradient(135deg, #b83a2a, #d44a3a);
    color: #fff;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 3px 12px;
    border-radius: 10px;
    letter-spacing: 0.03em;
    text-transform: uppercase;
  }

  .pay-option-price {
    font-size: 1.4rem;
    font-weight: 700;
    color: #3d3229;
  }

  .pay-option-price small {
    font-size: 0.7rem;
    font-weight: 500;
    color: #7a6e60;
  }

  .pay-option-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #3d3229;
  }

  .pay-option-desc {
    font-size: 0.75rem;
    color: #a99e8f;
    line-height: 1.3;
  }

  .pay-option-unit {
    font-size: 0.7rem;
    font-weight: 600;
    color: #b83a2a;
    letter-spacing: 0.02em;
  }

  /* -- Trust signal -- */

  .pay-trust {
    text-align: center;
    font-size: 0.7rem;
    color: #a99e8f;
    margin: 0.5rem 0 0;
    line-height: 1.3;
  }

  /* -- Divider ("Already purchased?") -- */

  .pay-indie-note {
    text-align: center;
    font-size: 0.7rem;
    color: #a99e8f;
    margin: 1rem 0 0.25rem;
    line-height: 1.4;
    font-style: italic;
  }

  .pay-terms {
    text-align: center;
    font-size: 0.65rem;
    color: #a99e8f;
    margin: 0.35rem 0 0;
    line-height: 1.3;
  }

  .pay-terms a {
    color: #a99e8f;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .pay-terms a:hover {
    color: #7a6e60;
  }

  .pay-divider {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 1.25rem 0 1rem;
    color: #a99e8f;
    font-size: 0.75rem;
  }

  .pay-divider::before,
  .pay-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: #e0d6c8;
  }

  /* -- License key input row -- */

  .pay-key-input {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .pay-key-input input {
    flex: 1;
    padding: 0.6rem 0.75rem;
    border: 2px solid #e0d6c8;
    border-radius: 8px;
    font-family: 'Anybody', system-ui, sans-serif;
    font-size: 0.85rem;
    color: #3d3229;
    background: #fff;
    outline: none;
    transition: border-color 0.15s;
  }

  .pay-key-input input:focus {
    border-color: #b83a2a;
  }

  .pay-key-input input::placeholder {
    color: #c4bbb0;
  }

  .pay-key-input button {
    padding: 0.6rem 1rem;
    border: none;
    border-radius: 8px;
    background: #3d3229;
    color: #fff;
    font-family: 'Anybody', system-ui, sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
    white-space: nowrap;
  }

  .pay-key-input button:hover {
    background: #2a231c;
  }

  .pay-key-input button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* -- Credits display -- */

  #credits-display {
    font-size: 0.8rem;
    color: #3d3229;
    font-weight: 600;
    background: rgba(184, 58, 42, 0.06);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    display: inline-block;
  }

  #credits-display.pay-hidden {
    display: none;
  }

  /* -- Responsive: stack payment options vertically on narrow screens -- */

  @media (max-width: 520px) {
    .pay-options { flex-direction: column; gap: 0.6rem; }
    .pay-dialog { padding: 1.5rem; }
    .pay-option { padding: 1rem 0.75rem; }
  }

  /* -- Free first download modal -- */

  .free-dialog {
    max-width: 420px;
  }

  .free-gift {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }

  .free-email-row {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .free-email-row input {
    flex: 1;
    padding: 0.7rem 0.9rem;
    border: 2px solid #e0d6c8;
    border-radius: 8px;
    font-family: 'Anybody', system-ui, sans-serif;
    font-size: 0.9rem;
    color: #3d3229;
    background: #fff;
    outline: none;
    transition: border-color 0.15s;
  }

  .free-email-row input:focus {
    border-color: #b83a2a;
  }

  .free-email-row input::placeholder {
    color: #c4bbb0;
  }

  .free-email-row button {
    padding: 0.7rem 1.2rem;
    border: none;
    border-radius: 8px;
    background: #b83a2a;
    color: #fff;
    font-family: 'Anybody', system-ui, sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
    white-space: nowrap;
  }

  .free-email-row button:hover {
    background: #9c3023;
  }

  .free-error {
    color: #b83a2a;
    font-size: 0.8rem;
    margin-top: 0.4rem;
    min-height: 1.2em;
  }

  .free-note {
    font-size: 0.7rem;
    color: #a99e8f;
    margin-top: 0.75rem;
    font-style: italic;
  }

  @media (max-width: 520px) {
    .free-email-row { flex-direction: column; }
  }

  /* -- Post-purchase upsell modal -- */

  .upsell-dialog {
    max-width: 420px;
  }

  .upsell-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }

  .upsell-deal {
    font-size: 0.95rem;
    font-weight: 600;
    color: #b83a2a;
    margin: 0.75rem 0 1.25rem;
    padding: 0.6rem 1rem;
    background: rgba(184, 58, 42, 0.06);
    border-radius: 8px;
  }

  .upsell-btn {
    display: block;
    width: 100%;
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 10px;
    background: #b83a2a;
    color: #fff;
    font-family: 'Anybody', system-ui, sans-serif;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
  }

  .upsell-btn:hover {
    background: #9c3023;
  }

  .upsell-skip {
    display: block;
    width: 100%;
    padding: 0.6rem;
    border: none;
    background: none;
    color: #a99e8f;
    font-family: 'Anybody', system-ui, sans-serif;
    font-size: 0.8rem;
    cursor: pointer;
    margin-top: 0.5rem;
  }

  .upsell-skip:hover {
    color: #7a6e60;
  }

  /* -- Key-only mode: after payment, hide plan cards and show only key input -- */

  .pay-key-only .pay-options,
  .pay-key-only .pay-indie-note,
  .pay-key-only .pay-trust,
  .pay-key-only .pay-terms {
    display: none;
  }

  .pay-key-only .pay-divider span {
    font-weight: 600;
    color: #7a6e60;
  }

  /* -- Checkout iframe overlay (replaces lemon.js) -- */

  .ls-overlay {
    position: fixed;
    inset: 0;
    z-index: 99999;
    background: rgba(61, 50, 41, 0.12);
    backdrop-filter: blur(1px);
    animation: ls-overlay-fadein 0.2s ease-out;
  }

  @keyframes ls-overlay-fadein {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .ls-overlay-iframe {
    position: fixed;
    inset: 0;
    z-index: 99999;
    width: 100%;
    height: 100%;
    border: none;
    background: transparent;
  }

  .ls-overlay-close {
    position: fixed;
    top: max(12px, env(safe-area-inset-top, 12px));
    right: max(16px, env(safe-area-inset-right, 16px));
    z-index: 100001;
    background: rgba(61, 50, 41, 0.7);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 1.3rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s, opacity 0.3s;
    opacity: 0;
    animation: ls-close-fadein 0.4s 1.5s forwards;
  }

  .ls-overlay-close:hover {
    background: rgba(184, 58, 42, 0.9);
  }

  @keyframes ls-close-fadein {
    to { opacity: 1; }
  }

  .ls-overlay-loader {
    position: fixed;
    inset: 0;
    z-index: 100000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ls-overlay-spinner {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #b83a2a;
    animation: ls-pulse 1s ease-out infinite;
  }

  @keyframes ls-pulse {
    0% { opacity: 1; transform: scale(0.1); }
    100% { opacity: 0; transform: scale(1); }
  }
}

</style>
</head>
<body>

<!-- -- Top Bar -- -->
<header class="topbar">
  <div class="logo">
    <span class="logo-x">&#10006;</span>
    <span class="logo-text">Word<em>2</em>Stitch</span>
  </div>

  <div class="topbar-sep"></div>

  <div class="text-input-area">
    <textarea
      class="text-input"
      id="textInput"
      aria-label="Text to render"
      placeholder="Type your text here…"
      data-i18n-placeholder="placeholder_text"
      maxlength="200"
      autocomplete="off"
      spellcheck="false"
      rows="1"
    >Hello</textarea>
  </div>

  <select class="lang-select" id="langSelect" aria-label="Language">
    <option value="en">🇬🇧 EN</option>
    <option value="es">🇪🇸 ES</option>
    <option value="fr">🇫🇷 FR</option>
    <option value="de">🇩🇪 DE</option>
    <option value="it">🇮🇹 IT</option>
    <option value="pt">🇧🇷 PT</option>
    <option value="nl">🇳🇱 NL</option>
    <option value="ja">🇯🇵 JA</option>
    <option value="ko">🇰🇷 KO</option>
    <option value="zh">🇨🇳 ZH</option>
    <option value="ru">🇷🇺 RU</option>
    <option value="pl">🇵🇱 PL</option>
    <option value="sv">🇸🇪 SV</option>
    <option value="da">🇩🇰 DA</option>
    <option value="fi">🇫🇮 FI</option>
    <option value="uk">🇺🇦 UK</option>
    <option value="hu">🇭🇺 HU</option>
  </select>

  <div class="unit-toggle" id="unitToggle">
    <button class="unit-toggle-btn active" data-unit="metric" aria-pressed="true" aria-label="Centimeters">cm</button>
    <button class="unit-toggle-btn" data-unit="imperial" aria-pressed="false" aria-label="Inches">in</button>
  </div>

  <button class="btn-download" id="btnDownload" aria-label="Download PDF">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="7 10 12 15 17 10"/>
      <line x1="12" y1="15" x2="12" y2="3"/>
    </svg>
    <span class="dl-label">PDF</span>
  </button>

</header>

<!-- -- Main Split Layout -- -->
<main class="main-layout">

  <!-- -- Left Sidebar: Controls -- -->
  <aside class="sidebar">

    <!-- Font Search + Header -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
        <span data-i18n="section_font">Font</span>
      </div>
      <input
        type="text"
        class="font-search"
        id="fontSearch"
        aria-label="Search fonts"
        placeholder="Search fonts…"
        data-i18n-placeholder="search_fonts"
        autocomplete="off"
        spellcheck="false"
      />
      <div class="font-tabs" id="fontCategoryTabs">
        <button class="font-tab active" data-category="all">All</button>
      </div>
    </div>

    <!-- Font List (scrollable) -->
    <div class="font-list" id="fontList"></div>

    <!-- Height Control -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h4M18 12h4M7 7l2 2M15 15l2 2M7 17l2-2M15 7l2-2"/></svg>
        <span data-i18n="section_height">Stitch Height</span>
      </div>
      <div class="height-control">
        <input type="range" class="height-slider" id="heightSlider" min="8" max="30" value="18" step="1" aria-label="Stitch height" />
        <div>
          <span class="height-value" id="heightValue">18</span>
          <span class="height-unit" data-i18n="unit_px">st</span>
        </div>
      </div>
    </div>

    <!-- Text Alignment -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        <span data-i18n="section_align">Alignment</span>
      </div>
      <div class="align-row" id="alignRow">
        <button class="align-btn" data-align="left" aria-label="Align left">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>
          <span data-i18n="align_left">Left</span>
        </button>
        <button class="align-btn active" data-align="center" aria-label="Align center">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>
          <span data-i18n="align_center">Center</span>
        </button>
        <button class="align-btn" data-align="right" aria-label="Align right">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg>
          <span data-i18n="align_right">Right</span>
        </button>
      </div>
    </div>

    <!-- Color Picker -->
    <div class="sidebar-section sidebar-color-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
        <span data-i18n="section_color">Thread Color</span>
      </div>
      <div class="color-row" id="colorRow"></div>
      <!-- Desktop color popover (all 449 DMC colors with search) -->
      <div class="color-popover" id="colorPopover">
        <div class="color-popover-header">
          <input type="text" class="color-popover-search" id="colorPopoverSearch" placeholder="Search DMC colors…" autocomplete="off" spellcheck="false" />
          <button class="color-popover-close" id="colorPopoverClose" aria-label="Close">&times;</button>
        </div>
        <div class="color-popover-grid" id="colorPopoverGrid"></div>
      </div>
    </div>

    <!-- Aida Count -->
    <div class="sidebar-section">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
        <span data-i18n="section_fabric">Fabric</span>
      </div>
      <div class="aida-row" id="aidaRow">
        <button class="aida-chip" data-count="11">
          <span class="aida-chip-num">11</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip selected" data-count="14">
          <span class="aida-chip-num">14</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip" data-count="16">
          <span class="aida-chip-num">16</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip" data-count="18">
          <span class="aida-chip-num">18</span>
          <span class="aida-chip-label" data-i18n="label_aida">Aida</span>
        </button>
        <button class="aida-chip" data-count="custom" id="aidaCustomChip">
          <span class="aida-chip-num">✎</span>
          <span class="aida-chip-label" data-i18n="label_custom">Custom</span>
        </button>
      </div>
      <div class="custom-stitch-row" id="customStitchRow">
        <div class="custom-stitch-header">
          <span class="stitch-label" data-i18n="label_stitch_length">Stitch length</span>
          <div class="stitch-value-display">
            <span class="stitch-value-num" id="customStitchValue">3.0</span>
            <span class="stitch-value-unit" id="customStitchUnit">mm</span>
          </div>
        </div>
        <input type="range" class="custom-stitch-slider" id="customStitchSlider" min="1" max="10" value="3" step="0.1" aria-label="Custom stitch length" />
        <div class="custom-stitch-equiv" id="customStitchEquiv"></div>
      </div>
    </div>

  </aside>

  <!-- -- Right: Preview -- -->
  <div class="preview-area" id="previewArea">

    <!-- Loading overlay -->
    <div class="preview-loading hidden" id="previewLoading">
      <div class="loading-spinner"></div>
      <div class="loading-text" data-i18n="loading_text">Rasterizing…</div>
    </div>

    <div class="preview-empty" id="previewEmpty">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <line x1="3" y1="9" x2="21" y2="9"/>
        <line x1="3" y1="15" x2="21" y2="15"/>
        <line x1="9" y1="3" x2="9" y2="21"/>
        <line x1="15" y1="3" x2="15" y2="21"/>
      </svg>
      <span data-i18n="empty_state">Type something to see your pattern</span>
    </div>

    <div class="preview-canvas-wrap" id="previewWrap" style="display:none;">
      <!-- Canvas + vertical ruler wrapper -->
      <div class="canvas-rulers-wrap">
        <!-- Vertical ruler (left of canvas, mobile only) -->
        <div class="ruler-vertical" id="rulerVertical">
          <div class="ruler-v-edge"></div>
          <div class="ruler-v-bar">
            <div class="ruler-v-label" id="rulerHeight">--</div>
          </div>
          <div class="ruler-v-edge"></div>
        </div>
        <canvas id="mainCanvas"></canvas>
      </div>

      <!-- Ruler showing width in cm -->
      <div class="ruler-info" id="rulerInfo">
        <div class="ruler-line">
          <div class="ruler-edge"></div>
          <div class="ruler-bar">
            <div class="ruler-label" id="rulerWidth">--</div>
          </div>
          <div class="ruler-edge"></div>
        </div>
      </div>

      <!-- Stats pills -->
      <div class="stats-bar" id="statsBar">
        <div class="stat-pill size-pill">
          <strong id="statSizeCm">--</strong>
          <span class="unit" id="statSizeUnit">cm</span>
        </div>
        <div class="stat-sep">.</div>
        <div class="stat-pill">
          <strong id="statStitchesW">--</strong>x<strong id="statStitchesH">--</strong>
          <span class="unit" data-i18n="unit_stitches">stitches</span>
        </div>
        <div class="stat-sep">.</div>
        <div class="stat-pill">
          <strong id="statTotal">--</strong>
          <span class="unit" data-i18n="unit_crosses">crosses</span>
        </div>
        <div class="stat-sep">.</div>
        <div class="stat-pill">
          DMC <strong id="statDmc">--</strong>
          <span class="unit" id="statThread">--</span>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- -- Mobile Input Bar -- -->
<div class="mobile-input-bar" id="mobileInputBar">
  <textarea
    class="mobile-text-input"
    id="mobileTextInput"
    aria-label="Text to render"
    placeholder="Type your text here…"
    data-i18n-placeholder="placeholder_text"
    maxlength="200"
    autocomplete="off"
    spellcheck="false"
    rows="2"
  >Hello</textarea>
</div>

<!-- -- Mobile Toolbar (Slider + 3 Buttons) -- -->
<div class="mobile-toolbar" id="mobileToolbar">
  <!-- Row 1: Height slider -->
  <div class="mobile-slider-row">
    <span class="mobile-slider-label">H</span>
    <input type="range" class="height-slider" id="mobileHeightSlider" min="8" max="30" value="18" step="1" />
    <span class="mobile-slider-value" id="mobileHeightValue">18</span>
    <span class="mobile-slider-unit">st</span>
  </div>
  <!-- Row 2: Text alignment -->
  <div class="mobile-align-row" id="mobileAlignRow">
    <button class="align-btn" data-align="left" aria-label="Align left">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>
    </button>
    <button class="align-btn active" data-align="center" aria-label="Align center">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>
    </button>
    <button class="align-btn" data-align="right" aria-label="Align right">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg>
    </button>
  </div>
  <!-- Row 3: Aida + Font + Color buttons -->
  <div class="mobile-buttons-row">
    <button class="mobile-tb-btn" id="mobileAidaBtn" aria-label="Fabric settings">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
      <span class="tb-label" id="mobileAidaValue">14 ct</span>
      <svg class="tb-chevron" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
    </button>
    <button class="mobile-tb-btn" id="mobileFontBtn" aria-label="Select font">
      <svg viewBox="0 0 24 24"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg>
      <span class="tb-label" id="mobileFontName">Font</span>
      <svg class="tb-chevron" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
    </button>
    <button class="mobile-tb-btn" id="mobileColorBtn" aria-label="Thread color">
      <div class="mobile-color-swatch" id="mobileColorSwatch"></div>
      <span class="tb-label" id="mobileColorName">Black</span>
      <svg class="tb-chevron" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
    </button>
  </div>
</div>

<!-- -- Sheet Backdrop -- -->
<div class="sheet-backdrop" id="sheetBackdrop"></div>

<!-- -- Font Bottom Sheet -- -->
<div class="bottom-sheet sheet-font" id="sheetFont" role="dialog" aria-modal="true" aria-label="Font selector">
  <div class="sheet-handle" id="sheetFontHandle"></div>
  <div class="sheet-title" data-i18n="section_font">Font</div>
  <div class="sheet-body">
    <div class="sheet-font-search">
      <input type="text" id="sheetFontSearch" aria-label="Search fonts" placeholder="Search fonts…" data-i18n-placeholder="search_fonts" autocomplete="off" spellcheck="false" />
    </div>
    <div class="sheet-font-tabs" id="sheetFontTabs"></div>
    <div class="sheet-font-list-wrap" id="sheetFontListWrap" role="listbox" aria-label="Font list">
      <div class="sheet-font-list-viewport" id="sheetFontListViewport"></div>
    </div>
  </div>
</div>

<!-- -- Color Bottom Sheet -- -->
<div class="bottom-sheet sheet-color" id="sheetColor" role="dialog" aria-modal="true" aria-label="Color selector">
  <div class="sheet-handle" id="sheetColorHandle"></div>
  <div class="sheet-title" data-i18n="section_color">Thread Color</div>
  <div class="sheet-body">
    <div class="sheet-color-current" id="sheetColorCurrent">
      <div class="sheet-color-swatch" id="sheetColorSwatch"></div>
      <div>
        <div class="sheet-color-name" id="sheetColorName">--</div>
        <div class="sheet-color-code" id="sheetColorCode">DMC --</div>
      </div>
    </div>
    <div class="sheet-color-search">
      <input type="text" id="sheetColorSearch" placeholder="Search DMC colors…" autocomplete="off" spellcheck="false" />
    </div>
    <div class="sheet-color-grid" id="sheetColorGrid"></div>
  </div>
</div>

<!-- -- Settings Bottom Sheet -- -->
<div class="bottom-sheet sheet-settings" id="sheetSettings" role="dialog" aria-modal="true" aria-label="Fabric & Stitch">
  <div class="sheet-handle" id="sheetSettingsHandle"></div>
  <div class="sheet-title" data-i18n="sheet_fabric">Fabric &amp; Stitch</div>
  <div class="sheet-body">
    <div class="sheet-settings-group">
      <div class="sheet-settings-label">
        <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h4M18 12h4M7 7l2 2M15 15l2 2M7 17l2-2M15 7l2-2"/></svg>
        <span data-i18n="section_height">Stitch Height</span>
      </div>
      <div class="height-control">
        <input type="range" class="height-slider" id="sheetHeightSlider" min="8" max="30" value="18" step="1" aria-label="Stitch height" />
        <div>
          <span class="height-value" id="sheetHeightValue">18</span>
          <span class="height-unit" data-i18n="unit_px">st</span>
        </div>
      </div>
    </div>
    <div class="sheet-settings-group">
      <div class="sheet-settings-label">
        <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
        <span data-i18n="section_fabric">Fabric</span>
      </div>
      <div class="aida-row" id="sheetAidaRow">
        <button class="aida-chip" data-count="11"><span class="aida-chip-num">11</span><span class="aida-chip-label" data-i18n="label_aida">Aida</span></button>
        <button class="aida-chip selected" data-count="14"><span class="aida-chip-num">14</span><span class="aida-chip-label" data-i18n="label_aida">Aida</span></button>
        <button class="aida-chip" data-count="16"><span class="aida-chip-num">16</span><span class="aida-chip-label" data-i18n="label_aida">Aida</span></button>
        <button class="aida-chip" data-count="18"><span class="aida-chip-num">18</span><span class="aida-chip-label" data-i18n="label_aida">Aida</span></button>
        <button class="aida-chip" data-count="custom"><span class="aida-chip-num">&#9998;</span><span class="aida-chip-label" data-i18n="label_custom">Custom</span></button>
      </div>
      <div class="custom-stitch-row" id="sheetCustomStitchRow">
        <div class="custom-stitch-header">
          <span class="stitch-label" data-i18n="label_stitch_length">Stitch length</span>
          <div class="stitch-value-display">
            <span class="stitch-value-num" id="sheetCustomStitchValue">3.0</span>
            <span class="stitch-value-unit" id="sheetCustomStitchUnit">mm</span>
          </div>
        </div>
        <input type="range" class="custom-stitch-slider" id="sheetCustomStitchSlider" min="1" max="10" value="3" step="0.1" aria-label="Custom stitch length" />
        <div class="custom-stitch-equiv" id="sheetCustomStitchEquiv"></div>
      </div>
    </div>
  </div>
</div>

<!-- -- Info Bottom Sheet -- -->
<div class="bottom-sheet sheet-info" id="sheetInfo" role="dialog" aria-modal="true" aria-label="Pattern info">
  <div class="sheet-handle" id="sheetInfoHandle"></div>
  <div class="sheet-title" data-i18n="sheet_info">Pattern Info</div>
  <div class="sheet-body">
    <div class="sheet-info-cards">
      <div class="sheet-info-card full-width">
        <div class="sheet-info-card-value" id="infoSize">-- x --</div>
        <div class="sheet-info-card-label" id="infoSizeUnit">cm</div>
      </div>
      <div class="sheet-info-card">
        <div class="sheet-info-card-value" id="infoStitches">--x--</div>
        <div class="sheet-info-card-label" data-i18n="unit_stitches">stitches</div>
      </div>
      <div class="sheet-info-card">
        <div class="sheet-info-card-value" id="infoCrosses">--</div>
        <div class="sheet-info-card-label" data-i18n="unit_crosses">crosses</div>
      </div>
      <div class="sheet-info-card">
        <div class="sheet-info-card-value" id="infoDmc">--</div>
        <div class="sheet-info-card-label" data-i18n="label_dmc">DMC</div>
      </div>
      <div class="sheet-info-card">
        <div class="sheet-info-card-value" id="infoThread">--</div>
        <div class="sheet-info-card-label" data-i18n="label_thread">Thread</div>
      </div>
    </div>
    <div class="sheet-info-ruler" id="infoRuler">
      <div class="ruler-line">
        <div class="ruler-edge"></div>
        <div class="ruler-bar"><div class="ruler-label" id="infoRulerWidth">--</div></div>
        <div class="ruler-edge"></div>
      </div>
    </div>
    <div class="sheet-info-lang">
      <label data-i18n="label_language">Language</label>
      <select id="sheetLangSelect">
        <option value="en">EN English</option>
        <option value="es">ES Español</option>
        <option value="fr">FR Français</option>
        <option value="de">DE Deutsch</option>
        <option value="it">IT Italiano</option>
        <option value="pt">PT Português</option>
        <option value="nl">NL Nederlands</option>
        <option value="ja">JA Japanese</option>
        <option value="ko">KO Korean</option>
        <option value="zh">ZH Chinese</option>
        <option value="ru">RU Russian</option>
        <option value="pl">PL Polish</option>
        <option value="sv">SV Swedish</option>
        <option value="da">DA Danish</option>
        <option value="fi">FI Finnish</option>
        <option value="uk">UK Ukrainian</option>
        <option value="hu">HU Hungarian</option>
      </select>
    </div>
  </div>
</div>

<!-- -- Payment Modal -- -->
<div id="pay-modal" class="pay-hidden" role="dialog" aria-modal="true" aria-label="Payment">
  <div class="pay-backdrop" id="pay-backdrop"></div>
  <div class="pay-dialog">
    <button class="pay-close" id="pay-close">&times;</button>
    <div class="pay-title" data-i18n="pay_title">Your pattern is ready to stitch &#x2728;</div>
    <div class="pay-subtitle" data-i18n="pay_subtitle">Get your thread list, color codes, and print-ready PDF &mdash; everything you need to start stitching.</div>
    <div class="pay-options">
      <button class="pay-option" id="pay-single">
        <span class="pay-option-price">$1.99</span>
        <span class="pay-option-label" data-i18n="pay_single_label">Just this one</span>
        <span class="pay-option-desc" data-i18n="pay_single_desc">Your pattern in seconds</span>
      </button>
      <button class="pay-option pay-option-featured" id="pay-pack10">
        <span class="pay-option-badge" data-i18n="pay_badge_save">Save 50%</span>
        <span class="pay-option-price">$9.99</span>
        <span class="pay-option-unit" data-i18n="pay_pack_unit">$0.99 each</span>
        <span class="pay-option-label" data-i18n="pay_pack_label">10 Patterns</span>
        <span class="pay-option-desc" data-i18n="pay_pack_desc">Perfect for gifts &amp; projects</span>
      </button>
      <button class="pay-option" id="pay-annual">
        <span class="pay-option-price">$24.99<small>/yr</small></span>
        <span class="pay-option-unit" data-i18n="pay_annual_unit">just $2.08/mo</span>
        <span class="pay-option-label" data-i18n="pay_annual_label">All year</span>
        <span class="pay-option-desc" data-i18n="pay_annual_desc">Unlimited patterns, all year</span>
      </button>
    </div>
    <div class="pay-indie-note" data-i18n="pay_indie_note">Word2Stitch is made with love by one person. Your support helps build new fonts and features. &#x1F49C;</div>
    <div class="pay-trust" data-i18n-html="pay_trust">&#x1F512; Secure checkout via Lemon Squeezy</div>
    <div class="pay-terms" data-i18n-html="pay_terms">By purchasing, you agree to our <a href="/terms" target="_blank" rel="noopener">Terms of Service</a></div>
    <div class="pay-divider"><span data-i18n="pay_divider_key">Already have a key?</span></div>
    <div class="pay-key-input">
      <input type="text" id="pay-key-field" placeholder="Paste your pattern key here" data-i18n-placeholder="pay_key_placeholder" />
      <button id="pay-key-submit" data-i18n="pay_key_submit">Activate &#x2713;</button>
    </div>
    <div id="credits-display" class="pay-hidden"></div>
  </div>
</div>

<!-- -- Free First Download Modal -- -->
<div id="free-modal" class="pay-hidden" role="dialog" aria-modal="true" aria-label="Free download">
  <div class="pay-backdrop" id="free-backdrop"></div>
  <div class="pay-dialog free-dialog">
    <button class="pay-close" id="free-close">&times;</button>
    <div class="free-gift">&#x1F381;</div>
    <div class="pay-title" data-i18n="free_title">Your first pattern is free!</div>
    <div class="pay-subtitle" data-i18n="free_subtitle">Enter your email to download your complete pattern &mdash; thread list, color codes, and print-ready PDF.</div>
    <div class="free-email-row">
      <input type="email" id="free-email-field" placeholder="your@email.com" data-i18n-placeholder="free_email_placeholder" autocomplete="email" />
      <button id="free-email-submit" data-i18n="free_email_submit">Download Free &darr;</button>
    </div>
    <div id="free-email-error" class="free-error"></div>
    <div class="free-note" data-i18n="free_note">No spam, ever. Just your pattern.</div>
  </div>
</div>

<!-- -- Post-Purchase Upsell Modal -- -->
<div id="upsell-modal" class="pay-hidden" role="dialog" aria-modal="true" aria-label="Upgrade">
  <div class="pay-backdrop" id="upsell-backdrop"></div>
  <div class="pay-dialog upsell-dialog">
    <button class="pay-close" id="upsell-close">&times;</button>
    <div class="upsell-icon">&#x1F389;</div>
    <div class="pay-title" data-i18n="upsell_title">Pattern downloaded!</div>
    <div class="pay-subtitle" data-i18n="upsell_subtitle">Love it? Get 10 patterns and save 50%</div>
    <div class="upsell-deal" data-i18n="upsell_deal">10 patterns for $9.99 &mdash; that's $0.99 each!</div>
    <button class="upsell-btn" id="upsell-upgrade" data-i18n="upsell_btn">Upgrade to 10 Patterns &mdash; $9.99</button>
    <button class="upsell-skip" id="upsell-skip" data-i18n="upsell_skip">No thanks</button>
  </div>
</div>

<!-- JS loaded via assemble.js from ui-modules/ -->


<!-- ═══ jsPDF CDN ═══ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha384-JcnsjUPPylna1s1fvi1u12X5qjY5OL56iySh75FdtrwhO/SWXgMjoVqcKyIIWOLk" crossorigin="anonymous"></script>

<!-- ═══ Embedded Font & Color Data ═══ -->
<script>
// DMC thread color data for word2stitch (449 colors)
const DMC_COLORS = [
  {"code":"blanc","name":"White","hex":"#FFFFFF"},
  {"code":"ecru","name":"Ecru","hex":"#F0EADA"},
  {"code":"150","name":"Dusty Rose Ultra Very Dark","hex":"#AB0249"},
  {"code":"151","name":"Dusty Rose Very Light","hex":"#F0D6D7"},
  {"code":"152","name":"Shell Pink Medium Light","hex":"#E0A0A7"},
  {"code":"153","name":"Violet Very Light","hex":"#E6CCD9"},
  {"code":"154","name":"Grape Very Dark","hex":"#572333"},
  {"code":"155","name":"Blue Violet Medium Dark","hex":"#8098C0"},
  {"code":"156","name":"Blue Violet Medium Light","hex":"#A3B8D2"},
  {"code":"157","name":"Cornflower Blue Very Light","hex":"#BBCBDA"},
  {"code":"158","name":"Cornflower Blue Medium Very Dark","hex":"#4C5872"},
  {"code":"159","name":"Blue Gray Light","hex":"#C7CAD7"},
  {"code":"160","name":"Blue Gray Medium","hex":"#999FB7"},
  {"code":"161","name":"Blue Gray","hex":"#7880A0"},
  {"code":"162","name":"Blue Ultra Very Light","hex":"#DBEBF3"},
  {"code":"163","name":"Celadon Green Medium","hex":"#536E54"},
  {"code":"164","name":"Forest Green Light","hex":"#C8D8B8"},
  {"code":"165","name":"Moss Green Very Light","hex":"#EFF4A8"},
  {"code":"166","name":"Moss Green Medium Light","hex":"#C0C840"},
  {"code":"167","name":"Yellow Beige Very Dark","hex":"#A08050"},
  {"code":"168","name":"Pewter Very Light","hex":"#D1D1D1"},
  {"code":"169","name":"Pewter Light","hex":"#848484"},
  {"code":"208","name":"Lavender Very Dark","hex":"#835B8B"},
  {"code":"209","name":"Lavender Dark","hex":"#A37BA7"},
  {"code":"210","name":"Lavender Medium","hex":"#C39FC3"},
  {"code":"211","name":"Lavender Light","hex":"#E3CBE3"},
  {"code":"221","name":"Shell Pink Very Dark","hex":"#883848"},
  {"code":"223","name":"Shell Pink Light","hex":"#CC8888"},
  {"code":"224","name":"Shell Pink Very Light","hex":"#E8C0C0"},
  {"code":"225","name":"Shell Pink Ultra Very Light","hex":"#FFDFDF"},
  {"code":"300","name":"Mahogany Very Dark","hex":"#6F2F00"},
  {"code":"301","name":"Mahogany Medium","hex":"#B35F2B"},
  {"code":"304","name":"Christmas Red Medium","hex":"#B3272F"},
  {"code":"307","name":"Lemon","hex":"#FDED54"},
  {"code":"309","name":"Rose Dark","hex":"#B83858"},
  {"code":"310","name":"Black","hex":"#000000"},
  {"code":"311","name":"Navy Blue Medium","hex":"#4E6583"},
  {"code":"312","name":"Navy Blue Light","hex":"#35536B"},
  {"code":"315","name":"Antique Mauve Medium Very Dark","hex":"#814952"},
  {"code":"316","name":"Antique Mauve Medium","hex":"#B7777F"},
  {"code":"317","name":"Pewter Gray","hex":"#6C6C6C"},
  {"code":"318","name":"Steel Gray Light","hex":"#ABABAB"},
  {"code":"319","name":"Pistachio Green Very Dark","hex":"#205F47"},
  {"code":"320","name":"Pistachio Green Medium","hex":"#698867"},
  {"code":"321","name":"Christmas Red","hex":"#C72C2C"},
  {"code":"322","name":"Navy Blue Very Light","hex":"#5A7692"},
  {"code":"326","name":"Rose Very Dark","hex":"#A73757"},
  {"code":"327","name":"Violet Dark","hex":"#633666"},
  {"code":"333","name":"Blue Violet Very Dark","hex":"#5C5478"},
  {"code":"334","name":"Baby Blue Medium","hex":"#85ABCA"},
  {"code":"335","name":"Rose","hex":"#EE546E"},
  {"code":"336","name":"Navy Blue","hex":"#253B73"},
  {"code":"340","name":"Blue Violet Medium","hex":"#ADA7C7"},
  {"code":"341","name":"Blue Violet Light","hex":"#B7BFDD"},
  {"code":"347","name":"Salmon Very Dark","hex":"#BF2D2D"},
  {"code":"349","name":"Coral Dark","hex":"#D21035"},
  {"code":"350","name":"Coral Medium","hex":"#E33044"},
  {"code":"351","name":"Coral","hex":"#E96A67"},
  {"code":"352","name":"Coral Light","hex":"#FD9C97"},
  {"code":"353","name":"Peach","hex":"#FED7CC"},
  {"code":"355","name":"Terra Cotta Dark","hex":"#983F33"},
  {"code":"356","name":"Terra Cotta Medium","hex":"#E7917B"},
  {"code":"367","name":"Pistachio Green Dark","hex":"#617A60"},
  {"code":"368","name":"Pistachio Green Light","hex":"#A6C298"},
  {"code":"369","name":"Pistachio Green Very Light","hex":"#D7EDCC"},
  {"code":"370","name":"Mustard Medium","hex":"#B88A00"},
  {"code":"371","name":"Mustard","hex":"#BF9B5F"},
  {"code":"372","name":"Mustard Light","hex":"#CCB784"},
  {"code":"400","name":"Mahogany Dark","hex":"#8F4108"},
  {"code":"402","name":"Mahogany Very Light","hex":"#F7A777"},
  {"code":"407","name":"Desert Sand Dark","hex":"#BB8B77"},
  {"code":"413","name":"Pewter Gray Dark","hex":"#565656"},
  {"code":"414","name":"Steel Gray Dark","hex":"#8C8C8C"},
  {"code":"415","name":"Pearl Gray","hex":"#D3D3D6"},
  {"code":"420","name":"Hazelnut Brown Dark","hex":"#A07042"},
  {"code":"422","name":"Hazelnut Brown Light","hex":"#C69F7B"},
  {"code":"433","name":"Brown Medium","hex":"#7A451F"},
  {"code":"434","name":"Brown Light","hex":"#985E33"},
  {"code":"435","name":"Brown Very Light","hex":"#B87748"},
  {"code":"436","name":"Tan","hex":"#CB9051"},
  {"code":"437","name":"Tan Light","hex":"#E4BB8E"},
  {"code":"444","name":"Lemon Dark","hex":"#FFD600"},
  {"code":"445","name":"Lemon Light","hex":"#FFEB84"},
  {"code":"451","name":"Shell Gray Dark","hex":"#917B73"},
  {"code":"452","name":"Shell Gray Medium","hex":"#C0B3AC"},
  {"code":"453","name":"Shell Gray Light","hex":"#D7CECB"},
  {"code":"469","name":"Avocado Green","hex":"#72843C"},
  {"code":"470","name":"Avocado Green Light","hex":"#94B257"},
  {"code":"471","name":"Avocado Green Very Light","hex":"#AEBF79"},
  {"code":"472","name":"Avocado Green Ultra Light","hex":"#D8E498"},
  {"code":"498","name":"Christmas Red Dark","hex":"#A7132B"},
  {"code":"500","name":"Blue Green Very Dark","hex":"#005441"},
  {"code":"501","name":"Blue Green Dark","hex":"#3A6A5B"},
  {"code":"502","name":"Blue Green","hex":"#869E8B"},
  {"code":"503","name":"Blue Green Medium","hex":"#A4BDAF"},
  {"code":"504","name":"Blue Green Very Light","hex":"#C4D9CC"},
  {"code":"517","name":"Wedgewood Dark","hex":"#3B768F"},
  {"code":"518","name":"Wedgewood Light","hex":"#4F8DA5"},
  {"code":"519","name":"Sky Blue","hex":"#88B4C8"},
  {"code":"520","name":"Fern Green Dark","hex":"#666D56"},
  {"code":"522","name":"Fern Green","hex":"#96967F"},
  {"code":"523","name":"Fern Green Light","hex":"#ACB7A5"},
  {"code":"524","name":"Fern Green Very Light","hex":"#C4CDC1"},
  {"code":"535","name":"Ash Gray Very Light","hex":"#63645C"},
  {"code":"543","name":"Beige Brown Ultra Very Light","hex":"#F2E3CE"},
  {"code":"550","name":"Violet Very Dark","hex":"#501A55"},
  {"code":"552","name":"Violet Medium","hex":"#804E7D"},
  {"code":"553","name":"Violet","hex":"#9B6E94"},
  {"code":"554","name":"Violet Light","hex":"#DBB3CB"},
  {"code":"561","name":"Jade Very Dark","hex":"#2A5649"},
  {"code":"562","name":"Jade Medium","hex":"#457D64"},
  {"code":"563","name":"Jade Light","hex":"#82B39E"},
  {"code":"564","name":"Jade Very Light","hex":"#AFCBBC"},
  {"code":"580","name":"Moss Green Dark","hex":"#808300"},
  {"code":"581","name":"Moss Green","hex":"#A7A757"},
  {"code":"597","name":"Turquoise","hex":"#539590"},
  {"code":"598","name":"Turquoise Light","hex":"#86ADAB"},
  {"code":"600","name":"Cranberry Very Dark","hex":"#D32159"},
  {"code":"601","name":"Cranberry Dark","hex":"#D63962"},
  {"code":"602","name":"Cranberry Medium","hex":"#E55F83"},
  {"code":"603","name":"Cranberry","hex":"#FFA4BE"},
  {"code":"604","name":"Cranberry Light","hex":"#FFBDCA"},
  {"code":"605","name":"Cranberry Very Light","hex":"#FFCFD6"},
  {"code":"606","name":"Bright Orange Red","hex":"#FA2700"},
  {"code":"608","name":"Bright Orange","hex":"#FD5D00"},
  {"code":"610","name":"Drab Brown Dark","hex":"#755D43"},
  {"code":"611","name":"Drab Brown","hex":"#987758"},
  {"code":"612","name":"Drab Brown Light","hex":"#BC9777"},
  {"code":"613","name":"Drab Brown Very Light","hex":"#DCC2AA"},
  {"code":"632","name":"Desert Sand Ultra Very Dark","hex":"#875C4F"},
  {"code":"640","name":"Beige Gray Very Dark","hex":"#8A7567"},
  {"code":"642","name":"Beige Gray Dark","hex":"#A49483"},
  {"code":"644","name":"Beige Gray Medium","hex":"#DDD8CB"},
  {"code":"645","name":"Beaver Gray Very Dark","hex":"#6E6E6E"},
  {"code":"646","name":"Beaver Gray Dark","hex":"#878787"},
  {"code":"647","name":"Beaver Gray Medium","hex":"#B0B0B0"},
  {"code":"648","name":"Beaver Gray Light","hex":"#BCBCBC"},
  {"code":"666","name":"Bright Red","hex":"#E31D42"},
  {"code":"676","name":"Old Gold Light","hex":"#E5BE84"},
  {"code":"677","name":"Old Gold Very Light","hex":"#F5E2BC"},
  {"code":"680","name":"Old Gold Dark","hex":"#BC8D0E"},
  {"code":"699","name":"Christmas Green","hex":"#056533"},
  {"code":"700","name":"Christmas Green Bright","hex":"#10753D"},
  {"code":"701","name":"Christmas Green Light","hex":"#4F8958"},
  {"code":"702","name":"Kelly Green","hex":"#5CA462"},
  {"code":"703","name":"Chartreuse","hex":"#7BB661"},
  {"code":"704","name":"Chartreuse Bright","hex":"#9CCB65"},
  {"code":"718","name":"Plum","hex":"#893456"},
  {"code":"720","name":"Orange Spice Dark","hex":"#E55B00"},
  {"code":"721","name":"Orange Spice Medium","hex":"#F27D22"},
  {"code":"722","name":"Orange Spice Light","hex":"#F68D39"},
  {"code":"725","name":"Topaz","hex":"#FFC700"},
  {"code":"726","name":"Topaz Light","hex":"#FDD758"},
  {"code":"727","name":"Topaz Very Light","hex":"#FFEBA8"},
  {"code":"729","name":"Old Gold Medium","hex":"#D08900"},
  {"code":"730","name":"Olive Green Very Dark","hex":"#856F00"},
  {"code":"731","name":"Olive Green Dark","hex":"#957B00"},
  {"code":"732","name":"Olive Green","hex":"#9C8643"},
  {"code":"733","name":"Olive Green Medium","hex":"#BCA76B"},
  {"code":"734","name":"Olive Green Light","hex":"#C8BA88"},
  {"code":"738","name":"Tan Very Light","hex":"#ECCC9E"},
  {"code":"739","name":"Tan Ultra Very Light","hex":"#F8E4C8"},
  {"code":"740","name":"Tangerine","hex":"#FF8B00"},
  {"code":"741","name":"Tangerine Medium","hex":"#FFA300"},
  {"code":"742","name":"Tangerine Light","hex":"#FFB755"},
  {"code":"743","name":"Yellow Medium","hex":"#FED376"},
  {"code":"744","name":"Yellow Pale","hex":"#FFE793"},
  {"code":"745","name":"Yellow Light Pale","hex":"#FFEEAD"},
  {"code":"746","name":"Off White","hex":"#FCFCF6"},
  {"code":"747","name":"Sky Blue Very Light","hex":"#E1F5FF"},
  {"code":"754","name":"Peach Light","hex":"#FAD3C3"},
  {"code":"758","name":"Terra Cotta Very Light","hex":"#EEC3B5"},
  {"code":"760","name":"Salmon","hex":"#F59B95"},
  {"code":"761","name":"Salmon Light","hex":"#FFC9C9"},
  {"code":"762","name":"Pearl Gray Very Light","hex":"#ECECEC"},
  {"code":"772","name":"Pine Green Light","hex":"#D9EAD3"},
  {"code":"775","name":"Baby Blue Very Light","hex":"#D9ECF2"},
  {"code":"776","name":"Pink Medium","hex":"#FAAAB4"},
  {"code":"777","name":"Raspberry Very Dark","hex":"#912048"},
  {"code":"778","name":"Antique Mauve Very Light","hex":"#DFB6BD"},
  {"code":"779","name":"Cocoa Dark","hex":"#634B44"},
  {"code":"780","name":"Topaz Ultra Very Dark","hex":"#955A00"},
  {"code":"781","name":"Topaz Very Dark","hex":"#A26700"},
  {"code":"782","name":"Topaz Dark","hex":"#AE7700"},
  {"code":"783","name":"Christmas Gold","hex":"#CC8F00"},
  {"code":"791","name":"Cornflower Blue Very Dark","hex":"#49486A"},
  {"code":"792","name":"Cornflower Blue Dark","hex":"#6F6C8E"},
  {"code":"793","name":"Cornflower Blue Medium","hex":"#938BA4"},
  {"code":"794","name":"Cornflower Blue Light","hex":"#9FB7CF"},
  {"code":"796","name":"Royal Blue Dark","hex":"#13395F"},
  {"code":"797","name":"Royal Blue","hex":"#194C7A"},
  {"code":"798","name":"Delft Blue Dark","hex":"#46698A"},
  {"code":"799","name":"Delft Blue Medium","hex":"#749BC1"},
  {"code":"800","name":"Delft Blue Pale","hex":"#C0DAEB"},
  {"code":"801","name":"Coffee Brown Dark","hex":"#65442A"},
  {"code":"803","name":"Baby Blue Ultra Very Dark","hex":"#35668C"},
  {"code":"806","name":"Peacock Blue Dark","hex":"#3C8A96"},
  {"code":"807","name":"Peacock Blue","hex":"#649BA3"},
  {"code":"809","name":"Delft Blue","hex":"#94BACB"},
  {"code":"813","name":"Blue Light","hex":"#A2C2D6"},
  {"code":"814","name":"Garnet Dark","hex":"#A1002C"},
  {"code":"815","name":"Garnet Medium","hex":"#B00032"},
  {"code":"816","name":"Garnet","hex":"#B33B4B"},
  {"code":"817","name":"Coral Red Very Dark","hex":"#BB3B4A"},
  {"code":"818","name":"Baby Pink","hex":"#FFDFE5"},
  {"code":"819","name":"Baby Pink Light","hex":"#FFEFEF"},
  {"code":"820","name":"Royal Blue Very Dark","hex":"#0D2952"},
  {"code":"822","name":"Beige Gray Light","hex":"#E7E2D3"},
  {"code":"823","name":"Navy Blue Dark","hex":"#000049"},
  {"code":"824","name":"Blue Very Dark","hex":"#3B6482"},
  {"code":"825","name":"Blue Dark","hex":"#537C9D"},
  {"code":"826","name":"Blue Medium","hex":"#739EBD"},
  {"code":"827","name":"Blue Very Light","hex":"#BDDDED"},
  {"code":"828","name":"Blue Ultra Very Light","hex":"#D3ECF1"},
  {"code":"829","name":"Golden Olive Very Dark","hex":"#7F6B00"},
  {"code":"830","name":"Golden Olive Dark","hex":"#8D7500"},
  {"code":"831","name":"Golden Olive Medium","hex":"#9C8200"},
  {"code":"832","name":"Golden Olive","hex":"#B48F12"},
  {"code":"833","name":"Golden Olive Light","hex":"#C6A46F"},
  {"code":"834","name":"Golden Olive Very Light","hex":"#D4B684"},
  {"code":"838","name":"Beige Brown Very Dark","hex":"#594937"},
  {"code":"839","name":"Beige Brown Dark","hex":"#695845"},
  {"code":"840","name":"Beige Brown Medium","hex":"#9A7C5C"},
  {"code":"841","name":"Beige Brown Light","hex":"#B69B7E"},
  {"code":"842","name":"Beige Brown Very Light","hex":"#D1BAA1"},
  {"code":"844","name":"Beaver Gray Ultra Dark","hex":"#484848"},
  {"code":"869","name":"Hazelnut Brown Very Dark","hex":"#83593C"},
  {"code":"890","name":"Pistachio Green Ultra Dark","hex":"#174F42"},
  {"code":"891","name":"Carnation Dark","hex":"#FF5A73"},
  {"code":"892","name":"Carnation Medium","hex":"#FF8495"},
  {"code":"893","name":"Carnation Light","hex":"#FFB7C1"},
  {"code":"894","name":"Carnation Very Light","hex":"#FFD6DC"},
  {"code":"895","name":"Hunter Green Very Dark","hex":"#20563B"},
  {"code":"898","name":"Coffee Brown Very Dark","hex":"#493219"},
  {"code":"899","name":"Rose Medium","hex":"#F3748E"},
  {"code":"900","name":"Burnt Orange Dark","hex":"#D15600"},
  {"code":"902","name":"Garnet Very Dark","hex":"#852032"},
  {"code":"904","name":"Parrot Green Very Dark","hex":"#637700"},
  {"code":"905","name":"Parrot Green Dark","hex":"#758E00"},
  {"code":"906","name":"Parrot Green Medium","hex":"#8EA800"},
  {"code":"907","name":"Parrot Green Light","hex":"#CDD96D"},
  {"code":"909","name":"Emerald Green Very Dark","hex":"#12563C"},
  {"code":"910","name":"Emerald Green Dark","hex":"#196848"},
  {"code":"911","name":"Emerald Green Medium","hex":"#1E7F55"},
  {"code":"912","name":"Emerald Green Light","hex":"#1A9560"},
  {"code":"913","name":"Nile Green Medium","hex":"#99BC95"},
  {"code":"915","name":"Plum Dark","hex":"#A31855"},
  {"code":"917","name":"Plum Medium","hex":"#AC1B5A"},
  {"code":"918","name":"Red Copper Dark","hex":"#834438"},
  {"code":"919","name":"Red Copper","hex":"#B15942"},
  {"code":"920","name":"Copper Medium","hex":"#C56D54"},
  {"code":"921","name":"Copper","hex":"#CB7A5B"},
  {"code":"922","name":"Copper Light","hex":"#E29268"},
  {"code":"924","name":"Gray Green Very Dark","hex":"#486359"},
  {"code":"926","name":"Gray Green Medium","hex":"#7C9A8C"},
  {"code":"927","name":"Gray Green Light","hex":"#AABDB3"},
  {"code":"928","name":"Gray Green Very Light","hex":"#CFDAD4"},
  {"code":"930","name":"Antique Blue Dark","hex":"#466375"},
  {"code":"931","name":"Antique Blue Medium","hex":"#688694"},
  {"code":"932","name":"Antique Blue Light","hex":"#99B3BF"},
  {"code":"934","name":"Avocado Green Black","hex":"#2A3322"},
  {"code":"935","name":"Avocado Green Dark","hex":"#445031"},
  {"code":"936","name":"Avocado Green Very Dark","hex":"#4E5E2F"},
  {"code":"937","name":"Avocado Green Medium","hex":"#617840"},
  {"code":"938","name":"Coffee Brown Ultra Dark","hex":"#361F00"},
  {"code":"939","name":"Navy Blue Very Dark","hex":"#002050"},
  {"code":"943","name":"Aquamarine Medium","hex":"#00AF9B"},
  {"code":"945","name":"Tawny","hex":"#FBDABB"},
  {"code":"946","name":"Burnt Orange Medium","hex":"#F26A24"},
  {"code":"947","name":"Burnt Orange","hex":"#FF7B4D"},
  {"code":"948","name":"Peach Very Light","hex":"#FFE7D9"},
  {"code":"950","name":"Desert Sand Light","hex":"#EED6D2"},
  {"code":"951","name":"Tawny Light","hex":"#FFE7CE"},
  {"code":"954","name":"Nile Green","hex":"#86B7A0"},
  {"code":"955","name":"Nile Green Light","hex":"#ACD0BC"},
  {"code":"956","name":"Geranium","hex":"#FF6D73"},
  {"code":"957","name":"Geranium Pale","hex":"#FDADAD"},
  {"code":"958","name":"Sea Green Dark","hex":"#009E89"},
  {"code":"959","name":"Sea Green Medium","hex":"#66B7A4"},
  {"code":"961","name":"Dusty Rose Dark","hex":"#C7637D"},
  {"code":"962","name":"Dusty Rose Medium","hex":"#E68FA3"},
  {"code":"963","name":"Dusty Rose Ultra Very Light","hex":"#FFCDD2"},
  {"code":"964","name":"Sea Green Light","hex":"#9DCEC3"},
  {"code":"966","name":"Baby Green Medium","hex":"#B2C297"},
  {"code":"970","name":"Pumpkin Light","hex":"#F78B13"},
  {"code":"971","name":"Pumpkin","hex":"#F78B13"},
  {"code":"972","name":"Canary Deep","hex":"#FFB515"},
  {"code":"973","name":"Canary Bright","hex":"#FFE300"},
  {"code":"975","name":"Golden Brown Dark","hex":"#8B5300"},
  {"code":"976","name":"Golden Brown Medium","hex":"#F68D39"},
  {"code":"977","name":"Golden Brown Light","hex":"#FFB066"},
  {"code":"986","name":"Forest Green Very Dark","hex":"#3D5C49"},
  {"code":"987","name":"Forest Green Dark","hex":"#597560"},
  {"code":"988","name":"Forest Green Medium","hex":"#839882"},
  {"code":"989","name":"Forest Green","hex":"#869E77"},
  {"code":"991","name":"Aquamarine Dark","hex":"#007C6D"},
  {"code":"992","name":"Aquamarine","hex":"#6DB0A1"},
  {"code":"993","name":"Aquamarine Light","hex":"#8EC2B4"},
  {"code":"995","name":"Electric Blue Dark","hex":"#007BA7"},
  {"code":"996","name":"Electric Blue Medium","hex":"#00A3DA"},
  {"code":"3011","name":"Khaki Green Dark","hex":"#77684E"},
  {"code":"3012","name":"Khaki Green Medium","hex":"#A69776"},
  {"code":"3013","name":"Khaki Green Light","hex":"#B9AE85"},
  {"code":"3021","name":"Brown Gray Very Dark","hex":"#4F443A"},
  {"code":"3022","name":"Brown Gray Medium","hex":"#8E8470"},
  {"code":"3023","name":"Brown Gray Light","hex":"#B5AE9A"},
  {"code":"3024","name":"Brown Gray Very Light","hex":"#D3D0CD"},
  {"code":"3031","name":"Mocha Brown Very Dark","hex":"#483C32"},
  {"code":"3032","name":"Mocha Brown Medium","hex":"#BC9C78"},
  {"code":"3033","name":"Mocha Brown Very Light","hex":"#EFDDBE"},
  {"code":"3041","name":"Antique Violet Medium","hex":"#B79BA7"},
  {"code":"3042","name":"Antique Violet Light","hex":"#E1CDC8"},
  {"code":"3045","name":"Yellow Beige Dark","hex":"#BA9167"},
  {"code":"3046","name":"Yellow Beige Medium","hex":"#E5C18B"},
  {"code":"3047","name":"Yellow Beige Light","hex":"#FFECD3"},
  {"code":"3051","name":"Green Gray Dark","hex":"#595F4B"},
  {"code":"3052","name":"Green Gray Medium","hex":"#889277"},
  {"code":"3053","name":"Green Gray","hex":"#9CA48F"},
  {"code":"3064","name":"Desert Sand","hex":"#BF917C"},
  {"code":"3072","name":"Beaver Gray Very Light","hex":"#E6E8E8"},
  {"code":"3078","name":"Golden Yellow Very Light","hex":"#FFFCE1"},
  {"code":"3325","name":"Baby Blue Light","hex":"#B3D1E4"},
  {"code":"3326","name":"Rose Light","hex":"#FF9D96"},
  {"code":"3328","name":"Salmon Dark","hex":"#BC4055"},
  {"code":"3340","name":"Apricot Medium","hex":"#FF7B67"},
  {"code":"3341","name":"Apricot","hex":"#FFACA2"},
  {"code":"3345","name":"Hunter Green Dark","hex":"#365647"},
  {"code":"3346","name":"Hunter Green","hex":"#53705A"},
  {"code":"3347","name":"Yellow Green Medium","hex":"#708E6B"},
  {"code":"3348","name":"Yellow Green Light","hex":"#E1F9BE"},
  {"code":"3350","name":"Dusty Rose Ultra Dark","hex":"#B84F64"},
  {"code":"3354","name":"Dusty Rose Light","hex":"#FFD6D1"},
  {"code":"3362","name":"Pine Green Dark","hex":"#61735C"},
  {"code":"3363","name":"Pine Green Medium","hex":"#73866B"},
  {"code":"3364","name":"Pine Green","hex":"#869977"},
  {"code":"3371","name":"Black Brown","hex":"#271C13"},
  {"code":"3607","name":"Plum Light","hex":"#E74F86"},
  {"code":"3608","name":"Plum Very Light","hex":"#F798B6"},
  {"code":"3609","name":"Plum Ultra Light","hex":"#FFC5D5"},
  {"code":"3685","name":"Mauve Very Dark","hex":"#7F335D"},
  {"code":"3687","name":"Mauve","hex":"#C15481"},
  {"code":"3688","name":"Mauve Medium","hex":"#E689AF"},
  {"code":"3689","name":"Mauve Light","hex":"#FFBACD"},
  {"code":"3705","name":"Melon Dark","hex":"#FF555B"},
  {"code":"3706","name":"Melon Medium","hex":"#FF8C8A"},
  {"code":"3708","name":"Melon Light","hex":"#FED4DB"},
  {"code":"3712","name":"Salmon Medium","hex":"#E26D76"},
  {"code":"3713","name":"Salmon Very Light","hex":"#FDE5D9"},
  {"code":"3716","name":"Dusty Rose Very Light","hex":"#FFBDC1"},
  {"code":"3721","name":"Shell Pink Dark","hex":"#A9555F"},
  {"code":"3722","name":"Shell Pink Medium","hex":"#AB6F73"},
  {"code":"3726","name":"Antique Mauve Dark","hex":"#91636B"},
  {"code":"3727","name":"Antique Mauve Light","hex":"#FFBDBF"},
  {"code":"3731","name":"Dusty Rose Very Dark","hex":"#DC677F"},
  {"code":"3733","name":"Dusty Rose","hex":"#FF9DAE"},
  {"code":"3740","name":"Antique Violet Dark","hex":"#9C7D85"},
  {"code":"3743","name":"Antique Violet Very Light","hex":"#EBEBE7"},
  {"code":"3746","name":"Blue Violet Dark","hex":"#776B98"},
  {"code":"3747","name":"Blue Violet Very Light","hex":"#E6ECE8"},
  {"code":"3750","name":"Antique Blue Very Dark","hex":"#355868"},
  {"code":"3752","name":"Antique Blue Very Light","hex":"#C7D8DC"},
  {"code":"3753","name":"Antique Blue Ultra Very Light","hex":"#ECF4F4"},
  {"code":"3755","name":"Baby Blue","hex":"#799EC0"},
  {"code":"3756","name":"Baby Blue Ultra Very Light","hex":"#F2FAFF"},
  {"code":"3760","name":"Wedgewood Medium","hex":"#638FA3"},
  {"code":"3761","name":"Sky Blue Light","hex":"#D3F2F3"},
  {"code":"3765","name":"Peacock Blue Very Dark","hex":"#007D87"},
  {"code":"3766","name":"Peacock Blue Light","hex":"#409AA4"},
  {"code":"3768","name":"Gray Green Dark","hex":"#5C6E6C"},
  {"code":"3770","name":"Tawny Very Light","hex":"#FFFAE0"},
  {"code":"3771","name":"Terra Cotta Ultra Very Light","hex":"#F7DACB"},
  {"code":"3772","name":"Desert Sand Very Dark","hex":"#A07465"},
  {"code":"3773","name":"Desert Sand Medium","hex":"#C49782"},
  {"code":"3774","name":"Desert Sand Very Light","hex":"#F3E1D7"},
  {"code":"3776","name":"Mahogany Light","hex":"#DD9059"},
  {"code":"3777","name":"Terra Cotta Very Dark","hex":"#863022"},
  {"code":"3778","name":"Terra Cotta Light","hex":"#D98C73"},
  {"code":"3779","name":"Terra Cotta Ultra Very Light","hex":"#F8CBBB"},
  {"code":"3781","name":"Mocha Brown Dark","hex":"#6B5749"},
  {"code":"3782","name":"Mocha Brown Light","hex":"#CFAB8F"},
  {"code":"3787","name":"Brown Gray Dark","hex":"#6F675E"},
  {"code":"3790","name":"Beige Gray Ultra Dark","hex":"#8C756D"},
  {"code":"3799","name":"Pewter Gray Very Dark","hex":"#424242"},
  {"code":"3801","name":"Christmas Red Very Dark","hex":"#E50033"},
  {"code":"3802","name":"Antique Mauve Very Dark","hex":"#714149"},
  {"code":"3803","name":"Mauve Dark","hex":"#A93C6F"},
  {"code":"3804","name":"Cyclamen Pink Dark","hex":"#E02876"},
  {"code":"3805","name":"Cyclamen Pink","hex":"#F3478B"},
  {"code":"3806","name":"Cyclamen Pink Light","hex":"#FF8CAE"},
  {"code":"3807","name":"Cornflower Blue","hex":"#667798"},
  {"code":"3808","name":"Turquoise Ultra Very Dark","hex":"#366970"},
  {"code":"3809","name":"Turquoise Very Dark","hex":"#3F7C85"},
  {"code":"3810","name":"Turquoise Dark","hex":"#488E9A"},
  {"code":"3811","name":"Turquoise Very Light","hex":"#BCE3E6"},
  {"code":"3812","name":"Sea Green Very Dark","hex":"#2F8C84"},
  {"code":"3813","name":"Blue Green Light","hex":"#B2D4BD"},
  {"code":"3814","name":"Aquamarine","hex":"#508B7D"},
  {"code":"3815","name":"Celadon Green Dark","hex":"#477759"},
  {"code":"3816","name":"Celadon Green","hex":"#65A57D"},
  {"code":"3817","name":"Celadon Green Light","hex":"#99C3AA"},
  {"code":"3818","name":"Emerald Green Ultra Very Dark","hex":"#115A3B"},
  {"code":"3819","name":"Moss Green Light","hex":"#E0E868"},
  {"code":"3820","name":"Straw Dark","hex":"#DFB65F"},
  {"code":"3821","name":"Straw","hex":"#F3CE75"},
  {"code":"3822","name":"Straw Light","hex":"#F6DC98"},
  {"code":"3823","name":"Yellow Ultra Pale","hex":"#FFFDE3"},
  {"code":"3824","name":"Apricot Light","hex":"#FECDC2"},
  {"code":"3825","name":"Pumpkin Pale","hex":"#FDBD96"},
  {"code":"3826","name":"Golden Brown","hex":"#AD7239"},
  {"code":"3827","name":"Golden Brown Pale","hex":"#F7BB77"},
  {"code":"3828","name":"Hazelnut Brown","hex":"#B78B61"},
  {"code":"3829","name":"Old Gold Very Dark","hex":"#A98204"},
  {"code":"3830","name":"Terra Cotta","hex":"#B9644F"},
  {"code":"3831","name":"Raspberry Dark","hex":"#B32F48"},
  {"code":"3832","name":"Raspberry Medium","hex":"#DB556E"},
  {"code":"3833","name":"Raspberry Light","hex":"#EA8699"},
  {"code":"3834","name":"Grape Dark","hex":"#72375D"},
  {"code":"3835","name":"Grape Medium","hex":"#946083"},
  {"code":"3836","name":"Grape Light","hex":"#BA91AA"},
  {"code":"3837","name":"Lavender Ultra Dark","hex":"#6C3A6E"},
  {"code":"3838","name":"Lavender Blue Dark","hex":"#5C7294"},
  {"code":"3839","name":"Lavender Blue Medium","hex":"#7B8EAB"},
  {"code":"3840","name":"Lavender Blue Light","hex":"#B0C0DA"},
  {"code":"3841","name":"Baby Blue Pale","hex":"#CDDFED"},
  {"code":"3842","name":"Wedgewood Very Dark","hex":"#32667C"},
  {"code":"3843","name":"Electric Blue","hex":"#14AAD0"},
  {"code":"3844","name":"Bright Turquoise Dark","hex":"#12AEBA"},
  {"code":"3845","name":"Bright Turquoise Medium","hex":"#04C4CA"},
  {"code":"3846","name":"Bright Turquoise Light","hex":"#06E3E6"},
  {"code":"3847","name":"Teal Green Dark","hex":"#347D75"},
  {"code":"3848","name":"Teal Green Medium","hex":"#559392"},
  {"code":"3849","name":"Teal Green Light","hex":"#52B3A4"},
  {"code":"3850","name":"Bright Green Dark","hex":"#378477"},
  {"code":"3851","name":"Bright Green Light","hex":"#49B3A1"},
  {"code":"3852","name":"Straw Very Dark","hex":"#CD9D37"},
  {"code":"3853","name":"Autumn Gold Dark","hex":"#F29746"},
  {"code":"3854","name":"Autumn Gold Medium","hex":"#F2AF6D"},
  {"code":"3855","name":"Autumn Gold Light","hex":"#FAD396"},
  {"code":"3856","name":"Mahogany Ultra Very Light","hex":"#FFD3B5"},
  {"code":"3857","name":"Rosewood Dark","hex":"#682424"},
  {"code":"3858","name":"Rosewood Medium","hex":"#964A3F"},
  {"code":"3859","name":"Rosewood Light","hex":"#BA9189"},
  {"code":"3860","name":"Cocoa","hex":"#7D5D57"},
  {"code":"3861","name":"Cocoa Light","hex":"#A68881"},
  {"code":"3862","name":"Mocha Beige Dark","hex":"#8A6E4E"},
  {"code":"3863","name":"Mocha Beige Medium","hex":"#A4835C"},
  {"code":"3864","name":"Mocha Beige Light","hex":"#CBB69C"},
  {"code":"3865","name":"Winter White","hex":"#F9F7F1"},
  {"code":"3866","name":"Mocha Brown Ultra Very Light","hex":"#FAF6F0"}
];

// Top 20 popular DMC colors (quick-access in sidebar)
const POPULAR_DMC_CODES = [
  "310", "321", "blanc", "498", "666", "336", "796", "699", "702", "553",
  "550", "720", "741", "307", "444", "3846", "3801", "3607", "738", "414"
];

// Add RGB values to DMC colors (PDF engine needs r,g,b)
DMC_COLORS.forEach(function(c) {
  if (c.hex && !c.r) {
    c.r = parseInt(c.hex.slice(1, 3), 16);
    c.g = parseInt(c.hex.slice(3, 5), 16);
    c.b = parseInt(c.hex.slice(5, 7), 16);
  }
});
</script>

<!-- ═══ Shared Bitmap Utilities ═══ -->
<script>
// shared.js — Unified bitmap utilities used by both UI and PDF engine
// Loaded before pdf-modules and ui-modules by assemble.js

/**
 * Trim trailing empty rows from a glyph bitmap.
 * Returns only the rows up to and including the last row containing a '1'.
 *
 * @param {object} glyph - Glyph object with .bitmap (array of strings)
 * @returns {string[]} Trimmed bitmap rows
 */
function getEffectiveBitmap(glyph) {
  if (!glyph || !glyph.bitmap || !glyph.bitmap.length) return [];
  var bitmap = glyph.bitmap;
  var lastFilledRow = -1;
  for (var r = bitmap.length - 1; r >= 0; r--) {
    if (bitmap[r].indexOf('1') !== -1) { lastFilledRow = r; break; }
  }
  if (lastFilledRow === -1) return [];
  return bitmap.slice(0, lastFilledRow + 1);
}

/**
 * Render a single line of text to a 2D bitmap.
 * This is the core single-line logic extracted from getTextBitmap.
 *
 * @param {string} lineText - Single line of text (no newlines)
 * @param {object} fontData - Font object with glyphs, height, letterSpacing, spaceWidth
 * @param {object} [options] - Rendering options (align, format)
 * @returns {{ bitmap: Array[], width: number, height: number }}
 */
function getLineBitmap(lineText, fontData, options) {
  options = options || {};
  var align = options.align || 'bottom';
  var format = options.format || 'boolean';

  if (!lineText || !fontData || !fontData.glyphs) return { bitmap: [], width: 0, height: 0 };

  var glyphs = fontData.glyphs;
  var height = fontData.height || 9;
  var letterSpacing = (fontData.letterSpacing != null) ? fontData.letterSpacing : 1;
  var spaceWidth = fontData.spaceWidth || 3;
  var columns = [];

  var falseVal = (format === 'string') ? '0' : false;
  var trueVal = (format === 'string') ? '1' : true;

  for (var ci = 0; ci < lineText.length; ci++) {
    var ch = lineText[ci];

    // Letter spacing between characters (not before the first)
    if (ci > 0 && letterSpacing > 0) {
      for (var s = 0; s < letterSpacing; s++) columns.push(newEmptyCol(height, falseVal));
    }

    // Space or missing/empty glyph: insert empty columns
    if (ch === ' ' || !glyphs[ch] || !glyphs[ch].bitmap || !glyphs[ch].bitmap.length) {
      for (var sw = 0; sw < spaceWidth; sw++) columns.push(newEmptyCol(height, falseVal));
      continue;
    }

    var glyph = glyphs[ch];
    var bmp = glyph.bitmap;
    var glyphWidth = glyph.width || (bmp[0] ? bmp[0].length : 0);
    var glyphHeight = bmp.length;

    // 'top' alignment: push glyph down so empty space is at the top of the cell
    // 'bottom' (default): glyph starts at row 0, empty space at bottom
    var yOffset = (align === 'top') ? (height - glyphHeight) : 0;

    for (var x = 0; x < glyphWidth; x++) {
      var col = newEmptyCol(height, falseVal);
      for (var row = 0; row < glyphHeight; row++) {
        if (row < bmp.length && x < bmp[row].length && bmp[row][x] === '1') {
          col[yOffset + row] = trueVal;
        }
      }
      columns.push(col);
    }
  }

  if (!columns.length) return { bitmap: [], width: 0, height: 0 };

  // Transpose columns to rows
  var width = columns.length;
  var bitmap = [];
  for (var y = 0; y < height; y++) {
    var row = [];
    for (var x2 = 0; x2 < width; x2++) row.push(columns[x2][y]);
    bitmap.push(row);
  }
  return { bitmap: bitmap, width: width, height: height };
}

/**
 * Convert a text string to a 2D bitmap using bitmap font glyph data.
 * Supports multi-line text (split by \n) with horizontal alignment.
 * Supports both UI (top-aligned, boolean) and PDF (bottom-aligned, boolean) use cases.
 *
 * @param {string} text - The text to render (may contain \n for multi-line)
 * @param {object} fontData - Font object with glyphs, height, letterSpacing, spaceWidth
 * @param {object} [options] - Rendering options
 * @param {string} [options.align='bottom'] - Vertical glyph alignment:
 *   'bottom' (default): glyph rows start at top of cell, empty space at bottom
 *   'top': glyph rows pushed to bottom of cell, empty space at top
 * @param {string} [options.format='boolean'] - Cell value format:
 *   'boolean' (default): cells are true/false
 *   'string': cells are '1'/'0'
 * @param {string} [options.textAlign='left'] - Horizontal text alignment:
 *   'left' (default), 'center', 'right'
 * @returns {{ bitmap: Array[], width: number, height: number }}
 */
function getTextBitmap(text, fontData, options) {
  options = options || {};
  var textAlign = options.textAlign || 'left';
  var format = options.format || 'boolean';

  if (!text || !fontData || !fontData.glyphs) return { bitmap: [], width: 0, height: 0 };

  var height = fontData.height || 9;
  var falseVal = (format === 'string') ? '0' : false;
  var trueVal = (format === 'string') ? '1' : true;

  var lines = text.split('\n');
  var lineBitmaps = [];
  var maxWidth = 0;

  for (var i = 0; i < lines.length; i++) {
    if (!lines[i].trim()) {
      // Empty line: push empty bitmap with just the font height
      lineBitmaps.push({ bitmap: [], width: 0, height: height });
      continue;
    }
    var lb = getLineBitmap(lines[i], fontData, options);
    lineBitmaps.push(lb);
    if (lb.width > maxWidth) maxWidth = lb.width;
  }

  if (maxWidth === 0) return { bitmap: [], width: 0, height: 0 };

  var lineGap = Math.max(2, Math.round(height * 0.15));
  var totalHeight = 0;
  var finalBitmap = [];

  for (var i = 0; i < lineBitmaps.length; i++) {
    var lb = lineBitmaps[i];
    var padLeft = 0;

    if (textAlign === 'center') {
      padLeft = Math.floor((maxWidth - lb.width) / 2);
    } else if (textAlign === 'right') {
      padLeft = maxWidth - lb.width;
    }
    var padRight = maxWidth - lb.width - padLeft;

    // If line has actual bitmap rows, pad them
    if (lb.bitmap.length > 0) {
      for (var y = 0; y < lb.bitmap.length; y++) {
        var row = [];
        for (var p = 0; p < padLeft; p++) row.push(falseVal);
        for (var x = 0; x < lb.bitmap[y].length; x++) row.push(lb.bitmap[y][x]);
        for (var p2 = 0; p2 < padRight; p2++) row.push(falseVal);
        finalBitmap.push(row);
      }
      totalHeight += lb.bitmap.length;
    } else {
      // Empty line: add empty rows for the font height
      for (var y = 0; y < height; y++) {
        var emptyRow = [];
        for (var x = 0; x < maxWidth; x++) emptyRow.push(falseVal);
        finalBitmap.push(emptyRow);
      }
      totalHeight += height;
    }

    // Line gap (not after last line)
    if (i < lineBitmaps.length - 1) {
      for (var g = 0; g < lineGap; g++) {
        var gapRow = [];
        for (var x = 0; x < maxWidth; x++) gapRow.push(falseVal);
        finalBitmap.push(gapRow);
      }
      totalHeight += lineGap;
    }
  }

  // Trim empty rows from top and bottom of composed bitmap.
  // Removes unused descent/accent rows when the text has no descenders/accents,
  // so the stitch count reflects actual ink, not font padding.
  while (finalBitmap.length > 0 && finalBitmap[0].indexOf(trueVal) === -1) {
    finalBitmap.shift();
  }
  while (finalBitmap.length > 0 && finalBitmap[finalBitmap.length - 1].indexOf(trueVal) === -1) {
    finalBitmap.pop();
  }
  totalHeight = finalBitmap.length;

  return { bitmap: finalBitmap, width: maxWidth, height: totalHeight };
}

function newEmptyCol(height, fillValue) {
  var col = new Array(height);
  for (var i = 0; i < height; i++) col[i] = fillValue;
  return col;
}

</script>

<!-- ═══ PDF Generation Engine ═══ -->
<script>
// ══════════════════════════════════════════════════════════════════
//  Word2Stitch — PDF Helpers
//  Utility functions shared across PDF modules
// ══════════════════════════════════════════════════════════════════

/**
 * Get translated string for PDF. Falls back to English default if t() unavailable.
 */
function pt(key, fallback) {
  if (typeof window.t === 'function') {
    var val = window.t(key);
    if (val && val !== key) return val;
  }
  return fallback;
}

function getLuminance(color) {
  return (0.299 * color.r + 0.587 * color.g + 0.114 * color.b) / 255;
}

/**
 * Truncate a string to maxLen characters, adding ellipsis if needed.
 */
function truncate(str, maxLen) {
  if (!str) return '';
  if (str.length <= maxLen) return str;
  return str.substring(0, maxLen - 1) + '\u2026';
}


// pdf-modules/pdf-bitmap.js — Thin wrapper over shared getTextBitmap()

function getTextBitmapForPDF(text, fontData) {
  return getTextBitmap(text, fontData, { align: 'top' }).bitmap;
}


// ══════════════════════════════════════════════════════════════════
//  Word2Stitch — PDF Chrome
//  Branded headers, footers, watermarks, and upgrade CTA page.
//  Depends on pdf-helpers (pt, truncate, getLuminance).
// ══════════════════════════════════════════════════════════════════

/**
 * Draw branded header bar on a PDF page.
 * Crimson accent bar + logo text + pattern info + page number.
 */
function drawBrandedHeader(pdf, text, fontName, patternWidth, patternHeight, pageNum, totalPages, margin, pageW) {
  const barY = margin - 2;
  const barH = 12;

  // Accent bar background
  pdf.setFillColor(184, 58, 42); // var(--accent) #b83a2a
  pdf.rect(margin, barY, pageW - margin * 2, barH, 'F');

  // Logo: X Word2Stitch
  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(9);
  pdf.setTextColor(255, 255, 255);
  pdf.text('\u2715 Word2Stitch', margin + 3, barY + 5);

  // Pattern description
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(7);
  pdf.setTextColor(255, 230, 225);
  const desc = '"' + truncate(text, 25) + '" \u00B7 ' + fontName + ' \u00B7 ' +
    patternWidth + '\u00D7' + patternHeight;
  pdf.text(desc, margin + 3, barY + 9.5);

  // Page number (right-aligned)
  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(8);
  pdf.setTextColor(255, 255, 255);
  pdf.text(pageNum + ' / ' + totalPages, pageW - margin - 3, barY + 7, { align: 'right' });
}

/**
 * Draw branded footer on a PDF page.
 * Thin accent line + branding text + date.
 */
function drawBrandedFooter(pdf, margin, pageW, pageH) {
  const footerY = pageH - margin + 2;

  // Accent line
  pdf.setDrawColor(184, 58, 42);
  pdf.setLineWidth(0.5);
  pdf.line(margin, footerY, pageW - margin, footerY);

  // Left: branding
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(7);
  pdf.setTextColor(184, 58, 42);
  pdf.text('\u2715 Word2Stitch \u2014 ' + pt('pdf_footer_tagline', 'Cross-Stitch Pattern Generator'), margin, footerY + 4);

  // Right: date
  pdf.setTextColor(160, 150, 140);
  var now = new Date();
  var dateStr = now.getFullYear() + '-' +
    String(now.getMonth() + 1).padStart(2, '0') + '-' +
    String(now.getDate()).padStart(2, '0');
  pdf.text(dateStr, pageW - margin, footerY + 4, { align: 'right' });
}

/**
 * Draw a semi-transparent diagonal watermark on a grid page.
 * Uses jsPDF GState for transparency when available, falls back to light gray.
 *
 * @param {jsPDF} pdf - jsPDF instance
 * @param {number} pageW - Page width in mm
 * @param {number} pageH - Page height in mm
 */
function drawWatermark(pdf, pageW, pageH) {
  pdf.saveGraphicsState();

  // Try to apply transparency via GState (jsPDF 2.x)
  let usedGState = false;
  try {
    const GState = (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API &&
      window.jspdf.jsPDF.API.GState) || (pdf.GState);
    if (typeof GState === 'function') {
      pdf.setGState(new GState({ opacity: 0.08 }));
      pdf.setTextColor(184, 58, 42);
      usedGState = true;
    }
  } catch (e) {
    // GState not supported — fall through to fallback
  }

  if (!usedGState) {
    // Fallback: very light gray simulates low opacity on white background
    pdf.setTextColor(235, 225, 224);
  }

  pdf.setFontSize(48);
  pdf.setFont('helvetica', 'bold');
  pdf.text('Word2Stitch', pageW / 2, pageH / 2, {
    align: 'center',
    angle: 35,
  });

  pdf.restoreGraphicsState();
}

/**
 * Draw the upgrade CTA page (replaces legend in preview mode).
 * Branded header/footer + call-to-action with feature list and pricing.
 *
 * @param {jsPDF} pdf - jsPDF instance
 * @param {object} opts - Page options
 * @param {number} opts.margin - Page margin in mm
 * @param {number} opts.pageW - Page width in mm
 * @param {number} opts.pageH - Page height in mm
 * @param {number} opts.pageNum - Current page number
 * @param {number} opts.totalPages - Total page count
 */
function drawUpgradePage(pdf, opts) {
  const margin = opts.margin;
  const pageW = opts.pageW;
  const pageH = opts.pageH;

  // Branded header (no pattern info — this is a CTA page)
  drawBrandedHeader(pdf, '', '', 0, 0, opts.pageNum, opts.totalPages, margin, pageW);
  drawBrandedFooter(pdf, margin, pageW, pageH);

  const centerX = pageW / 2;
  let y = pageH * 0.3;

  // Title
  pdf.setFontSize(22);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(184, 58, 42);
  pdf.text('Your pattern is ready to come to life', centerX, y, { align: 'center' });
  y += 12;

  // Subtitle
  pdf.setFontSize(12);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(100, 100, 100);
  pdf.text('Everything you need to start stitching \u2014 thread colors, quantities, and dimensions.', centerX, y, { align: 'center' });
  y += 20;

  // Feature checklist
  const items = [
    'Exact DMC thread colors you\u2019ll need',
    'How much thread to buy (meters + skeins)',
    'Finished size & fabric cutting guide',
    'Clean pattern, no watermark',
    'Print & stitch at true 1:1 scale',
  ];

  pdf.setFontSize(11);
  pdf.setTextColor(60, 60, 60);
  pdf.setFont('helvetica', 'normal');
  for (let i = 0; i < items.length; i++) {
    pdf.text('\u2713  ' + items[i], centerX - 60, y);
    y += 7;
  }
  y += 10;

  // Indie support message
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(140, 130, 120);
  pdf.text('Made with love by one person. Your support keeps Word2Stitch free for everyone.', centerX, y, { align: 'center' });
  y += 12;

  // Pricing
  pdf.setFontSize(14);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(184, 58, 42);
  pdf.text('Support an indie maker \u2014 from $1.99', centerX, y, { align: 'center' });
  y += 8;

  // URL
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(120, 120, 120);
  pdf.text('word2stitch.vercel.app', centerX, y, { align: 'center' });
}


// ══════════════════════════════════════════════════════════════════
//  Word2Stitch — PDF Legend
//  Legend/materials page: thread table, pattern info, size boxes.
//  Depends on pdf-helpers (pt, getLuminance) and pdf-chrome (header/footer).
// ══════════════════════════════════════════════════════════════════

/**
 * Draw the thread table section of the legend page.
 *
 * @param {jsPDF} pdf - jsPDF instance
 * @param {object} opts - Legend options
 * @param {number} y - Current Y position
 * @returns {number} Updated Y position after drawing
 */
function drawThreadTable(pdf, opts, y) {
  var color = opts.color;
  var stitchCount = opts.stitchCount;
  var aidaCount = opts.aidaCount;
  var margin = opts.margin;
  var pageW = opts.pageW;

  // Thread calculation: ~0.013m per full cross stitch at Aida 14
  // (4 diagonal passes x stitch_size x sqrt(2) + 20% waste), scaled by fabric count
  const metersPerStitch = 0.013 * (14 / aidaCount);
  const meters = stitchCount * metersPerStitch;
  const skeins = Math.ceil(meters / 8);
  const preferImperial = (typeof window.getDisplayUnit === 'function' && window.getDisplayUnit() === 'imperial');

  // Table width adapts to page
  const contentW = pageW - margin * 2;
  const tW = Math.min(contentW, 220);
  const colPcts = [0, 0.10, 0.19, 0.31, 0.52, 0.68, 0.84];
  const colX = colPcts.map(function(p) { return margin + p * tW; });
  const colLabels = [pt('pdf_col_symbol','Symbol'), pt('pdf_col_swatch','Swatch'), pt('pdf_col_dmc_code','DMC Code'), pt('pdf_col_color_name','Color Name'), pt('pdf_col_stitches','Stitches'), pt('pdf_col_thread','Thread'), pt('pdf_col_skeins','Skeins')];

  // Table header
  pdf.setFillColor(245, 240, 235);
  pdf.rect(margin, y - 3, tW, 8, 'F');
  pdf.setFontSize(8);
  pdf.setTextColor(80, 80, 80);
  pdf.setFont('helvetica', 'bold');
  for (let i = 0; i < colLabels.length; i++) {
    pdf.text(colLabels[i], colX[i] + 1, y + 2);
  }
  y += 10;

  // Header line
  pdf.setDrawColor(200, 190, 175);
  pdf.setLineWidth(0.3);
  pdf.line(margin, y - 2, margin + tW, y - 2);

  // Data row
  const luminance = getLuminance(color);

  // Symbol cell
  pdf.setFillColor(color.r, color.g, color.b);
  pdf.rect(colX[0] + 1, y - 2, 10, 7, 'F');
  pdf.setTextColor(luminance < 0.5 ? 255 : 0, luminance < 0.5 ? 255 : 0, luminance < 0.5 ? 255 : 0);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.text('\u00D7', colX[0] + 6, y + 3, { align: 'center' });

  // Color swatch
  pdf.setFillColor(color.r, color.g, color.b);
  pdf.rect(colX[1] + 1, y - 2, 14, 7, 'F');
  pdf.setDrawColor(180, 170, 160);
  pdf.setLineWidth(0.15);
  pdf.rect(colX[1] + 1, y - 2, 14, 7, 'S');

  // Text values
  pdf.setTextColor(60, 60, 60);
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(9);
  pdf.text('DMC ' + color.code, colX[2] + 1, y + 2.5);
  pdf.text(color.name || '', colX[3] + 1, y + 2.5);
  pdf.text(String(stitchCount), colX[4] + 1, y + 2.5);
  var threadText = preferImperial ? (meters * 1.09361).toFixed(2) + ' yd' : meters.toFixed(2) + ' m';
  pdf.text(threadText, colX[5] + 1, y + 2.5);
  pdf.text(String(skeins), colX[6] + 1, y + 2.5);
  y += 12;

  // Bottom line
  pdf.setDrawColor(200, 190, 175);
  pdf.setLineWidth(0.2);
  pdf.line(margin, y - 3, margin + tW, y - 3);
  y += 8;

  return { y: y, meters: meters, skeins: skeins, preferImperial: preferImperial };
}

/**
 * Draw the pattern information section of the legend page.
 *
 * @param {jsPDF} pdf - jsPDF instance
 * @param {object} opts - Legend options
 * @param {number} y - Current Y position
 * @param {object} threadInfo - { meters, skeins, preferImperial } from drawThreadTable
 * @returns {number} Updated Y position after drawing
 */
function drawPatternInfo(pdf, opts, y, threadInfo) {
  var stitchCount = opts.stitchCount;
  var aidaCount = opts.aidaCount;
  var width = opts.width;
  var height = opts.height;
  var margin = opts.margin;
  var meters = threadInfo.meters;
  var skeins = threadInfo.skeins;
  var preferImperial = threadInfo.preferImperial;

  pdf.setFontSize(13);
  pdf.setTextColor(184, 58, 42);
  pdf.setFont('helvetica', 'bold');
  pdf.text(pt('pdf_pattern_info', 'Pattern Information'), margin, y);
  y += 9;

  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(9);
  pdf.setTextColor(70, 70, 70);

  const stitchMm = (25.4 / aidaCount).toFixed(2);
  const inchesW = (width / aidaCount).toFixed(2);
  const inchesH = (height / aidaCount).toFixed(2);
  const cmW = (width / aidaCount * 2.54).toFixed(1);
  const cmH = (height / aidaCount * 2.54).toFixed(1);

  var yards = (meters * 1.09361).toFixed(2);
  var finishedSizeNote = preferImperial
    ? pt('pdf_info_finished_size', 'Finished size') + ': ' + inchesW + ' \u00D7 ' + inchesH + '" (' + cmW + ' \u00D7 ' + cmH + ' cm)'
    : pt('pdf_info_finished_size', 'Finished size') + ': ' + cmW + ' \u00D7 ' + cmH + ' cm (' + inchesW + ' \u00D7 ' + inchesH + '")';
  var threadNote = preferImperial
    ? pt('pdf_info_thread_required', 'Thread required') + ': ' + yards + ' yd (' + skeins + ' ' + (skeins !== 1 ? pt('pdf_unit_skeins', 'skeins') : pt('pdf_unit_skein', 'skein')) + ')'
    : pt('pdf_info_thread_required', 'Thread required') + ': ' + meters.toFixed(2) + ' m (' + skeins + ' ' + (skeins !== 1 ? pt('pdf_unit_skeins', 'skeins') : pt('pdf_unit_skein', 'skein')) + ')';

  const notes = [
    pt('pdf_note_strands', 'Use 2 strands of DMC thread for cross stitches'),
    pt('pdf_note_center', 'Start from the center of the fabric for best results'),
    pt('pdf_info_fabric_aida', 'Fabric: Aida') + ' ' + aidaCount.toFixed(1) + ' ct \u2014 ' + pt('pdf_info_each_stitch', 'Each stitch') + ' = ' + stitchMm + ' mm',
    pt('pdf_info_pattern_size', 'Pattern size') + ': ' + width + ' \u00D7 ' + height + ' ' + pt('pdf_unit_stitches', 'stitches'),
    finishedSizeNote,
    pt('pdf_info_total_crosses', 'Total crosses') + ': ' + stitchCount,
    threadNote,
    pt('pdf_note_print', '\u26a0 Print at 100% scale (no fit-to-page) for 1:1 stitch size'),
  ];

  for (const note of notes) {
    pdf.text('\u2022  ' + note, margin + 2, y);
    y += 5.8;
  }
  y += 6;

  return { y: y, inchesW: inchesW, inchesH: inchesH, cmW: cmW, cmH: cmH };
}

/**
 * Draw the finished size and cut fabric boxes on the legend page.
 *
 * @param {jsPDF} pdf - jsPDF instance
 * @param {object} opts - Legend options
 * @param {number} y - Current Y position
 * @param {object} sizeInfo - { inchesW, inchesH, cmW, cmH } from drawPatternInfo
 * @param {boolean} preferImperial - Whether to show imperial units first
 */
function drawSizeBoxes(pdf, opts, y, sizeInfo, preferImperial) {
  var margin = opts.margin;
  var pageW = opts.pageW;
  var contentW = pageW - margin * 2;
  var tW = Math.min(contentW, 220);

  var inchesW = sizeInfo.inchesW;
  var inchesH = sizeInfo.inchesH;
  var cmW = sizeInfo.cmW;
  var cmH = sizeInfo.cmH;

  pdf.setDrawColor(184, 58, 42);
  pdf.setLineWidth(0.4);
  pdf.setFillColor(253, 248, 244);
  const boxW = Math.min(tW / 2 - 4, 90);

  // Finished Size box
  pdf.rect(margin, y, boxW, 22, 'FD');
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(184, 58, 42);
  pdf.text(pt('pdf_finished_size', 'Finished Size'), margin + 4, y + 6);
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(11);
  pdf.setTextColor(60, 60, 60);
  if (preferImperial) {
    pdf.text(inchesW + ' \u00D7 ' + inchesH + '"', margin + 4, y + 13);
    pdf.setFontSize(8);
    pdf.setTextColor(140, 130, 120);
    pdf.text('(' + cmW + ' \u00D7 ' + cmH + ' cm)', margin + 4, y + 18);
  } else {
    pdf.text(cmW + ' \u00D7 ' + cmH + ' cm', margin + 4, y + 13);
    pdf.setFontSize(8);
    pdf.setTextColor(140, 130, 120);
    pdf.text('(' + inchesW + ' \u00D7 ' + inchesH + '")', margin + 4, y + 18);
  }

  // Cut Fabric box (add 3" margin each side)
  const cutX = margin + boxW + 8;
  pdf.setDrawColor(184, 58, 42);
  pdf.setFillColor(253, 248, 244);
  pdf.rect(cutX, y, boxW, 22, 'FD');
  const cutInW = (parseFloat(inchesW) + 6).toFixed(1);
  const cutInH = (parseFloat(inchesH) + 6).toFixed(1);
  const cutCmW = (cutInW * 2.54).toFixed(1);
  const cutCmH = (cutInH * 2.54).toFixed(1);
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(184, 58, 42);
  pdf.text(pt('pdf_cut_fabric', 'Cut Fabric'), cutX + 4, y + 6);
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(11);
  pdf.setTextColor(60, 60, 60);
  if (preferImperial) {
    pdf.text(cutInW + ' \u00D7 ' + cutInH + '"', cutX + 4, y + 13);
    pdf.setFontSize(8);
    pdf.setTextColor(140, 130, 120);
    pdf.text(pt('pdf_cut_margin_imperial', '(+3" margin each side)'), cutX + 4, y + 18);
  } else {
    pdf.text(cutCmW + ' \u00D7 ' + cutCmH + ' cm', cutX + 4, y + 13);
    pdf.setFontSize(8);
    pdf.setTextColor(140, 130, 120);
    pdf.text(pt('pdf_cut_margin_metric', '(+7.6 cm margin each side)'), cutX + 4, y + 18);
  }
}

/**
 * Draw the legend/materials page.
 *
 * @param {jsPDF} pdf - jsPDF instance
 * @param {object} opts - Legend options
 * @param {object} opts.color - { code, name, hex, r, g, b }
 * @param {number} opts.stitchCount - Total filled stitches
 * @param {number} opts.aidaCount - Fabric count (11, 14, 16, 18)
 * @param {number} opts.width - Pattern width in stitches
 * @param {number} opts.height - Pattern height in stitches
 * @param {string} opts.fontName - Name of the font used
 * @param {string} opts.text - Pattern text
 * @param {number} opts.pageNum - Current page number
 * @param {number} opts.totalPages - Total page count
 * @param {number} opts.pageW - Page width in mm
 * @param {number} opts.pageH - Page height in mm
 */
function drawLegend(pdf, opts) {
  var color = opts.color;
  var stitchCount = opts.stitchCount;
  var aidaCount = opts.aidaCount;
  var width = opts.width;
  var height = opts.height;
  var fontName = opts.fontName;
  var text = opts.text;
  var pageNum = opts.pageNum;
  var totalPages = opts.totalPages;
  var pageW = opts.pageW || 210;
  var pageH = opts.pageH || 297;
  const margin = 15;

  // Branded header + footer
  drawBrandedHeader(pdf, text || '', fontName, width, height, pageNum, totalPages, margin, pageW);
  drawBrandedFooter(pdf, margin, pageW, pageH);

  let y = margin + 18; // after branded header bar

  // Title
  pdf.setFontSize(16);
  pdf.setTextColor(184, 58, 42); // accent color
  pdf.setFont('helvetica', 'bold');
  pdf.text(pt('pdf_thread_legend', 'Thread Legend'), margin, y);
  y += 10;

  var legendOpts = { color: color, stitchCount: stitchCount, aidaCount: aidaCount, width: width, height: height, margin: margin, pageW: pageW };

  // Thread table
  var threadResult = drawThreadTable(pdf, legendOpts, y);
  y = threadResult.y;

  // Pattern information
  var patternResult = drawPatternInfo(pdf, legendOpts, y, threadResult);
  y = patternResult.y;

  // Size boxes
  drawSizeBoxes(pdf, legendOpts, y, patternResult, threadResult.preferImperial);
  y += 30;

  // Indie thank-you note (post-purchase validation)
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'italic');
  pdf.setTextColor(170, 160, 150);
  pdf.text('Thank you for supporting Word2Stitch \u2014 an indie project made with love for the stitching community.', margin, y);
  pdf.text('Your support helps me keep building and improving this tool for crafters everywhere. Happy stitching! \u2764', margin, y + 4);
}


// ══════════════════════════════════════════════════════════════════
//  Word2Stitch — PDF Redacted Legend
//  Preview-mode legend with skeleton blur bars hiding premium values.
//  Depends on pdf-helpers (pt, getLuminance) and pdf-chrome (header/footer).
// ══════════════════════════════════════════════════════════════════

/**
 * Draw a redacted version of the legend page for preview PDFs.
 * Shows the real structure (table, info, boxes) but hides critical values
 * behind block characters, creating desire to see the real data.
 *
 * @param {jsPDF} pdf - jsPDF instance
 * @param {object} opts - Same options as drawLegend
 */
function drawRedactedLegend(pdf, opts) {
  var color = opts.color;
  var stitchCount = opts.stitchCount;
  var aidaCount = opts.aidaCount;
  var width = opts.width;
  var height = opts.height;
  var fontName = opts.fontName;
  var text = opts.text;
  var pageNum = opts.pageNum;
  var totalPages = opts.totalPages;
  var pageW = opts.pageW || 210;
  var pageH = opts.pageH || 297;
  var margin = 15;

  // Rounded pill placeholder bar (skeleton-style) to redact premium values
  function blurBar(x, baselineY, w, h) {
    h = h || 3.5;
    pdf.setFillColor(225, 218, 210);
    pdf.roundedRect(x, baselineY - h + 1, w, h, 1.2, 1.2, 'F');
  }

  drawBrandedHeader(pdf, text || '', fontName, width, height, pageNum, totalPages, margin, pageW);
  drawBrandedFooter(pdf, margin, pageW, pageH);

  var y = margin + 18;
  var contentW = pageW - margin * 2;
  var tW = Math.min(contentW, 220);
  var colPcts = [0, 0.10, 0.19, 0.31, 0.52, 0.68, 0.84];
  var colX = colPcts.map(function(p) { return margin + p * tW; });

  // -- Title --
  pdf.setFontSize(16);
  pdf.setTextColor(184, 58, 42);
  pdf.setFont('helvetica', 'bold');
  pdf.text(pt('pdf_thread_legend', 'Thread Legend'), margin, y);
  y += 10;

  // -- Thread table header (real) --
  var colLabels = [pt('pdf_col_symbol','Symbol'), pt('pdf_col_swatch','Swatch'), pt('pdf_col_dmc_code','DMC Code'), pt('pdf_col_color_name','Color Name'), pt('pdf_col_stitches','Stitches'), pt('pdf_col_thread','Thread'), pt('pdf_col_skeins','Skeins')];
  pdf.setFillColor(245, 240, 235);
  pdf.rect(margin, y - 3, tW, 8, 'F');
  pdf.setFontSize(8);
  pdf.setTextColor(80, 80, 80);
  pdf.setFont('helvetica', 'bold');
  for (var i = 0; i < colLabels.length; i++) {
    pdf.text(colLabels[i], colX[i] + 1, y + 2);
  }
  y += 10;
  pdf.setDrawColor(200, 190, 175);
  pdf.setLineWidth(0.3);
  pdf.line(margin, y - 2, margin + tW, y - 2);

  // -- Data row: symbol + swatch real, values as clean blur bars --
  var luminance = getLuminance(color);

  // Symbol cell (real)
  pdf.setFillColor(color.r, color.g, color.b);
  pdf.rect(colX[0] + 1, y - 2, 10, 7, 'F');
  pdf.setTextColor(luminance < 0.5 ? 255 : 0, luminance < 0.5 ? 255 : 0, luminance < 0.5 ? 255 : 0);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.text('\u00D7', colX[0] + 6, y + 3, { align: 'center' });

  // Color swatch (real)
  pdf.setFillColor(color.r, color.g, color.b);
  pdf.rect(colX[1] + 1, y - 2, 14, 7, 'F');
  pdf.setDrawColor(180, 170, 160);
  pdf.setLineWidth(0.15);
  pdf.rect(colX[1] + 1, y - 2, 14, 7, 'S');

  // Redacted values: clean blur bars instead of block characters
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(9);

  // DMC code: label + blur bar
  pdf.setTextColor(60, 60, 60);
  pdf.text('DMC', colX[2] + 1, y + 2.5);
  blurBar(colX[2] + 1 + pdf.getTextWidth('DMC '), y + 2.5, 14);

  // Color name: blur bar
  blurBar(colX[3] + 1, y + 2.5, 28);

  // Stitches: real value
  pdf.setTextColor(60, 60, 60);
  pdf.text(String(stitchCount), colX[4] + 1, y + 2.5);

  // Thread: blur bar
  blurBar(colX[5] + 1, y + 2.5, 18);

  // Skeins: blur bar
  blurBar(colX[6] + 1, y + 2.5, 8);

  y += 12;

  pdf.setDrawColor(200, 190, 175);
  pdf.setLineWidth(0.2);
  pdf.line(margin, y - 3, margin + tW, y - 3);
  y += 8;

  // -- Pattern Information (clean blur bars for redacted values) --
  pdf.setFontSize(13);
  pdf.setTextColor(184, 58, 42);
  pdf.setFont('helvetica', 'bold');
  pdf.text(pt('pdf_pattern_info', 'Pattern Information'), margin, y);
  y += 9;

  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(9);

  // Render bullet with text segments and inline blur bars
  function bulletLine(segments) {
    var x = margin + 2;
    pdf.setTextColor(70, 70, 70);
    pdf.text('\u2022', x, y);
    x += pdf.getTextWidth('\u2022') + 2;
    for (var s = 0; s < segments.length; s++) {
      if (segments[s].bar) {
        blurBar(x, y, segments[s].bar);
        x += segments[s].bar + 1;
      } else {
        pdf.setTextColor(70, 70, 70);
        pdf.text(segments[s].text, x, y);
        x += pdf.getTextWidth(segments[s].text);
      }
    }
    y += 5.8;
  }

  bulletLine([{ text: pt('pdf_note_strands', 'Use 2 strands of DMC thread for cross stitches') }]);
  bulletLine([{ text: pt('pdf_note_center', 'Start from the center of the fabric for best results') }]);
  bulletLine([
    { text: pt('pdf_info_fabric_aida', 'Fabric: Aida') + ' ' },
    { bar: 10 },
    { text: ' ct \u2014 ' + pt('pdf_info_each_stitch', 'Each stitch') + ' = ' },
    { bar: 12 },
    { text: ' mm' },
  ]);
  bulletLine([{ text: pt('pdf_info_pattern_size', 'Pattern size') + ': ' + width + ' \u00D7 ' + height + ' ' + pt('pdf_unit_stitches', 'stitches') }]);
  bulletLine([
    { text: pt('pdf_info_finished_size', 'Finished size') + ': ' },
    { bar: 32 },
  ]);
  bulletLine([{ text: pt('pdf_info_total_crosses', 'Total crosses') + ': ' + stitchCount }]);
  bulletLine([
    { text: pt('pdf_info_thread_required', 'Thread required') + ': ' },
    { bar: 38 },
  ]);
  bulletLine([{ text: '\u26a0 ' + pt('pdf_note_print', 'Print at 100% scale (no fit-to-page) for 1:1 stitch size') }]);
  y += 6;

  // -- Size boxes (blur bars instead of block chars) --
  var boxW = Math.min(tW / 2 - 4, 90);

  pdf.setDrawColor(184, 58, 42);
  pdf.setLineWidth(0.4);
  pdf.setFillColor(253, 248, 244);
  pdf.rect(margin, y, boxW, 22, 'FD');
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(184, 58, 42);
  pdf.text(pt('pdf_finished_size', 'Finished Size'), margin + 4, y + 6);
  blurBar(margin + 4, y + 13, 42, 4);

  var cutX = margin + boxW + 8;
  pdf.setDrawColor(184, 58, 42);
  pdf.setFillColor(253, 248, 244);
  pdf.rect(cutX, y, boxW, 22, 'FD');
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(184, 58, 42);
  pdf.text(pt('pdf_cut_fabric', 'Cut Fabric'), cutX + 4, y + 6);
  blurBar(cutX + 4, y + 13, 42, 4);

  y += 28;

  // -- Indie note --
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'italic');
  pdf.setTextColor(160, 150, 140);
  pdf.text('Word2Stitch is an indie project by one stitching enthusiast.', margin + (tW / 2), y, { align: 'center' });
  y += 4;
  pdf.text('Every pattern you get helps keep this tool free for everyone.', margin + (tW / 2), y, { align: 'center' });
  y += 10;

  // -- CTA box --
  var ctaW = tW * 0.7;
  var ctaX = margin + (tW - ctaW) / 2;
  pdf.setDrawColor(184, 58, 42);
  pdf.setLineWidth(0.6);
  pdf.setFillColor(253, 248, 244);
  pdf.roundedRect(ctaX, y, ctaW, 24, 3, 3, 'FD');

  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(184, 58, 42);
  pdf.text('Get the full thread list and measurements for just $1.99', ctaX + ctaW / 2, y + 10, { align: 'center' });
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(140, 130, 120);
  pdf.text('word2stitch.vercel.app', ctaX + ctaW / 2, y + 18, { align: 'center' });
}


// ══════════════════════════════════════════════════════════════════
//  Word2Stitch — PDF Renderer
//  Layout calculation, grid drawing, and PDF document assembly.
//  Depends on pdf-helpers, pdf-bitmap, pdf-chrome, and pdf-legend.
// ══════════════════════════════════════════════════════════════════

/**
 * Calculate multi-page layout for the pattern grid.
 *
 * @param {number} width - Total bitmap width in cells
 * @param {number} height - Total bitmap height in cells
 * @param {number} cellSize - Cell size in mm
 * @param {number} pageW - Usable page width in mm
 * @param {number} pageH - Usable page height in mm
 * @returns {object} Layout info: colsPerPage, rowsPerPage, pagesX, pagesY, totalPages
 */
function calculatePDFLayout(width, height, cellSize, pageW, pageH) {
  // Reserve space for coordinate labels on left (~5mm, vertical text) and top (~6mm)
  const labelMarginLeft = 5;
  const labelMarginTop = 6;

  const availableW = pageW - labelMarginLeft;
  const availableH = pageH - labelMarginTop;

  const colsPerPage = Math.max(1, Math.floor(availableW / cellSize));
  const rowsPerPage = Math.max(1, Math.floor(availableH / cellSize));

  const pagesX = Math.max(1, Math.ceil(width / colsPerPage));
  const pagesY = Math.max(1, Math.ceil(height / rowsPerPage));

  return {
    colsPerPage,
    rowsPerPage,
    pagesX,
    pagesY,
    totalPages: pagesX * pagesY,
    labelMarginLeft,
    labelMarginTop,
  };
}

/**
 * Draw one page section of the pattern grid.
 *
 * @param {jsPDF} pdf - jsPDF instance
 * @param {object} opts - Grid page options
 * @param {boolean[][]} opts.bitmap - Full 2D bitmap
 * @param {object} opts.color - { r, g, b } thread color
 * @param {number} opts.startCol - First column index for this page
 * @param {number} opts.startRow - First row index for this page
 * @param {number} opts.colsPerPage - Max columns that fit on one page
 * @param {number} opts.rowsPerPage - Max rows that fit on one page
 * @param {number} opts.cellSize - Cell size in mm
 * @param {object} opts.margins - { left, top } in mm
 * @param {object} opts.layout - Layout info from calculatePDFLayout
 */
function drawGridPage(pdf, opts) {
  var bitmap = opts.bitmap;
  var color = opts.color;
  var startCol = opts.startCol;
  var startRow = opts.startRow;
  var colsPerPage = opts.colsPerPage;
  var rowsPerPage = opts.rowsPerPage;
  var cellSize = opts.cellSize;
  var margins = opts.margins;
  var layout = opts.layout;

  const totalWidth = bitmap[0] ? bitmap[0].length : 0;
  const totalHeight = bitmap.length;

  // How many cells to actually draw on this page
  const endCol = Math.min(startCol + colsPerPage, totalWidth);
  const endRow = Math.min(startRow + rowsPerPage, totalHeight);
  const drawCols = endCol - startCol;
  const drawRows = endRow - startRow;

  const offsetX = margins.left + layout.labelMarginLeft;
  const offsetY = margins.top + layout.labelMarginTop;

  // Determine symbol color based on luminance
  const luminance = getLuminance(color);
  const symbolIsWhite = luminance < 0.5;

  // 1. Draw filled cells
  for (let row = startRow; row < endRow; row++) {
    for (let col = startCol; col < endCol; col++) {
      if (bitmap[row] && bitmap[row][col]) {
        const x = offsetX + (col - startCol) * cellSize;
        const y = offsetY + (row - startRow) * cellSize;

        // Fill cell with thread color
        pdf.setFillColor(color.r, color.g, color.b);
        pdf.rect(x, y, cellSize, cellSize, 'F');

        // Draw cross symbol centered in cell (only if cell is large enough to be readable)
        if (cellSize >= 1.5) {
          if (symbolIsWhite) {
            pdf.setTextColor(255, 255, 255);
          } else {
            pdf.setTextColor(0, 0, 0);
          }
          pdf.setFontSize(Math.max(4, cellSize * 2.2));
          pdf.text(
            '\u00D7',
            x + cellSize / 2,
            y + cellSize / 2 + cellSize * 0.12,
            { align: 'center' }
          );
        }
      }
    }
  }

  // 2. Draw grid lines

  // Thin grid lines (every cell)
  pdf.setDrawColor(204, 204, 204); // #ccc
  pdf.setLineWidth(0.1);

  for (let col = 0; col <= drawCols; col++) {
    const x = offsetX + col * cellSize;
    pdf.line(x, offsetY, x, offsetY + drawRows * cellSize);
  }
  for (let row = 0; row <= drawRows; row++) {
    const y = offsetY + row * cellSize;
    pdf.line(offsetX, y, offsetX + drawCols * cellSize, y);
  }

  // Bold grid lines (every 10 cells)
  pdf.setDrawColor(51, 51, 51); // #333
  pdf.setLineWidth(0.3);

  for (let col = 0; col <= drawCols; col++) {
    const absCol = startCol + col;
    if (absCol % 10 === 0) {
      const x = offsetX + col * cellSize;
      pdf.line(x, offsetY, x, offsetY + drawRows * cellSize);
    }
  }
  for (let row = 0; row <= drawRows; row++) {
    const absRow = startRow + row;
    if (absRow % 10 === 0) {
      const y = offsetY + row * cellSize;
      pdf.line(offsetX, y, offsetX + drawCols * cellSize, y);
    }
  }

  // Bold border around the grid area
  pdf.setDrawColor(51, 51, 51);
  pdf.setLineWidth(0.3);
  pdf.rect(offsetX, offsetY, drawCols * cellSize, drawRows * cellSize, 'S');

  // 3. Coordinate labels every 10 cells

  pdf.setFontSize(5);
  pdf.setTextColor(120, 120, 120);

  // Top edge labels
  for (let col = 0; col <= drawCols; col++) {
    const absCol = startCol + col;
    if (absCol % 10 === 0 && absCol > 0) {
      const x = offsetX + col * cellSize;
      pdf.text(String(absCol), x, offsetY - 1, { align: 'center' });
    }
  }

  // Left edge labels (rotated 90 for compact width)
  for (let row = 0; row <= drawRows; row++) {
    const absRow = startRow + row;
    if (absRow % 10 === 0 && absRow > 0) {
      const y = offsetY + row * cellSize;
      pdf.text(String(absRow), offsetX - 1.5, y, { align: 'center', angle: 90 });
    }
  }

  // 4. Verification scale bar (1:1 print check)
  // Draw a 10mm bar at bottom-right so users can verify print scale with a ruler
  const gridBottom = offsetY + drawRows * cellSize;
  const gridRight = offsetX + drawCols * cellSize;
  const barLen = 10; // exactly 10mm
  const barY = gridBottom + 5;
  const barX = gridRight - barLen;

  // Bar line
  pdf.setDrawColor(184, 58, 42);
  pdf.setLineWidth(0.4);
  pdf.line(barX, barY, barX + barLen, barY);
  // End ticks
  pdf.line(barX, barY - 1.5, barX, barY + 1.5);
  pdf.line(barX + barLen, barY - 1.5, barX + barLen, barY + 1.5);
  // Label
  pdf.setFontSize(5.5);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(184, 58, 42);
  pdf.text('\u2190 10 mm \u2192', barX + barLen / 2, barY - 2.5, { align: 'center' });
  pdf.setFontSize(4.5);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(140, 130, 120);
  pdf.text(pt('pdf_scale_verify', 'Verify: measure this bar with a ruler. Must be exactly 10 mm.'), barX + barLen / 2, barY + 3.5, { align: 'center' });
}

/**
 * Build the PDF document with given orientation.
 * Returns { pdf, filename } without saving.
 *
 * @param {string} text - Pattern text
 * @param {object} fontData - Font data with glyphs
 * @param {object} dmcColor - DMC color { code, name, hex, r, g, b }
 * @param {number} aidaCount - Fabric count (e.g. 14)
 * @param {string} orientation - 'portrait' or 'landscape'
 * @param {object} [options] - Optional settings
 * @param {boolean} [options.preview] - When true: watermark + no legend + upgrade CTA page
 */
function buildPDF(text, fontData, dmcColor, aidaCount, orientation, options) {
  const opts = options || {};
  const isPreview = !!opts.preview;
  const bitmap = getTextBitmapForPDF(text, fontData);
  if (bitmap.length === 0 || !bitmap[0] || bitmap[0].length === 0) {
    return null;
  }

  const patternWidth = bitmap[0].length;
  const patternHeight = bitmap.length;

  let stitchCount = 0;
  for (let row = 0; row < patternHeight; row++) {
    for (let col = 0; col < patternWidth; col++) {
      if (bitmap[row][col]) stitchCount++;
    }
  }

  const isLandscape = orientation === 'landscape';
  const pageW = isLandscape ? 297 : 210;
  const pageH = isLandscape ? 210 : 297;
  const margin = 15;
  const headerHeight = 14;
  // 1:1 scale: cellSize = real stitch size in mm = 25.4 / aidaCount
  const cellSize = 25.4 / aidaCount;

  const usableW = pageW - margin * 2;
  const usableH = pageH - margin * 2 - headerHeight;

  const layout = calculatePDFLayout(patternWidth, patternHeight, cellSize, usableW, usableH);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation: isLandscape ? 'landscape' : 'portrait',
    unit: 'mm',
    format: 'a4',
  });

  const totalGridPages = layout.totalPages;
  const totalPagesWithLegend = totalGridPages + 1;
  const fontName = fontData.name || fontData.id || 'Unknown';

  let pageNum = 0;
  for (let pageY = 0; pageY < layout.pagesY; pageY++) {
    for (let pageX = 0; pageX < layout.pagesX; pageX++) {
      if (pageNum > 0) {
        pdf.addPage();
      }
      pageNum++;

      const startCol = pageX * layout.colsPerPage;
      const startRow = pageY * layout.rowsPerPage;

      drawBrandedHeader(pdf, text, fontName, patternWidth, patternHeight, pageNum, totalPagesWithLegend, margin, pageW);
      drawBrandedFooter(pdf, margin, pageW, pageH);

      drawGridPage(pdf, {
        bitmap: bitmap,
        color: { r: dmcColor.r, g: dmcColor.g, b: dmcColor.b },
        startCol: startCol,
        startRow: startRow,
        colsPerPage: layout.colsPerPage,
        rowsPerPage: layout.rowsPerPage,
        cellSize: cellSize,
        margins: { left: margin, top: margin + headerHeight },
        layout: layout,
      });

      if (isPreview) {
        drawWatermark(pdf, pageW, pageH);
      }
    }
  }

  if (isPreview) {
    // Preview: redacted legend (shows structure, hides values) + upgrade CTA
    const totalPagesPreview = totalGridPages + 2;

    pdf.addPage();
    drawRedactedLegend(pdf, {
      color: dmcColor,
      stitchCount: stitchCount,
      aidaCount: aidaCount,
      width: patternWidth,
      height: patternHeight,
      fontName: fontName,
      text: text,
      pageNum: totalGridPages + 1,
      totalPages: totalPagesPreview,
      pageW: pageW,
      pageH: pageH,
    });

    pdf.addPage();
    drawUpgradePage(pdf, {
      margin: margin,
      pageW: pageW,
      pageH: pageH,
      pageNum: totalPagesPreview,
      totalPages: totalPagesPreview,
    });
  } else {
    // Paid: full legend with all data
    pdf.addPage();
    drawLegend(pdf, {
      color: dmcColor,
      stitchCount: stitchCount,
      aidaCount: aidaCount,
      width: patternWidth,
      height: patternHeight,
      fontName: fontName,
      text: text,
      pageNum: totalPagesWithLegend,
      totalPages: totalPagesWithLegend,
      pageW: pageW,
      pageH: pageH,
    });
  }

  const finalPageCount = isPreview ? totalGridPages + 2 : totalPagesWithLegend;
  const safeText = text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '').substring(0, 40);
  const safeId = (fontData.id || 'font').replace(/[^a-z0-9-]/g, '');
  const filename = 'word2stitch-' + (safeText || 'pattern') + '-' + safeId + '.pdf';

  return { pdf, filename, pages: finalPageCount, stitches: stitchCount, patternWidth, patternHeight };
}


// ══════════════════════════════════════════════════════════════════
//  Word2Stitch — PDF Modal
//  Print preview modal UI and PDF generation entry point
// ══════════════════════════════════════════════════════════════════

/**
 * Create and show the print preview modal.
 */
function _createPrintModal() {
  if (document.getElementById('printModal')) return;

  var modal = document.createElement('div');
  modal.id = 'printModal';
  modal.innerHTML = [
    '<div class="pm-backdrop"></div>',
    '<div class="pm-dialog">',
    '  <div class="pm-header">',
    '    <span class="pm-title">\u2715 <span data-i18n="pdf_print_preview">Print Preview</span></span>',
    '    <button class="pm-close" id="pmClose">\u2715</button>',
    '  </div>',
    '  <div class="pm-orient-row">',
    '    <button class="pm-orient-btn pm-active" data-orient="portrait">',
    '      <svg viewBox="0 0 24 32" width="20" height="26"><rect x="1" y="1" width="22" height="30" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><line x1="5" y1="8" x2="19" y2="8" stroke="currentColor" stroke-width="1.5"/></svg>',
    '      <span data-i18n="pdf_orient_portrait">Portrait</span>',
    '    </button>',
    '    <button class="pm-orient-btn" data-orient="landscape">',
    '      <svg viewBox="0 0 32 24" width="26" height="20"><rect x="1" y="1" width="30" height="22" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><line x1="5" y1="6" x2="27" y2="6" stroke="currentColor" stroke-width="1.5"/></svg>',
    '      <span data-i18n="pdf_orient_landscape">Landscape</span>',
    '    </button>',
    '  </div>',
    '  <div class="pm-preview">',
    '    <iframe id="pmIframe" class="pm-iframe"></iframe>',
    '  </div>',
    '  <div class="pm-mobile-summary">',
    '    <div class="pm-mobile-summary-icon">\uD83D\uDCC4</div>',
    '    <div class="pm-mobile-summary-text">',
    '      <strong data-i18n="mobile_preview_title">Your complete pattern pack</strong>',
    '      <span data-i18n="mobile_preview_items">Grid \u00b7 Thread legend \u00b7 Color codes \u00b7 Measurements</span>',
    '    </div>',
    '  </div>',
    '  <div class="pm-info" id="pmInfo"></div>',
    '  <div class="pm-actions">',
    '    <button class="pm-btn pm-btn-secondary" id="pmDownload">',
    '      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
    '      <span data-i18n="pdf_btn_download_preview">Download Preview (free)</span>',
    '    </button>',
    '    <button class="pm-btn pm-btn-accent" id="pmDownloadComplete">',
    '      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
    '      <span data-i18n="pdf_btn_download_complete">Download Full Pattern \u2728</span>',
    '    </button>',
    '    <button class="pm-btn pm-btn-primary" id="pmPrint">',
    '      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>',
    '      <span data-i18n="pdf_btn_print">Print</span>',
    '    </button>',
    '  </div>',
    '</div>',
  ].join('\n');

  var style = document.createElement('style');
  style.textContent = [
    '#printModal { position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; }',
    '#printModal.pm-hidden { display:none; }',
    '.pm-backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.5); }',
    '.pm-dialog { position:relative; background:#faf8f5; border-radius:14px; width:90vw; max-width:680px; max-height:90vh; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden; }',
    '.pm-header { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid #e0d6c8; }',
    '.pm-title { font-family:"DM Serif Display",Georgia,serif; font-size:18px; color:#3d3229; }',
    '.pm-close { background:none; border:none; font-size:18px; color:#a99e8f; cursor:pointer; padding:4px 8px; border-radius:6px; transition:background 0.15s, color 0.15s; }',
    '.pm-close:hover { background:rgba(184,58,42,0.08); color:#b83a2a; }',
    '.pm-orient-row { display:flex; gap:8px; padding:12px 18px; justify-content:center; }',
    '.pm-orient-btn { display:flex; align-items:center; gap:8px; padding:10px 20px; border:2px solid #e0d6c8; border-radius:10px; background:#fff; cursor:pointer; font-family:"Anybody",system-ui,sans-serif; font-size:13px; font-weight:600; color:#7a6e60; transition:border-color 0.15s, background 0.15s, color 0.15s; min-height:48px; }',
    '.pm-orient-btn:hover { border-color:#b83a2a; color:#b83a2a; }',
    '.pm-orient-btn.pm-active { border-color:#b83a2a; background:rgba(184,58,42,0.08); color:#b83a2a; }',
    '.pm-preview { flex:1; min-height:0; padding:0 18px; overflow:hidden; }',
    '.pm-iframe { width:100%; height:350px; border:1px solid #e0d6c8; border-radius:8px; background:#fff; }',
    '.pm-info { padding:8px 18px; font-size:12px; color:#7a6e60; text-align:center; }',
    '.pm-actions { display:flex; gap:10px; padding:14px 18px; border-top:1px solid #e0d6c8; justify-content:flex-end; flex-wrap:wrap; }',
    '.pm-btn { display:flex; align-items:center; gap:6px; padding:10px 20px; border-radius:10px; font-family:"Anybody",system-ui,sans-serif; font-size:14px; font-weight:600; cursor:pointer; border:none; transition:background 0.15s, color 0.15s, box-shadow 0.15s; min-height:48px; }',
    '.pm-btn-secondary { background:#fff; color:#3d3229; border:2px solid #e0d6c8; }',
    '.pm-btn-secondary:hover { border-color:#b83a2a; color:#b83a2a; }',
    '.pm-btn-accent { background:#b83a2a; color:#fff; }',
    '.pm-btn-accent:hover { background:#9c3023; box-shadow:0 3px 12px rgba(184,58,42,0.25); }',
    '.pm-btn-primary { background:#3d3229; color:#fff; }',
    '.pm-btn-primary:hover { background:#2a231c; box-shadow:0 3px 12px rgba(61,50,41,0.25); }',
    '.pm-mobile-summary { display:none; }',
    '@media(max-width:640px) { .pm-dialog { width:96vw; max-height:95vh; border-radius:10px; } .pm-preview { display:none; } .pm-mobile-summary { display:flex; gap:12px; align-items:center; padding:14px 18px; background:rgba(184,58,42,0.04); border-radius:10px; margin:0 18px; text-align:left; } .pm-mobile-summary-icon { font-size:2rem; } .pm-mobile-summary-text { display:flex; flex-direction:column; gap:2px; } .pm-mobile-summary-text strong { font-size:14px; color:#3d3229; } .pm-mobile-summary-text span { font-size:12px; color:#7a6e60; } .pm-orient-btn { padding:8px 14px; font-size:12px; } .pm-actions { flex-direction:column; } .pm-btn { justify-content:center; } }',
  ].join('\n');

  document.head.appendChild(style);
  document.body.appendChild(modal);

  // Apply i18n to modal UI strings (uses data-i18n attrs, auto-translated by applyLang)
  if (typeof applyLang === 'function') applyLang();
}

/**
 * Show the print preview modal.
 * Generates PREVIEW PDF (watermark, no legend) and displays in iframe.
 * Complete PDF requires payment via requestPdfDownload().
 */
function generatePDF(text, fontData, dmcColor, aidaCount) {
  if (!text || !text.trim()) { alert(pt('pdf_alert_no_text', 'Please enter some text.')); return; }
  if (!fontData || !fontData.glyphs) { alert(pt('pdf_alert_no_font', 'No font selected.')); return; }
  if (!dmcColor) { alert(pt('pdf_alert_no_color', 'No color selected.')); return; }

  _createPrintModal();

  var modal = document.getElementById('printModal');
  var iframe = document.getElementById('pmIframe');
  var info = document.getElementById('pmInfo');
  var currentOrientation = 'portrait';
  var currentBlobUrl = null;

  function buildAndShow(orient) {
    // Build PREVIEW version (watermark, no legend, upgrade CTA)
    var result = buildPDF(text, fontData, dmcColor, aidaCount, orient, { preview: true });
    if (!result) { alert(pt('pdf_alert_no_render', 'Could not render pattern.')); return; }

    if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
    var blob = result.pdf.output('blob');
    currentBlobUrl = URL.createObjectURL(blob);

    iframe.src = currentBlobUrl;

    var cmW = (result.patternWidth / aidaCount * 2.54).toFixed(1);
    var cmH = (result.patternHeight / aidaCount * 2.54).toFixed(1);
    var inW = (result.patternWidth / aidaCount).toFixed(1);
    var inH = (result.patternHeight / aidaCount).toFixed(1);
    var isImperial = (typeof window.getDisplayUnit === 'function' && window.getDisplayUnit() === 'imperial');
    var sizeStr = isImperial ? (inW + ' \u00d7 ' + inH + '"') : (cmW + ' \u00d7 ' + cmH + ' cm');
    info.textContent = result.patternWidth + '\u00d7' + result.patternHeight +
      ' ' + pt('pdf_unit_stitches', 'stitches') + ' \u00b7 ' + sizeStr + ' \u00b7 ' +
      result.pages + ' ' + pt('pdf_unit_pages', 'pages') + ' \u00b7 ' + result.stitches + ' ' + pt('pdf_unit_crosses', 'crosses');

    // Store preview result for free download
    modal._previewResult = result;
    modal._blobUrl = currentBlobUrl;
  }

  // Show modal
  modal.classList.remove('pm-hidden');
  buildAndShow(currentOrientation);

  // Orientation buttons
  var orientBtns = modal.querySelectorAll('.pm-orient-btn');
  function handleOrient(e) {
    var btn = e.target.closest('.pm-orient-btn');
    if (!btn) return;
    var orient = btn.dataset.orient;
    if (orient === currentOrientation) return;
    currentOrientation = orient;
    orientBtns.forEach(function(b) { b.classList.toggle('pm-active', b.dataset.orient === orient); });
    buildAndShow(orient);
  }
  orientBtns.forEach(function(b) {
    b.removeEventListener('click', handleOrient);
    b.addEventListener('click', handleOrient);
  });

  // Close
  function closeModal() {
    modal.classList.add('pm-hidden');
    iframe.src = 'about:blank';
    if (currentBlobUrl) { URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; }
  }
  modal.querySelector('.pm-backdrop').onclick = closeModal;
  document.getElementById('pmClose').onclick = closeModal;

  // Download Preview (free)
  document.getElementById('pmDownload').onclick = function() {
    if (modal._previewResult) {
      modal._previewResult.pdf.save('preview-' + modal._previewResult.filename);
    }
  };

  // Download Complete (paid)
  document.getElementById('pmDownloadComplete').onclick = function() {
    window.requestPdfDownload(function() {
      var complete = buildPDF(text, fontData, dmcColor, aidaCount, currentOrientation, { preview: false });
      if (complete) {
        complete.pdf.save(complete.filename);
      }
    });
  };

  // Print (paid) — with popup blocker fallback
  document.getElementById('pmPrint').onclick = function() {
    window.requestPdfDownload(function() {
      var complete = buildPDF(text, fontData, dmcColor, aidaCount, currentOrientation, { preview: false });
      if (complete) {
        var blob = complete.pdf.output('blob');
        var url = URL.createObjectURL(blob);
        var printWin = window.open(url, '_blank');
        if (printWin) {
          printWin.addEventListener('load', function() {
            setTimeout(function() { printWin.print(); }, 500);
          });
        } else {
          // Popup blocked — fall back to download
          complete.pdf.save(complete.filename);
        }
      }
    });
  };
}

</script>

<!-- ═══ I18N Translations ═══ -->
<script>
// I18N translation dictionary for Word2Stitch
// Extracted from ui-shell.html for modularity
// This file is injected by assemble.js into the final index.html

  var I18N = {
    en: {
      placeholder_text: "Type your text here…",
      section_font: "Font",
      search_fonts: "Search fonts…",
      tab_all: "All",
      section_height: "Stitch Height",
      unit_px: "st",
      section_color: "Thread Color",
      section_fabric: "Fabric",
      label_aida: "Aida",
      empty_state: "Type something to see your pattern",
      loading_text: "Rasterizing…",
      unit_cm: "cm",
      unit_stitches: "stitches",
      unit_crosses: "crosses",
      toggle_controls: "Toggle controls",
      no_fonts: "No fonts available",
      no_matching: "No matching fonts",
      server_error: "Failed to load fonts. Is the server running?",
      alert_no_text: "Type some text and select a font first.",
      alert_no_pdf: "PDF engine not loaded. Please reload the page.",
      alert_no_jspdf: "jsPDF library not loaded. Check your internet connection and reload.",
      alert_pdf_fail: "PDF generation failed: ",
      pdf_alert_no_text: "Please enter some text.",
      pdf_alert_no_font: "No font selected.",
      pdf_alert_no_color: "No color selected.",
      pdf_alert_no_render: "Could not render pattern.",
      label_custom: 'Custom',
      label_stitch_length: 'Stitch length',
      sheet_fabric: 'Fabric & Stitch',
      sheet_info: 'Pattern Info',
      label_dmc: 'DMC',
      label_thread: 'Thread',
      label_language: 'Language',
      pdf_thread_legend: "Thread Legend",
      pdf_pattern_info: "Pattern Information",
      pdf_col_symbol: "Symbol",
      pdf_col_swatch: "Swatch",
      pdf_col_dmc_code: "DMC Code",
      pdf_col_color_name: "Color Name",
      pdf_col_stitches: "Stitches",
      pdf_col_thread: "Thread",
      pdf_col_skeins: "Skeins",
      pdf_note_strands: "Use 2 strands of DMC thread for cross stitches",
      pdf_note_center: "Start from the center of the fabric for best results",
      pdf_note_print: "\u26a0 Print at 100% scale (no fit-to-page) for 1:1 stitch size",
      pdf_finished_size: "Finished Size",
      pdf_cut_fabric: "Cut Fabric",
      pdf_cut_margin_imperial: "(+3\" margin each side)",
      pdf_cut_margin_metric: "(+7.6 cm margin each side)",
      pdf_orient_portrait: "Portrait",
      pdf_orient_landscape: "Landscape",
      pdf_btn_download: "Download PDF",
      pdf_btn_print: "Print",
      pdf_btn_download_preview: "Download Preview (free)",
      pdf_btn_download_complete: "Download Full Pattern ✨",
      pdf_print_preview: "Print Preview",
      pdf_scale_verify: "Verify: measure this bar with a ruler. Must be exactly 10 mm.",
      pdf_info_finished_size: "Finished size",
      pdf_info_thread_required: "Thread required",
      pdf_info_fabric_aida: "Fabric: Aida",
      pdf_info_each_stitch: "Each stitch",
      pdf_info_pattern_size: "Pattern size",
      pdf_info_total_crosses: "Total crosses",
      pdf_footer_tagline: "Cross-Stitch Pattern Generator",
      pdf_unit_stitches: "stitches",
      pdf_unit_pages: "pages",
      pdf_unit_crosses: "crosses",
      pdf_unit_skein: "skein",
      pdf_unit_skeins: "skeins",
      pay_title: "Your pattern is ready to stitch \u2728",
      pay_subtitle: "Get your thread list, color codes, and print-ready PDF \u2014 everything you need to start stitching.",
      pay_single_label: "Just this one",
      pay_single_desc: "Your pattern in seconds",
      pay_badge_save: "Save 50%",
      pay_pack_label: "10 Patterns",
      pay_pack_unit: "$0.99 each",
      pay_pack_desc: "Perfect for gifts & projects",
      pay_annual_label: "All year",
      pay_annual_unit: "just $2.08/mo",
      pay_annual_desc: "Unlimited patterns, all year",
      pay_indie_note: "Word2Stitch is made with love by one person. Your support helps build new fonts and features. \uD83D\uDC9C",
      pay_terms: 'By purchasing, you agree to our <a href="/terms" target="_blank" rel="noopener">Terms of Service</a>',
      pay_divider_key: "Already have a key?",
      pay_key_placeholder: "Paste your pattern key here",
      pay_key_submit: "Activate \u2713",
      pay_credits_unlimited: "Unlimited",
      pay_credits_remaining: "downloads left",
      pay_title_success: "Payment received! \u2713",
      pay_subtitle_success: "Check your inbox \u2014 your pattern key is on its way! Paste it below.",
      pay_email_hint: "Check your email from Lemon Squeezy \u2014 also check spam!",
      pay_key_error: "Invalid or exhausted license key. Please check and try again.",
      pay_title_activating: "Preparing your pattern\u2026",
      pay_subtitle_activating: "Almost ready \u2014 just a moment!",
      pay_trust: "\uD83D\uDD12 Secure checkout via Lemon Squeezy",
      pay_title_personalized: "Your '{text}' pattern is ready \u2728",
      pay_checkout_slow: "Taking longer than expected\u2026",
      pay_checkout_retry: "Try again",
      free_title: "Your first pattern is free!",
      free_subtitle: "Enter your email to download your complete pattern — thread list, color codes, and print-ready PDF.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Download Free \u2193",
      free_note: "No spam, ever. Just your pattern.",
      free_email_error: "Please enter a valid email",
      upsell_title: "Pattern downloaded!",
      upsell_subtitle: "Love it? Get 10 patterns and save 50%",
      upsell_deal: "10 patterns for $9.99 \u2014 that\u2019s $0.99 each!",
      upsell_btn: "Upgrade to 10 Patterns \u2014 $9.99",
      upsell_skip: "No thanks",
      mobile_preview_title: "Your complete pattern pack",
      mobile_preview_items: "Grid \u00b7 Thread legend \u00b7 Color codes \u00b7 Measurements"
    },
    es: {
      placeholder_text: "Escribe tu texto aquí…",
      section_font: "Fuente",
      search_fonts: "Buscar fuentes…",
      tab_all: "Todas",
      section_height: "Altura de Puntada",
      unit_px: "st",
      section_color: "Color de Hilo",
      section_fabric: "Tela",
      label_aida: "Aida",
      empty_state: "Escribe algo para ver tu patrón",
      loading_text: "Rasterizando…",
      unit_cm: "cm",
      unit_stitches: "puntadas",
      unit_crosses: "cruces",
      toggle_controls: "Mostrar controles",
      no_fonts: "No hay fuentes disponibles",
      no_matching: "No se encontraron fuentes",
      server_error: "Error al cargar fuentes. ¿Está el servidor activo?",
      alert_no_text: "Escribe un texto y selecciona una fuente primero.",
      alert_no_pdf: "Motor PDF no cargado. Recarga la página.",
      alert_no_jspdf: "Biblioteca jsPDF no cargada. Verifica tu conexión y recarga.",
      alert_pdf_fail: "Error al generar PDF: ",
      pdf_alert_no_text: "Por favor, ingresa un texto.",
      pdf_alert_no_font: "No se seleccionó ninguna fuente.",
      pdf_alert_no_color: "No se seleccionó ningún color.",
      pdf_alert_no_render: "No se pudo generar el patrón.",
      label_custom: 'Personalizado',
      label_stitch_length: 'Largo de puntada',
      sheet_fabric: 'Tela y Puntada',
      sheet_info: 'Info del Patrón',
      label_dmc: 'DMC',
      label_thread: 'Hilo',
      label_language: 'Idioma',
      pdf_thread_legend: "Leyenda de Hilos",
      pdf_pattern_info: "Información del Patrón",
      pdf_col_symbol: "Símbolo",
      pdf_col_swatch: "Muestra",
      pdf_col_dmc_code: "Código DMC",
      pdf_col_color_name: "Color",
      pdf_col_stitches: "Puntadas",
      pdf_col_thread: "Hilo",
      pdf_col_skeins: "Madejas",
      pdf_note_strands: "Usar 2 hebras de hilo DMC para punto de cruz",
      pdf_note_center: "Comenzar desde el centro de la tela para mejores resultados",
      pdf_note_print: "\u26a0 Imprimir al 100% (sin ajustar a página) para tamaño 1:1",
      pdf_finished_size: "Tamaño Final",
      pdf_cut_fabric: "Cortar Tela",
      pdf_cut_margin_imperial: '(+3" de margen por lado)',
      pdf_cut_margin_metric: "(+7.6 cm de margen por lado)",
      pdf_orient_portrait: "Vertical",
      pdf_orient_landscape: "Horizontal",
      pdf_btn_download: "Descargar PDF",
      pdf_btn_print: "Imprimir",
      pdf_btn_download_preview: "Descargar vista previa (gratis)",
      pdf_btn_download_complete: "Descargar patrón completo ✨",
      pdf_print_preview: "Vista Previa",
      pdf_scale_verify: "Verificar: medir esta barra con una regla. Debe ser exactamente 10 mm.",
      pdf_info_finished_size: "Tamaño final",
      pdf_info_thread_required: "Hilo requerido",
      pdf_info_fabric_aida: "Tela: Aida",
      pdf_info_each_stitch: "Cada puntada",
      pdf_info_pattern_size: "Tamaño del patrón",
      pdf_info_total_crosses: "Total de cruces",
      pdf_footer_tagline: "Generador de Patrones de Punto de Cruz",
      pdf_unit_stitches: "puntadas",
      pdf_unit_pages: "páginas",
      pdf_unit_crosses: "cruces",
      pdf_unit_skein: "madeja",
      pdf_unit_skeins: "madejas",
      pay_title: "Tu patr\u00f3n est\u00e1 listo para bordar \u2728",
      pay_subtitle: "Obt\u00e9n tu lista de hilos, c\u00f3digos de color y PDF listo para imprimir \u2014 todo lo que necesitas para empezar.",
      pay_single_label: "Solo este",
      pay_single_desc: "Tu patr\u00f3n en segundos",
      pay_badge_save: "Ahorra 50%",
      pay_pack_label: "10 Patrones",
      pay_pack_unit: "$0.99 c/u",
      pay_pack_desc: "Ideal para regalos y proyectos",
      pay_annual_label: "Todo el a\u00f1o",
      pay_annual_unit: "solo $2.08/mes",
      pay_annual_desc: "Patrones ilimitados, todo el a\u00f1o",
      pay_indie_note: "Word2Stitch est\u00e1 hecho con amor por una sola persona. Tu apoyo ayuda a crear nuevas fuentes y funciones. \uD83D\uDC9C",
      pay_terms: 'Al comprar, aceptas nuestros <a href="/terms" target="_blank" rel="noopener">T\u00e9rminos de Servicio</a>',
      pay_divider_key: "\u00bfYa tienes una clave?",
      pay_key_placeholder: "Pega tu clave de patr\u00f3n aqu\u00ed",
      pay_key_submit: "Activar \u2713",
      pay_credits_unlimited: "Ilimitado",
      pay_credits_remaining: "descargas restantes",
      pay_title_success: "\u00a1Pago recibido! \u2713",
      pay_subtitle_success: "Revisa tu bandeja de entrada \u2014 \u00a1tu clave est\u00e1 en camino! P\u00e9gala abajo.",
      pay_email_hint: "Revisa tu email de Lemon Squeezy \u2014 \u00a1mira tambi\u00e9n en spam!",
      pay_key_error: "Clave inv\u00e1lida o agotada. Verifica e intenta de nuevo.",
      pay_title_activating: "Preparando tu patr\u00f3n\u2026",
      pay_subtitle_activating: "\u00a1Casi listo \u2014 un momento!",
      pay_trust: "\uD83D\uDD12 Pago seguro a trav\u00e9s de Lemon Squeezy",
      pay_title_personalized: "Tu patr\u00f3n '{text}' est\u00e1 listo \u2728",
      pay_checkout_slow: "Tardando m\u00e1s de lo esperado\u2026",
      pay_checkout_retry: "Intentar de nuevo",
      free_title: "\u00a1Tu primer patr\u00f3n es gratis!",
      free_subtitle: "Ingresa tu email para descargar tu patr\u00f3n completo \u2014 lista de hilos, c\u00f3digos de color y PDF listo para imprimir.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Descargar Gratis \u2193",
      free_note: "Sin spam, nunca. Solo tu patr\u00f3n.",
      free_email_error: "Por favor, ingresa un email v\u00e1lido",
      upsell_title: "\u00a1Patr\u00f3n descargado!",
      upsell_subtitle: "\u00bfTe encant\u00f3? Obt\u00e9n 10 patrones y ahorra 50%",
      upsell_deal: "10 patrones por $9.99 \u2014 \u00a1eso es $0.99 cada uno!",
      upsell_btn: "Mejorar a 10 Patrones \u2014 $9.99",
      upsell_skip: "No, gracias",
      mobile_preview_title: "Tu pack completo de patrones",
      mobile_preview_items: "Cuadr\u00edcula \u00b7 Leyenda de hilos \u00b7 C\u00f3digos de color \u00b7 Medidas"
    },
    fr: {
      placeholder_text: "Tapez votre texte ici…",
      section_font: "Police",
      search_fonts: "Rechercher des polices…",
      tab_all: "Toutes",
      section_height: "Hauteur de Point",
      unit_px: "st",
      section_color: "Couleur du Fil",
      section_fabric: "Tissu",
      label_aida: "Aida",
      empty_state: "Tapez quelque chose pour voir votre motif",
      loading_text: "Rastérisation…",
      unit_cm: "cm",
      unit_stitches: "points",
      unit_crosses: "croix",
      toggle_controls: "Afficher les contrôles",
      no_fonts: "Aucune police disponible",
      no_matching: "Aucune police trouvée",
      server_error: "Échec du chargement des polices. Le serveur est-il lancé ?",
      alert_no_text: "Tapez du texte et sélectionnez une police d'abord.",
      alert_no_pdf: "Moteur PDF non chargé. Rechargez la page.",
      alert_no_jspdf: "Bibliothèque jsPDF non chargée. Vérifiez votre connexion et rechargez.",
      alert_pdf_fail: "Échec de la génération du PDF : ",
      pdf_alert_no_text: "Veuillez saisir du texte.",
      pdf_alert_no_font: "Aucune police sélectionnée.",
      pdf_alert_no_color: "Aucune couleur sélectionnée.",
      pdf_alert_no_render: "Impossible de générer le motif.",
      label_custom: "Personnalisé",
      label_stitch_length: "Longueur de point",
      sheet_fabric: "Tissu et Point",
      sheet_info: "Info du Patron",
      label_dmc: "DMC",
      label_thread: "Fil",
      label_language: "Langue",
      pdf_thread_legend: "Légende des Fils",
      pdf_pattern_info: "Informations du Modèle",
      pdf_col_symbol: "Symbole",
      pdf_col_swatch: "Échantillon",
      pdf_col_dmc_code: "Code DMC",
      pdf_col_color_name: "Couleur",
      pdf_col_stitches: "Points",
      pdf_col_thread: "Fil",
      pdf_col_skeins: "Échevettes",
      pdf_note_strands: "Utiliser 2 brins de fil DMC pour les points de croix",
      pdf_note_center: "Commencer par le centre du tissu pour de meilleurs résultats",
      pdf_note_print: "\u26a0 Imprimer à 100% (sans ajuster à la page) pour une taille 1:1",
      pdf_finished_size: "Taille Finie",
      pdf_cut_fabric: "Couper le Tissu",
      pdf_cut_margin_imperial: '(+3" de marge de chaque côté)',
      pdf_cut_margin_metric: "(+7,6 cm de marge de chaque côté)",
      pdf_orient_portrait: "Portrait",
      pdf_orient_landscape: "Paysage",
      pdf_btn_download: "Télécharger PDF",
      pdf_btn_print: "Imprimer",
      pdf_btn_download_preview: "Télécharger l'aperçu (gratuit)",
      pdf_btn_download_complete: "Télécharger le patron complet ✨",
      pdf_print_preview: "Aperçu",
      pdf_scale_verify: "Vérifier : mesurer cette barre avec une règle. Doit faire exactement 10 mm.",
      pdf_info_finished_size: "Taille finie",
      pdf_info_thread_required: "Fil requis",
      pdf_info_fabric_aida: "Tissu : Aida",
      pdf_info_each_stitch: "Chaque point",
      pdf_info_pattern_size: "Taille du motif",
      pdf_info_total_crosses: "Total de croix",
      pdf_footer_tagline: "Générateur de Modèles Point de Croix",
      pdf_unit_stitches: "points",
      pdf_unit_pages: "pages",
      pdf_unit_crosses: "croix",
      pdf_unit_skein: "\u00e9chevette",
      pdf_unit_skeins: "\u00e9chevettes",
      pay_title: "Votre motif est pr\u00eat \u00e0 broder \u2728",
      pay_subtitle: "Obtenez votre liste de fils, codes couleur et PDF pr\u00eat \u00e0 imprimer \u2014 tout pour commencer.",
      pay_single_label: "Juste celui-ci",
      pay_single_desc: "Votre motif en quelques secondes",
      pay_badge_save: "\u00c9conomisez 50%",
      pay_pack_label: "10 Motifs",
      pay_pack_unit: "$0.99 pi\u00e8ce",
      pay_pack_desc: "Parfait pour les cadeaux et projets",
      pay_annual_label: "Toute l\u2019ann\u00e9e",
      pay_annual_unit: "seulement $2.08/mois",
      pay_annual_desc: "Motifs illimit\u00e9s, toute l\u2019ann\u00e9e",
      pay_indie_note: "Word2Stitch est fait avec amour par une seule personne. Votre soutien aide \u00e0 cr\u00e9er de nouvelles polices et fonctionnalit\u00e9s. \uD83D\uDC9C",
      pay_terms: 'En achetant, vous acceptez nos <a href="/terms" target="_blank" rel="noopener">Conditions d\u2019utilisation</a>',
      pay_divider_key: "D\u00e9j\u00e0 une cl\u00e9 ?",
      pay_key_placeholder: "Collez votre cl\u00e9 de motif ici",
      pay_key_submit: "Activer \u2713",
      pay_credits_unlimited: "Illimit\u00e9",
      pay_credits_remaining: "t\u00e9l\u00e9chargements restants",
      pay_title_success: "Paiement re\u00e7u ! \u2713",
      pay_subtitle_success: "V\u00e9rifiez votre bo\u00eete de r\u00e9ception \u2014 votre cl\u00e9 arrive ! Collez-la ci-dessous.",
      pay_email_hint: "V\u00e9rifiez votre email de Lemon Squeezy \u2014 pensez aussi aux spams !",
      pay_key_error: "Cl\u00e9 invalide ou \u00e9puis\u00e9e. V\u00e9rifiez et r\u00e9essayez.",
      pay_title_activating: "Pr\u00e9paration de votre motif\u2026",
      pay_subtitle_activating: "Presque pr\u00eat \u2014 un instant !",
      pay_trust: "\uD83D\uDD12 Paiement s\u00e9curis\u00e9 via Lemon Squeezy",
      pay_title_personalized: "Votre motif \u00ab\u202F{text}\u202F\u00bb est pr\u00eat \u2728",
      pay_checkout_slow: "Plus long que pr\u00e9vu\u2026",
      pay_checkout_retry: "R\u00e9essayer",
      free_title: "Votre premier motif est gratuit\u202f!",
      free_subtitle: "Entrez votre email pour t\u00e9l\u00e9charger votre motif complet \u2014 liste de fils, codes couleur et PDF pr\u00eat \u00e0 imprimer.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "T\u00e9l\u00e9charger Gratuit \u2193",
      free_note: "Pas de spam, jamais. Juste votre motif.",
      free_email_error: "Veuillez entrer un email valide",
      upsell_title: "Motif t\u00e9l\u00e9charg\u00e9\u202f!",
      upsell_subtitle: "Vous aimez\u202f? Obtenez 10 motifs et \u00e9conomisez 50%",
      upsell_deal: "10 motifs pour $9.99 \u2014 soit $0.99 chacun\u202f!",
      upsell_btn: "Passer \u00e0 10 Motifs \u2014 $9.99",
      upsell_skip: "Non merci",
      mobile_preview_title: "Votre pack de motifs complet",
      mobile_preview_items: "Grille \u00b7 L\u00e9gende des fils \u00b7 Codes couleur \u00b7 Mesures"
    },
    de: {
      placeholder_text: "Gib deinen Text ein…",
      section_font: "Schriftart",
      search_fonts: "Schriftarten suchen…",
      tab_all: "Alle",
      section_height: "Stichhöhe",
      unit_px: "st",
      section_color: "Garnfarbe",
      section_fabric: "Stoff",
      label_aida: "Aida",
      empty_state: "Tippe etwas, um dein Muster zu sehen",
      loading_text: "Wird gerastert…",
      unit_cm: "cm",
      unit_stitches: "Stiche",
      unit_crosses: "Kreuze",
      toggle_controls: "Steuerung anzeigen",
      no_fonts: "Keine Schriftarten verfügbar",
      no_matching: "Keine passenden Schriftarten",
      server_error: "Schriftarten konnten nicht geladen werden. Läuft der Server?",
      alert_no_text: "Gib einen Text ein und wähle eine Schriftart.",
      alert_no_pdf: "PDF-Engine nicht geladen. Seite neu laden.",
      alert_no_jspdf: "jsPDF nicht geladen. Prüfe deine Internetverbindung und lade neu.",
      alert_pdf_fail: "PDF-Erzeugung fehlgeschlagen: ",
      pdf_alert_no_text: "Bitte geben Sie einen Text ein.",
      pdf_alert_no_font: "Keine Schriftart ausgewählt.",
      pdf_alert_no_color: "Keine Farbe ausgewählt.",
      pdf_alert_no_render: "Muster konnte nicht erstellt werden.",
      label_custom: "Benutzerdefiniert",
      label_stitch_length: "Stichlänge",
      sheet_fabric: "Stoff und Stich",
      sheet_info: "Musterinfo",
      label_dmc: "DMC",
      label_thread: "Faden",
      label_language: "Sprache",
      pdf_thread_legend: "Garnlegende",
      pdf_pattern_info: "Musterinformationen",
      pdf_col_symbol: "Symbol",
      pdf_col_swatch: "Farbfeld",
      pdf_col_dmc_code: "DMC-Code",
      pdf_col_color_name: "Farbe",
      pdf_col_stitches: "Stiche",
      pdf_col_thread: "Faden",
      pdf_col_skeins: "Stränge",
      pdf_note_strands: "2 Fäden DMC-Garn für Kreuzstiche verwenden",
      pdf_note_center: "Von der Mitte des Stoffes beginnen für beste Ergebnisse",
      pdf_note_print: "\u26a0 Mit 100% drucken (nicht an Seite anpassen) für 1:1 Stichgröße",
      pdf_finished_size: "Fertige Größe",
      pdf_cut_fabric: "Stoff Zuschneiden",
      pdf_cut_margin_imperial: '(+3" Rand auf jeder Seite)',
      pdf_cut_margin_metric: "(+7,6 cm Rand auf jeder Seite)",
      pdf_orient_portrait: "Hochformat",
      pdf_orient_landscape: "Querformat",
      pdf_btn_download: "PDF Herunterladen",
      pdf_btn_print: "Drucken",
      pdf_btn_download_preview: "Vorschau herunterladen (kostenlos)",
      pdf_btn_download_complete: "Vollständiges Muster herunterladen ✨",
      pdf_print_preview: "Druckvorschau",
      pdf_scale_verify: "Prüfen: Diese Leiste mit einem Lineal messen. Muss genau 10 mm sein.",
      pdf_info_finished_size: "Fertige Größe",
      pdf_info_thread_required: "Faden benötigt",
      pdf_info_fabric_aida: "Stoff: Aida",
      pdf_info_each_stitch: "Jeder Stich",
      pdf_info_pattern_size: "Mustergröße",
      pdf_info_total_crosses: "Kreuzstiche gesamt",
      pdf_footer_tagline: "Kreuzstich-Mustergenerator",
      pdf_unit_stitches: "Stiche",
      pdf_unit_pages: "Seiten",
      pdf_unit_crosses: "Kreuze",
      pdf_unit_skein: "Strang",
      pdf_unit_skeins: "Str\u00e4nge",
      pay_title: "Dein Muster ist bereit zum Sticken \u2728",
      pay_subtitle: "Hol dir deine Fadenliste, Farbcodes und druckfertiges PDF \u2014 alles was du zum Sticken brauchst.",
      pay_single_label: "Nur dieses eine",
      pay_single_desc: "Dein Muster in Sekunden",
      pay_badge_save: "Spare 50%",
      pay_pack_label: "10 Muster",
      pay_pack_unit: "$0.99 pro St\u00fcck",
      pay_pack_desc: "Perfekt f\u00fcr Geschenke & Projekte",
      pay_annual_label: "Das ganze Jahr",
      pay_annual_unit: "nur $2.08/Monat",
      pay_annual_desc: "Unbegrenzte Muster, das ganze Jahr",
      pay_indie_note: "Word2Stitch wird mit Liebe von einer Person gemacht. Deine Unterst\u00fctzung hilft, neue Schriftarten und Funktionen zu entwickeln. \uD83D\uDC9C",
      pay_terms: 'Mit dem Kauf stimmst du unseren <a href="/terms" target="_blank" rel="noopener">Nutzungsbedingungen</a> zu',
      pay_divider_key: "Schon einen Schl\u00fcssel?",
      pay_key_placeholder: "F\u00fcge deinen Musterschl\u00fcssel hier ein",
      pay_key_submit: "Aktivieren \u2713",
      pay_credits_unlimited: "Unbegrenzt",
      pay_credits_remaining: "Downloads \u00fcbrig",
      pay_title_success: "Zahlung erhalten! \u2713",
      pay_subtitle_success: "Pr\u00fcfe deinen Posteingang \u2014 dein Schl\u00fcssel ist unterwegs! F\u00fcge ihn unten ein.",
      pay_email_hint: "Schau in deiner E-Mail von Lemon Squeezy nach \u2014 auch im Spam-Ordner!",
      pay_key_error: "Ung\u00fcltiger oder aufgebrauchter Schl\u00fcssel. Bitte pr\u00fcfen und erneut versuchen.",
      pay_title_activating: "Dein Muster wird vorbereitet\u2026",
      pay_subtitle_activating: "Fast fertig \u2014 einen Moment noch!",
      pay_trust: "\uD83D\uDD12 Sicherer Checkout \u00fcber Lemon Squeezy",
      pay_title_personalized: "Dein \u201e{text}\u201c-Muster ist fertig \u2728",
      pay_checkout_slow: "Dauert l\u00e4nger als erwartet\u2026",
      pay_checkout_retry: "Erneut versuchen",
      free_title: "Dein erstes Muster ist kostenlos!",
      free_subtitle: "Gib deine E-Mail ein, um dein vollst\u00e4ndiges Muster herunterzuladen \u2014 Fadenliste, Farbcodes und druckfertiges PDF.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Kostenlos herunterladen \u2193",
      free_note: "Kein Spam, niemals. Nur dein Muster.",
      free_email_error: "Bitte gib eine g\u00fcltige E-Mail ein",
      upsell_title: "Muster heruntergeladen!",
      upsell_subtitle: "Gef\u00e4llt es dir? Hol dir 10 Muster und spare 50%",
      upsell_deal: "10 Muster f\u00fcr $9.99 \u2014 das sind nur $0.99 pro St\u00fcck!",
      upsell_btn: "Auf 10 Muster upgraden \u2014 $9.99",
      upsell_skip: "Nein danke",
      mobile_preview_title: "Dein komplettes Musterpaket",
      mobile_preview_items: "Raster \u00b7 Garnlegende \u00b7 Farbcodes \u00b7 Ma\u00dfe"
    },
    it: {
      placeholder_text: "Scrivi il tuo testo qui…",
      section_font: "Font",
      search_fonts: "Cerca font…",
      tab_all: "Tutti",
      section_height: "Altezza Punto",
      unit_px: "st",
      section_color: "Colore Filo",
      section_fabric: "Tessuto",
      label_aida: "Aida",
      empty_state: "Scrivi qualcosa per vedere il tuo schema",
      loading_text: "Rasterizzazione…",
      unit_cm: "cm",
      unit_stitches: "punti",
      unit_crosses: "croci",
      toggle_controls: "Mostra controlli",
      no_fonts: "Nessun font disponibile",
      no_matching: "Nessun font trovato",
      server_error: "Caricamento font fallito. Il server è attivo?",
      alert_no_text: "Scrivi un testo e seleziona un font prima.",
      alert_no_pdf: "Motore PDF non caricato. Ricarica la pagina.",
      alert_no_jspdf: "Libreria jsPDF non caricata. Controlla la connessione e ricarica.",
      alert_pdf_fail: "Generazione PDF fallita: ",
      pdf_alert_no_text: "Inserisci del testo.",
      pdf_alert_no_font: "Nessun font selezionato.",
      pdf_alert_no_color: "Nessun colore selezionato.",
      pdf_alert_no_render: "Impossibile generare il modello.",
      label_custom: "Personalizzato",
      label_stitch_length: "Lunghezza punto",
      sheet_fabric: "Tessuto e Punto",
      sheet_info: "Info Modello",
      label_dmc: "DMC",
      label_thread: "Filo",
      label_language: "Lingua",
      pdf_thread_legend: "Legenda Fili",
      pdf_pattern_info: "Informazioni Modello",
      pdf_col_symbol: "Simbolo",
      pdf_col_swatch: "Campione",
      pdf_col_dmc_code: "Codice DMC",
      pdf_col_color_name: "Colore",
      pdf_col_stitches: "Punti",
      pdf_col_thread: "Filo",
      pdf_col_skeins: "Matasse",
      pdf_note_strands: "Usare 2 fili di cotone DMC per i punti croce",
      pdf_note_center: "Iniziare dal centro del tessuto per risultati migliori",
      pdf_note_print: "\u26a0 Stampare al 100% (non adattare alla pagina) per dimensione 1:1",
      pdf_finished_size: "Dimensione Finita",
      pdf_cut_fabric: "Tagliare Tessuto",
      pdf_cut_margin_imperial: '(+3" di margine per lato)',
      pdf_cut_margin_metric: "(+7,6 cm di margine per lato)",
      pdf_orient_portrait: "Verticale",
      pdf_orient_landscape: "Orizzontale",
      pdf_btn_download: "Scarica PDF",
      pdf_btn_print: "Stampa",
      pdf_btn_download_preview: "Scarica anteprima (gratis)",
      pdf_btn_download_complete: "Scarica schema completo ✨",
      pdf_print_preview: "Anteprima",
      pdf_scale_verify: "Verificare: misurare questa barra con un righello. Deve essere esattamente 10 mm.",
      pdf_info_finished_size: "Dimensione finita",
      pdf_info_thread_required: "Filo necessario",
      pdf_info_fabric_aida: "Tessuto: Aida",
      pdf_info_each_stitch: "Ogni punto",
      pdf_info_pattern_size: "Dimensione modello",
      pdf_info_total_crosses: "Punti croce totali",
      pdf_footer_tagline: "Generatore di Schemi Punto Croce",
      pdf_unit_stitches: "punti",
      pdf_unit_pages: "pagine",
      pdf_unit_crosses: "croci",
      pdf_unit_skein: "matassa",
      pdf_unit_skeins: "matasse",
      pay_title: "Il tuo schema \u00e8 pronto da ricamare \u2728",
      pay_subtitle: "Ottieni la lista dei fili, i codici colore e il PDF pronto da stampare \u2014 tutto per iniziare.",
      pay_single_label: "Solo questo",
      pay_single_desc: "Il tuo schema in pochi secondi",
      pay_badge_save: "Risparmia 50%",
      pay_pack_label: "10 Schemi",
      pay_pack_unit: "$0.99 ciascuno",
      pay_pack_desc: "Perfetto per regali e progetti",
      pay_annual_label: "Tutto l\u2019anno",
      pay_annual_unit: "solo $2.08/mese",
      pay_annual_desc: "Schemi illimitati, tutto l\u2019anno",
      pay_indie_note: "Word2Stitch \u00e8 fatto con amore da una sola persona. Il tuo supporto aiuta a creare nuovi font e funzionalit\u00e0. \uD83D\uDC9C",
      pay_terms: 'Acquistando, accetti i nostri <a href="/terms" target="_blank" rel="noopener">Termini di Servizio</a>',
      pay_divider_key: "Hai gi\u00e0 una chiave?",
      pay_key_placeholder: "Incolla la tua chiave qui",
      pay_key_submit: "Attiva \u2713",
      pay_credits_unlimited: "Illimitato",
      pay_credits_remaining: "download rimanenti",
      pay_title_success: "Pagamento ricevuto! \u2713",
      pay_subtitle_success: "Controlla la tua posta \u2014 la tua chiave sta arrivando! Incollala qui sotto.",
      pay_email_hint: "Controlla l\u2019email da Lemon Squeezy \u2014 guarda anche nello spam!",
      pay_key_error: "Chiave non valida o esaurita. Verifica e riprova.",
      pay_title_activating: "Preparazione dello schema\u2026",
      pay_subtitle_activating: "Quasi pronto \u2014 un attimo!",
      pay_trust: "\uD83D\uDD12 Checkout sicuro tramite Lemon Squeezy",
      pay_title_personalized: "Il tuo schema \u00ab{text}\u00bb \u00e8 pronto \u2728",
      pay_checkout_slow: "Ci sta mettendo pi\u00f9 del previsto\u2026",
      pay_checkout_retry: "Riprova",
      free_title: "Il tuo primo schema \u00e8 gratis!",
      free_subtitle: "Inserisci la tua email per scaricare lo schema completo \u2014 lista fili, codici colore e PDF pronto da stampare.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Scarica Gratis \u2193",
      free_note: "Niente spam, mai. Solo il tuo schema.",
      free_email_error: "Inserisci un\u2019email valida",
      upsell_title: "Schema scaricato!",
      upsell_subtitle: "Ti piace? Ottieni 10 schemi e risparmia il 50%",
      upsell_deal: "10 schemi a $9.99 \u2014 solo $0.99 ciascuno!",
      upsell_btn: "Passa a 10 Schemi \u2014 $9.99",
      upsell_skip: "No grazie",
      mobile_preview_title: "Il tuo pack completo di schemi",
      mobile_preview_items: "Griglia \u00b7 Legenda fili \u00b7 Codici colore \u00b7 Misure"
    },
    pt: {
      placeholder_text: "Digite seu texto aqui…",
      section_font: "Fonte",
      search_fonts: "Buscar fontes…",
      tab_all: "Todas",
      section_height: "Altura do Ponto",
      unit_px: "st",
      section_color: "Cor da Linha",
      section_fabric: "Tecido",
      label_aida: "Aida",
      empty_state: "Digite algo para ver seu padrão",
      loading_text: "Rasterizando…",
      unit_cm: "cm",
      unit_stitches: "pontos",
      unit_crosses: "cruzes",
      toggle_controls: "Mostrar controles",
      no_fonts: "Nenhuma fonte disponível",
      no_matching: "Nenhuma fonte encontrada",
      server_error: "Falha ao carregar fontes. O servidor está ativo?",
      alert_no_text: "Digite um texto e selecione uma fonte primeiro.",
      alert_no_pdf: "Motor PDF não carregado. Recarregue a página.",
      alert_no_jspdf: "Biblioteca jsPDF não carregada. Verifique sua conexão e recarregue.",
      alert_pdf_fail: "Falha na geração do PDF: ",
      pdf_alert_no_text: "Por favor, insira um texto.",
      pdf_alert_no_font: "Nenhuma fonte selecionada.",
      pdf_alert_no_color: "Nenhuma cor selecionada.",
      pdf_alert_no_render: "Não foi possível gerar o padrão.",
      label_custom: "Personalizado",
      label_stitch_length: "Comprimento do ponto",
      sheet_fabric: "Tecido e Ponto",
      sheet_info: "Info do Padrão",
      label_dmc: "DMC",
      label_thread: "Linha",
      label_language: "Idioma",
      pdf_thread_legend: "Legenda de Linhas",
      pdf_pattern_info: "Informações do Padrão",
      pdf_col_symbol: "Símbolo",
      pdf_col_swatch: "Amostra",
      pdf_col_dmc_code: "Código DMC",
      pdf_col_color_name: "Cor",
      pdf_col_stitches: "Pontos",
      pdf_col_thread: "Linha",
      pdf_col_skeins: "Meadas",
      pdf_note_strands: "Usar 2 fios de linha DMC para ponto cruz",
      pdf_note_center: "Começar pelo centro do tecido para melhores resultados",
      pdf_note_print: "\u26a0 Imprimir em 100% (sem ajustar à página) para tamanho 1:1",
      pdf_finished_size: "Tamanho Final",
      pdf_cut_fabric: "Cortar Tecido",
      pdf_cut_margin_imperial: '(+3" de margem de cada lado)',
      pdf_cut_margin_metric: "(+7,6 cm de margem de cada lado)",
      pdf_orient_portrait: "Retrato",
      pdf_orient_landscape: "Paisagem",
      pdf_btn_download: "Baixar PDF",
      pdf_btn_print: "Imprimir",
      pdf_btn_download_preview: "Baixar pré-visualização (grátis)",
      pdf_btn_download_complete: "Baixar padrão completo ✨",
      pdf_print_preview: "Pré-visualização",
      pdf_scale_verify: "Verificar: meça esta barra com uma régua. Deve ter exatamente 10 mm.",
      pdf_info_finished_size: "Tamanho final",
      pdf_info_thread_required: "Linha necessária",
      pdf_info_fabric_aida: "Tecido: Aida",
      pdf_info_each_stitch: "Cada ponto",
      pdf_info_pattern_size: "Tamanho do padrão",
      pdf_info_total_crosses: "Total de cruzes",
      pdf_footer_tagline: "Gerador de Padrões Ponto Cruz",
      pdf_unit_stitches: "pontos",
      pdf_unit_pages: "páginas",
      pdf_unit_crosses: "cruzes",
      pdf_unit_skein: "meada",
      pdf_unit_skeins: "meadas",
      pay_title: "Seu padr\u00e3o est\u00e1 pronto para bordar \u2728",
      pay_subtitle: "Receba sua lista de linhas, c\u00f3digos de cores e PDF pronto para imprimir \u2014 tudo para come\u00e7ar.",
      pay_single_label: "S\u00f3 este",
      pay_single_desc: "Seu padr\u00e3o em segundos",
      pay_badge_save: "Economize 50%",
      pay_pack_label: "10 Padr\u00f5es",
      pay_pack_unit: "$0.99 cada",
      pay_pack_desc: "Perfeito para presentes e projetos",
      pay_annual_label: "O ano todo",
      pay_annual_unit: "apenas $2.08/m\u00eas",
      pay_annual_desc: "Padr\u00f5es ilimitados, o ano todo",
      pay_indie_note: "Word2Stitch \u00e9 feito com amor por uma pessoa s\u00f3. Seu apoio ajuda a criar novas fontes e recursos. \uD83D\uDC9C",
      pay_terms: 'Ao comprar, voc\u00ea concorda com nossos <a href="/terms" target="_blank" rel="noopener">Termos de Servi\u00e7o</a>',
      pay_divider_key: "J\u00e1 tem uma chave?",
      pay_key_placeholder: "Cole sua chave de padr\u00e3o aqui",
      pay_key_submit: "Ativar \u2713",
      pay_credits_unlimited: "Ilimitado",
      pay_credits_remaining: "downloads restantes",
      pay_title_success: "Pagamento recebido! \u2713",
      pay_subtitle_success: "Verifique sua caixa de entrada \u2014 sua chave est\u00e1 a caminho! Cole abaixo.",
      pay_email_hint: "Verifique seu email do Lemon Squeezy \u2014 confira tamb\u00e9m o spam!",
      pay_key_error: "Chave inv\u00e1lida ou esgotada. Verifique e tente novamente.",
      pay_title_activating: "Preparando seu padr\u00e3o\u2026",
      pay_subtitle_activating: "Quase pronto \u2014 s\u00f3 um momento!",
      pay_trust: "\uD83D\uDD12 Pagamento seguro via Lemon Squeezy",
      pay_title_personalized: "Seu padr\u00e3o '{text}' est\u00e1 pronto \u2728",
      pay_checkout_slow: "Demorando mais que o esperado\u2026",
      pay_checkout_retry: "Tentar novamente",
      free_title: "Seu primeiro padr\u00e3o \u00e9 gr\u00e1tis!",
      free_subtitle: "Digite seu email para baixar seu padr\u00e3o completo \u2014 lista de linhas, c\u00f3digos de cores e PDF pronto para imprimir.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Baixar Gr\u00e1tis \u2193",
      free_note: "Sem spam, nunca. S\u00f3 o seu padr\u00e3o.",
      free_email_error: "Por favor, insira um email v\u00e1lido",
      upsell_title: "Padr\u00e3o baixado!",
      upsell_subtitle: "Gostou? Garanta 10 padr\u00f5es e economize 50%",
      upsell_deal: "10 padr\u00f5es por $9.99 \u2014 apenas $0.99 cada!",
      upsell_btn: "Passar para 10 Padr\u00f5es \u2014 $9.99",
      upsell_skip: "N\u00e3o, obrigada",
      mobile_preview_title: "Seu pack completo de padr\u00f5es",
      mobile_preview_items: "Grade \u00b7 Legenda de linhas \u00b7 C\u00f3digos de cor \u00b7 Medidas"
    },
    nl: {
      placeholder_text: "Typ je tekst hier…",
      section_font: "Lettertype",
      search_fonts: "Lettertypen zoeken…",
      tab_all: "Alle",
      section_height: "Steekhoogte",
      unit_px: "st",
      section_color: "Draadkleur",
      section_fabric: "Stof",
      label_aida: "Aida",
      empty_state: "Typ iets om je patroon te zien",
      loading_text: "Rasteren…",
      unit_cm: "cm",
      unit_stitches: "steken",
      unit_crosses: "kruisjes",
      toggle_controls: "Bediening tonen",
      no_fonts: "Geen lettertypen beschikbaar",
      no_matching: "Geen overeenkomende lettertypen",
      server_error: "Lettertypen laden mislukt. Draait de server?",
      alert_no_text: "Typ tekst en selecteer een lettertype.",
      alert_no_pdf: "PDF-engine niet geladen. Herlaad de pagina.",
      alert_no_jspdf: "jsPDF-bibliotheek niet geladen. Controleer je verbinding en herlaad.",
      alert_pdf_fail: "PDF genereren mislukt: ",
      pdf_alert_no_text: "Voer een tekst in.",
      pdf_alert_no_font: "Geen lettertype geselecteerd.",
      pdf_alert_no_color: "Geen kleur geselecteerd.",
      pdf_alert_no_render: "Patroon kon niet worden gegenereerd.",
      label_custom: "Aangepast",
      label_stitch_length: "Steeklengte",
      sheet_fabric: "Stof en Steek",
      sheet_info: "Patrooninfo",
      label_dmc: "DMC",
      label_thread: "Draad",
      label_language: "Taal",
      pdf_thread_legend: "Draadlegende",
      pdf_pattern_info: "Patrooninformatie",
      pdf_col_symbol: "Symbool",
      pdf_col_swatch: "Staal",
      pdf_col_dmc_code: "DMC-code",
      pdf_col_color_name: "Kleur",
      pdf_col_stitches: "Steken",
      pdf_col_thread: "Draad",
      pdf_col_skeins: "Strengen",
      pdf_note_strands: "Gebruik 2 draden DMC-garen voor kruissteek",
      pdf_note_center: "Begin in het midden van de stof voor het beste resultaat",
      pdf_note_print: "\u26a0 Print op 100% (niet passend maken) voor 1:1 steekgrootte",
      pdf_finished_size: "Afgewerkte Maat",
      pdf_cut_fabric: "Stof Knippen",
      pdf_cut_margin_imperial: '(+3" marge aan elke kant)',
      pdf_cut_margin_metric: "(+7,6 cm marge aan elke kant)",
      pdf_orient_portrait: "Staand",
      pdf_orient_landscape: "Liggend",
      pdf_btn_download: "PDF Downloaden",
      pdf_btn_print: "Afdrukken",
      pdf_btn_download_preview: "Voorbeeld downloaden (gratis)",
      pdf_btn_download_complete: "Volledig patroon downloaden ✨",
      pdf_print_preview: "Afdrukvoorbeeld",
      pdf_scale_verify: "Controleer: meet deze balk met een liniaal. Moet precies 10 mm zijn.",
      pdf_info_finished_size: "Afgewerkte maat",
      pdf_info_thread_required: "Draad nodig",
      pdf_info_fabric_aida: "Stof: Aida",
      pdf_info_each_stitch: "Elke steek",
      pdf_info_pattern_size: "Patroongrootte",
      pdf_info_total_crosses: "Totaal kruisjes",
      pdf_footer_tagline: "Kruissteekpatroongenerator",
      pdf_unit_stitches: "steken",
      pdf_unit_pages: "pagina's",
      pdf_unit_crosses: "kruisjes",
      pdf_unit_skein: "streng",
      pdf_unit_skeins: "strengen",
      pay_title: "Je patroon is klaar om te borduren \u2728",
      pay_subtitle: "Ontvang je draadlijst, kleurcodes en printklare PDF \u2014 alles om te beginnen.",
      pay_single_label: "Alleen deze",
      pay_single_desc: "Je patroon in seconden",
      pay_badge_save: "Bespaar 50%",
      pay_pack_label: "10 Patronen",
      pay_pack_unit: "$0.99 per stuk",
      pay_pack_desc: "Perfect voor cadeaus & projecten",
      pay_annual_label: "Het hele jaar",
      pay_annual_unit: "slechts $2.08/mnd",
      pay_annual_desc: "Onbeperkt patronen, het hele jaar",
      pay_indie_note: "Word2Stitch is met liefde gemaakt door \u00e9\u00e9n persoon. Jouw steun helpt nieuwe lettertypen en functies te bouwen. \uD83D\uDC9C",
      pay_terms: 'Door te kopen ga je akkoord met onze <a href="/terms" target="_blank" rel="noopener">Servicevoorwaarden</a>',
      pay_divider_key: "Heb je al een sleutel?",
      pay_key_placeholder: "Plak je patroonsleutel hier",
      pay_key_submit: "Activeren \u2713",
      pay_credits_unlimited: "Onbeperkt",
      pay_credits_remaining: "downloads over",
      pay_title_success: "Betaling ontvangen! \u2713",
      pay_subtitle_success: "Check je inbox \u2014 je sleutel is onderweg! Plak hem hieronder.",
      pay_email_hint: "Check je e-mail van Lemon Squeezy \u2014 kijk ook bij spam!",
      pay_key_error: "Ongeldige of uitgeputte sleutel. Controleer en probeer opnieuw.",
      pay_title_activating: "Je patroon wordt voorbereid\u2026",
      pay_subtitle_activating: "Bijna klaar \u2014 een momentje!",
      pay_trust: "\uD83D\uDD12 Veilig afrekenen via Lemon Squeezy",
      pay_title_personalized: "Je '{text}'-patroon is klaar \u2728",
      pay_checkout_slow: "Duurt langer dan verwacht\u2026",
      pay_checkout_retry: "Opnieuw proberen",
      free_title: "Je eerste patroon is gratis!",
      free_subtitle: "Vul je e-mail in om je volledige patroon te downloaden \u2014 draadlijst, kleurcodes en printklare PDF.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Gratis downloaden \u2193",
      free_note: "Geen spam, nooit. Alleen je patroon.",
      free_email_error: "Vul een geldig e-mailadres in",
      upsell_title: "Patroon gedownload!",
      upsell_subtitle: "Blij mee? Pak 10 patronen en bespaar 50%",
      upsell_deal: "10 patronen voor $9.99 \u2014 dat is $0.99 per stuk!",
      upsell_btn: "Upgraden naar 10 Patronen \u2014 $9.99",
      upsell_skip: "Nee bedankt",
      mobile_preview_title: "Je complete patroenpakket",
      mobile_preview_items: "Raster \u00b7 Draadlegende \u00b7 Kleurcodes \u00b7 Afmetingen"
    },
    ja: {
      placeholder_text: "テキストを入力…",
      section_font: "フォント",
      search_fonts: "フォントを検索…",
      tab_all: "すべて",
      section_height: "ステッチ高さ",
      unit_px: "st",
      section_color: "糸の色",
      section_fabric: "布地",
      label_aida: "アイーダ",
      empty_state: "テキストを入力するとパターンが表示されます",
      loading_text: "ラスタライズ中…",
      unit_cm: "cm",
      unit_stitches: "ステッチ",
      unit_crosses: "クロス",
      toggle_controls: "コントロール表示",
      no_fonts: "フォントがありません",
      no_matching: "一致するフォントがありません",
      server_error: "フォントの読み込みに失敗しました。サーバーは起動していますか？",
      alert_no_text: "テキストを入力してフォントを選択してください。",
      alert_no_pdf: "PDFエンジンが読み込まれていません。ページを再読み込みしてください。",
      alert_no_jspdf: "jsPDFが読み込まれていません。接続を確認して再読み込みしてください。",
      alert_pdf_fail: "PDF生成に失敗しました: ",
      pdf_alert_no_text: "テキストを入力してください。",
      pdf_alert_no_font: "フォントが選択されていません。",
      pdf_alert_no_color: "色が選択されていません。",
      pdf_alert_no_render: "パターンを生成できませんでした。",
      label_custom: "カスタム",
      label_stitch_length: "ステッチの長さ",
      sheet_fabric: "布とステッチ",
      sheet_info: "パターン情報",
      label_dmc: "DMC",
      label_thread: "糸",
      label_language: "言語",
      pdf_thread_legend: "糸の凡例",
      pdf_pattern_info: "パターン情報",
      pdf_col_symbol: "記号",
      pdf_col_swatch: "見本",
      pdf_col_dmc_code: "DMCコード",
      pdf_col_color_name: "色名",
      pdf_col_stitches: "ステッチ数",
      pdf_col_thread: "糸",
      pdf_col_skeins: "かせ",
      pdf_note_strands: "クロスステッチにはDMC糸2本取りで",
      pdf_note_center: "最良の結果を得るために布の中央から始めてください",
      pdf_note_print: "\u26a0 1:1サイズで100%印刷してください（ページに合わせないで）",
      pdf_finished_size: "完成サイズ",
      pdf_cut_fabric: "布のカット",
      pdf_cut_margin_imperial: '(各辺+3"の余白)',
      pdf_cut_margin_metric: "(各辺+7.6 cmの余白)",
      pdf_orient_portrait: "縦",
      pdf_orient_landscape: "横",
      pdf_btn_download: "PDFダウンロード",
      pdf_btn_print: "印刷",
      pdf_btn_download_preview: "プレビューをダウンロード（無料）",
      pdf_btn_download_complete: "完全な図案をダウンロード ✨",
      pdf_print_preview: "印刷プレビュー",
      pdf_scale_verify: "確認：この線を定規で測ってください。正確に10 mmである必要があります。",
      pdf_info_finished_size: "完成サイズ",
      pdf_info_thread_required: "必要な糸",
      pdf_info_fabric_aida: "布: Aida",
      pdf_info_each_stitch: "各ステッチ",
      pdf_info_pattern_size: "パターンサイズ",
      pdf_info_total_crosses: "クロス合計",
      pdf_footer_tagline: "クロスステッチパターンジェネレーター",
      pdf_unit_stitches: "ステッチ",
      pdf_unit_pages: "ページ",
      pdf_unit_crosses: "クロス",
      pdf_unit_skein: "\u304b\u305b",
      pdf_unit_skeins: "\u304b\u305b",
      pay_title: "\u30d1\u30bf\u30fc\u30f3\u304c\u523a\u3057\u3085\u3046\u6e96\u5099\u5b8c\u4e86 \u2728",
      pay_subtitle: "\u7cf8\u30ea\u30b9\u30c8\u3001\u30ab\u30e9\u30fc\u30b3\u30fc\u30c9\u3001\u5370\u5237\u7528PDF \u2014 \u523a\u3057\u3085\u3046\u306b\u5fc5\u8981\u306a\u3059\u3079\u3066\u304c\u63c3\u3044\u307e\u3059\u3002",
      pay_single_label: "\u3053\u306e1\u3064\u3060\u3051",
      pay_single_desc: "\u6570\u79d2\u3067\u30d1\u30bf\u30fc\u30f3\u5b8c\u6210",
      pay_badge_save: "50%\u304a\u5f97",
      pay_pack_label: "10\u30d1\u30bf\u30fc\u30f3",
      pay_pack_unit: "$0.99/\u500b",
      pay_pack_desc: "\u30d7\u30ec\u30bc\u30f3\u30c8\u3084\u4f5c\u54c1\u4f5c\u308a\u306b\u6700\u9069",
      pay_annual_label: "\u5e74\u9593",
      pay_annual_unit: "\u6708\u305f\u3063\u305f$2.08",
      pay_annual_desc: "\u7121\u5236\u9650\u306e\u30d1\u30bf\u30fc\u30f3\u3001\u4e00\u5e74\u4e2d",
      pay_indie_note: "Word2Stitch\u306f\u4e00\u4eba\u3067\u611b\u3092\u8fbc\u3081\u3066\u4f5c\u3063\u3066\u3044\u307e\u3059\u3002\u3042\u306a\u305f\u306e\u5fdc\u63f4\u304c\u65b0\u3057\u3044\u30d5\u30a9\u30f3\u30c8\u3084\u6a5f\u80fd\u306e\u958b\u767a\u306b\u5f79\u7acb\u3061\u307e\u3059\u3002\uD83D\uDC9C",
      pay_terms: '\u8cfc\u5165\u3059\u308b\u3053\u3068\u3067<a href="/terms" target="_blank" rel="noopener">\u5229\u7528\u898f\u7d04</a>\u306b\u540c\u610f\u3057\u307e\u3059',
      pay_divider_key: "\u30ad\u30fc\u3092\u304a\u6301\u3061\u3067\u3059\u304b\uff1f",
      pay_key_placeholder: "\u30d1\u30bf\u30fc\u30f3\u30ad\u30fc\u3092\u3053\u3053\u306b\u8cbc\u308a\u4ed8\u3051",
      pay_key_submit: "\u6709\u52b9\u5316 \u2713",
      pay_credits_unlimited: "\u7121\u5236\u9650",
      pay_credits_remaining: "\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u6b8b\u308a",
      pay_title_success: "\u304a\u652f\u6255\u3044\u5b8c\u4e86\uff01\u2713",
      pay_subtitle_success: "\u53d7\u4fe1\u30c8\u30ec\u30a4\u3092\u78ba\u8a8d \u2014 \u30ad\u30fc\u3092\u9001\u4fe1\u4e2d\u3067\u3059\uff01\u4e0b\u306b\u8cbc\u308a\u4ed8\u3051\u3066\u304f\u3060\u3055\u3044\u3002",
      pay_email_hint: "Lemon Squeezy\u304b\u3089\u306e\u30e1\u30fc\u30eb\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044 \u2014 \u8ff7\u60d1\u30e1\u30fc\u30eb\u30d5\u30a9\u30eb\u30c0\u3082\u30c1\u30a7\u30c3\u30af\uff01",
      pay_key_error: "\u7121\u52b9\u307e\u305f\u306f\u4f7f\u7528\u6e08\u307f\u306e\u30ad\u30fc\u3067\u3059\u3002\u78ba\u8a8d\u3057\u3066\u518d\u5ea6\u304a\u8a66\u3057\u304f\u3060\u3055\u3044\u3002",
      pay_title_activating: "\u30d1\u30bf\u30fc\u30f3\u3092\u6e96\u5099\u4e2d\u2026",
      pay_subtitle_activating: "\u3082\u3046\u5c11\u3057 \u2014 \u304a\u5f85\u3061\u304f\u3060\u3055\u3044\uff01",
      pay_trust: "\uD83D\uDD12 Lemon Squeezy\u306b\u3088\u308b\u5b89\u5168\u306a\u6c7a\u6e08",
      pay_title_personalized: "\u300c{text}\u300d\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u5b8c\u6210 \u2728",
      pay_checkout_slow: "\u4e88\u60f3\u3088\u308a\u6642\u9593\u304c\u304b\u304b\u3063\u3066\u3044\u307e\u3059\u2026",
      pay_checkout_retry: "\u3082\u3046\u4e00\u5ea6\u8a66\u3059",
      free_title: "\u6700\u521d\u306e\u30d1\u30bf\u30fc\u30f3\u306f\u7121\u6599\u3067\u3059\uff01",
      free_subtitle: "\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3092\u5165\u529b\u3057\u3066\u3001\u5b8c\u5168\u306a\u30d1\u30bf\u30fc\u30f3\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9 \u2014 \u7cf8\u30ea\u30b9\u30c8\u3001\u30ab\u30e9\u30fc\u30b3\u30fc\u30c9\u3001\u5370\u5237\u7528PDF\u4ed8\u304d\u3002",
      free_email_placeholder: "your@email.com",
      free_email_submit: "\u7121\u6599\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9 \u2193",
      free_note: "\u30b9\u30d1\u30e0\u306f\u4e00\u5207\u3042\u308a\u307e\u305b\u3093\u3002\u30d1\u30bf\u30fc\u30f3\u3060\u3051\u304a\u5c4a\u3051\u3057\u307e\u3059\u3002",
      free_email_error: "\u6709\u52b9\u306a\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044",
      upsell_title: "\u30d1\u30bf\u30fc\u30f3\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3057\u305f\uff01",
      upsell_subtitle: "\u6c17\u306b\u5165\u308a\u307e\u3057\u305f\u304b\uff1f10\u30d1\u30bf\u30fc\u30f3\u3067 50%\u304a\u5f97\u306b",
      upsell_deal: "10\u30d1\u30bf\u30fc\u30f3\u304c$9.99 \u2014 1\u3064\u305f\u3063\u305f\u306e$0.99\uff01",
      upsell_btn: "10\u30d1\u30bf\u30fc\u30f3\u306b\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9 \u2014 $9.99",
      upsell_skip: "\u3044\u3044\u3048\u3001\u7d50\u69cb\u3067\u3059",
      mobile_preview_title: "\u5b8c\u5168\u306a\u30d1\u30bf\u30fc\u30f3\u30d1\u30c3\u30af",
      mobile_preview_items: "\u30b0\u30ea\u30c3\u30c9 \u00b7 \u7cf8\u306e\u51e1\u4f8b \u00b7 \u30ab\u30e9\u30fc\u30b3\u30fc\u30c9 \u00b7 \u5bf8\u6cd5"
    },
    ko: {
      placeholder_text: "텍스트를 입력하세요…",
      section_font: "글꼴",
      search_fonts: "글꼴 검색…",
      tab_all: "전체",
      section_height: "스티치 높이",
      unit_px: "st",
      section_color: "실 색상",
      section_fabric: "원단",
      label_aida: "아이다",
      empty_state: "텍스트를 입력하면 패턴이 표시됩니다",
      loading_text: "래스터라이즈 중…",
      unit_cm: "cm",
      unit_stitches: "스티치",
      unit_crosses: "크로스",
      toggle_controls: "컨트롤 표시",
      no_fonts: "사용 가능한 글꼴이 없습니다",
      no_matching: "일치하는 글꼴이 없습니다",
      server_error: "글꼴 로드 실패. 서버가 실행 중인지 확인하세요.",
      alert_no_text: "텍스트를 입력하고 글꼴을 선택하세요.",
      alert_no_pdf: "PDF 엔진이 로드되지 않았습니다. 페이지를 새로고침하세요.",
      alert_no_jspdf: "jsPDF가 로드되지 않았습니다. 연결을 확인하고 새로고침하세요.",
      alert_pdf_fail: "PDF 생성 실패: ",
      pdf_alert_no_text: "텍스트를 입력해주세요.",
      pdf_alert_no_font: "글꼴이 선택되지 않았습니다.",
      pdf_alert_no_color: "색상이 선택되지 않았습니다.",
      pdf_alert_no_render: "패턴을 생성할 수 없습니다.",
      label_custom: "사용자 정의",
      label_stitch_length: "스티치 길이",
      sheet_fabric: "원단과 스티치",
      sheet_info: "패턴 정보",
      label_dmc: "DMC",
      label_thread: "실",
      label_language: "언어",
      pdf_thread_legend: "실 범례",
      pdf_pattern_info: "패턴 정보",
      pdf_col_symbol: "기호",
      pdf_col_swatch: "견본",
      pdf_col_dmc_code: "DMC 코드",
      pdf_col_color_name: "색상명",
      pdf_col_stitches: "스티치",
      pdf_col_thread: "실",
      pdf_col_skeins: "타래",
      pdf_note_strands: "십자수에 DMC 실 2가닥 사용",
      pdf_note_center: "최상의 결과를 위해 천의 중앙부터 시작하세요",
      pdf_note_print: "\u26a0 1:1 크기로 100% 인쇄하세요 (페이지에 맞추기 사용하지 마세요)",
      pdf_finished_size: "완성 크기",
      pdf_cut_fabric: "천 자르기",
      pdf_cut_margin_imperial: '(각 면 +3" 여유분)',
      pdf_cut_margin_metric: "(각 면 +7.6 cm 여유분)",
      pdf_orient_portrait: "세로",
      pdf_orient_landscape: "가로",
      pdf_btn_download: "PDF 다운로드",
      pdf_btn_print: "인쇄",
      pdf_btn_download_preview: "미리보기 다운로드 (무료)",
      pdf_btn_download_complete: "전체 도안 다운로드 ✨",
      pdf_print_preview: "인쇄 미리보기",
      pdf_scale_verify: "확인: 자로 이 막대를 측정하세요. 정확히 10 mm여야 합니다.",
      pdf_info_finished_size: "완성 크기",
      pdf_info_thread_required: "필요한 실",
      pdf_info_fabric_aida: "천: Aida",
      pdf_info_each_stitch: "각 스티치",
      pdf_info_pattern_size: "패턴 크기",
      pdf_info_total_crosses: "총 십자수",
      pdf_footer_tagline: "십자수 패턴 생성기",
      pdf_unit_stitches: "스티치",
      pdf_unit_pages: "페이지",
      pdf_unit_crosses: "십자수",
      pdf_unit_skein: "타래",
      pdf_unit_skeins: "타래",
      pay_title: "패턴이 준비되었습니다 \u2728",
      pay_subtitle: "실 목록, 색상 코드, 인쇄용 PDF \u2014 스티치에 필요한 모든 것을 받으세요.",
      pay_single_label: "이것만",
      pay_single_desc: "몇 초 만에 패턴 완성",
      pay_badge_save: "50% 할인",
      pay_pack_label: "10개 패턴",
      pay_pack_unit: "$0.99/개",
      pay_pack_desc: "선물과 프로젝트에 딱",
      pay_annual_label: "연간",
      pay_annual_unit: "월 $2.08에 불과",
      pay_annual_desc: "무제한 패턴, 1년 내내",
      pay_indie_note: "Word2Stitch는 한 사람이 사랑으로 만듭니다. 당신의 후원이 새 폰트와 기능 개발에 도움이 됩니다. \uD83D\uDC9C",
      pay_terms: '구매 시 <a href="/terms" target="_blank" rel="noopener">이용약관</a>에 동의합니다',
      pay_divider_key: "이미 키가 있으신가요?",
      pay_key_placeholder: "패턴 키를 여기에 붙여넣으세요",
      pay_key_submit: "활성화 \u2713",
      pay_credits_unlimited: "무제한",
      pay_credits_remaining: "다운로드 남음",
      pay_title_success: "결제 완료! \u2713",
      pay_subtitle_success: "받은편지함을 확인하세요 \u2014 키가 전송 중입니다! 아래에 붙여넣으세요.",
      pay_email_hint: "Lemon Squeezy\uc5d0\uc11c \uc628 \uc774\uba54\uc77c\uc744 \ud655\uc778\ud558\uc138\uc694 \u2014 \uc2a4\ud338 \ud3f4\ub354\ub3c4 \ud655\uc778\ud574 \ubcf4\uc138\uc694!",
      pay_key_error: "유효하지 않거나 소진된 키입니다. 확인 후 다시 시도하세요.",
      pay_title_activating: "패턴 준비 중\u2026",
      pay_subtitle_activating: "거의 완료 \u2014 잠시만요!",
      pay_trust: "\uD83D\uDD12 Lemon Squeezy를 통한 안전한 결제",
      pay_title_personalized: "'{text}' 패턴이 준비되었습니다 \u2728",
      pay_checkout_slow: "예상보다 오래 걸리고 있습니다\u2026",
      pay_checkout_retry: "다시 시도",
      free_title: "첫 번째 패턴은 무료입니다!",
      free_subtitle: "이메일을 입력하고 완전한 패턴을 다운로드하세요 — 실 목록, 색상 코드, 인쇄용 PDF 포함.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "무료 다운로드 \u2193",
      free_note: "스팸은 절대 없어요. 패턴만 보내드려요.",
      free_email_error: "유효한 이메일을 입력해주세요",
      upsell_title: "패턴 다운로드 완료!",
      upsell_subtitle: "마음에 드셨나요? 10개 패턴으로 50% 할인받으세요",
      upsell_deal: "10개 패턴 $9.99 — 개당 $0.99!",
      upsell_btn: "10개 패턴으로 업그레이드 — $9.99",
      upsell_skip: "괜찮아요",
      mobile_preview_title: "완전한 패턴 팩",
      mobile_preview_items: "그리드 \u00b7 실 범례 \u00b7 색상 코드 \u00b7 치수"
    },
    zh: {
      placeholder_text: "在此输入文字…",
      section_font: "字体",
      search_fonts: "搜索字体…",
      tab_all: "全部",
      section_height: "针高",
      unit_px: "st",
      section_color: "线色",
      section_fabric: "布料",
      label_aida: "Aida",
      empty_state: "输入文字以查看图案",
      loading_text: "正在栅格化…",
      unit_cm: "厘米",
      unit_stitches: "针",
      unit_crosses: "十字",
      toggle_controls: "显示控件",
      no_fonts: "没有可用字体",
      no_matching: "没有匹配的字体",
      server_error: "字体加载失败。服务器是否正在运行？",
      alert_no_text: "请输入文字并选择字体。",
      alert_no_pdf: "PDF引擎未加载。请刷新页面。",
      alert_no_jspdf: "jsPDF库未加载。请检查网络连接并刷新。",
      alert_pdf_fail: "PDF生成失败: ",
      pdf_alert_no_text: "请输入文本。",
      pdf_alert_no_font: "未选择字体。",
      pdf_alert_no_color: "未选择颜色。",
      pdf_alert_no_render: "无法生成图案。",
      label_custom: "自定义",
      label_stitch_length: "针距长度",
      sheet_fabric: "布料与针法",
      sheet_info: "图案信息",
      label_dmc: "DMC",
      label_thread: "线",
      label_language: "语言",
      pdf_thread_legend: "线材图例",
      pdf_pattern_info: "图案信息",
      pdf_col_symbol: "符号",
      pdf_col_swatch: "色样",
      pdf_col_dmc_code: "DMC编号",
      pdf_col_color_name: "颜色",
      pdf_col_stitches: "针数",
      pdf_col_thread: "线",
      pdf_col_skeins: "绞",
      pdf_note_strands: "十字绣使用2股DMC绣线",
      pdf_note_center: "从布料中心开始以获得最佳效果",
      pdf_note_print: "\u26a0 以100%比例打印（不要适应页面）以获得1:1针距",
      pdf_finished_size: "成品尺寸",
      pdf_cut_fabric: "裁布尺寸",
      pdf_cut_margin_imperial: '(每边+3"余量)',
      pdf_cut_margin_metric: "(每边+7.6厘米余量)",
      pdf_orient_portrait: "纵向",
      pdf_orient_landscape: "横向",
      pdf_btn_download: "下载PDF",
      pdf_btn_print: "打印",
      pdf_btn_download_preview: "下载预览（免费）",
      pdf_btn_download_complete: "下载完整图案 ✨",
      pdf_print_preview: "打印预览",
      pdf_scale_verify: "验证：用尺子测量此条。必须恰好为10毫米。",
      pdf_info_finished_size: "成品尺寸",
      pdf_info_thread_required: "所需线量",
      pdf_info_fabric_aida: "布料: Aida",
      pdf_info_each_stitch: "每针",
      pdf_info_pattern_size: "图案尺寸",
      pdf_info_total_crosses: "十字绣总数",
      pdf_footer_tagline: "十字绣图案生成器",
      pdf_unit_stitches: "针",
      pdf_unit_pages: "页",
      pdf_unit_crosses: "十字",
      pdf_unit_skein: "绞",
      pdf_unit_skeins: "绞",
      pay_title: "您的图案已准备好绣制 \u2728",
      pay_subtitle: "获取线材清单、色号和打印就绪的PDF \u2014 开始绣制所需的一切。",
      pay_single_label: "仅此一个",
      pay_single_desc: "几秒完成您的图案",
      pay_badge_save: "节省50%",
      pay_pack_label: "10个图案",
      pay_pack_unit: "$0.99/个",
      pay_pack_desc: "送礼与创作的理想之选",
      pay_annual_label: "全年",
      pay_annual_unit: "仅$2.08/月",
      pay_annual_desc: "无限图案，全年畅享",
      pay_indie_note: "Word2Stitch由一个人用爱心制作。您的支持有助于开发新字体和功能。\uD83D\uDC9C",
      pay_terms: '购买即表示您同意我们的<a href="/terms" target="_blank" rel="noopener">服务条款</a>',
      pay_divider_key: "已有密钥？",
      pay_key_placeholder: "在此粘贴您的图案密钥",
      pay_key_submit: "激活 \u2713",
      pay_credits_unlimited: "无限",
      pay_credits_remaining: "次下载剩余",
      pay_title_success: "支付成功！\u2713",
      pay_subtitle_success: "请查看您的邮箱 \u2014 密钥正在发送中！粘贴在下方。",
      pay_email_hint: "\u8bf7\u67e5\u770b Lemon Squeezy \u53d1\u9001\u7684\u90ae\u4ef6 \u2014 \u4e5f\u8bf7\u68c0\u67e5\u5783\u573e\u90ae\u4ef6\uff01",
      pay_key_error: "密钥无效或已用完。请检查后重试。",
      pay_title_activating: "正在准备您的图案\u2026",
      pay_subtitle_activating: "即将完成 \u2014 请稍等！",
      pay_trust: "\uD83D\uDD12 通过Lemon Squeezy安全结账",
      pay_title_personalized: "您的\u201c{text}\u201d图案已准备好 \u2728",
      pay_checkout_slow: "比预期花费更长时间\u2026",
      pay_checkout_retry: "重试",
      free_title: "您的第一个图案免费！",
      free_subtitle: "输入邮箱即可下载完整图案 — 线材清单、色号和打印就绪的PDF。",
      free_email_placeholder: "your@email.com",
      free_email_submit: "免费下载 \u2193",
      free_note: "绝不发送垃圾邮件。只为您送上图案。",
      free_email_error: "请输入有效的邮箱地址",
      upsell_title: "图案下载完成！",
      upsell_subtitle: "喜欢吗？获取10个图案，立省50%",
      upsell_deal: "10个图案仅$9.99 — 每个只要$0.99！",
      upsell_btn: "升级至10个图案 — $9.99",
      upsell_skip: "不用了，谢谢",
      mobile_preview_title: "您的完整图案包",
      mobile_preview_items: "网格 \u00b7 线材图例 \u00b7 色号 \u00b7 尺寸"
    },
    ru: {
      placeholder_text: "Введите текст…",
      section_font: "Шрифт",
      search_fonts: "Поиск шрифтов…",
      tab_all: "Все",
      section_height: "Высота стежка",
      unit_px: "st",
      section_color: "Цвет нити",
      section_fabric: "Ткань",
      label_aida: "Аида",
      empty_state: "Введите текст, чтобы увидеть узор",
      loading_text: "Растеризация…",
      unit_cm: "см",
      unit_stitches: "стежков",
      unit_crosses: "крестов",
      toggle_controls: "Показать панель",
      no_fonts: "Нет доступных шрифтов",
      no_matching: "Шрифты не найдены",
      server_error: "Не удалось загрузить шрифты. Сервер запущен?",
      alert_no_text: "Введите текст и выберите шрифт.",
      alert_no_pdf: "PDF-движок не загружен. Перезагрузите страницу.",
      alert_no_jspdf: "Библиотека jsPDF не загружена. Проверьте подключение и перезагрузите.",
      alert_pdf_fail: "Ошибка генерации PDF: ",
      pdf_alert_no_text: "Пожалуйста, введите текст.",
      pdf_alert_no_font: "Шрифт не выбран.",
      pdf_alert_no_color: "Цвет не выбран.",
      pdf_alert_no_render: "Не удалось создать схему.",
      label_custom: "Свой",
      label_stitch_length: "Длина стежка",
      sheet_fabric: "Ткань и Стежок",
      sheet_info: "Информация",
      label_dmc: "DMC",
      label_thread: "Нить",
      label_language: "Язык",
      pdf_thread_legend: "Таблица ниток",
      pdf_pattern_info: "Информация о схеме",
      pdf_col_symbol: "Символ",
      pdf_col_swatch: "Образец",
      pdf_col_dmc_code: "Код DMC",
      pdf_col_color_name: "Цвет",
      pdf_col_stitches: "Стежки",
      pdf_col_thread: "Нить",
      pdf_col_skeins: "Мотки",
      pdf_note_strands: "Используйте 2 нити мулине DMC для крестиков",
      pdf_note_center: "Начинайте с центра ткани для лучшего результата",
      pdf_note_print: "\u26a0 Печатайте в масштабе 100% (без подгонки) для размера 1:1",
      pdf_finished_size: "Готовый размер",
      pdf_cut_fabric: "Размер ткани",
      pdf_cut_margin_imperial: '(+3" запас с каждой стороны)',
      pdf_cut_margin_metric: "(+7,6 см запас с каждой стороны)",
      pdf_orient_portrait: "Книжная",
      pdf_orient_landscape: "Альбомная",
      pdf_btn_download: "Скачать PDF",
      pdf_btn_print: "Печать",
      pdf_btn_download_preview: "Скачать предпросмотр (бесплатно)",
      pdf_btn_download_complete: "Скачать полную схему ✨",
      pdf_print_preview: "Предпросмотр",
      pdf_scale_verify: "Проверка: измерьте эту полоску линейкой. Должна быть ровно 10 мм.",
      pdf_info_finished_size: "Готовый размер",
      pdf_info_thread_required: "Нить требуется",
      pdf_info_fabric_aida: "Ткань: Aida",
      pdf_info_each_stitch: "Каждый стежок",
      pdf_info_pattern_size: "Размер схемы",
      pdf_info_total_crosses: "Всего крестиков",
      pdf_footer_tagline: "Генератор схем для вышивки крестом",
      pdf_unit_stitches: "стежков",
      pdf_unit_pages: "стр.",
      pdf_unit_crosses: "крестиков",
      pdf_unit_skein: "моток",
      pdf_unit_skeins: "мотков",
      pay_title: "Ваша схема готова к вышивке \u2728",
      pay_subtitle: "Получите список ниток, цветовые коды и PDF для печати \u2014 всё для начала вышивки.",
      pay_single_label: "Только эта",
      pay_single_desc: "Ваша схема за секунды",
      pay_badge_save: "Скидка 50%",
      pay_pack_label: "10 Схем",
      pay_pack_unit: "$0.99 за штуку",
      pay_pack_desc: "Идеально для подарков и проектов",
      pay_annual_label: "Весь год",
      pay_annual_unit: "всего $2.08/мес",
      pay_annual_desc: "Безлимитные схемы, весь год",
      pay_indie_note: "Word2Stitch создан с любовью одним человеком. Ваша поддержка помогает создавать новые шрифты и функции. \uD83D\uDC9C",
      pay_terms: 'Покупая, вы соглашаетесь с <a href="/terms" target="_blank" rel="noopener">Условиями использования</a>',
      pay_divider_key: "Уже есть ключ?",
      pay_key_placeholder: "Вставьте ключ схемы сюда",
      pay_key_submit: "Активировать \u2713",
      pay_credits_unlimited: "Безлимитно",
      pay_credits_remaining: "загрузок осталось",
      pay_title_success: "Оплата получена! \u2713",
      pay_subtitle_success: "Проверьте почту \u2014 ваш ключ уже в пути! Вставьте его ниже.",
      pay_email_hint: "\u041f\u0440\u043e\u0432\u0435\u0440\u044c\u0442\u0435 \u043f\u0438\u0441\u044c\u043c\u043e \u043e\u0442 Lemon Squeezy \u2014 \u0437\u0430\u0433\u043b\u044f\u043d\u0438\u0442\u0435 \u0438 \u0432 \u0441\u043f\u0430\u043c!",
      pay_key_error: "Недействительный или использованный ключ. Проверьте и попробуйте снова.",
      pay_title_activating: "Подготовка вашей схемы\u2026",
      pay_subtitle_activating: "Почти готово \u2014 одну секунду!",
      pay_trust: "\uD83D\uDD12 Безопасная оплата через Lemon Squeezy",
      pay_title_personalized: "Ваша схема \u00ab{text}\u00bb готова \u2728",
      pay_checkout_slow: "Занимает больше времени, чем ожидалось\u2026",
      pay_checkout_retry: "Попробовать снова",
      free_title: "Ваша первая схема — бесплатно!",
      free_subtitle: "Введите email, чтобы скачать полную схему — список ниток, цветовые коды и PDF для печати.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Скачать бесплатно \u2193",
      free_note: "Никакого спама. Только ваша схема.",
      free_email_error: "Пожалуйста, введите корректный email",
      upsell_title: "Схема скачана!",
      upsell_subtitle: "Понравилось? Возьмите 10 схем и сэкономьте 50%",
      upsell_deal: "10 схем за $9.99 — это всего $0.99 за штуку!",
      upsell_btn: "Перейти на 10 Схем — $9.99",
      upsell_skip: "Нет, спасибо",
      mobile_preview_title: "Ваш полный набор схем",
      mobile_preview_items: "Сетка \u00b7 Таблица ниток \u00b7 Цветовые коды \u00b7 Размеры"
    },
    pl: {
      placeholder_text: "Wpisz swój tekst…",
      section_font: "Czcionka",
      search_fonts: "Szukaj czcionek…",
      tab_all: "Wszystkie",
      section_height: "Wysokość Ściegu",
      unit_px: "st",
      section_color: "Kolor Nici",
      section_fabric: "Tkanina",
      label_aida: "Aida",
      empty_state: "Wpisz coś, aby zobaczyć wzór",
      loading_text: "Rasteryzacja…",
      unit_cm: "cm",
      unit_stitches: "ściegów",
      unit_crosses: "krzyżyków",
      toggle_controls: "Pokaż panel",
      no_fonts: "Brak dostępnych czcionek",
      no_matching: "Nie znaleziono czcionek",
      server_error: "Nie udało się załadować czcionek. Czy serwer działa?",
      alert_no_text: "Wpisz tekst i wybierz czcionkę.",
      alert_no_pdf: "Silnik PDF nie załadowany. Odśwież stronę.",
      alert_no_jspdf: "Biblioteka jsPDF nie załadowana. Sprawdź połączenie i odśwież.",
      alert_pdf_fail: "Błąd generowania PDF: ",
      pdf_alert_no_text: "Proszę wpisać tekst.",
      pdf_alert_no_font: "Nie wybrano czcionki.",
      pdf_alert_no_color: "Nie wybrano koloru.",
      pdf_alert_no_render: "Nie udało się wygenerować wzoru.",
      label_custom: "Własny",
      label_stitch_length: "Długość ściegu",
      sheet_fabric: "Tkanina i Ścieg",
      sheet_info: "Info Wzoru",
      label_dmc: "DMC",
      label_thread: "Nici",
      label_language: "Język",
      pdf_thread_legend: "Legenda nici",
      pdf_pattern_info: "Informacje o wzorze",
      pdf_col_symbol: "Symbol",
      pdf_col_swatch: "Próbka",
      pdf_col_dmc_code: "Kod DMC",
      pdf_col_color_name: "Kolor",
      pdf_col_stitches: "Ściegi",
      pdf_col_thread: "Nici",
      pdf_col_skeins: "Motki",
      pdf_note_strands: "Użyj 2 nitek mulin DMC do krzyżyków",
      pdf_note_center: "Zacznij od środka tkaniny dla najlepszych rezultatów",
      pdf_note_print: "\u26a0 Drukuj w skali 100% (bez dopasowania) dla rozmiaru 1:1",
      pdf_finished_size: "Gotowy rozmiar",
      pdf_cut_fabric: "Rozmiar tkaniny",
      pdf_cut_margin_imperial: '(+3" marginesu z każdej strony)',
      pdf_cut_margin_metric: "(+7,6 cm marginesu z każdej strony)",
      pdf_orient_portrait: "Pionowo",
      pdf_orient_landscape: "Poziomo",
      pdf_btn_download: "Pobierz PDF",
      pdf_btn_print: "Drukuj",
      pdf_btn_download_preview: "Pobierz podgląd (bezpłatnie)",
      pdf_btn_download_complete: "Pobierz pełny wzór ✨",
      pdf_print_preview: "Podgląd wydruku",
      pdf_scale_verify: "Sprawdź: zmierz tę belkę linijką. Musi mieć dokładnie 10 mm.",
      pdf_info_finished_size: "Gotowy rozmiar",
      pdf_info_thread_required: "Potrzebna nić",
      pdf_info_fabric_aida: "Tkanina: Aida",
      pdf_info_each_stitch: "Każdy ścieg",
      pdf_info_pattern_size: "Rozmiar wzoru",
      pdf_info_total_crosses: "Łącznie krzyżyków",
      pdf_footer_tagline: "Generator Wzorów Krzyżykowych",
      pdf_unit_stitches: "ściegów",
      pdf_unit_pages: "stron",
      pdf_unit_crosses: "krzyżyków",
      pdf_unit_skein: "motek",
      pdf_unit_skeins: "motków",
      pay_title: "Twój wzór jest gotowy do haftowania \u2728",
      pay_subtitle: "Otrzymaj listę nici, kody kolorów i PDF do druku \u2014 wszystko, czego potrzebujesz.",
      pay_single_label: "Tylko ten",
      pay_single_desc: "Twój wzór w kilka sekund",
      pay_badge_save: "Oszczędź 50%",
      pay_pack_label: "10 Wzorów",
      pay_pack_unit: "$0.99 za sztukę",
      pay_pack_desc: "Idealny na prezenty i projekty",
      pay_annual_label: "Cały rok",
      pay_annual_unit: "tylko $2.08/mies.",
      pay_annual_desc: "Nieograniczone wzory, cały rok",
      pay_indie_note: "Word2Stitch jest tworzony z miłością przez jedną osobę. Twoje wsparcie pomaga tworzyć nowe czcionki i funkcje. \uD83D\uDC9C",
      pay_terms: 'Kupując, zgadzasz się z naszymi <a href="/terms" target="_blank" rel="noopener">Warunkami usługi</a>',
      pay_divider_key: "Masz już klucz?",
      pay_key_placeholder: "Wklej swój klucz wzoru tutaj",
      pay_key_submit: "Aktywuj \u2713",
      pay_credits_unlimited: "Bez limitu",
      pay_credits_remaining: "pobrań pozostało",
      pay_title_success: "Płatność otrzymana! \u2713",
      pay_subtitle_success: "Sprawdź skrzynkę \u2014 klucz jest w drodze! Wklej go poniżej.",
      pay_email_hint: "Sprawd\u017a email od Lemon Squeezy \u2014 zajrzyj te\u017c do spamu!",
      pay_key_error: "Nieprawidłowy lub wyczerpany klucz. Sprawdź i spróbuj ponownie.",
      pay_title_activating: "Przygotowywanie wzoru\u2026",
      pay_subtitle_activating: "Prawie gotowe \u2014 chwileczkę!",
      pay_trust: "\uD83D\uDD12 Bezpieczna płatność przez Lemon Squeezy",
      pay_title_personalized: "Twój wzór \u201e{text}\u201d jest gotowy \u2728",
      pay_checkout_slow: "Trwa dłużej niż oczekiwano\u2026",
      pay_checkout_retry: "Spróbuj ponownie",
      free_title: "Twój pierwszy wzór jest za darmo!",
      free_subtitle: "Wpisz swój email, aby pobrać kompletny wzór — lista nici, kody kolorów i PDF gotowy do druku.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Pobierz za darmo \u2193",
      free_note: "Żadnego spamu, nigdy. Tylko Twój wzór.",
      free_email_error: "Wpisz prawidłowy adres email",
      upsell_title: "Wzór pobrany!",
      upsell_subtitle: "Podoba się? Zdobądź 10 wzorów i zaoszczędź 50%",
      upsell_deal: "10 wzorów za $9.99 — to tylko $0.99 za sztukę!",
      upsell_btn: "Przejdź na 10 Wzorów — $9.99",
      upsell_skip: "Nie, dziękuję",
      mobile_preview_title: "Twój kompletny pakiet wzorów",
      mobile_preview_items: "Siatka \u00b7 Legenda nici \u00b7 Kody kolorów \u00b7 Wymiary"
    },
    sv: {
      placeholder_text: "Skriv din text här…",
      section_font: "Typsnitt",
      search_fonts: "Sök typsnitt…",
      tab_all: "Alla",
      section_height: "Stygnh\u00f6jd",
      unit_px: "st",
      section_color: "Trådfärg",
      section_fabric: "Tyg",
      label_aida: "Aida",
      empty_state: "Skriv något för att se ditt mönster",
      loading_text: "Rastrerar…",
      unit_cm: "cm",
      unit_stitches: "stygn",
      unit_crosses: "kors",
      toggle_controls: "Visa kontroller",
      no_fonts: "Inga typsnitt tillgängliga",
      no_matching: "Inga matchande typsnitt",
      server_error: "Kunde inte ladda typsnitt. Körs servern?",
      alert_no_text: "Skriv text och välj ett typsnitt först.",
      alert_no_pdf: "PDF-motor inte laddad. Ladda om sidan.",
      alert_no_jspdf: "jsPDF inte laddat. Kontrollera din anslutning och ladda om.",
      alert_pdf_fail: "PDF-generering misslyckades: ",
      pdf_alert_no_text: "Ange en text.",
      pdf_alert_no_font: "Inget typsnitt valt.",
      pdf_alert_no_color: "Ingen färg vald.",
      pdf_alert_no_render: "Kunde inte generera mönstret.",
      label_custom: "Anpassad",
      label_stitch_length: "Stygnlängd",
      sheet_fabric: "Tyg och Stygn",
      sheet_info: "Mönsterinfo",
      label_dmc: "DMC",
      label_thread: "Tråd",
      label_language: "Språk",
      pdf_thread_legend: "Trådguide",
      pdf_pattern_info: "Mönsterinformation",
      pdf_col_symbol: "Symbol",
      pdf_col_swatch: "Prov",
      pdf_col_dmc_code: "DMC-kod",
      pdf_col_color_name: "Färg",
      pdf_col_stitches: "Stygn",
      pdf_col_thread: "Tråd",
      pdf_col_skeins: "Dockor",
      pdf_note_strands: "Använd 2 trådar DMC-garn för korsstygn",
      pdf_note_center: "Börja från mitten av tyget för bästa resultat",
      pdf_note_print: "\u26a0 Skriv ut i 100% (inte anpassa till sida) för 1:1 stygnstorlek",
      pdf_finished_size: "Färdig storlek",
      pdf_cut_fabric: "Klipp Tyg",
      pdf_cut_margin_imperial: '(+3" marginal på varje sida)',
      pdf_cut_margin_metric: "(+7,6 cm marginal på varje sida)",
      pdf_orient_portrait: "Stående",
      pdf_orient_landscape: "Liggande",
      pdf_btn_download: "Ladda ner PDF",
      pdf_btn_print: "Skriv ut",
      pdf_btn_download_preview: "Ladda ner förhandsgranskning (gratis)",
      pdf_btn_download_complete: "Ladda ner komplett mönster ✨",
      pdf_print_preview: "Förhandsgranskning",
      pdf_scale_verify: "Verifiera: mät denna stapel med en linjal. Måste vara exakt 10 mm.",
      pdf_info_finished_size: "Färdig storlek",
      pdf_info_thread_required: "Tråd som behövs",
      pdf_info_fabric_aida: "Tyg: Aida",
      pdf_info_each_stitch: "Varje stygn",
      pdf_info_pattern_size: "Mönsterstorlek",
      pdf_info_total_crosses: "Totalt korsstygn",
      pdf_footer_tagline: "Korsstygnsmönstergenerator",
      pdf_unit_stitches: "stygn",
      pdf_unit_pages: "sidor",
      pdf_unit_crosses: "kors",
      pdf_unit_skein: "docka",
      pdf_unit_skeins: "dockor",
      pay_title: "Ditt mönster är redo att brodera \u2728",
      pay_subtitle: "Få din trådlista, färgkoder och utskriftsklar PDF \u2014 allt du behöver för att börja.",
      pay_single_label: "Bara denna",
      pay_single_desc: "Ditt mönster på sekunder",
      pay_badge_save: "Spara 50%",
      pay_pack_label: "10 Mönster",
      pay_pack_unit: "$0.99 styck",
      pay_pack_desc: "Perfekt för presenter och projekt",
      pay_annual_label: "Hela året",
      pay_annual_unit: "bara $2.08/mån",
      pay_annual_desc: "Obegränsade mönster, hela året",
      pay_indie_note: "Word2Stitch är gjort med kärlek av en person. Ditt stöd hjälper till att bygga nya typsnitt och funktioner. \uD83D\uDC9C",
      pay_terms: 'Genom att köpa godkänner du våra <a href="/terms" target="_blank" rel="noopener">Användarvillkor</a>',
      pay_divider_key: "Har du redan en nyckel?",
      pay_key_placeholder: "Klistra in din mönsternyckel här",
      pay_key_submit: "Aktivera \u2713",
      pay_credits_unlimited: "Obegränsat",
      pay_credits_remaining: "nedladdningar kvar",
      pay_title_success: "Betalning mottagen! \u2713",
      pay_subtitle_success: "Kolla din inkorg \u2014 din nyckel är på väg! Klistra in den nedan.",
      pay_email_hint: "Kolla din e-post fr\u00e5n Lemon Squeezy \u2014 kolla \u00e4ven skr\u00e4pposten!",
      pay_key_error: "Ogiltig eller förbrukad nyckel. Kontrollera och försök igen.",
      pay_title_activating: "Förbereder ditt mönster\u2026",
      pay_subtitle_activating: "Nästan klart \u2014 ett ögonblick!",
      pay_trust: "\uD83D\uDD12 Säker betalning via Lemon Squeezy",
      pay_title_personalized: "Ditt \u201c{text}\u201d-mönster är klart \u2728",
      pay_checkout_slow: "Tar längre tid än väntat\u2026",
      pay_checkout_retry: "Försök igen",
      free_title: "Ditt första mönster är gratis!",
      free_subtitle: "Ange din e-post för att ladda ner ditt kompletta mönster — trådlista, färgkoder och utskriftsklar PDF.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Ladda ner gratis \u2193",
      free_note: "Ingen spam, aldrig. Bara ditt mönster.",
      free_email_error: "Ange en giltig e-postadress",
      upsell_title: "Mönster nedladdat!",
      upsell_subtitle: "Gillar du det? Få 10 mönster och spara 50%",
      upsell_deal: "10 mönster för $9.99 — det är bara $0.99 styck!",
      upsell_btn: "Uppgradera till 10 Mönster — $9.99",
      upsell_skip: "Nej tack",
      mobile_preview_title: "Ditt kompletta mönsterpaket",
      mobile_preview_items: "Rutnät \u00b7 Trådguide \u00b7 Färgkoder \u00b7 Mått"
    },
    da: {
      placeholder_text: "Skriv din tekst her…",
      section_font: "Skrifttype",
      search_fonts: "Søg skrifttyper…",
      tab_all: "Alle",
      section_height: "Stinghøjde",
      unit_px: "st",
      section_color: "Trådfarve",
      section_fabric: "Stof",
      label_aida: "Aida",
      empty_state: "Skriv noget for at se dit mønster",
      loading_text: "Rastrerer…",
      unit_cm: "cm",
      unit_stitches: "sting",
      unit_crosses: "kors",
      toggle_controls: "Vis kontroller",
      no_fonts: "Ingen skrifttyper tilgængelige",
      no_matching: "Ingen matchende skrifttyper",
      server_error: "Kunne ikke indlæse skrifttyper. Kører serveren?",
      alert_no_text: "Skriv tekst og vælg en skrifttype først.",
      alert_no_pdf: "PDF-motor ikke indlæst. Genindlæs siden.",
      alert_no_jspdf: "jsPDF ikke indlæst. Kontrollér din forbindelse og genindlæs.",
      alert_pdf_fail: "PDF-generering mislykkedes: ",
      pdf_alert_no_text: "Indtast venligst en tekst.",
      pdf_alert_no_font: "Ingen skrifttype valgt.",
      pdf_alert_no_color: "Ingen farve valgt.",
      pdf_alert_no_render: "Kunne ikke generere mønstret.",
      label_custom: "Brugerdefineret",
      label_stitch_length: "Stinglængde",
      sheet_fabric: "Stof og Sting",
      sheet_info: "Mønsterinfo",
      label_dmc: "DMC",
      label_thread: "Tråd",
      label_language: "Sprog",
      pdf_thread_legend: "Trådoversigt",
      pdf_pattern_info: "Mønsterinformation",
      pdf_col_symbol: "Symbol",
      pdf_col_swatch: "Prøve",
      pdf_col_dmc_code: "DMC-kode",
      pdf_col_color_name: "Farve",
      pdf_col_stitches: "Sting",
      pdf_col_thread: "Tråd",
      pdf_col_skeins: "Nøgler",
      pdf_note_strands: "Brug 2 tråde DMC-garn til korssting",
      pdf_note_center: "Start fra midten af stoffet for bedste resultat",
      pdf_note_print: "\u26a0 Udskriv i 100% (ikke tilpas til side) for 1:1 stingstørrelse",
      pdf_finished_size: "Færdig størrelse",
      pdf_cut_fabric: "Klip Stof",
      pdf_cut_margin_imperial: '(+3" margen på hver side)',
      pdf_cut_margin_metric: "(+7,6 cm margen på hver side)",
      pdf_orient_portrait: "Stående",
      pdf_orient_landscape: "Liggende",
      pdf_btn_download: "Download PDF",
      pdf_btn_print: "Udskriv",
      pdf_btn_download_preview: "Download forhåndsvisning (gratis)",
      pdf_btn_download_complete: "Download fuldt mønster ✨",
      pdf_print_preview: "Forhåndsvisning",
      pdf_scale_verify: "Verificér: mål denne bjælke med en lineal. Skal være præcis 10 mm.",
      pdf_info_finished_size: "Færdig størrelse",
      pdf_info_thread_required: "Tråd nødvendig",
      pdf_info_fabric_aida: "Stof: Aida",
      pdf_info_each_stitch: "Hvert sting",
      pdf_info_pattern_size: "Mønsterstørrelse",
      pdf_info_total_crosses: "Korssting i alt",
      pdf_footer_tagline: "Korsstingsmønstergenerator",
      pdf_unit_stitches: "sting",
      pdf_unit_pages: "sider",
      pdf_unit_crosses: "kors",
      pdf_unit_skein: "nøgle",
      pdf_unit_skeins: "nøgler",
      pay_title: "Dit mønster er klar til at brodere \u2728",
      pay_subtitle: "Få din trådliste, farvekoder og printklart PDF \u2014 alt hvad du skal bruge.",
      pay_single_label: "Kun denne",
      pay_single_desc: "Dit mønster på sekunder",
      pay_badge_save: "Spar 50%",
      pay_pack_label: "10 Mønstre",
      pay_pack_unit: "$0.99 stk.",
      pay_pack_desc: "Perfekt til gaver og projekter",
      pay_annual_label: "Hele året",
      pay_annual_unit: "kun $2.08/md.",
      pay_annual_desc: "Ubegrænsede mønstre, hele året",
      pay_indie_note: "Word2Stitch er lavet med kærlighed af én person. Din støtte hjælper med at bygge nye skrifttyper og funktioner. \uD83D\uDC9C",
      pay_terms: 'Ved at købe accepterer du vores <a href="/terms" target="_blank" rel="noopener">Servicevilkår</a>',
      pay_divider_key: "Har du allerede en nøgle?",
      pay_key_placeholder: "Indsæt din mønsternøgle her",
      pay_key_submit: "Aktivér \u2713",
      pay_credits_unlimited: "Ubegrænset",
      pay_credits_remaining: "downloads tilbage",
      pay_title_success: "Betaling modtaget! \u2713",
      pay_subtitle_success: "Tjek din indbakke \u2014 din nøgle er på vej! Indsæt den nedenfor.",
      pay_email_hint: "Tjek din e-mail fra Lemon Squeezy \u2014 kig ogs\u00e5 i spam!",
      pay_key_error: "Ugyldig eller opbrugt nøgle. Kontrollér og prøv igen.",
      pay_title_activating: "Forbereder dit mønster\u2026",
      pay_subtitle_activating: "Næsten klar \u2014 et øjeblik!",
      pay_trust: "\uD83D\uDD12 Sikker betaling via Lemon Squeezy",
      pay_title_personalized: "Dit '{text}'-mønster er klar \u2728",
      pay_checkout_slow: "Tager længere tid end forventet\u2026",
      pay_checkout_retry: "Prøv igen",
      free_title: "Dit første mønster er gratis!",
      free_subtitle: "Indtast din email for at downloade dit komplette mønster — trådliste, farvekoder og printklart PDF.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Download gratis \u2193",
      free_note: "Ingen spam, aldrig. Kun dit mønster.",
      free_email_error: "Indtast venligst en gyldig email",
      upsell_title: "Mønster downloadet!",
      upsell_subtitle: "Kan du lide det? Få 10 mønstre og spar 50%",
      upsell_deal: "10 mønstre for $9.99 — det er kun $0.99 stk.!",
      upsell_btn: "Opgrader til 10 Mønstre — $9.99",
      upsell_skip: "Nej tak",
      mobile_preview_title: "Din komplette mønsterpakke",
      mobile_preview_items: "Gitter \u00b7 Trådoversigt \u00b7 Farvekoder \u00b7 Mål"
    },
    fi: {
      placeholder_text: "Kirjoita tekstisi tähän…",
      section_font: "Fontti",
      search_fonts: "Etsi fontteja…",
      tab_all: "Kaikki",
      section_height: "Pistonkorkeus",
      unit_px: "st",
      section_color: "Langan Väri",
      section_fabric: "Kangas",
      label_aida: "Aida",
      empty_state: "Kirjoita jotain nähdäksesi kuviosi",
      loading_text: "Rasteroidaan…",
      unit_cm: "cm",
      unit_stitches: "pistoa",
      unit_crosses: "ristiä",
      toggle_controls: "Näytä ohjaimet",
      no_fonts: "Ei fontteja saatavilla",
      no_matching: "Ei vastaavia fontteja",
      server_error: "Fonttien lataus epäonnistui. Onko palvelin käynnissä?",
      alert_no_text: "Kirjoita teksti ja valitse fontti ensin.",
      alert_no_pdf: "PDF-moottori ei latautunut. Lataa sivu uudelleen.",
      alert_no_jspdf: "jsPDF ei latautunut. Tarkista yhteys ja lataa uudelleen.",
      alert_pdf_fail: "PDF:n luonti epäonnistui: ",
      pdf_alert_no_text: "Kirjoita teksti.",
      pdf_alert_no_font: "Fonttia ei valittu.",
      pdf_alert_no_color: "Väriä ei valittu.",
      pdf_alert_no_render: "Kuviota ei voitu luoda.",
      label_custom: "Mukautettu",
      label_stitch_length: "Pistonpituus",
      sheet_fabric: "Kangas ja Pisto",
      sheet_info: "Kuviotiedot",
      label_dmc: "DMC",
      label_thread: "Lanka",
      label_language: "Kieli",
      pdf_thread_legend: "Lankaopas",
      pdf_pattern_info: "Kuviotiedot",
      pdf_col_symbol: "Symboli",
      pdf_col_swatch: "Näyte",
      pdf_col_dmc_code: "DMC-koodi",
      pdf_col_color_name: "Väri",
      pdf_col_stitches: "Pistot",
      pdf_col_thread: "Lanka",
      pdf_col_skeins: "Vyyhdit",
      pdf_note_strands: "Käytä 2 säiettä DMC-lankaa ristipistoon",
      pdf_note_center: "Aloita kankaan keskeltä parhaan tuloksen saavuttamiseksi",
      pdf_note_print: "\u26a0 Tulosta 100% koossa (ei sovita sivulle) 1:1 pistokokoon saamiseksi",
      pdf_finished_size: "Valmis koko",
      pdf_cut_fabric: "Leikkaa Kangas",
      pdf_cut_margin_imperial: '(+3" marginaali joka puolella)',
      pdf_cut_margin_metric: "(+7,6 cm marginaali joka puolella)",
      pdf_orient_portrait: "Pysty",
      pdf_orient_landscape: "Vaaka",
      pdf_btn_download: "Lataa PDF",
      pdf_btn_print: "Tulosta",
      pdf_btn_download_preview: "Lataa esikatselu (ilmainen)",
      pdf_btn_download_complete: "Lataa täydellinen kuvio ✨",
      pdf_print_preview: "Esikatselu",
      pdf_scale_verify: "Tarkista: mittaa tämä palkki viivaimella. Sen on oltava tarkalleen 10 mm.",
      pdf_info_finished_size: "Valmis koko",
      pdf_info_thread_required: "Lankaa tarvitaan",
      pdf_info_fabric_aida: "Kangas: Aida",
      pdf_info_each_stitch: "Jokainen pisto",
      pdf_info_pattern_size: "Kuvion koko",
      pdf_info_total_crosses: "Ristipistoja yhteensä",
      pdf_footer_tagline: "Ristipistokaavageneraattori",
      pdf_unit_stitches: "pistoa",
      pdf_unit_pages: "sivua",
      pdf_unit_crosses: "ristiä",
      pdf_unit_skein: "vyyhti",
      pdf_unit_skeins: "vyyhtiä",
      pay_title: "Kuviosi on valmis ristipistoon \u2728",
      pay_subtitle: "Saat lankalistan, värikoodit ja tulostus-PDF:n \u2014 kaiken mitä tarvitset.",
      pay_single_label: "Vain tämä",
      pay_single_desc: "Kuviosi sekunneissa",
      pay_badge_save: "Säästä 50%",
      pay_pack_label: "10 Kuviota",
      pay_pack_unit: "$0.99 kpl",
      pay_pack_desc: "Täydellinen lahjoihin ja projekteihin",
      pay_annual_label: "Koko vuosi",
      pay_annual_unit: "vain $2.08/kk",
      pay_annual_desc: "Rajattomat kuviot, koko vuoden",
      pay_indie_note: "Word2Stitch on tehty rakkaudella yhden henkilön voimin. Tukesi auttaa luomaan uusia fontteja ja ominaisuuksia. \uD83D\uDC9C",
      pay_terms: 'Ostamalla hyväksyt <a href="/terms" target="_blank" rel="noopener">Käyttöehdot</a>',
      pay_divider_key: "Onko sinulla jo avain?",
      pay_key_placeholder: "Liitä kuvioavaimesi tähän",
      pay_key_submit: "Aktivoi \u2713",
      pay_credits_unlimited: "Rajoittamaton",
      pay_credits_remaining: "latausta jäljellä",
      pay_title_success: "Maksu vastaanotettu! \u2713",
      pay_subtitle_success: "Tarkista sähköpostisi \u2014 avaimesi on matkalla! Liitä se alle.",
      pay_email_hint: "Tarkista Lemon Squeezyn lähettämä sähköposti \u2014 katso myös roskapostista!",
      pay_key_error: "Virheellinen tai käytetty avain. Tarkista ja yritä uudelleen.",
      pay_title_activating: "Valmistellaan kuviotasi\u2026",
      pay_subtitle_activating: "Melkein valmis \u2014 hetkinen!",
      pay_trust: "\uD83D\uDD12 Turvallinen maksu Lemon Squeezyn kautta",
      pay_title_personalized: "'{text}'-kuviosi on valmis \u2728",
      pay_checkout_slow: "Kestää odotettua kauemmin\u2026",
      pay_checkout_retry: "Yritä uudelleen",
      free_title: "Ensimmäinen kuviosi on ilmainen!",
      free_subtitle: "Syötä sähköpostisi ja lataa täydellinen kuvio — lankalista, värikoodit ja tulostus-PDF.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Lataa ilmaiseksi \u2193",
      free_note: "Ei roskapostia, koskaan. Vain kuviosi.",
      free_email_error: "Syötä kelvollinen sähköpostiosoite",
      upsell_title: "Kuvio ladattu!",
      upsell_subtitle: "Pitikö? Hanki 10 kuviota ja säästä 50%",
      upsell_deal: "10 kuviota hintaan $9.99 — vain $0.99 kappale!",
      upsell_btn: "Päivitä 10 Kuvioon — $9.99",
      upsell_skip: "Ei kiitos",
      mobile_preview_title: "Täydellinen kuviopakettisi",
      mobile_preview_items: "Ruudukko \u00b7 Lankaopas \u00b7 Värikoodit \u00b7 Mitat"
    },
    uk: {
      placeholder_text: "Введіть текст…",
      section_font: "Шрифт",
      search_fonts: "Пошук шрифтів…",
      tab_all: "Усі",
      section_height: "Висота стібка",
      unit_px: "st",
      section_color: "Колір нитки",
      section_fabric: "Тканина",
      label_aida: "Аїда",
      empty_state: "Введіть текст, щоб побачити візерунок",
      loading_text: "Растеризація…",
      unit_cm: "см",
      unit_stitches: "стібків",
      unit_crosses: "хрестиків",
      toggle_controls: "Показати панель",
      no_fonts: "Немає доступних шрифтів",
      no_matching: "Шрифти не знайдено",
      server_error: "Не вдалося завантажити шрифти. Сервер запущено?",
      alert_no_text: "Введіть текст і виберіть шрифт.",
      alert_no_pdf: "PDF-рушій не завантажено. Перезавантажте сторінку.",
      alert_no_jspdf: "Бібліотеку jsPDF не завантажено. Перевірте з'єднання і перезавантажте.",
      alert_pdf_fail: "Помилка генерації PDF: ",
      pdf_alert_no_text: "Будь ласка, введіть текст.",
      pdf_alert_no_font: "Шрифт не обрано.",
      pdf_alert_no_color: "Колір не обрано.",
      pdf_alert_no_render: "Не вдалося створити схему.",
      label_custom: "Власний",
      label_stitch_length: "Довжина стібка",
      sheet_fabric: "Тканина і Стібок",
      sheet_info: "Інформація",
      label_dmc: "DMC",
      label_thread: "Нитка",
      label_language: "Мова",
      pdf_thread_legend: "Таблиця ниток",
      pdf_pattern_info: "Інформація про схему",
      pdf_col_symbol: "Символ",
      pdf_col_swatch: "Зразок",
      pdf_col_dmc_code: "Код DMC",
      pdf_col_color_name: "Колір",
      pdf_col_stitches: "Стібки",
      pdf_col_thread: "Нитка",
      pdf_col_skeins: "Мотки",
      pdf_note_strands: "Використовуйте 2 нитки муліне DMC для хрестиків",
      pdf_note_center: "Починайте з центру тканини для кращого результату",
      pdf_note_print: "\u26a0 Друкуйте в масштабі 100% (без підгонки) для розміру 1:1",
      pdf_finished_size: "Готовий розмір",
      pdf_cut_fabric: "Розмір тканини",
      pdf_cut_margin_imperial: '(+3" запас з кожного боку)',
      pdf_cut_margin_metric: "(+7,6 см запас з кожного боку)",
      pdf_orient_portrait: "Книжкова",
      pdf_orient_landscape: "Альбомна",
      pdf_btn_download: "Завантажити PDF",
      pdf_btn_print: "Друк",
      pdf_btn_download_preview: "Завантажити попередній перегляд (безкоштовно)",
      pdf_btn_download_complete: "Завантажити повну схему ✨",
      pdf_print_preview: "Попередній перегляд",
      pdf_scale_verify: "Перевірка: виміряйте цю смужку лінійкою. Має бути рівно 10 мм.",
      pdf_info_finished_size: "Готовий розмір",
      pdf_info_thread_required: "Потрібна нитка",
      pdf_info_fabric_aida: "Тканина: Aida",
      pdf_info_each_stitch: "Кожен стібок",
      pdf_info_pattern_size: "Розмір схеми",
      pdf_info_total_crosses: "Всього хрестиків",
      pdf_footer_tagline: "Генератор схем для вишивки хрестиком",
      pdf_unit_stitches: "стібків",
      pdf_unit_pages: "стор.",
      pdf_unit_crosses: "хрестиків",
      pdf_unit_skein: "моток",
      pdf_unit_skeins: "мотків",
      pay_title: "Ваша схема готова до вишивки \u2728",
      pay_subtitle: "Отримайте список ниток, кольорові коди та PDF для друку \u2014 все для початку вишивки.",
      pay_single_label: "Лише ця",
      pay_single_desc: "Ваша схема за кілька секунд",
      pay_badge_save: "Знижка 50%",
      pay_pack_label: "10 Схем",
      pay_pack_unit: "$0.99 за штуку",
      pay_pack_desc: "Ідеально для подарунків та проєктів",
      pay_annual_label: "Весь рік",
      pay_annual_unit: "лише $2.08/міс",
      pay_annual_desc: "Безлімітні схеми, цілий рік",
      pay_indie_note: "Word2Stitch створено з любов'ю однією людиною. Ваша підтримка допомагає створювати нові шрифти та функції. \uD83D\uDC9C",
      pay_terms: 'Купуючи, ви погоджуєтесь з <a href="/terms" target="_blank" rel="noopener">Умовами використання</a>',
      pay_divider_key: "Вже маєте ключ?",
      pay_key_placeholder: "Вставте ключ схеми сюди",
      pay_key_submit: "Активувати \u2713",
      pay_credits_unlimited: "Безлімітно",
      pay_credits_remaining: "завантажень залишилось",
      pay_title_success: "Оплату отримано! \u2713",
      pay_subtitle_success: "Перевірте пошту \u2014 ваш ключ вже в дорозі! Вставте його нижче.",
      pay_email_hint: "Перевірте лист від Lemon Squeezy \u2014 загляньте і в спам!",
      pay_key_error: "Недійсний або використаний ключ. Перевірте та спробуйте знову.",
      pay_title_activating: "Підготовка вашої схеми\u2026",
      pay_subtitle_activating: "Майже готово \u2014 одну мить!",
      pay_trust: "\uD83D\uDD12 Безпечна оплата через Lemon Squeezy",
      pay_title_personalized: "Ваша схема \u00ab{text}\u00bb готова \u2728",
      pay_checkout_slow: "Займає більше часу, ніж очікувалось\u2026",
      pay_checkout_retry: "Спробувати знову",
      free_title: "Ваша перша схема — безкоштовно!",
      free_subtitle: "Введіть email, щоб завантажити повну схему — список ниток, кольорові коди та PDF для друку.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Завантажити безкоштовно \u2193",
      free_note: "Жодного спаму, ніколи. Тільки ваша схема.",
      free_email_error: "Будь ласка, введіть дійсний email",
      upsell_title: "Схему завантажено!",
      upsell_subtitle: "Сподобалось? Отримайте 10 схем і заощадьте 50%",
      upsell_deal: "10 схем за $9.99 — лише $0.99 за штуку!",
      upsell_btn: "Перейти на 10 Схем — $9.99",
      upsell_skip: "Ні, дякую",
      mobile_preview_title: "Ваш повний набір схем",
      mobile_preview_items: "Сітка \u00b7 Таблиця ниток \u00b7 Кольорові коди \u00b7 Розміри"
    },
    hu: {
      placeholder_text: "Írd be a szöveged…",
      section_font: "Betűtípus",
      search_fonts: "Betűtípusok keresése…",
      tab_all: "Összes",
      section_height: "Öltésmagasság",
      unit_px: "st",
      section_color: "Fonalszín",
      section_fabric: "Szövet",
      label_aida: "Aida",
      empty_state: "Írj valamit a minta megtekintéséhez",
      loading_text: "Raszterizálás…",
      unit_cm: "cm",
      unit_stitches: "öltés",
      unit_crosses: "kereszt",
      toggle_controls: "Vezérlők mutatása",
      no_fonts: "Nincs elérhető betűtípus",
      no_matching: "Nincs egyező betűtípus",
      server_error: "Betűtípusok betöltése sikertelen. Fut a szerver?",
      alert_no_text: "Írj szöveget és válassz betűtípust.",
      alert_no_pdf: "PDF-motor nincs betöltve. Töltsd újra az oldalt.",
      alert_no_jspdf: "jsPDF nincs betöltve. Ellenőrizd a kapcsolatot és töltsd újra.",
      alert_pdf_fail: "PDF létrehozás sikertelen: ",
      pdf_alert_no_text: "Kérjük, írjon be szöveget.",
      pdf_alert_no_font: "Nincs betűtípus kiválasztva.",
      pdf_alert_no_color: "Nincs szín kiválasztva.",
      pdf_alert_no_render: "A minta nem hozható létre.",
      label_custom: "Egyéni",
      label_stitch_length: "Öltéshossz",
      sheet_fabric: "Szövet és Öltés",
      sheet_info: "Minta Info",
      label_dmc: "DMC",
      label_thread: "Fonal",
      label_language: "Nyelv",
      pdf_thread_legend: "Fonalútmutató",
      pdf_pattern_info: "Minta Információ",
      pdf_col_symbol: "Szimbólum",
      pdf_col_swatch: "Minta",
      pdf_col_dmc_code: "DMC kód",
      pdf_col_color_name: "Szín",
      pdf_col_stitches: "Öltések",
      pdf_col_thread: "Fonal",
      pdf_col_skeins: "Pászmák",
      pdf_note_strands: "Használjon 2 szál DMC fonalat a keresztszemes öltésekhez",
      pdf_note_center: "A legjobb eredményért a szövet közepéről induljon",
      pdf_note_print: "\u26a0 100%-os méretben nyomtasson (ne illeszsze oldalhoz) az 1:1 öltésméretért",
      pdf_finished_size: "Kész méret",
      pdf_cut_fabric: "Szövet Vágás",
      pdf_cut_margin_imperial: '(+3" margó minden oldalon)',
      pdf_cut_margin_metric: "(+7,6 cm margó minden oldalon)",
      pdf_orient_portrait: "Álló",
      pdf_orient_landscape: "Fekvő",
      pdf_btn_download: "PDF Letöltés",
      pdf_btn_print: "Nyomtatás",
      pdf_btn_download_preview: "Előnézet letöltése (ingyenes)",
      pdf_btn_download_complete: "Teljes minta letöltése ✨",
      pdf_print_preview: "Nyomtatási előnézet",
      pdf_scale_verify: "Ellenőrizze: mérje meg ezt a csíkot vonalzóval. Pontosan 10 mm-nek kell lennie.",
      pdf_info_finished_size: "Kész méret",
      pdf_info_thread_required: "Szükséges fonal",
      pdf_info_fabric_aida: "Szövet: Aida",
      pdf_info_each_stitch: "Minden öltés",
      pdf_info_pattern_size: "Minta mérete",
      pdf_info_total_crosses: "Összes keresztöltés",
      pdf_footer_tagline: "Keresztszemes Mintakészítő",
      pdf_unit_stitches: "öltés",
      pdf_unit_pages: "oldal",
      pdf_unit_crosses: "kereszt",
      pdf_unit_skein: "pászma",
      pdf_unit_skeins: "pászmák",
      pay_title: "A mintád készen áll a hímzésre \u2728",
      pay_subtitle: "Kapd meg a fonallistát, színkódokat és nyomtatható PDF-et \u2014 mindent, ami a kezdéshez kell.",
      pay_single_label: "Csak ez az egy",
      pay_single_desc: "A mintád másodpercek alatt",
      pay_badge_save: "Spórolj 50%-ot",
      pay_pack_label: "10 Minta",
      pay_pack_unit: "$0.99 darabja",
      pay_pack_desc: "Tökéletes ajándéknak és projektekhez",
      pay_annual_label: "Egész évben",
      pay_annual_unit: "csak $2.08/hó",
      pay_annual_desc: "Korlátlan minták, egész évben",
      pay_indie_note: "A Word2Stitch-et egy ember készíti szeretettel. Támogatásod új betűtípusok és funkciók fejlesztését segíti. \uD83D\uDC9C",
      pay_terms: 'Vásárlással elfogadod az <a href="/terms" target="_blank" rel="noopener">Általános Szerződési Feltételeket</a>',
      pay_divider_key: "Már van kulcsod?",
      pay_key_placeholder: "Illeszd be a mintakulcsodat ide",
      pay_key_submit: "Aktiválás \u2713",
      pay_credits_unlimited: "Korlátlan",
      pay_credits_remaining: "letöltés maradt",
      pay_title_success: "Fizetés megérkezett! \u2713",
      pay_subtitle_success: "Nézd meg a postaládádat \u2014 a kulcsod úton van! Illeszd be alább.",
      pay_email_hint: "Nézd meg a Lemon Squeezy-től kapott emailt \u2014 a spam mappát is ellenőrizd!",
      pay_key_error: "Érvénytelen vagy kimerült kulcs. Ellenőrizd és próbáld újra.",
      pay_title_activating: "Mintád előkészítése\u2026",
      pay_subtitle_activating: "Majdnem kész \u2014 egy pillanat!",
      pay_trust: "\uD83D\uDD12 Biztonságos fizetés a Lemon Squeezy-n keresztül",
      pay_title_personalized: "A '{text}' mintád készen áll \u2728",
      pay_checkout_slow: "Tovább tart a vártnál\u2026",
      pay_checkout_retry: "Próbáld újra",
      free_title: "Az első mintád ingyenes!",
      free_subtitle: "Add meg az email címed, és töltsd le a teljes mintát — fonallista, színkódok és nyomtatásra kész PDF.",
      free_email_placeholder: "your@email.com",
      free_email_submit: "Ingyenes letöltés \u2193",
      free_note: "Nem küldünk spamet, soha. Csak a mintádat.",
      free_email_error: "Kérjük, adj meg egy érvényes email címet",
      upsell_title: "Minta letöltve!",
      upsell_subtitle: "Tetszett? Szerezz 10 mintát és spórolj 50%-ot",
      upsell_deal: "10 minta $9.99-ért — ez csak $0.99 darabonként!",
      upsell_btn: "Frissítés 10 Mintára — $9.99",
      upsell_skip: "Nem, köszönöm",
      mobile_preview_title: "A teljes mintacsomagod",
      mobile_preview_items: "Rács \u00b7 Fonalútmutató \u00b7 Színkódok \u00b7 Méretek"
    }
  };

</script>

<!-- ═══ UI Application Logic ═══ -->
<script>
(function () {
  'use strict';

// ui-modules/i18n.js — I18N functions (t, applyLang, setLanguage)

  // I18N data loaded from i18n-data.js

  var currentLang = 'en';

  function t(key) {
    var lang = I18N[currentLang] || I18N.en;
    return lang[key] || I18N.en[key] || key;
  }

  function applyLang() {
    document.querySelectorAll('[data-i18n]').forEach(function(el) {
      el.textContent = t(el.dataset.i18n);
    });
    document.querySelectorAll('[data-i18n-html]').forEach(function(el) {
      el.innerHTML = t(el.dataset.i18nHtml);
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
      el.placeholder = t(el.dataset.i18nPlaceholder);
    });
    document.querySelectorAll('[data-i18n-aria]').forEach(function(el) {
      el.setAttribute('aria-label', t(el.dataset.i18nAria));
    });
    document.title = 'Word2Stitch — ' + t('empty_state').split(' ').slice(0, 4).join(' ');
  }

  function setLanguage(lang) {
    if (!I18N[lang]) lang = 'en';
    currentLang = lang;
    document.documentElement.lang = lang;
    try { localStorage.setItem('w2s_lang', lang); } catch(e) {}
    var sel = document.getElementById('langSelect');
    if (sel) sel.value = lang;
    applyLang();
    if (typeof renderFontListUI === 'function') renderFontListUI();
  }


// ui-modules/state.js — State variables, DOM refs, and helpers

  // -- State --
  var currentText = 'Welcome';
  var currentFontFile = 'GeorgiaPro-Bold.ttf';
  var currentFontName = 'GeorgiaPro-Bold';
  var currentHeight = 18;
  var currentColorCode = '310'; // DMC code (robust with 449 colors)
  var currentAida = 14;
  var currentCategoryFilter = 'all';
  var displayUnit = 'metric'; // 'metric' | 'imperial'
  var currentAlign = 'center'; // 'left' | 'center' | 'right'

  // -- Unit detection & formatting --

  function detectDefaultUnit() {
    var lang = navigator.language || '';
    var parts = lang.split('-');
    var country = (parts[1] || '').toUpperCase();
    // US, Liberia (LR), Myanmar (MM) use imperial
    if (country === 'US' || country === 'LR' || country === 'MM') return 'imperial';
    // Fallback: if just 'en' without country, assume metric (UK, AU, etc.)
    return 'metric';
  }

  function formatSize(wStitches, hStitches, aida) {
    var inW = (wStitches / aida).toFixed(1);
    var inH = (hStitches / aida).toFixed(1);
    var cmW = (wStitches / aida * 2.54).toFixed(1);
    var cmH = (hStitches / aida * 2.54).toFixed(1);
    if (displayUnit === 'imperial') {
      return { value: inW + ' \u00d7 ' + inH, unit: 'in', width: inW + ' in', height: inH + ' in' };
    }
    return { value: cmW + ' \u00d7 ' + cmH, unit: 'cm', width: cmW + ' cm', height: cmH + ' cm' };
  }

  function formatThread(stitches, aida) {
    var metersPerStitch = 0.013 * (14 / aida);
    var totalMeters = stitches * metersPerStitch;
    if (displayUnit === 'imperial') {
      var yards = (totalMeters * 1.09361).toFixed(1);
      return yards + '\u00a0yd';
    }
    return totalMeters.toFixed(1) + '\u00a0m';
  }

  function setDisplayUnit(unit) {
    displayUnit = (unit === 'imperial') ? 'imperial' : 'metric';
    try { localStorage.setItem('w2s_unit', displayUnit); } catch(e) {}
    // Sync toggle buttons
    var toggle = document.getElementById('unitToggle');
    if (toggle) {
      toggle.querySelectorAll('.unit-toggle-btn').forEach(function(b) {
        b.classList.toggle('active', b.dataset.unit === displayUnit);
      });
    }
    // Refresh custom stitch labels if visible
    if (isCustomAida) {
      updateCustomStitch(currentStitchMm, 'unit');
    }
    updatePreview();
  }

  var categoryLabels = {
    'serif': 'Serif', 'sans-serif': 'Sans', 'script': 'Script',
    'decorative': 'Decorative', 'monospace': 'Mono', 'other': 'Other'
  };

  // Font list from API: [{file, name, size, category}, ...]
  var fontListData = [];

  // Client-side cache: Map<string, fontJSON>
  // Key format: "filename.ttf_height"
  var fontCache = new Map();

  // In-flight request deduplication: Map<cacheKey, Promise>
  var inFlightRequests = new Map();

  // AbortControllers for preview requests: Map<cacheKey, AbortController>
  var previewAbortControllers = new Map();

  // Currently loaded font data (from cache or API)
  var currentFontData = null;

  // -- DOM refs --
  var textInput = document.getElementById('textInput');
  var fontList = document.getElementById('fontList');
  var fontSearch = document.getElementById('fontSearch');
  var heightSlider = document.getElementById('heightSlider');
  var heightValue = document.getElementById('heightValue');
  var colorRow = document.getElementById('colorRow');
  var aidaRow = document.getElementById('aidaRow');
  var btnDownload = document.getElementById('btnDownload');
  var previewEmpty = document.getElementById('previewEmpty');
  var previewWrap = document.getElementById('previewWrap');
  var previewLoading = document.getElementById('previewLoading');
  var mainCanvas = document.getElementById('mainCanvas');
  var previewArea = document.getElementById('previewArea');

  // -- Helpers --

  function getCacheKey(fontFile, height) {
    return fontFile + '_' + height;
  }

  function getCurrentColor() {
    if (typeof DMC_COLORS === 'undefined' || !DMC_COLORS.length) return { hex: '#000000', code: '310', name: 'Black' };
    for (var i = 0; i < DMC_COLORS.length; i++) {
      if (DMC_COLORS[i].code === currentColorCode) return DMC_COLORS[i];
    }
    return DMC_COLORS[0]; // fallback
  }

  function showLoading() {
    previewLoading.classList.remove('hidden');
  }

  function hideLoading() {
    previewLoading.classList.add('hidden');
  }


// ui-modules/auth.js — License key verification + payment gate
// Manages license keys (localStorage), server verification via /api/verify,
// and the payment modal flow with Lemon Squeezy checkout overlay.

  var LICENSE_KEY_STORAGE = 'w2s_license_key';
  var FIRST_FREE_KEY = 'w2s_first_free';
  var STORED_EMAIL_KEY = 'w2s_email';
  var _pendingPdfFn = null;
  var _lastPurchasePlan = '';

  var payModalEl = document.getElementById('pay-modal');
  var payBackdrop = document.getElementById('pay-backdrop');
  var payBtnClose = document.getElementById('pay-close');

  // -- License key management --

  function getLicenseKey() {
    try { return localStorage.getItem(LICENSE_KEY_STORAGE) || ''; }
    catch (e) { return ''; }
  }

  function storeLicenseKey(key) {
    try { localStorage.setItem(LICENSE_KEY_STORAGE, key); }
    catch (e) { /* silent */ }
  }

  function clearLicenseKey() {
    try { localStorage.removeItem(LICENSE_KEY_STORAGE); }
    catch (e) { /* silent */ }
  }

  // -- Free trial & email --

  function hasUsedFreeTrial() {
    try { return localStorage.getItem(FIRST_FREE_KEY) === '1'; } catch(e) { return false; }
  }

  function markFreeTrialUsed() {
    try { localStorage.setItem(FIRST_FREE_KEY, '1'); } catch(e) {}
  }

  function getStoredEmail() {
    try { return localStorage.getItem(STORED_EMAIL_KEY) || ''; } catch(e) { return ''; }
  }

  function storeEmail(email) {
    try { localStorage.setItem(STORED_EMAIL_KEY, email); } catch(e) {}
  }

  // -- Server verification --

  function verifyLicenseKey(key) {
    return fetch('/api/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ license_key: key })
    })
    .then(function(res) { return res.json(); })
    .catch(function() { return { allowed: false, error: 'network' }; });
  }

  // -- Read-only check (does NOT consume credits) --

  function checkLicenseKey(key) {
    return fetch('/api/check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ license_key: key })
    })
    .then(function(res) { return res.json(); })
    .catch(function() { return { valid: false, error: 'network' }; });
  }

  // -- Payment modal --

  function showPaymentModal() {
    // Hide print modal if it's open (avoid overlapping modals)
    var printModal = document.getElementById('printModal');
    if (printModal) printModal.classList.add('pm-hidden');

    if (payModalEl) {
      payModalEl.classList.remove('pay-hidden');
      payModalEl.classList.remove('pay-key-only');
      // Reset title and subtitle to defaults (i18n)
      var title = payModalEl.querySelector('.pay-title');
      if (title) title.textContent = t('pay_title');
      var subtitle = payModalEl.querySelector('.pay-subtitle');
      if (subtitle) {
        subtitle.textContent = t('pay_subtitle');
      }
      // Personalize title with user's pattern text
      var userText = '';
      var textInput = document.getElementById('textInput');
      if (textInput) userText = textInput.value.trim();
      if (!userText) {
        var mobileInput = document.getElementById('mobileTextInput');
        if (mobileInput) userText = mobileInput.value.trim();
      }
      if (title && userText) {
        var personalizedTitle = t('pay_title_personalized');
        if (personalizedTitle !== 'pay_title_personalized') {
          var truncated = userText.length > 30 ? userText.substring(0, 30) + '\u2026' : userText;
          title.textContent = personalizedTitle.replace('{text}', truncated);
        }
      }
    }
  }

  function hidePaymentModal(restorePrint) {
    if (payModalEl) payModalEl.classList.add('pay-hidden');
    // Restore print modal only on cancel (not after successful payment)
    if (restorePrint !== false) {
      var printModal = document.getElementById('printModal');
      if (printModal) printModal.classList.remove('pm-hidden');
    }
  }

  // -- Payment flow --

  function requestPdfDownload(generateCompleteFn) {
    var key = getLicenseKey();
    if (!key && !hasUsedFreeTrial()) {
      // First download is free — capture email
      _pendingPdfFn = generateCompleteFn;
      showFreeModal();
      return;
    }
    if (!key) {
      _pendingPdfFn = generateCompleteFn;
      try { sessionStorage.setItem('w2s_pending_download', '1'); } catch(e) {}
      showPaymentModal();
      return;
    }
    // Has key — verify with server (show brief loading state)
    var dlBtn = document.getElementById('pmDownloadComplete');
    if (dlBtn) { dlBtn.disabled = true; dlBtn.style.opacity = '0.6'; }
    verifyLicenseKey(key).then(function(result) {
      if (dlBtn) { dlBtn.disabled = false; dlBtn.style.opacity = ''; }
      if (result.allowed) {
        try { sessionStorage.removeItem('w2s_pending_download'); } catch(e) {}
        generateCompleteFn();
        updateCreditsDisplay(result.remaining);
      } else {
        if (result.error === 'exhausted' || result.error === 'expired' || result.error === 'invalid_key') {
          clearLicenseKey();
        }
        _pendingPdfFn = generateCompleteFn;
        try { sessionStorage.setItem('w2s_pending_download', '1'); } catch(e) {}
        showPaymentModal();
      }
    });
  }

  // Expose for pdf-modal.js and checkout overlay retry button (run in global scope)
  window.requestPdfDownload = requestPdfDownload;
  window.closeCheckoutOverlay = closeCheckoutOverlay;
  window.showPaymentModal = showPaymentModal;

  // -- Credits display --

  function updateCreditsDisplay(remaining) {
    var el = document.getElementById('credits-display');
    if (!el) return;
    if (remaining < 0) {
      el.textContent = t('pay_credits_unlimited');
    } else {
      el.textContent = remaining + ' ' + t('pay_credits_remaining');
    }
    el.classList.remove('pay-hidden');
  }

  // -- Checkout overlay (own iframe, no lemon.js dependency) --

  var _checkoutOverlay = null;
  var _checkoutIframe = null;
  var _checkoutTimeout = null;
  var _paymentHandled = false;

  function showCheckoutOverlay(checkoutUrl) {
    _checkoutOverlay = document.createElement('div');
    _checkoutOverlay.className = 'ls-overlay';

    // Escape button (fades in after 1.5s so it doesn't interfere with iframe load)
    var closeBtn = document.createElement('button');
    closeBtn.className = 'ls-overlay-close';
    closeBtn.innerHTML = '&times;';
    closeBtn.title = 'Close checkout';
    closeBtn.addEventListener('click', function() {
      closeCheckoutOverlay();
      showPaymentModal();
    });
    _checkoutOverlay.appendChild(closeBtn);

    var loader = document.createElement('div');
    loader.className = 'ls-overlay-loader';
    loader.innerHTML = '<div class="ls-overlay-spinner"></div>';
    _checkoutOverlay.appendChild(loader);

    _checkoutIframe = document.createElement('iframe');
    _checkoutIframe.className = 'ls-overlay-iframe';
    _checkoutIframe.src = checkoutUrl;
    _checkoutIframe.allow = 'payment';
    _checkoutOverlay.appendChild(_checkoutIframe);

    document.body.appendChild(_checkoutOverlay);
    _paymentHandled = false;

    // Iframe load timeout — show retry after 15s
    _checkoutTimeout = setTimeout(function() {
      if (_checkoutOverlay) {
        var loader = _checkoutOverlay.querySelector('.ls-overlay-loader');
        if (loader) {
          loader.innerHTML = '<div style="color:#fff;text-align:center;padding:2rem;">' +
            '<p>' + t('pay_checkout_slow') + '</p>' +
            '<button onclick="closeCheckoutOverlay();showPaymentModal();" style="margin-top:1rem;padding:0.5rem 1.5rem;background:#fff;color:#3d3229;border:none;border-radius:8px;cursor:pointer;font-weight:600;">' + t('pay_checkout_retry') + '</button>' +
            '</div>';
        }
      }
    }, 15000);
  }

  function closeCheckoutOverlay() {
    clearTimeout(_checkoutTimeout);
    if (_checkoutOverlay) {
      _checkoutOverlay.remove();
      _checkoutOverlay = null;
      _checkoutIframe = null;
    }
  }

  function handlePaymentSuccess(eventData) {
    if (_paymentHandled) return;
    _paymentHandled = true;

    closeCheckoutOverlay();

    // Try auto-activation first, fallback to manual key entry
    var orderId = extractOrderId(eventData);
    if (orderId) {
      autoActivateOrder(orderId);
    } else {
      showLicenseKeyPrompt();
    }
  }

  function extractOrderId(eventData) {
    if (!eventData || typeof eventData !== 'object') return '';
    // LS Checkout.Success format: { event, data: { id, attributes: { order_number } } }
    var data = eventData.data;
    if (data) {
      if (data.attributes) {
        return String(data.attributes.order_number || data.id || '');
      }
      if (data.id) return String(data.id);
      // Legacy fallback: data.order (defensive)
      var order = data.order;
      if (order) return String(order.order_number || order.identifier || order.id || '');
    }
    // Top-level fallback
    if (eventData.order) {
      return String(eventData.order.order_number || eventData.order.identifier || eventData.order.id || '');
    }
    return '';
  }

  function autoActivateOrder(orderId) {
    // Show activating state in modal
    showPaymentModal();
    if (payModalEl) payModalEl.classList.add('pay-key-only');
    var title = payModalEl.querySelector('.pay-title');
    if (title) title.textContent = t('pay_title_activating');
    var subtitle = payModalEl.querySelector('.pay-subtitle');
    if (subtitle) subtitle.textContent = t('pay_subtitle_activating');

    fetch('/api/activate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ order_id: orderId })
    })
    .then(function(res) { return res.json(); })
    .then(function(result) {
      if (result.allowed && result.license_key) {
        storeLicenseKey(result.license_key);
        try { sessionStorage.removeItem('w2s_pending_download'); } catch(e) {}
        updateCreditsDisplay(result.remaining);
        hidePaymentModal(false);
        if (_pendingPdfFn) {
          _pendingPdfFn();
          _pendingPdfFn = null;
          maybeShowUpsell();
        }
      } else {
        // Fallback to manual key entry
        showLicenseKeyPrompt();
      }
    })
    .catch(function() {
      // Fallback to manual key entry on network error
      showLicenseKeyPrompt();
    });
  }

  function showLicenseKeyPrompt() {
    showPaymentModal();
    // Switch to key-only mode: hide plan cards, show only key input
    if (payModalEl) payModalEl.classList.add('pay-key-only');
    var title = payModalEl.querySelector('.pay-title');
    if (title) title.textContent = t('pay_title_success');
    var subtitle = payModalEl.querySelector('.pay-subtitle');
    if (subtitle) {
      subtitle.textContent = t('pay_subtitle_success');
    }
    // Show email help hint
    var divider = payModalEl.querySelector('.pay-divider span');
    if (divider) {
      var helpText = t('pay_email_hint');
      if (helpText && helpText !== 'pay_email_hint') {
        divider.textContent = helpText;
      }
    }
    var keyField = document.getElementById('pay-key-field');
    if (keyField) keyField.focus();
  }

  // Listen for postMessage from LS checkout iframe
  window.addEventListener('message', function (e) {
    if (!_checkoutIframe) return;
    // Only accept messages from Lemon Squeezy checkout (exact domain match)
    if (!e.origin || !(/\.lemonsqueezy\.com$/.test(e.origin.replace(/^https?:\/\//, '')))) return;
    var data = e.data;

    if (data === 'mounted' && _checkoutOverlay) {
      clearTimeout(_checkoutTimeout);
      var loader = _checkoutOverlay.querySelector('.ls-overlay-loader');
      if (loader) loader.remove();
    }

    if (data === 'close') {
      closeCheckoutOverlay();
      showPaymentModal();
    }

    var eventName = data && data.event ? data.event : '';
    if (eventName === 'Checkout.Success' || eventName === 'GA.Purchase') {
      handlePaymentSuccess(data);
    }
  });

  // ESC key closes checkout overlay or payment modal
  window.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      if (_checkoutOverlay) {
        closeCheckoutOverlay();
        showPaymentModal();
      } else if (upsellModalEl && !upsellModalEl.classList.contains('pay-hidden')) {
        hideUpsellModal();
      } else if (freeModalEl && !freeModalEl.classList.contains('pay-hidden')) {
        hideFreeModal();
      } else if (payModalEl && !payModalEl.classList.contains('pay-hidden')) {
        hidePaymentModal();
      }
    }
  });

  // Direct checkout URLs from Lemon Squeezy dashboard
  var CHECKOUT_URLS = {
    single: 'https://infinis.lemonsqueezy.com/checkout/buy/54636d22-edf5-4542-bb96-096f8421c872',
    pack10: 'https://infinis.lemonsqueezy.com/checkout/buy/8e42106f-beb8-4780-8d19-39ac427f4430',
    annual: 'https://infinis.lemonsqueezy.com/checkout/buy/dcb8543d-c293-42bd-875e-ec7029e2ab95'
  };

  function goToCheckout(plan) {
    hidePaymentModal(false);

    var directUrl = CHECKOUT_URLS[plan];
    if (directUrl) {
      // Build optimized checkout URL
      _lastPurchasePlan = plan;
      var params = 'embed=1&button_color=%23b83a2a&media=0&desc=0';
      var storedEmail = getStoredEmail();
      if (storedEmail) {
        params += '&checkout[email]=' + encodeURIComponent(storedEmail);
      }
      var lang = navigator.language || '';
      var country = lang.split('-')[1];
      if (country && country.length === 2) {
        params += '&checkout[billing_address][country]=' + country.toUpperCase();
      }
      // Safari/Brave block third-party iframes — open in new tab instead
      var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      var isBrave = navigator.brave && navigator.brave.isBrave;
      if (isSafari || isBrave) {
        window.open(directUrl + '?' + params.replace('embed=1&', ''), '_blank');
        return;
      }
      showCheckoutOverlay(directUrl + '?' + params);
      return;
    }

    // Fallback: create checkout via API (for custom plans or future use)
    fetch('/api/checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ plan: plan })
    })
      .then(function (res) { return res.json(); })
      .then(function (data) {
        if (data.url && data.url.indexOf('https://') === 0 &&
            data.url.indexOf('lemonsqueezy.com') !== -1) {
          showCheckoutOverlay(data.url);
        } else {
          console.error('Checkout error');
        }
      })
      .catch(function () {
        console.error('Checkout unavailable');
      });
  }

  // -- Bind modal buttons --

  // Plan buttons
  var payBtnSingle = document.getElementById('pay-single');
  var payBtnPack10 = document.getElementById('pay-pack10');
  var payBtnAnnual = document.getElementById('pay-annual');

  if (payBtnSingle) {
    payBtnSingle.addEventListener('click', function () {
      goToCheckout('single');
    });
  }
  if (payBtnPack10) {
    payBtnPack10.addEventListener('click', function () {
      goToCheckout('pack10');
    });
  }
  if (payBtnAnnual) {
    payBtnAnnual.addEventListener('click', function () {
      goToCheckout('annual');
    });
  }

  // Close / backdrop
  if (payBtnClose) {
    payBtnClose.addEventListener('click', hidePaymentModal);
  }
  if (payBackdrop) {
    payBackdrop.addEventListener('click', hidePaymentModal);
  }

  // License key input
  var payKeySubmit = document.getElementById('pay-key-submit');
  var payKeyField = document.getElementById('pay-key-field');

  // Clear inline error when user starts typing
  if (payKeyField) {
    payKeyField.addEventListener('input', function() {
      var errorEl = document.getElementById('pay-key-error');
      if (errorEl) errorEl.textContent = '';
    });
  }

  if (payKeySubmit) {
    payKeySubmit.addEventListener('click', function () {
      var keyField = document.getElementById('pay-key-field');
      var key = keyField ? keyField.value.trim() : '';
      if (!key) return;

      payKeySubmit.disabled = true;
      payKeySubmit.textContent = '...';

      verifyLicenseKey(key).then(function(result) {
        payKeySubmit.disabled = false;
        payKeySubmit.textContent = t('pay_key_submit');

        if (result.allowed) {
          // Clear any inline error
          var errorEl = document.getElementById('pay-key-error');
          if (errorEl) errorEl.textContent = '';
          storeLicenseKey(key);
          try { sessionStorage.removeItem('w2s_pending_download'); } catch(e) {}
          hidePaymentModal(false);
          updateCreditsDisplay(result.remaining);
          if (_pendingPdfFn) {
            _pendingPdfFn();
            _pendingPdfFn = null;
            maybeShowUpsell();
          }
        } else {
          // Show inline error instead of alert()
          var errorEl = document.getElementById('pay-key-error');
          if (!errorEl) {
            errorEl = document.createElement('div');
            errorEl.id = 'pay-key-error';
            errorEl.style.cssText = 'color:#b83a2a;font-size:0.8rem;margin-top:0.5rem;';
            var keyInput = document.querySelector('.pay-key-input');
            if (keyInput) keyInput.parentNode.insertBefore(errorEl, keyInput.nextSibling);
          }
          errorEl.textContent = t('pay_key_error');
        }
      });
    });
  }

  // -- Free first download modal --

  var freeModalEl = document.getElementById('free-modal');

  function showFreeModal() {
    var printModal = document.getElementById('printModal');
    if (printModal) printModal.classList.add('pm-hidden');
    if (freeModalEl) {
      freeModalEl.classList.remove('pay-hidden');
      var emailField = document.getElementById('free-email-field');
      var storedEmail = getStoredEmail();
      if (emailField) {
        if (storedEmail) emailField.value = storedEmail;
        emailField.focus();
      }
    }
  }

  function hideFreeModal() {
    if (freeModalEl) freeModalEl.classList.add('pay-hidden');
  }

  // Free modal close / backdrop
  var freeClose = document.getElementById('free-close');
  var freeBackdrop = document.getElementById('free-backdrop');
  if (freeClose) freeClose.addEventListener('click', function() {
    hideFreeModal();
    var printModal = document.getElementById('printModal');
    if (printModal) printModal.classList.remove('pm-hidden');
  });
  if (freeBackdrop) freeBackdrop.addEventListener('click', function() {
    hideFreeModal();
    var printModal = document.getElementById('printModal');
    if (printModal) printModal.classList.remove('pm-hidden');
  });

  // Free modal submit
  var freeSubmit = document.getElementById('free-email-submit');
  if (freeSubmit) {
    freeSubmit.addEventListener('click', function() {
      var emailField = document.getElementById('free-email-field');
      var email = emailField ? emailField.value.trim() : '';
      var errorEl = document.getElementById('free-email-error');

      if (!email || email.indexOf('@') === -1 || email.indexOf('.') === -1) {
        if (errorEl) errorEl.textContent = t('free_email_error');
        return;
      }
      if (errorEl) errorEl.textContent = '';

      storeEmail(email);
      markFreeTrialUsed();
      hideFreeModal();

      if (_pendingPdfFn) {
        _pendingPdfFn();
        _pendingPdfFn = null;
      }
    });
  }

  // -- Post-purchase upsell modal --

  var upsellModalEl = document.getElementById('upsell-modal');

  function showUpsellModal() {
    if (upsellModalEl) upsellModalEl.classList.remove('pay-hidden');
  }

  function hideUpsellModal() {
    if (upsellModalEl) upsellModalEl.classList.add('pay-hidden');
  }

  var upsellClose = document.getElementById('upsell-close');
  var upsellBackdrop = document.getElementById('upsell-backdrop');
  var upsellSkip = document.getElementById('upsell-skip');
  var upsellUpgrade = document.getElementById('upsell-upgrade');

  if (upsellClose) upsellClose.addEventListener('click', hideUpsellModal);
  if (upsellBackdrop) upsellBackdrop.addEventListener('click', hideUpsellModal);
  if (upsellSkip) upsellSkip.addEventListener('click', hideUpsellModal);
  if (upsellUpgrade) {
    upsellUpgrade.addEventListener('click', function() {
      hideUpsellModal();
      goToCheckout('pack10');
    });
  }

  function maybeShowUpsell() {
    if (_lastPurchasePlan === 'single') {
      setTimeout(function() { showUpsellModal(); }, 2000);
    }
  }

  // -- Init --

  function initAuth(onReady) {
    // Handle ?payment=success redirect (from API fallback checkout path)
    if (window.location.search.indexOf('payment=success') !== -1) {
      window.history.replaceState({}, '', window.location.pathname);
      setTimeout(function() { showLicenseKeyPrompt(); }, 300);
    }

    // Restore pending download state after page refresh during checkout
    try {
      if (sessionStorage.getItem('w2s_pending_download') === '1') {
        sessionStorage.removeItem('w2s_pending_download');
        var existingKey2 = getLicenseKey();
        if (!existingKey2) {
          setTimeout(function() { showLicenseKeyPrompt(); }, 300);
        }
      }
    } catch(e) {}

    // Check if user already has a key and show credits (read-only, no credit burn)
    var existingKey = getLicenseKey();
    if (existingKey) {
      checkLicenseKey(existingKey).then(function(result) {
        if (result.valid) {
          updateCreditsDisplay(result.remaining);
        } else {
          clearLicenseKey();
        }
      });
    }
    onReady();
  }


// ui-modules/renderer.js — Canvas rendering (renderPreview)

  // -- Render --

  function renderPreview(canvas, text, fontData, colorHex, options) {
    var ctx = canvas.getContext('2d');
    if (!text || !fontData) {
      canvas.width = 1; canvas.height = 1;
      ctx.clearRect(0, 0, 1, 1);
      return { width: 0, height: 0, stitches: 0 };
    }

    var result = getTextBitmap(text, fontData, { textAlign: options.textAlign || 'left' });
    var bitmap = result.bitmap;
    var width = result.width;
    var height = result.height;
    if (!bitmap.length || !width) {
      canvas.width = 1; canvas.height = 1;
      ctx.clearRect(0, 0, 1, 1);
      return { width: 0, height: 0, stitches: 0 };
    }

    var opts = options || {};
    var maxCanvasWidth = opts.maxWidth || 850;
    var cellSize = opts.cellSize || 12;
    if (width * cellSize > maxCanvasWidth) {
      cellSize = Math.max(2, Math.floor(maxCanvasWidth / width));
    }

    var canvasW = width * cellSize + 1;
    var canvasH = height * cellSize + 1;
    canvas.width = canvasW;
    canvas.height = canvasH;

    // Background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvasW, canvasH);

    var stitchCount = 0;

    // Filled cells
    ctx.fillStyle = colorHex;
    for (var y = 0; y < height; y++) {
      for (var x = 0; x < width; x++) {
        if (bitmap[y][x]) {
          ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
          stitchCount++;
        }
      }
    }

    // Grid lines
    ctx.strokeStyle = '#e0d8d0';
    ctx.lineWidth = 0.5;
    for (var gx = 0; gx <= width; gx++) {
      var px = gx * cellSize + 0.5;
      ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, canvasH); ctx.stroke();
    }
    for (var gy = 0; gy <= height; gy++) {
      var py = gy * cellSize + 0.5;
      ctx.beginPath(); ctx.moveTo(0, py); ctx.lineTo(canvasW, py); ctx.stroke();
    }

    // Bold every 10
    if (cellSize >= 4) {
      ctx.strokeStyle = '#a09888';
      ctx.lineWidth = 1.5;
      for (var bx = 0; bx <= width; bx += 10) {
        var bpx = bx * cellSize + 0.5;
        ctx.beginPath(); ctx.moveTo(bpx, 0); ctx.lineTo(bpx, canvasH); ctx.stroke();
      }
      for (var by = 0; by <= height; by += 10) {
        var bpy = by * cellSize + 0.5;
        ctx.beginPath(); ctx.moveTo(0, bpy); ctx.lineTo(canvasW, bpy); ctx.stroke();
      }
    }

    return { width: width, height: height, stitches: stitchCount };
  }


// ui-modules/api.js — API calls (fetchFontList, rasterizeFont)

  // -- API calls --

  function fetchFontList() {
    return fetch('/api/fonts')
      .then(function (res) {
        if (!res.ok) throw new Error('Failed to load font list');
        return res.json();
      })
      .then(function (data) {
        fontListData = data;
        renderFontListUI();
        // Auto-rasterize default font on load
        if (currentFontFile && currentText) {
          loadAndRender();
        }
      })
      .catch(function (err) {
        fontList.innerHTML = '';
        var msg = document.createElement('div');
        msg.style.cssText = 'padding:20px;color:var(--text-muted);font-size:12px;text-align:center';
        msg.textContent = t('server_error');
        fontList.appendChild(msg);
        console.error('Font list unavailable');
      });
  }

  function rasterizeFont(fontFile, height) {
    var key = getCacheKey(fontFile, height);

    // L1: Memory cache
    if (fontCache.has(key)) {
      return Promise.resolve(fontCache.get(key));
    }

    // Dedup: return existing in-flight promise
    if (inFlightRequests.has(key)) {
      return inFlightRequests.get(key);
    }

    showLoading();

    var promise = fetch('/api/rasterize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        font: fontFile,
        height: height,
        bold: 0,
        strategy: 'average'
      })
    })
    .then(function (res) {
      if (!res.ok) throw new Error('Rasterization failed');
      return res.json();
    })
    .then(function (data) {
      fontCache.set(key, data);
      hideLoading();
      return data;
    })
    .catch(function (err) {
      hideLoading();
      console.error('Rasterization failed');
      return null;
    })
    .finally(function () {
      inFlightRequests.delete(key);
    });

    inFlightRequests.set(key, promise);
    return promise;
  }


// ui-modules/preview.js — Preview orchestration
// updatePreview(), loadAndRender(), text input handler

  // -- Update Preview (main function) --

  function updatePreview() {
    var color = getCurrentColor();

    if (!currentText.trim() || !currentFontData) {
      previewEmpty.style.display = 'flex';
      previewWrap.style.display = 'none';
      return;
    }

    previewEmpty.style.display = 'none';
    previewWrap.style.display = 'flex';

    // Calculate available space
    var areaRect = previewArea.getBoundingClientRect();
    var maxW = areaRect.width - 40;

    var result = renderPreview(mainCanvas, currentText, currentFontData, color.hex, {
      cellSize: 16,
      maxWidth: maxW,
      textAlign: currentAlign
    });

    if (result.width === 0) {
      previewEmpty.style.display = 'flex';
      previewWrap.style.display = 'none';
      return;
    }

    // Calculate physical size using unit-aware helpers
    var size = formatSize(result.width, result.height, currentAida);

    // Update stats
    var statsBar = document.getElementById('statsBar');
    if (statsBar && !statsBar.getAttribute('aria-live')) {
      statsBar.setAttribute('aria-live', 'polite');
      statsBar.setAttribute('aria-atomic', 'true');
    }
    document.getElementById('statSizeCm').textContent = size.value;
    var sizeUnitEl = document.getElementById('statSizeUnit');
    if (sizeUnitEl) sizeUnitEl.textContent = size.unit;
    document.getElementById('statStitchesW').textContent = result.width;
    document.getElementById('statStitchesH').textContent = result.height;
    document.getElementById('statTotal').textContent = result.stitches;
    document.getElementById('statDmc').textContent = color.code;

    // Thread estimate
    document.getElementById('statThread').textContent = formatThread(result.stitches, currentAida);

    // Ruler: match canvas rendered dimensions
    document.getElementById('rulerWidth').textContent = size.width;
    var rulerHeightLabel = document.getElementById('rulerHeight');
    if (rulerHeightLabel) rulerHeightLabel.textContent = size.height;
    requestAnimationFrame(function () {
      var canvasRect = mainCanvas.getBoundingClientRect();
      var rulerLine = document.querySelector('.ruler-line');
      if (rulerLine && canvasRect.width > 0) {
        rulerLine.style.width = canvasRect.width + 'px';
      }
      // Vertical ruler: match canvas rendered height
      var rulerV = document.getElementById('rulerVertical');
      if (rulerV && canvasRect.height > 0) {
        rulerV.style.height = canvasRect.height + 'px';
      }
    });
  }

  // -- Trigger rasterization and update --

  function loadAndRender() {
    if (!currentFontFile) {
      currentFontData = null;
      updatePreview();
      return;
    }

    rasterizeFont(currentFontFile, currentHeight).then(function (data) {
      if (data) {
        currentFontData = data;
      }
      updatePreview();
    });
  }

  // -- Text Input --

  var desktopInputDebounce = null;
  textInput.addEventListener('input', function () {
    currentText = this.value;
    clearTimeout(desktopInputDebounce);
    desktopInputDebounce = setTimeout(function () {
      updatePreview();
      renderVirtualFontList();
      refreshSidebarPreviews();
    }, 300);
  });


// ui-modules/font-manager.js — Font list rendering, search, category tabs
// renderFontListUI(), font search handler, category tab click handler

  // -- Font List UI --

  function renderFontListUI() {
    var filter = (fontSearch.value || '').toLowerCase().trim();

    // Compute category counts from filtered fonts
    var categoryCounts = {};
    fontListData.forEach(function (font) {
      var name = font.name || font.file;
      if (filter && name.toLowerCase().indexOf(filter) === -1) return;
      var cat = font.category || 'other';
      categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
    });

    var categories = Object.keys(categoryCounts).sort();
    var totalFiltered = 0;
    categories.forEach(function (c) { totalFiltered += categoryCounts[c]; });

    // Populate category tabs
    var tabsEl = document.getElementById('fontCategoryTabs');
    tabsEl.innerHTML = '';
    var allBtn = document.createElement('button');
    allBtn.className = 'font-tab' + (currentCategoryFilter === 'all' ? ' active' : '');
    allBtn.dataset.category = 'all';
    allBtn.textContent = t('tab_all') + ' (' + totalFiltered + ')';
    tabsEl.appendChild(allBtn);

    categories.forEach(function (cat) {
      var btn = document.createElement('button');
      btn.className = 'font-tab' + (currentCategoryFilter === cat ? ' active' : '');
      btn.dataset.category = cat;
      btn.textContent = (categoryLabels[cat] || cat) + ' (' + categoryCounts[cat] + ')';
      tabsEl.appendChild(btn);
    });

    // Reset if current category has no fonts
    if (currentCategoryFilter !== 'all' && !categoryCounts[currentCategoryFilter]) {
      currentCategoryFilter = 'all';
      tabsEl.querySelector('[data-category="all"]').classList.add('active');
    }

    // Render font list
    fontList.innerHTML = '';

    if (!fontListData.length) {
      var msg = document.createElement('div');
      msg.style.cssText = 'padding:20px;color:var(--text-muted);font-size:12px;text-align:center';
      msg.textContent = t('no_fonts');
      fontList.appendChild(msg);
      return;
    }

    var displayed = 0;
    var fragment = document.createDocumentFragment();

    fontListData.forEach(function (font) {
      var name = font.name || font.file;
      if (filter && name.toLowerCase().indexOf(filter) === -1) return;
      if (currentCategoryFilter !== 'all' && (font.category || 'other') !== currentCategoryFilter) return;

      displayed++;

      var item = document.createElement('div');
      item.className = 'font-item' + (font.file === currentFontFile ? ' selected' : '');
      item.dataset.fontFile = font.file;

      var info = document.createElement('div');
      info.className = 'font-item-info';

      var nameEl = document.createElement('div');
      nameEl.className = 'font-item-name';
      nameEl.textContent = name;

      var meta = document.createElement('div');
      meta.className = 'font-item-meta';
      var sizeKb = font.size ? (font.size / 1024).toFixed(0) + ' KB' : '';
      meta.textContent = (categoryLabels[font.category] || font.category || '') + (sizeKb ? ' \u00b7 ' + sizeKb : '');

      var previewCanvas = document.createElement('canvas');
      previewCanvas.className = 'font-item-preview';
      previewCanvas.dataset.fontFile = font.file;

      info.appendChild(nameEl);
      info.appendChild(meta);
      info.appendChild(previewCanvas);
      item.appendChild(info);
      fragment.appendChild(item);

      item.addEventListener('click', function () {
        currentFontFile = font.file;
        currentFontName = name;
        fontList.querySelectorAll('.font-item').forEach(function (el) {
          el.classList.toggle('selected', el.dataset.fontFile === font.file);
        });
        syncMobileFontName();
        loadAndRender();
      });
    });

    fontList.appendChild(fragment);

    if (!displayed) {
      fontList.innerHTML = '';
      var msg = document.createElement('div');
      msg.style.cssText = 'padding:20px;color:var(--text-muted);font-size:12px;text-align:center';
      msg.textContent = t('no_matching');
      fontList.appendChild(msg);
    }

    // Queue font previews for visible desktop items
    if (typeof queueFontPreview === 'function') {
      var desktopCanvases = fontList.querySelectorAll('.font-item-preview');
      for (var pi = 0; pi < desktopCanvases.length; pi++) {
        queueFontPreview(desktopCanvases[pi].dataset.fontFile, desktopCanvases[pi]);
      }
    }
  }

  // Font search filtering
  fontSearch.addEventListener('input', function () {
    renderFontListUI();
  });

  // Category tab filtering (delegated)
  document.getElementById('fontCategoryTabs').addEventListener('click', function (e) {
    var tab = e.target.closest('.font-tab');
    if (!tab) return;
    currentCategoryFilter = tab.dataset.category;
    this.querySelectorAll('.font-tab').forEach(function (t) { t.classList.remove('active'); });
    tab.classList.add('active');
    renderFontListUI();
  });


// ui-modules/color-manager.js — DMC color swatch rendering and click handlers
// renderColors(), openColorPopover(), closeColorPopover()

  // -- Color Swatches (sidebar: popular 20 + "All" button) --

  function renderColors() {
    if (typeof DMC_COLORS === 'undefined' || !DMC_COLORS.length) return;
    colorRow.innerHTML = '';
    var fragment = document.createDocumentFragment();

    var popularCodes = (typeof POPULAR_DMC_CODES !== 'undefined') ? POPULAR_DMC_CODES : [];
    var popular = popularCodes.map(function (code) {
      for (var i = 0; i < DMC_COLORS.length; i++) {
        if (DMC_COLORS[i].code === code) return DMC_COLORS[i];
      }
      return null;
    }).filter(Boolean);

    // If no popular list, show first 20
    if (!popular.length) popular = DMC_COLORS.slice(0, 20);

    popular.forEach(function (color) {
      var dot = document.createElement('div');
      dot.className = 'color-dot' + (color.code === currentColorCode ? ' selected' : '');
      dot.style.backgroundColor = color.hex;
      dot.dataset.code = color.code;

      var tip = document.createElement('div');
      tip.className = 'tip';
      tip.textContent = 'DMC ' + color.code + ' \u2014 ' + color.name;
      dot.appendChild(tip);

      fragment.appendChild(dot);
    });

    // "All colors" button
    var allBtn = document.createElement('button');
    allBtn.className = 'color-all-btn';
    allBtn.textContent = 'All\u2026';
    allBtn.setAttribute('aria-label', 'Show all DMC colors');
    fragment.appendChild(allBtn);

    colorRow.appendChild(fragment);

    // Delegated click handler for the whole color row
    colorRow.onclick = function (e) {
      var dot = e.target.closest('.color-dot');
      if (dot && dot.dataset.code) {
        selectColor(dot.dataset.code);
        return;
      }
      if (e.target.closest('.color-all-btn')) {
        openColorPopover();
      }
    };
  }

  // -- Select color by DMC code --

  function selectColor(code) {
    currentColorCode = code;

    // Update sidebar dots
    colorRow.querySelectorAll('.color-dot').forEach(function (d) {
      d.classList.toggle('selected', d.dataset.code === code);
    });

    // Update popover selection if open
    var popGrid = document.getElementById('colorPopoverGrid');
    if (popGrid) {
      popGrid.querySelectorAll('.color-dot').forEach(function (d) {
        d.classList.toggle('selected', d.dataset.code === code);
      });
    }

    syncMobileColorStrip();
    updatePreview();
  }

  // -- Desktop Color Popover --

  function openColorPopover() {
    var popover = document.getElementById('colorPopover');
    if (!popover) return;
    popover.classList.add('open');
    renderColorPopoverGrid('');

    var searchInput = document.getElementById('colorPopoverSearch');
    if (searchInput) {
      searchInput.value = '';
      searchInput.focus();
    }
  }

  function closeColorPopover() {
    var popover = document.getElementById('colorPopover');
    if (popover) popover.classList.remove('open');
  }

  function renderColorPopoverGrid(query) {
    var grid = document.getElementById('colorPopoverGrid');
    if (!grid) return;
    grid.innerHTML = '';

    var q = (query || '').toLowerCase().trim();
    var filtered = DMC_COLORS.filter(function (c) {
      if (!q) return true;
      return c.code.toLowerCase().indexOf(q) !== -1 || c.name.toLowerCase().indexOf(q) !== -1;
    });

    var fragment = document.createDocumentFragment();
    filtered.forEach(function (color) {
      var dot = document.createElement('div');
      dot.className = 'color-dot' + (color.code === currentColorCode ? ' selected' : '');
      dot.style.backgroundColor = color.hex;
      dot.dataset.code = color.code;

      var tip = document.createElement('div');
      tip.className = 'tip';
      tip.textContent = 'DMC ' + color.code + ' \u2014 ' + color.name;
      dot.appendChild(tip);

      fragment.appendChild(dot);
    });

    grid.appendChild(fragment);
  }

  // Popover event wiring (delegated)
  var colorPopover = document.getElementById('colorPopover');
  if (colorPopover) {
    // Grid click
    var popGrid = document.getElementById('colorPopoverGrid');
    if (popGrid) {
      popGrid.onclick = function (e) {
        var dot = e.target.closest('.color-dot');
        if (dot && dot.dataset.code) {
          selectColor(dot.dataset.code);
          closeColorPopover();
        }
      };
    }

    // Search input
    var popSearch = document.getElementById('colorPopoverSearch');
    if (popSearch) {
      popSearch.addEventListener('input', function () {
        renderColorPopoverGrid(this.value);
      });
    }

    // Close button
    var popClose = document.getElementById('colorPopoverClose');
    if (popClose) {
      popClose.addEventListener('click', closeColorPopover);
    }

    // Close on outside click
    document.addEventListener('click', function (e) {
      if (colorPopover.classList.contains('open') && !colorPopover.contains(e.target) && !e.target.closest('.color-all-btn')) {
        closeColorPopover();
      }
    });
  }


// ui-modules/settings.js — Stitch/aida/height/unit handlers and custom stitch variables
// Height slider, aida count buttons, custom stitch slider, unit toggle

  // -- Height Slider --

  var heightDebounceTimer = null;

  heightSlider.addEventListener('input', function () {
    var val = parseInt(this.value);
    heightValue.textContent = val;
    syncMobileHeightValue(val);
    currentHeight = val;

    // Cancel stale preview requests immediately
    cancelAllPreviews();

    // Priority: re-rasterize selected font immediately
    loadAndRender();

    // Debounced: re-render sidebar previews (300ms)
    clearTimeout(heightDebounceTimer);
    heightDebounceTimer = setTimeout(function () {
      renderFontListUI();
    }, 300);
  });

  // -- Aida Count --

  document.getElementById('langSelect').addEventListener('change', function() {
    setLanguage(this.value);
  });

  var customStitchRow = document.getElementById('customStitchRow');
  var customStitchSlider = document.getElementById('customStitchSlider');
  var customStitchValue = document.getElementById('customStitchValue');
  var customStitchEquiv = document.getElementById('customStitchEquiv');
  var currentStitchMm = 3.0; // default 3mm stitch length
  var isCustomAida = false;

  function stitchMmToAida(mm) {
    return 25.4 / mm; // 25.4mm per inch
  }

  // Format stitch length + equivalence respecting displayUnit
  function formatStitchDisplay(mm) {
    var isImperial = (displayUnit === 'imperial');
    var displayVal, unit, equiv;
    if (isImperial) {
      displayVal = (mm / 25.4).toFixed(2);  // mm → inches
      unit = 'in';
      equiv = '\u2248 ' + (25.4 / mm).toFixed(1) + ' stitches/in';
    } else {
      displayVal = mm.toFixed(1);
      unit = 'mm';
      equiv = '\u2248 ' + (10 / mm).toFixed(1) + ' stitches/cm';
    }
    return { value: displayVal, unit: unit, equiv: equiv };
  }

  function updateCustomStitch(mm, source) {
    currentStitchMm = mm;
    var aida = stitchMmToAida(mm);
    currentAida = aida;

    var fmt = formatStitchDisplay(mm);

    // Update desktop UI
    if (customStitchValue) customStitchValue.textContent = fmt.value;
    if (customStitchSlider && source !== 'desktop') customStitchSlider.value = mm;
    if (customStitchEquiv) customStitchEquiv.textContent = fmt.equiv;
    var dUnit = document.getElementById('customStitchUnit');
    if (dUnit) dUnit.textContent = fmt.unit;

    // Update sheet UI
    var sheetVal = document.getElementById('sheetCustomStitchValue');
    var sheetSlider = document.getElementById('sheetCustomStitchSlider');
    var sheetEquiv = document.getElementById('sheetCustomStitchEquiv');
    var sheetUnit = document.getElementById('sheetCustomStitchUnit');
    if (sheetVal) sheetVal.textContent = fmt.value;
    if (sheetSlider && source !== 'sheet') sheetSlider.value = mm;
    if (sheetEquiv) sheetEquiv.textContent = fmt.equiv;
    if (sheetUnit) sheetUnit.textContent = fmt.unit;

    syncMobileAidaChips();
    updatePreview();
  }

  aidaRow.addEventListener('click', function (e) {
    var chip = e.target.closest('.aida-chip');
    if (!chip) return;
    var countVal = chip.dataset.count;

    // Deselect all chips
    aidaRow.querySelectorAll('.aida-chip').forEach(function (c) {
      c.classList.remove('selected');
    });
    chip.classList.add('selected');

    if (countVal === 'custom') {
      if (isCustomAida) {
        // Already custom — toggle slider visibility
        if (customStitchRow) customStitchRow.classList.toggle('visible');
      } else {
        isCustomAida = true;
        if (customStitchRow) customStitchRow.classList.add('visible');
        updateCustomStitch(currentStitchMm, 'init');
      }
    } else {
      isCustomAida = false;
      if (customStitchRow) customStitchRow.classList.remove('visible');
      currentAida = parseInt(countVal);
      syncMobileAidaChips();
      updatePreview();
    }
  });

  // Desktop stitch slider
  if (customStitchSlider) {
    customStitchSlider.addEventListener('input', function () {
      if (isCustomAida) updateCustomStitch(parseFloat(this.value), 'desktop');
    });
  }

  // -- Global unit toggle (cm / in) --
  document.getElementById('unitToggle').addEventListener('click', function (e) {
    var btn = e.target.closest('.unit-toggle-btn');
    if (!btn || btn.classList.contains('active')) return;
    setDisplayUnit(btn.dataset.unit);
  });


// ui-modules/pdf-integration.js — Download PDF button handler
// Opens the print preview modal (free preview). Payment gate is inside
// the modal for Download Complete and Print actions.

  // -- Download PDF --

  btnDownload.addEventListener('click', function () {
    var color = getCurrentColor();
    if (!currentFontData || !currentText.trim()) {
      alert(t('alert_no_text'));
      return;
    }
    if (typeof generatePDF !== 'function') {
      alert(t('alert_no_pdf'));
      return;
    }
    if (!window.jspdf) {
      alert(t('alert_no_jspdf'));
      return;
    }

    // Always show preview (free, no payment needed)
    generatePDF(currentText, currentFontData, color, currentAida);
  });


// ui-modules/sheet-system.js — Mobile sheet open/close & swipe-to-dismiss

  // ============================================================
  // == Mobile Canvas First: Bottom Sheets & Virtual Scroll     ==
  // ============================================================

  var isMobile = function () { return window.innerWidth <= 640; };

  // -- Sheet State --
  var activeSheet = null;
  var sheetBackdrop = document.getElementById('sheetBackdrop');
  var mobileToolbar = document.getElementById('mobileToolbar');
  var sheets = {
    font: document.getElementById('sheetFont'),
    color: document.getElementById('sheetColor'),
    settings: document.getElementById('sheetSettings'),
    info: document.getElementById('sheetInfo')
  };

  // -- Focus Trap --
  function trapFocus(sheet) {
    var focusable = sheet.querySelectorAll(
      'button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
    );
    if (!focusable.length) return;
    var first = focusable[0];
    var last = focusable[focusable.length - 1];
    sheet._focusTrapHandler = function (e) {
      if (e.key !== 'Tab') return;
      if (e.shiftKey) {
        if (document.activeElement === first) { e.preventDefault(); last.focus(); }
      } else {
        if (document.activeElement === last) { e.preventDefault(); first.focus(); }
      }
    };
    sheet.addEventListener('keydown', sheet._focusTrapHandler);
    first.focus();
  }

  function releaseFocus(sheet) {
    if (sheet._focusTrapHandler) {
      sheet.removeEventListener('keydown', sheet._focusTrapHandler);
      delete sheet._focusTrapHandler;
    }
  }

  // -- Sheet Open / Close --
  function openSheet(name) {
    if (!isMobile()) return;
    if (activeSheet === name) {
      closeSheet();
      return;
    }
    // Close any open sheet first (animated via CSS transition)
    if (activeSheet) {
      var prev = sheets[activeSheet];
      prev.classList.remove('open');
      prev.setAttribute('aria-hidden', 'true');
      releaseFocus(prev);
    }
    activeSheet = name;
    var sheet = sheets[name];
    if (!sheet) return;

    // Populate sheet content before opening
    if (name === 'font') populateFontSheet();
    if (name === 'color') populateColorSheet();
    if (name === 'settings') syncSettingsSheet();
    if (name === 'info') syncInfoSheet();

    sheetBackdrop.classList.add('visible');
    sheet.classList.add('open');
    document.body.classList.add('sheet-open');
    sheet.setAttribute('aria-hidden', 'false');
    history.pushState({ sheet: name }, '');
    trapFocus(sheet);
  }

  function closeSheet(fromPopstate) {
    if (!activeSheet) return;
    var sheet = sheets[activeSheet];
    if (sheet) {
      releaseFocus(sheet);
      sheet.classList.remove('open');
      sheet.setAttribute('aria-hidden', 'true');
    }
    sheetBackdrop.classList.remove('visible');
    document.body.classList.remove('sheet-open');
    activeSheet = null;
    if (!fromPopstate) history.back();
  }

  // Backdrop click: forward to toolbar buttons or close sheet
  sheetBackdrop.addEventListener('click', function (e) {
    if (!mobileToolbar) { closeSheet(); return; }
    var toolbarRect = mobileToolbar.getBoundingClientRect();
    if (e.clientY >= toolbarRect.top) {
      var btns = mobileToolbar.querySelectorAll('button');
      for (var i = 0; i < btns.length; i++) {
        var r = btns[i].getBoundingClientRect();
        if (e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom) {
          btns[i].click();
          return;
        }
      }
    }
    closeSheet();
  });

  // Escape key closes sheet
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape' && activeSheet) closeSheet();
  });

  // Browser back button closes sheet
  window.addEventListener('popstate', function () {
    if (activeSheet) closeSheet(true);
  });

  // ============================================================
  // == Swipe-to-Dismiss on Sheet Handles                       ==
  // ============================================================

  function initSheetDrag(sheetId) {
    var sheet = document.getElementById(sheetId);
    if (!sheet) return;
    var dragZones = sheet.querySelectorAll('.sheet-handle, .sheet-title');
    if (!dragZones.length) return;

    var startY = 0, currentY = 0, startTime = 0, isDragging = false;

    function onTouchStart(e) {
      if (!sheet.classList.contains('open')) return;
      isDragging = true;
      startY = e.touches[0].clientY;
      currentY = startY;
      startTime = Date.now();
      sheet.style.transition = 'none';
    }

    function onTouchMove(e) {
      if (!isDragging) return;
      currentY = e.touches[0].clientY;
      var dy = currentY - startY;
      dy = Math.max(-30, dy);  // Allow small upward pull for rubber-band feedback
      sheet.style.transform = 'translateY(' + dy + 'px)';
    }

    function onTouchEnd() {
      if (!isDragging) return;
      isDragging = false;
      sheet.style.transition = '';
      var dy = currentY - startY;
      var dt = Date.now() - startTime;
      var velocity = dy / Math.max(dt, 1);

      if (dy > 120 || velocity > 0.5) {
        closeSheet();
      } else {
        sheet.style.transform = '';
      }
    }

    for (var i = 0; i < dragZones.length; i++) {
      dragZones[i].addEventListener('touchstart', onTouchStart, { passive: true });
      dragZones[i].addEventListener('touchmove', onTouchMove, { passive: true });
      dragZones[i].addEventListener('touchend', onTouchEnd);
    }
  }

  initSheetDrag('sheetFont');
  initSheetDrag('sheetColor');
  initSheetDrag('sheetSettings');
  initSheetDrag('sheetInfo');


// ui-modules/virtual-scroll.js — Font sheet virtual scroll & preview queue

  // ============================================================
  // == Font Sheet: Virtual Scroll                              ==
  // ============================================================

  var FONT_ITEM_HEIGHT = 80;
  var OVERSCAN = 5;
  var fontSheetFilter = '';
  var fontSheetCategory = 'all';
  var filteredFontsCache = [];

  function getFilteredFonts() {
    var filter = fontSheetFilter.toLowerCase().trim();
    return fontListData.filter(function (font) {
      var name = (font.name || font.file).toLowerCase();
      if (filter && name.indexOf(filter) === -1) return false;
      if (fontSheetCategory !== 'all' && (font.category || 'other') !== fontSheetCategory) return false;
      return true;
    });
  }

  function populateFontSheet() {
    // Build tabs
    var tabsEl = document.getElementById('sheetFontTabs');
    var filter = fontSheetFilter.toLowerCase().trim();
    var categoryCounts = {};
    fontListData.forEach(function (font) {
      var name = (font.name || font.file).toLowerCase();
      if (filter && name.indexOf(filter) === -1) return;
      var cat = font.category || 'other';
      categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
    });
    var categories = Object.keys(categoryCounts).sort();
    var total = 0;
    categories.forEach(function (c) { total += categoryCounts[c]; });

    tabsEl.innerHTML = '';
    var allTab = document.createElement('button');
    allTab.className = 'font-tab' + (fontSheetCategory === 'all' ? ' active' : '');
    allTab.dataset.category = 'all';
    allTab.textContent = t('tab_all') + ' (' + total + ')';
    tabsEl.appendChild(allTab);

    categories.forEach(function (cat) {
      var btn = document.createElement('button');
      btn.className = 'font-tab' + (fontSheetCategory === cat ? ' active' : '');
      btn.dataset.category = cat;
      btn.textContent = (categoryLabels[cat] || cat) + ' (' + categoryCounts[cat] + ')';
      tabsEl.appendChild(btn);
    });

    // Reset category if invalid
    if (fontSheetCategory !== 'all' && !categoryCounts[fontSheetCategory]) {
      fontSheetCategory = 'all';
    }

    // Update filtered cache
    filteredFontsCache = getFilteredFonts();

    // Set viewport total height
    var viewport = document.getElementById('sheetFontListViewport');
    viewport.style.height = (filteredFontsCache.length * FONT_ITEM_HEIGHT) + 'px';

    // Trigger initial render
    renderVirtualFontList();
  }

  var rafPending = false;

  function renderVirtualFontList() {
    var wrap = document.getElementById('sheetFontListWrap');
    var viewport = document.getElementById('sheetFontListViewport');
    if (!wrap || !viewport) return;

    var scrollTop = wrap.scrollTop;
    var viewportHeight = wrap.clientHeight;
    var totalItems = filteredFontsCache.length;

    if (!totalItems) {
      viewport.innerHTML = '';
      var msg = document.createElement('div');
      msg.style.cssText = 'padding:40px 20px;color:var(--text-muted);font-size:14px;text-align:center';
      msg.textContent = t('no_matching');
      viewport.appendChild(msg);
      viewport.style.height = 'auto';
      return;
    }

    var startIndex = Math.max(0, Math.floor(scrollTop / FONT_ITEM_HEIGHT) - OVERSCAN);
    var endIndex = Math.min(totalItems, Math.ceil((scrollTop + viewportHeight) / FONT_ITEM_HEIGHT) + OVERSCAN);

    var fragment = document.createDocumentFragment();

    // Top spacer
    if (startIndex > 0) {
      var topSpacer = document.createElement('div');
      topSpacer.style.height = (startIndex * FONT_ITEM_HEIGHT) + 'px';
      fragment.appendChild(topSpacer);
    }

    for (var i = startIndex; i < endIndex; i++) {
      var font = filteredFontsCache[i];
      var name = font.name || font.file;

      var item = document.createElement('div');
      item.className = 'sheet-font-item' + (font.file === currentFontFile ? ' selected' : '');
      item.dataset.fontFile = font.file;
      item.dataset.fontIndex = i;
      item.setAttribute('role', 'option');
      item.setAttribute('aria-selected', font.file === currentFontFile ? 'true' : 'false');

      var info = document.createElement('div');
      info.className = 'sheet-font-item-info';

      var nameEl = document.createElement('div');
      nameEl.className = 'sheet-font-item-name';
      nameEl.textContent = name;

      var meta = document.createElement('div');
      meta.className = 'sheet-font-item-meta';
      meta.textContent = categoryLabels[font.category] || font.category || '';

      var previewCanvas = document.createElement('canvas');
      previewCanvas.className = 'sheet-font-item-preview';
      previewCanvas.dataset.fontFile = font.file;

      info.appendChild(nameEl);
      info.appendChild(meta);
      info.appendChild(previewCanvas);
      item.appendChild(info);

      // Checkmark
      var check = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      check.setAttribute('class', 'sheet-font-item-check');
      check.setAttribute('viewBox', '0 0 24 24');
      check.setAttribute('fill', 'none');
      check.setAttribute('stroke', 'currentColor');
      check.setAttribute('stroke-width', '3');
      check.setAttribute('stroke-linecap', 'round');
      check.setAttribute('stroke-linejoin', 'round');
      var path = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
      path.setAttribute('points', '20 6 9 17 4 12');
      check.appendChild(path);
      item.appendChild(check);

      fragment.appendChild(item);
    }

    // Bottom spacer
    var bottomHeight = (totalItems - endIndex) * FONT_ITEM_HEIGHT;
    if (bottomHeight > 0) {
      var bottomSpacer = document.createElement('div');
      bottomSpacer.style.height = bottomHeight + 'px';
      fragment.appendChild(bottomSpacer);
    }

    previewQueue = [];
    viewport.innerHTML = '';
    viewport.appendChild(fragment);
    viewport.style.height = ''; // let spacers define height

    // Queue font previews for visible items
    var canvases = viewport.querySelectorAll('.sheet-font-item-preview');
    for (var ci = 0; ci < canvases.length; ci++) {
      queueFontPreview(canvases[ci].dataset.fontFile, canvases[ci]);
    }
  }

  // -- Font Preview Queue --
  var previewQueue = [];
  var activePreviewRequests = 0;
  var MAX_PREVIEW_CONCURRENT = 3;

  function cancelAllPreviews() {
    previewAbortControllers.forEach(function (ctrl) { ctrl.abort(); });
    previewAbortControllers.clear();
    previewQueue = [];
    activePreviewRequests = 0;
  }

  function queueFontPreview(fontFile, canvasEl) {
    var cacheKey = getCacheKey(fontFile, currentHeight);
    if (fontCache.has(cacheKey)) {
      renderFontPreviewCanvas(canvasEl, fontCache.get(cacheKey));
      return;
    }
    canvasEl.classList.add('loading');
    previewQueue.push({ fontFile: fontFile, canvas: canvasEl, height: currentHeight });
    processPreviewQueue();
  }

  function processPreviewQueue() {
    while (activePreviewRequests < MAX_PREVIEW_CONCURRENT && previewQueue.length > 0) {
      var job = previewQueue.shift();
      if (!document.contains(job.canvas)) continue;
      var cacheKey = getCacheKey(job.fontFile, job.height);
      if (fontCache.has(cacheKey)) {
        renderFontPreviewCanvas(job.canvas, fontCache.get(cacheKey));
        job.canvas.classList.remove('loading');
        continue;
      }
      activePreviewRequests++;
      rasterizeFontForPreview(job);
    }
  }

  function rasterizeFontForPreview(job) {
    var cacheKey = getCacheKey(job.fontFile, job.height);
    var controller = new AbortController();
    previewAbortControllers.set(cacheKey, controller);

    fetch('/api/rasterize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ font: job.fontFile, height: job.height, bold: 0, strategy: 'average' }),
      signal: controller.signal
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      fontCache.set(cacheKey, data);
      if (document.contains(job.canvas)) {
        renderFontPreviewCanvas(job.canvas, data);
        job.canvas.classList.remove('loading');
      }
    })
    .catch(function(err) {
      if (err.name === 'AbortError') return; // Silently ignore aborted requests
      if (document.contains(job.canvas)) job.canvas.classList.remove('loading');
    })
    .finally(function() {
      previewAbortControllers.delete(cacheKey);
      activePreviewRequests--;
      processPreviewQueue();
    });
  }

  function renderFontPreviewCanvas(canvas, fontData) {
    // Use only first line for compact previews in font picker
    var text = (currentText || 'Abc').split('\n')[0] || 'Abc';
    var color = getCurrentColor().hex;
    renderPreview(canvas, text, fontData, color, { cellSize: 2, maxWidth: 260 });
  }

  // Re-render desktop sidebar previews using already-cached font data (no server requests)
  function refreshSidebarPreviews() {
    var canvases = document.querySelectorAll('.font-item-preview');
    for (var i = 0; i < canvases.length; i++) {
      var fontFile = canvases[i].dataset.fontFile;
      if (!fontFile) continue;
      var cacheKey = getCacheKey(fontFile, currentHeight);
      if (fontCache.has(cacheKey)) {
        renderFontPreviewCanvas(canvases[i], fontCache.get(cacheKey));
      }
    }
  }

  // Scroll handler (RAF-throttled)
  var sheetFontListWrap = document.getElementById('sheetFontListWrap');
  if (sheetFontListWrap) {
    sheetFontListWrap.addEventListener('scroll', function () {
      if (rafPending) return;
      rafPending = true;
      requestAnimationFrame(function () {
        rafPending = false;
        renderVirtualFontList();
      });
    }, { passive: true });
  }

  // Font sheet: item click (delegated)
  var sheetFontListViewport = document.getElementById('sheetFontListViewport');
  if (sheetFontListViewport) {
    sheetFontListViewport.addEventListener('click', function (e) {
      var item = e.target.closest('.sheet-font-item');
      if (!item) return;
      var fontFile = item.dataset.fontFile;
      var font = fontListData.find(function (f) { return f.file === fontFile; });
      if (!font) return;

      currentFontFile = font.file;
      currentFontName = font.name || font.file;

      // Update desktop sidebar selection too
      fontList.querySelectorAll('.font-item').forEach(function (el) {
        el.classList.toggle('selected', el.dataset.fontFile === font.file);
      });

      syncMobileFontName();
      loadAndRender();

      // Re-render virtual list to update selection
      renderVirtualFontList();

      // Close sheet after brief delay
      setTimeout(closeSheet, 200);
    });
  }

  // Font sheet: search
  var sheetFontSearchInput = document.getElementById('sheetFontSearch');
  var fontSearchDebounce = null;
  if (sheetFontSearchInput) {
    sheetFontSearchInput.addEventListener('input', function () {
      clearTimeout(fontSearchDebounce);
      fontSearchDebounce = setTimeout(function () {
        fontSheetFilter = sheetFontSearchInput.value;
        filteredFontsCache = getFilteredFonts();
        var viewport = document.getElementById('sheetFontListViewport');
        if (viewport) viewport.style.height = (filteredFontsCache.length * FONT_ITEM_HEIGHT) + 'px';
        var wrap = document.getElementById('sheetFontListWrap');
        if (wrap) wrap.scrollTop = 0;
        populateFontSheet();
      }, 150);
    });
  }

  // Font sheet: category tabs (delegated)
  var sheetFontTabs = document.getElementById('sheetFontTabs');
  if (sheetFontTabs) {
    sheetFontTabs.addEventListener('click', function (e) {
      var tab = e.target.closest('.font-tab');
      if (!tab) return;
      fontSheetCategory = tab.dataset.category;
      // Also sync desktop sidebar
      currentCategoryFilter = fontSheetCategory;
      populateFontSheet();
      renderFontListUI();
    });
  }


// ui-modules/sheet-content.js — Color, Settings & Info sheet content

  // ============================================================
  // == Color Sheet                                             ==
  // ============================================================

  function populateColorSheet() {
    if (typeof DMC_COLORS === 'undefined' || !DMC_COLORS.length) return;

    var color = getCurrentColor();
    var swatch = document.getElementById('sheetColorSwatch');
    var nameEl = document.getElementById('sheetColorName');
    var codeEl = document.getElementById('sheetColorCode');
    if (swatch) swatch.style.backgroundColor = color.hex;
    if (nameEl) nameEl.textContent = color.name;
    if (codeEl) codeEl.textContent = 'DMC ' + color.code;

    var searchInput = document.getElementById('sheetColorSearch');
    if (searchInput && !searchInput._bound) {
      searchInput._bound = true;
      searchInput.addEventListener('input', function () {
        renderSheetColorGrid(this.value);
      });
    }

    renderSheetColorGrid(searchInput ? searchInput.value : '');
  }

  function renderSheetColorGrid(query) {
    var grid = document.getElementById('sheetColorGrid');
    if (!grid) return;
    grid.innerHTML = '';

    var q = (query || '').toLowerCase().trim();
    var filtered = DMC_COLORS.filter(function (c) {
      if (!q) return true;
      return c.code.toLowerCase().indexOf(q) !== -1 || c.name.toLowerCase().indexOf(q) !== -1;
    });

    var fragment = document.createDocumentFragment();
    filtered.forEach(function (c) {
      var dot = document.createElement('div');
      dot.className = 'color-dot' + (c.code === currentColorCode ? ' selected' : '');
      dot.style.backgroundColor = c.hex;
      dot.dataset.code = c.code;
      fragment.appendChild(dot);
    });
    grid.appendChild(fragment);

    // Delegated click handler (set once)
    if (!grid._bound) {
      grid._bound = true;
      grid.addEventListener('click', function (e) {
        var dot = e.target.closest('.color-dot');
        if (!dot || !dot.dataset.code) return;
        selectColor(dot.dataset.code);
        populateColorSheet();
      });
    }
  }

  // ============================================================
  // == Settings Sheet                                          ==
  // ============================================================

  function syncSettingsSheet() {
    var sheetSlider = document.getElementById('sheetHeightSlider');
    var sheetValue = document.getElementById('sheetHeightValue');
    if (sheetSlider) sheetSlider.value = currentHeight;
    if (sheetValue) sheetValue.textContent = currentHeight;

    // Sync aida selection
    var sheetAidaRow = document.getElementById('sheetAidaRow');
    if (sheetAidaRow) {
      sheetAidaRow.querySelectorAll('.aida-chip').forEach(function (chip) {
        var count = chip.dataset.count;
        if (count === 'custom') {
          chip.classList.toggle('selected', isCustomAida);
        } else {
          chip.classList.toggle('selected', !isCustomAida && parseInt(count) === currentAida);
        }
      });
    }

    var sheetCustomRow = document.getElementById('sheetCustomStitchRow');
    if (sheetCustomRow) {
      sheetCustomRow.classList.toggle('visible', isCustomAida);
      if (isCustomAida) {
        var fmt = formatStitchDisplay(currentStitchMm);
        var sv = document.getElementById('sheetCustomStitchValue');
        var ss = document.getElementById('sheetCustomStitchSlider');
        var se = document.getElementById('sheetCustomStitchEquiv');
        var su = document.getElementById('sheetCustomStitchUnit');
        if (sv) sv.textContent = fmt.value;
        if (ss) ss.value = currentStitchMm;
        if (se) se.textContent = fmt.equiv;
        if (su) su.textContent = fmt.unit;
      }
    }
  }

  // Settings sheet: height slider
  var sheetHeightSlider = document.getElementById('sheetHeightSlider');
  var sheetHeightDebounce = null;
  if (sheetHeightSlider) {
    sheetHeightSlider.addEventListener('input', function () {
      var val = parseInt(this.value);
      var sheetValue = document.getElementById('sheetHeightValue');
      if (sheetValue) sheetValue.textContent = val;

      // Sync desktop slider + mobile slider
      heightSlider.value = val;
      heightValue.textContent = val;
      syncMobileHeightValue(val);

      currentHeight = val;

      // Cancel stale preview requests immediately
      cancelAllPreviews();

      // Priority: re-rasterize selected font immediately
      loadAndRender();

      // Debounced: re-render sidebar previews (300ms)
      clearTimeout(sheetHeightDebounce);
      sheetHeightDebounce = setTimeout(function () {
        renderFontListUI();
      }, 300);
    });
  }

  // Settings sheet: aida chips
  var sheetAidaRow = document.getElementById('sheetAidaRow');
  if (sheetAidaRow) {
    sheetAidaRow.addEventListener('click', function (e) {
      var chip = e.target.closest('.aida-chip');
      if (!chip) return;
      var countVal = chip.dataset.count;

      // Deselect all in sheet
      sheetAidaRow.querySelectorAll('.aida-chip').forEach(function (c) { c.classList.remove('selected'); });
      chip.classList.add('selected');

      // Sync desktop
      aidaRow.querySelectorAll('.aida-chip').forEach(function (c) { c.classList.remove('selected'); });
      var desktopChip = aidaRow.querySelector('[data-count="' + countVal + '"]');
      if (desktopChip) desktopChip.classList.add('selected');

      var sheetCustomRow = document.getElementById('sheetCustomStitchRow');

      if (countVal === 'custom') {
        isCustomAida = true;
        if (customStitchRow) customStitchRow.classList.add('visible');
        if (sheetCustomRow) sheetCustomRow.classList.add('visible');
        updateCustomStitch(currentStitchMm, 'init');
      } else {
        isCustomAida = false;
        if (customStitchRow) customStitchRow.classList.remove('visible');
        if (sheetCustomRow) sheetCustomRow.classList.remove('visible');
        currentAida = parseInt(countVal);
        syncMobileAidaChips();
        updatePreview();
      }
    });
  }

  // Settings sheet: stitch length slider
  var sheetStitchSlider = document.getElementById('sheetCustomStitchSlider');
  if (sheetStitchSlider) {
    sheetStitchSlider.addEventListener('input', function () {
      if (isCustomAida) updateCustomStitch(parseFloat(this.value), 'sheet');
    });
  }

  // ============================================================
  // == Info Sheet                                              ==
  // ============================================================

  function syncInfoSheet() {
    var color = getCurrentColor();
    var sizeCm = document.getElementById('statSizeCm');
    var stitchW = document.getElementById('statStitchesW');
    var stitchH = document.getElementById('statStitchesH');
    var total = document.getElementById('statTotal');
    var dmc = document.getElementById('statDmc');
    var thread = document.getElementById('statThread');

    var infoSize = document.getElementById('infoSize');
    var infoStitches = document.getElementById('infoStitches');
    var infoCrosses = document.getElementById('infoCrosses');
    var infoDmc = document.getElementById('infoDmc');
    var infoThread = document.getElementById('infoThread');
    var infoRulerW = document.getElementById('infoRulerWidth');

    if (infoSize && sizeCm) infoSize.textContent = sizeCm.textContent || '-- x --';
    if (infoStitches && stitchW && stitchH) infoStitches.textContent = (stitchW.textContent || '--') + 'x' + (stitchH.textContent || '--');
    if (infoCrosses && total) infoCrosses.textContent = total.textContent || '--';
    if (infoDmc && dmc) infoDmc.textContent = dmc.textContent || '--';
    if (infoThread && thread) infoThread.textContent = thread.textContent || '--';
    // Sync unit label
    var infoSizeUnit = document.getElementById('infoSizeUnit');
    var statSizeUnit = document.getElementById('statSizeUnit');
    if (infoSizeUnit && statSizeUnit) infoSizeUnit.textContent = statSizeUnit.textContent;
    if (infoRulerW) {
      var rulerW = document.getElementById('rulerWidth');
      infoRulerW.textContent = rulerW ? rulerW.textContent : '--';
    }

    // Sync language selector
    var sheetLang = document.getElementById('sheetLangSelect');
    if (sheetLang) sheetLang.value = currentLang;
  }

  // Info sheet: language selector
  var sheetLangSelect = document.getElementById('sheetLangSelect');
  if (sheetLangSelect) {
    sheetLangSelect.addEventListener('change', function () {
      setLanguage(this.value);
      // Sync desktop selector
      var desktopSelect = document.getElementById('langSelect');
      if (desktopSelect) desktopSelect.value = this.value;
    });
  }


// ui-modules/mobile-toolbar.js — Mobile toolbar sync, slider & button handlers

  // ============================================================
  // == Mobile Toolbar (Slider + 3 Buttons → Sheets)           ==
  // ============================================================

  // -- Sync helpers --

  function syncMobileColorStrip() {
    // Update color button swatch and name
    var color = getCurrentColor();
    var swatch = document.getElementById('mobileColorSwatch');
    var nameEl = document.getElementById('mobileColorName');
    if (swatch) swatch.style.backgroundColor = color.hex;
    if (nameEl) nameEl.textContent = color.name;
  }

  function syncMobileHeightValue(val) {
    var el = document.getElementById('mobileHeightValue');
    var slider = document.getElementById('mobileHeightSlider');
    if (el) el.textContent = val;
    if (slider) slider.value = val;
  }

  function syncMobileAidaChips() {
    var el = document.getElementById('mobileAidaValue');
    if (el) el.textContent = (isCustomAida ? Math.round(currentAida) : currentAida) + ' ct';
  }

  function syncMobileFontName() {
    var el = document.getElementById('mobileFontName');
    if (el) el.textContent = currentFontName || 'Font';
  }

  // Kept for compatibility — no longer renders dots
  function populateMobileColorStrip() {
    syncMobileColorStrip();
  }

  // -- Mobile height slider --

  var mobileSlider = document.getElementById('mobileHeightSlider');
  var mobileSliderDebounce = null;
  if (mobileSlider) {
    mobileSlider.addEventListener('input', function () {
      var val = parseInt(this.value);
      var display = document.getElementById('mobileHeightValue');
      if (display) display.textContent = val;

      // Sync desktop + sheet sliders
      heightSlider.value = val;
      heightValue.textContent = val;
      var sheetSlider = document.getElementById('sheetHeightSlider');
      var sheetValue = document.getElementById('sheetHeightValue');
      if (sheetSlider) sheetSlider.value = val;
      if (sheetValue) sheetValue.textContent = val;

      currentHeight = val;

      // Cancel stale preview requests immediately
      cancelAllPreviews();

      // Priority: re-rasterize selected font immediately
      loadAndRender();

      // Debounced: re-render sidebar previews (300ms)
      clearTimeout(mobileSliderDebounce);
      mobileSliderDebounce = setTimeout(function () {
        renderFontListUI();
      }, 300);
    });
  }

  // -- Aida button → opens settings sheet --

  var mobileAidaBtn = document.getElementById('mobileAidaBtn');
  if (mobileAidaBtn) {
    mobileAidaBtn.addEventListener('click', function () {
      openSheet('settings');
    });
  }

  // -- Font button → opens font sheet --

  var mobileFontBtn = document.getElementById('mobileFontBtn');
  if (mobileFontBtn) {
    mobileFontBtn.addEventListener('click', function () {
      openSheet('font');
    });
  }

  // -- Color button → opens color sheet --

  var mobileColorBtn = document.getElementById('mobileColorBtn');
  if (mobileColorBtn) {
    mobileColorBtn.addEventListener('click', function () {
      openSheet('color');
    });
  }

  // -- Initialize mobile toolbar on load --

  function initMobileToolbar() {
    syncMobileColorStrip();
    syncMobileHeightValue(currentHeight);
    syncMobileAidaChips();
    syncMobileFontName();
  }

  // ============================================================
  // == Resize: close sheet if transitioning to desktop         ==
  // ============================================================

  var mobileResizeTimer;
  window.addEventListener('resize', function () {
    clearTimeout(mobileResizeTimer);
    mobileResizeTimer = setTimeout(function () {
      if (!isMobile() && activeSheet) {
        closeSheet();
      }
    }, 150);
  });


// ui-modules/bottom-input.js — Mobile bottom input bar: sync, keyboard mode & canvas tap-to-focus

  // -- Mobile Input Bar --

  var mobileTextInput = document.getElementById('mobileTextInput');

  // Sync mobile input → state + desktop input + preview (debounced)
  var mobileInputDebounce = null;
  if (mobileTextInput) {
    mobileTextInput.addEventListener('input', function () {
      currentText = this.value;
      textInput.value = currentText;
      clearTimeout(mobileInputDebounce);
      mobileInputDebounce = setTimeout(function () {
        updatePreview();
        renderVirtualFontList();
        refreshSidebarPreviews();
      }, 300);
    });
  }

  // Sync desktop input → mobile input
  if (textInput && mobileTextInput) {
    textInput.addEventListener('input', function () {
      mobileTextInput.value = this.value;
    });
  }

  // -- Keyboard Mode: hide toolbar when typing on mobile --

  if (mobileTextInput) {
    mobileTextInput.addEventListener('focus', function () {
      document.body.classList.add('keyboard-open');
      setTimeout(updatePreview, 100);
    });

    mobileTextInput.addEventListener('blur', function () {
      document.body.classList.remove('keyboard-open');
      setTimeout(updatePreview, 100);
    });
  }

  // -- Canvas / Preview Tap → Focus Input (mobile + desktop) --

  var previewAreaEl = document.getElementById('previewArea');
  if (previewAreaEl) {
    previewAreaEl.addEventListener('click', function (e) {
      if (e.target.closest('button, a, input, select, textarea')) return;

      if (isMobile() && mobileTextInput) {
        mobileTextInput.focus();
      } else if (textInput) {
        textInput.focus();
        textInput.select();
      }
    });
  }

  // -- Alignment Buttons (desktop + mobile) --

  function setAlignment(align) {
    currentAlign = align;
    // Sync all alignment button groups
    document.querySelectorAll('.align-btn').forEach(function (btn) {
      btn.classList.toggle('active', btn.dataset.align === align);
    });
    updatePreview();
  }

  // Desktop sidebar alignment
  var alignRow = document.getElementById('alignRow');
  if (alignRow) {
    alignRow.addEventListener('click', function (e) {
      var btn = e.target.closest('.align-btn');
      if (!btn) return;
      setAlignment(btn.dataset.align);
    });
  }

  // Mobile toolbar alignment
  var mobileAlignRow = document.getElementById('mobileAlignRow');
  if (mobileAlignRow) {
    mobileAlignRow.addEventListener('click', function (e) {
      var btn = e.target.closest('.align-btn');
      if (!btn) return;
      setAlignment(btn.dataset.align);
    });
  }

  // -- Sync on init --

  function syncMobileTextInput() {
    if (mobileTextInput) {
      mobileTextInput.value = currentText || '';
    }
  }


// ui-modules/init.js — Resize handling, init function, window exposures, DOMContentLoaded

  // -- Resize handling --

  var resizeTimer;
  window.addEventListener('resize', function () {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(updatePreview, 150);
  });

  // -- Initialize --

  function init() {
    // Detect language
    var savedLang = null;
    try { savedLang = localStorage.getItem('w2s_lang'); } catch(e) {}
    var browserLang = (navigator.language || '').split('-')[0];
    setLanguage(savedLang || (I18N[browserLang] ? browserLang : 'en'));

    // Detect unit preference
    var savedUnit = null;
    try { savedUnit = localStorage.getItem('w2s_unit'); } catch(e) {}
    setDisplayUnit(savedUnit || detectDefaultUnit());

    renderColors();
    initMobileToolbar();
    syncMobileTextInput();
    fetchFontList();
    updatePreview();
  }

  // Expose for pdf-engine
  window.getTextBitmap = getTextBitmap;
  window.getEffectiveBitmap = getEffectiveBitmap;
  window.renderPreview = renderPreview;
  window.getDisplayUnit = function() { return displayUnit; };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function () { initAuth(init); });
  } else {
    initAuth(init);
  }

  // Wait for DMC_COLORS if loaded late
  var _colorsInterval = setInterval(function () {
    if (typeof DMC_COLORS !== 'undefined') {
      clearInterval(_colorsInterval);
      renderColors();
      populateMobileColorStrip();
    }
  }, 200);
  setTimeout(function () { clearInterval(_colorsInterval); }, 10000);


})();
</script>

<!-- ═══ Vercel Analytics & Speed Insights ═══ -->
<script defer src="/_vercel/insights/script.js"></script>
<script defer src="/_vercel/speed-insights/script.js"></script>

</body>
</html>
